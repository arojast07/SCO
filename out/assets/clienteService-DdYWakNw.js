import{s as a}from"./index-Xz42BvxI.js";const c=async(r={})=>{try{const{data:{user:e}}=await a.auth.getUser();if(!e)throw new Error("Usuario no autenticado");const{data:o}=await a.from("usuario_tienda_actual").select("tienda_id").eq("usuario_id",e.id).single();if(!o?.tienda_id)return console.warn("‚ö†Ô∏è Usuario sin tienda asignada"),[];let t=a.from("clientes").select(`
        *,
        pais:paises(nombre),
        provincia:provincias(nombre),
        canton:cantones(nombre),
        distrito:distritos(nombre)
      `).eq("tienda_id",o.tienda_id).eq("activo",!0);r.search&&(t=t.or(`nombre_razon_social.ilike.%${r.search}%,identificacion.ilike.%${r.search}%,correo_principal.ilike.%${r.search}%`)),r.tipo&&(t=t.eq("tipo_identificacion",r.tipo)),t=t.order("nombre_razon_social");const{data:i,error:n}=await t;if(n)throw console.error("‚ùå Error obteniendo clientes:",n),n;return i||[]}catch(e){throw console.error("‚ùå Error en obtenerClientes:",e),e}},d=async()=>{try{const{data:r,error:e}=await a.from("provincias").select("*").order("nombre");if(e)throw e;return r||[]}catch(r){return console.error("Error obteniendo provincias:",r),[]}},l=async r=>{try{const{data:e,error:o}=await a.from("cantones").select("*").eq("provincia_id",r).order("nombre");if(o)throw o;return e||[]}catch(e){return console.error("Error obteniendo cantones:",e),[]}},u=async r=>{try{console.log("üîç Cargando distritos para cant√≥n:",r);const e=new Promise((n,s)=>setTimeout(()=>s(new Error("Timeout al cargar distritos")),1e4)),o=a.from("distritos").select("*").eq("canton_id",r).order("nombre"),{data:t,error:i}=await Promise.race([o,e]);if(i)throw console.error("‚ùå Error obteniendo distritos:",i),i;return console.log(`‚úÖ Distritos cargados: ${t?.length||0} registros`),t||[]}catch(e){return console.error("‚ùå Error en obtenerDistritos:",e),e.message==="Timeout al cargar distritos"&&console.warn("‚ö†Ô∏è Timeout al cargar distritos, retornando array vac√≠o"),[]}},m=async()=>{try{const{data:r,error:e}=await a.from("paises").select("*").order("nombre");if(e)throw e;return r||[]}catch(r){return console.error("Error obteniendo pa√≠ses:",r),[]}},_=async()=>{try{const{data:r,error:e}=await a.from("actividades_economicas").select("*").order("codigo");if(e)throw e;return r||[]}catch(r){return console.error("Error obteniendo actividades econ√≥micas:",r),[]}},h=(r,e)=>{const o=e.replace(/\D/g,"");switch(r){case"cedula_fisica":return o.length===9;case"cedula_juridica":return o.length===10;case"dimex":return o.length>=11&&o.length<=12;case"nite":return o.length===10;case"pasaporte":return e.length>=6&&e.length<=20;default:return!1}},w=r=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(r),f=r=>{const e=r.replace(/\D/g,"");return e.length>=8&&e.length<=15},p={obtenerClientes:c,obtenerProvincias:d,obtenerCantones:l,obtenerDistritos:u,obtenerPaises:m,obtenerActividadesEconomicas:_,validarIdentificacion:h,validarEmail:w,validarTelefono:f,buscarClientes:async r=>{try{const{data:{user:e}}=await a.auth.getUser();if(!e)throw new Error("Usuario no autenticado");const{data:o,error:t}=await a.from("usuario_tienda_actual").select("tienda_id").eq("usuario_id",e.id).single();if(t)throw t;const{data:i,error:n}=await a.from("clientes").select("id, nombre_razon_social, identificacion, tipo_identificacion").eq("tienda_id",o.tienda_id).or(`nombre_razon_social.ilike.%${r}%,identificacion.ilike.%${r}%`).eq("activo",!0).limit(10);if(n)throw n;return i||[]}catch(e){return console.error("Error buscando clientes:",e),[]}},crearCliente:async r=>{try{const{data:e}=await a.auth.getSession();if(!e.session?.user)throw new Error("Usuario no autenticado");const{data:o}=await a.from("usuario_tienda_actual").select("tienda_id").eq("usuario_id",e.session.user.id).single();if(!o)throw new Error("No se pudo determinar la tienda actual");const t={...r};t.exoneracion_vencimiento===""&&(t.exoneracion_vencimiento=null),t.hacienda_ultimo_intento===""&&(t.hacienda_ultimo_intento=null);const i={...t,tienda_id:o.tienda_id},{data:n,error:s}=await a.from("clientes").insert([i]).select().single();if(s)throw console.error("Error creando cliente:",s),new Error("Error al crear el cliente: "+s.message);return n}catch(e){throw console.error("Error en crearCliente:",e),e}},actualizarCliente:async(r,e)=>{try{const{data:o}=await a.auth.getSession();if(!o.session?.user)throw new Error("Usuario no autenticado");const{data:t}=await a.from("usuario_tienda_actual").select("tienda_id").eq("usuario_id",o.session.user.id).single();if(!t)throw new Error("No se pudo determinar la tienda actual");const i={...e};i.exoneracion_vencimiento===""&&(i.exoneracion_vencimiento=null),i.hacienda_ultimo_intento===""&&(i.hacienda_ultimo_intento=null);const{data:n,error:s}=await a.from("clientes").update(i).eq("id",r).eq("tienda_id",t.tienda_id).select().single();if(s)throw console.error("Error actualizando cliente:",s),new Error("Error al actualizar el cliente: "+s.message);return n}catch(o){throw console.error("Error en actualizarCliente:",o),o}}},g=async r=>{try{return await new Promise(e=>setTimeout(e,1e3)),{valido:!0,mensaje:"Identificaci√≥n v√°lida seg√∫n Hacienda"}}catch{return{valido:!1,mensaje:"Error al validar con Hacienda"}}},v={validarIdentificacion:g};export{p as C,v as H};
//# sourceMappingURL=clienteService-DdYWakNw.js.map
