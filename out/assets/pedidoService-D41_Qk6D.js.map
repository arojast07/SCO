{"version":3,"file":"pedidoService-D41_Qk6D.js","sources":["../../src/services/pedidoService.ts"],"sourcesContent":["import { supabase } from '../lib/supabase';\nimport { Pedido } from '../types/pedido';\n\ninterface UpdatePedidoData {\n  cliente_id: number;\n  moneda: string;\n  tipo_cambio: number;\n  notas?: string;\n  subtotal: number;\n  descuento_total: number;\n  impuesto_total: number;\n  total: number;\n  items?: Array<{\n    item_type: string;\n    item_id: number;\n    descripcion: string;\n    unidad: string;\n    cantidad: number;\n    precio_unit: number;\n    descuento_pct?: number;\n    impuesto_pct?: number;\n    total: number;\n    meta_json?: any;\n  }>;\n}\n\ninterface CreatePedidoData extends UpdatePedidoData {\n  codigo?: string;\n  fecha_pedido?: string;\n  fecha_entrega?: string;\n  estado?: string;\n}\n\nclass PedidoService {\n  // Obtener lista de pedidos con filtros\n  async getPedidos(filters?: {\n    estado?: string;\n    cliente_id?: number | null;\n    fecha_desde?: string;\n    fecha_hasta?: string;\n  }): Promise<Pedido[]> {\n    // Obtener usuario autenticado\n    const { data: { user } } = await supabase.auth.getUser();\n    if (!user) throw new Error('Usuario no autenticado');\n\n    // Obtener tienda actual del usuario\n    const { data: tiendaActual } = await supabase\n      .from('usuario_tienda_actual')\n      .select('tienda_id')\n      .eq('usuario_id', user.id)\n      .single();\n\n    if (!tiendaActual) throw new Error('No hay tienda asignada');\n\n    // Construir query base - CORREGIDO: Eliminada la relaci√≥n incorrecta con producto_id\n    let query = supabase\n      .from('pedidos')\n      .select(`\n        *,\n        cliente:clientes(\n          id,\n          nombre_razon_social,\n          identificacion\n        ),\n        pedido_items(\n          id,\n          item_type,\n          item_id,\n          descripcion,\n          unidad,\n          cantidad,\n          precio_unit,\n          descuento_pct,\n          impuesto_pct,\n          total,\n          meta_json\n        )\n      `)\n      .eq('tienda_id', tiendaActual.tienda_id)\n      .order('created_at', { ascending: false });\n\n    // Aplicar filtros\n    if (filters?.estado) {\n      query = query.eq('estado', filters.estado);\n    }\n\n    if (filters?.cliente_id) {\n      query = query.eq('cliente_id', filters.cliente_id);\n    }\n\n    if (filters?.fecha_desde) {\n      query = query.gte('created_at', filters.fecha_desde);\n    }\n\n    if (filters?.fecha_hasta) {\n      query = query.lte('created_at', filters.fecha_hasta);\n    }\n\n    const { data, error } = await query;\n\n    if (error) throw error;\n\n    // Mapear pedido_items a items para compatibilidad\n    const pedidosConItems = (data || []).map(pedido => ({\n      ...pedido,\n      items: pedido.pedido_items || []\n    }));\n\n    return pedidosConItems;\n  }\n\n  // Obtener pedido por ID\n  async getPedidoById(id: number): Promise<Pedido | null> {\n    try {\n      const { data, error } = await supabase\n        .from('pedidos')\n        .select(`\n          *,\n          clientes!inner(\n            id,\n            nombre_razon_social,\n            identificacion\n          ),\n          pedido_items(\n            id,\n            item_type,\n            item_id,\n            descripcion,\n            unidad,\n            cantidad,\n            precio_unit,\n            descuento_pct,\n            impuesto_pct,\n            total,\n            meta_json\n          )\n        `)\n        .eq('id', id)\n        .single();\n\n      if (error) throw error;\n      \n      // Mapear pedido_items a items para compatibilidad\n      return {\n        ...data,\n        items: data.pedido_items || []\n      } as Pedido;\n    } catch (error) {\n      console.error('Error obteniendo pedido:', error);\n      return null;\n    }\n  }\n\n  // Crear pedido\n  async createPedido(data: CreatePedidoData): Promise<Pedido> {\n    try {\n      // Obtener usuario actual\n      const { data: { user } } = await supabase.auth.getUser();\n      if (!user) throw new Error('Usuario no autenticado');\n\n      // Obtener tienda actual\n      const { data: tiendaData } = await supabase\n        .from('usuario_tienda_actual')\n        .select('tienda_id')\n        .eq('usuario_id', user.id)\n        .single();\n\n      if (!tiendaData) throw new Error('No hay tienda asignada');\n\n      // Crear pedido principal\n      const { data: pedido, error: pedidoError } = await supabase\n        .from('pedidos')\n        .insert({\n          codigo: data.codigo || `PED-${Date.now()}`,\n          cliente_id: data.cliente_id,\n          moneda: data.moneda,\n          tipo_cambio: data.tipo_cambio,\n          subtotal: data.subtotal,\n          descuento_total: data.descuento_total,\n          impuesto_total: data.impuesto_total,\n          total: data.total,\n          estado: data.estado || 'borrador',\n          notas: data.notas,\n          tienda_id: tiendaData.tienda_id,\n          created_by: user.id,\n          created_at: new Date().toISOString(),\n          updated_at: new Date().toISOString()\n        })\n        .select()\n        .single();\n\n      if (pedidoError) throw pedidoError;\n\n      // Crear items si se proporcionan\n      if (data.items && data.items.length > 0) {\n        const items = data.items.map(item => ({\n          pedido_id: pedido.id,\n          item_type: item.item_type,\n          item_id: item.item_id,\n          descripcion: item.descripcion,\n          unidad: item.unidad,\n          cantidad: item.cantidad,\n          precio_unit: item.precio_unit,\n          descuento_pct: item.descuento_pct || 0,\n          impuesto_pct: item.impuesto_pct || 13,\n          total: item.total,\n          meta_json: item.meta_json\n        }));\n\n        const { error: itemsError } = await supabase\n          .from('pedido_items')\n          .insert(items);\n\n        if (itemsError) throw itemsError;\n\n        // Crear reservas de inventario solo si est√° en borrador\n        if (pedido.estado === 'borrador') {\n          await this.crearReservasInventario(pedido.id, data.items);\n        }\n      }\n\n      return this.getPedidoById(pedido.id) as Promise<Pedido>;\n    } catch (error) {\n      console.error('Error creando pedido:', error);\n      throw error;\n    }\n  }\n\n  // Crear pedido desde cotizaci√≥n\n  async createPedidoFromCotizacion(cotizacionId: number): Promise<Pedido> {\n    try {\n      // Obtener cotizaci√≥n completa\n      const { data: cotizacion, error: cotizacionError } = await supabase\n        .from('cotizaciones')\n        .select(`\n          *,\n          cotizacion_items (*)\n        `)\n        .eq('id', cotizacionId)\n        .single();\n\n      if (cotizacionError) throw cotizacionError;\n      if (!cotizacion) throw new Error('Cotizaci√≥n no encontrada');\n\n      // Validar que est√© aprobada\n      if (cotizacion.estado !== 'aprobada' && cotizacion.estado !== 'Aprobada') {\n        throw new Error('Solo se pueden crear pedidos desde cotizaciones aprobadas');\n      }\n\n      // Convertir items de cotizaci√≥n a items de pedido\n      const pedidoItems = cotizacion.cotizacion_items.map((item: any) => ({\n        item_type: 'producto',\n        item_id: item.producto_id,\n        descripcion: item.descripcion,\n        unidad: 'UN',\n        cantidad: item.cantidad,\n        precio_unit: item.precio_unitario,\n        descuento_pct: item.descuento || 0,\n        impuesto_pct: 13,\n        total: item.subtotal,\n        meta_json: null\n      }));\n\n      // Crear datos del pedido\n      const pedidoData: CreatePedidoData = {\n        codigo: `PED-${cotizacion.numero_cotizacion || cotizacion.codigo || Date.now()}`,\n        cliente_id: cotizacion.cliente_id,\n        moneda: 'CRC',\n        tipo_cambio: 1,\n        subtotal: cotizacion.subtotal,\n        descuento_total: cotizacion.descuento_global || cotizacion.descuento_general || 0,\n        impuesto_total: cotizacion.impuestos || cotizacion.impuesto || 0,\n        total: cotizacion.total,\n        estado: 'borrador',\n        notas: `Generado desde cotizaci√≥n #${cotizacion.numero_cotizacion || cotizacion.codigo}. ${cotizacion.notas || cotizacion.observaciones || ''}`.trim(),\n        items: pedidoItems\n      };\n\n      return await this.createPedido(pedidoData);\n    } catch (error) {\n      console.error('Error creando pedido desde cotizaci√≥n:', error);\n      throw error;\n    }\n  }\n\n  // Actualizar pedido\n  async updatePedido(id: number, data: UpdatePedidoData): Promise<Pedido> {\n    // Permitir actualizar si est√° en borrador o confirmado (no facturado ni cancelado)\n    const pedidoActual = await this.getPedidoById(id);\n    if (!pedidoActual) {\n      throw new Error('Pedido no encontrado');\n    }\n    \n    if (pedidoActual.estado === 'facturado') {\n      throw new Error('No se pueden editar pedidos que ya han sido facturados');\n    }\n    \n    if (pedidoActual.estado === 'cancelado') {\n      throw new Error('No se pueden editar pedidos cancelados');\n    }\n\n    // Actualizar pedido\n    const { error: pedidoError } = await supabase\n      .from('pedidos')\n      .update({\n        cliente_id: data.cliente_id,\n        moneda: data.moneda,\n        tipo_cambio: data.tipo_cambio,\n        notas: data.notas,\n        subtotal: data.subtotal,\n        descuento_total: data.descuento_total,\n        impuesto_total: data.impuesto_total,\n        total: data.total,\n        updated_at: new Date().toISOString()\n      })\n      .eq('id', id);\n\n    if (pedidoError) throw pedidoError;\n\n    // Actualizar items si se proporcionan\n    if (data.items) {\n      // Eliminar items existentes\n      await supabase.from('pedido_items').delete().eq('pedido_id', id);\n      \n      // Liberar reservas existentes solo si est√° en borrador\n      if (pedidoActual.estado === 'borrador') {\n        await this.liberarReservas(id);\n      }\n\n      // Crear nuevos items\n      if (data.items.length > 0) {\n        const items = data.items.map(item => ({\n          pedido_id: id,\n          item_type: item.item_type,\n          item_id: item.item_id,\n          descripcion: item.descripcion,\n          unidad: item.unidad,\n          cantidad: item.cantidad,\n          precio_unit: item.precio_unit,\n          descuento_pct: item.descuento_pct || 0,\n          impuesto_pct: item.impuesto_pct || 13,\n          total: item.total,\n          meta_json: item.meta_json\n        }));\n\n        const { error: itemsError } = await supabase\n          .from('pedido_items')\n          .insert(items);\n\n        if (itemsError) throw itemsError;\n\n        // Crear nuevas reservas solo si est√° en borrador\n        if (pedidoActual.estado === 'borrador') {\n          await this.crearReservasInventario(id, data.items);\n        }\n      }\n    }\n\n    return this.getPedidoById(id) as Promise<Pedido>;\n  }\n\n  // Liberar reservas de inventario\n  private async liberarReservas(pedidoId: number): Promise<void> {\n    try {\n      const { error } = await supabase\n        .from('inventario_reservas')\n        .delete()\n        .eq('pedido_id', pedidoId);\n\n      if (error) throw error;\n      console.log('Reservas liberadas para pedido:', pedidoId);\n    } catch (error) {\n      console.error('Error liberando reservas:', error);\n      throw error;\n    }\n  }\n\n  // Crear reservas de inventario\n  private async crearReservasInventario(pedidoId: number, items: any[]): Promise<void> {\n    try {\n      console.log('üîç [RESERVAS] Iniciando creaci√≥n de reservas para pedido:', pedidoId);\n      console.log('üîç [RESERVAS] Items recibidos:', items);\n\n      // Filtrar solo items de tipo inventario\n      const itemsInventario = items.filter(item => item.item_type === 'inventario');\n      \n      console.log('üîç [RESERVAS] Items de inventario filtrados:', itemsInventario.length);\n\n      if (itemsInventario.length === 0) {\n        console.log('‚ÑπÔ∏è [RESERVAS] No hay items de inventario, no se crear√°n reservas');\n        return;\n      }\n\n      // Validar que los art√≠culos existan en inventario\n      const idsArticulos = itemsInventario.map(item => item.item_id);\n      console.log('üîç [RESERVAS] Validando existencia de art√≠culos:', idsArticulos);\n\n      const { data: articulosExistentes, error: validacionError } = await supabase\n        .from('inventario')\n        .select('id')\n        .in('id', idsArticulos);\n\n      if (validacionError) {\n        console.error('‚ùå [RESERVAS] Error validando art√≠culos:', validacionError);\n        throw validacionError;\n      }\n\n      const idsExistentes = (articulosExistentes || []).map(a => a.id);\n      console.log('‚úÖ [RESERVAS] Art√≠culos existentes en inventario:', idsExistentes);\n\n      // Filtrar solo items que existen en inventario\n      const itemsValidos = itemsInventario.filter(item => idsExistentes.includes(item.item_id));\n      \n      if (itemsValidos.length === 0) {\n        console.log('‚ö†Ô∏è [RESERVAS] Ning√∫n art√≠culo existe en inventario, no se crear√°n reservas');\n        return;\n      }\n\n      console.log('‚úÖ [RESERVAS] Items v√°lidos para reservar:', itemsValidos.length);\n\n      // Crear reservas con los campos correctos\n      const reservas = itemsValidos.map(item => ({\n        pedido_id: pedidoId,\n        id_articulo: item.item_id,\n        cantidad: item.cantidad,\n        vence_at: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(), // Vence en 7 d√≠as\n        estado: 'activa'\n      }));\n\n      console.log('üîç [RESERVAS] Reservas a crear:', reservas);\n\n      const { error } = await supabase\n        .from('inventario_reservas')\n        .insert(reservas);\n\n      if (error) {\n        console.error('‚ùå [RESERVAS] Error creando reservas:', error);\n        throw error;\n      }\n      \n      console.log('‚úÖ [RESERVAS] Reservas creadas exitosamente para pedido:', pedidoId);\n      console.log('‚úÖ [RESERVAS] Total de reservas creadas:', reservas.length);\n    } catch (error) {\n      console.error('‚ùå [RESERVAS] Error en crearReservasInventario:', error);\n      throw error;\n    }\n  }\n\n  // Confirmar pedido\n  async confirmarPedido(id: number, userId: string): Promise<void> {\n    try {\n      // Obtener pedido actual\n      const pedido = await this.getPedidoById(id);\n      if (!pedido) {\n        throw new Error('Pedido no encontrado');\n      }\n\n      // Validar que est√© en estado borrador\n      if (pedido.estado !== 'borrador') {\n        throw new Error('Solo se pueden confirmar pedidos en estado borrador');\n      }\n\n      // Actualizar estado a confirmado\n      const { error } = await supabase\n        .from('pedidos')\n        .update({\n          estado: 'confirmado',\n          updated_at: new Date().toISOString()\n        })\n        .eq('id', id);\n\n      if (error) throw error;\n\n      console.log('‚úÖ Pedido confirmado exitosamente:', id);\n    } catch (error) {\n      console.error('‚ùå Error confirmando pedido:', error);\n      throw error;\n    }\n  }\n\n  // Cancelar pedido\n  async cancelarPedido(id: number, userId: string): Promise<void> {\n    try {\n      // Obtener pedido actual\n      const pedido = await this.getPedidoById(id);\n      if (!pedido) {\n        throw new Error('Pedido no encontrado');\n      }\n\n      // Validar que no est√© facturado\n      if (pedido.estado === 'facturado') {\n        throw new Error('No se pueden cancelar pedidos facturados');\n      }\n\n      // Validar que no est√© ya cancelado\n      if (pedido.estado === 'cancelado') {\n        throw new Error('El pedido ya est√° cancelado');\n      }\n\n      // Liberar reservas de inventario\n      await this.liberarReservas(id);\n\n      // Actualizar estado a cancelado\n      const { error } = await supabase\n        .from('pedidos')\n        .update({\n          estado: 'cancelado',\n          updated_at: new Date().toISOString()\n        })\n        .eq('id', id);\n\n      if (error) throw error;\n\n      console.log('‚úÖ Pedido cancelado exitosamente:', id);\n    } catch (error) {\n      console.error('‚ùå Error cancelando pedido:', error);\n      throw error;\n    }\n  }\n\n  // Eliminar pedido\n  async deletePedido(id: number): Promise<void> {\n    try {\n      // Obtener pedido actual\n      const pedido = await this.getPedidoById(id);\n      if (!pedido) {\n        throw new Error('Pedido no encontrado');\n      }\n\n      // Validar que est√© en estado borrador o cancelado\n      if (pedido.estado !== 'borrador' && pedido.estado !== 'cancelado') {\n        throw new Error('Solo se pueden eliminar pedidos en estado borrador o cancelado');\n      }\n\n      // Liberar reservas si existen\n      await this.liberarReservas(id);\n\n      // Eliminar items\n      await supabase.from('pedido_items').delete().eq('pedido_id', id);\n\n      // Eliminar pedido\n      const { error } = await supabase\n        .from('pedidos')\n        .delete()\n        .eq('id', id);\n\n      if (error) throw error;\n\n      console.log('‚úÖ Pedido eliminado exitosamente:', id);\n    } catch (error) {\n      console.error('‚ùå Error eliminando pedido:', error);\n      throw error;\n    }\n  }\n}\n\n// Exportar instancia del servicio\nexport const pedidoService = new PedidoService();\nexport default pedidoService;\n"],"names":["PedidoService","filters","user","supabase","tiendaActual","query","data","error","pedido","id","tiendaData","pedidoError","items","item","itemsError","cotizacionId","cotizacion","cotizacionError","pedidoItems","pedidoData","pedidoActual","pedidoId","itemsInventario","idsArticulos","articulosExistentes","validacionError","idsExistentes","a","itemsValidos","reservas","userId","pedidoService"],"mappings":"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"}