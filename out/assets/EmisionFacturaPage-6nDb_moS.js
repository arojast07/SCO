import{r as l,j as e,u as Q,s as N}from"./index-Bb3NupjY.js";import{f as d}from"./currency-BmxXlzML.js";import{S as W,T as X}from"./TopBar-BP5RF_Jd.js";function Y({origenData:b,loading:_,onEmitir:f,onGuardarBorrador:w,onCancelar:z}){const[p,m]=l.useState(1),[i,t]=l.useState({origen_tipo:"",origen_id:null,tipo_documento:"FE",moneda:"CRC",tipo_cambio:1,condicion_venta:"contado",medio_pago:"efectivo",fecha_emision:new Date().toISOString().split("T")[0],codigo_actividad:"722001",observaciones:"",cliente_id:0,cliente:null,items:[]}),[n]=l.useState([{id:1,nombre_razon_social:"Empresa Demo S.A.",identificacion:"3-101-123456",correo_principal:"contacto@empresademo.com",telefono:"2222-3333"},{id:2,nombre_razon_social:"Comercial Los Andes Ltda.",identificacion:"3-102-654321",correo_principal:"ventas@losandes.com",telefono:"2555-7777"},{id:3,nombre_razon_social:"Juan P√©rez Rodr√≠guez",identificacion:"1-1234-5678",correo_principal:"juan.perez@email.com",telefono:"8888-9999"}]),[j]=l.useState([{id:1,codigo:"PROD001",descripcion:"Producto Demo 1",precio_venta:15e3,unidad:"UND",tipo:"producto"},{id:2,codigo:"SERV001",descripcion:"Servicio de Consultor√≠a",precio_venta:25e3,unidad:"HORA",tipo:"servicio"},{id:3,codigo:"INV001",descripcion:"Art√≠culo de Inventario",precio_venta:8500,unidad:"UND",tipo:"inventario"}]),[C]=l.useState([{id:1,codigo:"PED-001",fecha_creacion:new Date().toISOString(),total:15e4,cliente:{id:1,nombre_razon_social:"Cliente Demo 1",identificacion:"1-1234-5678"}},{id:2,codigo:"COT-001",fecha_emision:new Date().toISOString(),total:2e5,cliente:{id:2,nombre_razon_social:"Cliente Demo 2",identificacion:"2-2345-6789"}}]),[v,k]=l.useState(""),[F,y]=l.useState(!1),[S,u]=l.useState(!1),[r,c]=l.useState(!1),[g,A]=l.useState({subtotal:0,descuento_total:0,impuesto_total:0,total:0});l.useEffect(()=>{b&&T(b)},[b]),l.useEffect(()=>{$()},[i.items]);const T=s=>{const{tipo:a,data:o}=s;t(x=>({...x,origen_tipo:a,origen_id:o.id,cliente_id:o.cliente_id,cliente:o.cliente||o.clientes,moneda:o.moneda||"CRC",tipo_cambio:o.tipo_cambio||1,items:U(o.items||[])})),m(2)},U=s=>s.map((a,o)=>({id_item:a.item_id||a.producto_id||o,tipo_item:a.item_type||(a.producto_id?"producto":"inventario"),codigo:a.codigo_articulo||a.codigo||"",descripcion:a.descripcion||a.descripcion_producto||"",unidad:a.unidad||"UND",cantidad:a.cantidad||1,precio_unitario:a.precio_unitario||a.precio_unit||0,descuento_porcentaje:a.descuento_porcentaje||0,impuesto_porcentaje:a.impuesto_porcentaje||13,subtotal:0,descuento_monto:0,impuesto_monto:0,total:0,bom_items:a.meta_json?.bom_items||[]})),B=s=>!s||s.length<2?[]:C.filter(a=>a.codigo.toLowerCase().includes(s.toLowerCase())||a.cliente.nombre_razon_social.toLowerCase().includes(s.toLowerCase())),L=s=>{const a={...s,items:[{codigo:"PROD001",descripcion:"Producto Demo 1",cantidad:2,precio_unitario:5e4,unidad:"UND"}]};T({tipo:i.origen_tipo,data:a})},$=()=>{let s=0,a=0,o=0;const x=i.items.map(h=>{const E=h.cantidad*h.precio_unitario,O=E*(h.descuento_porcentaje/100),R=E-O,P=R*(h.impuesto_porcentaje/100),K=R+P;return s+=E,a+=O,o+=P,{...h,subtotal:E,descuento_monto:O,impuesto_monto:P,total:K}});t(h=>({...h,items:x})),A({subtotal:s,descuento_total:a,impuesto_total:o,total:s-a+o})},D=(s,a,o)=>{const x=[...i.items];x[s]={...x[s],[a]:o},t(h=>({...h,items:x}))},q=s=>{t(a=>({...a,items:a.items.filter((o,x)=>x!==s)}))},G=s=>{t(a=>({...a,cliente_id:s.id,cliente:s})),y(!1)},M=s=>{const a={id_item:s.id,tipo_item:s.tipo==="producto"?"producto":"inventario",codigo:s.codigo,descripcion:s.descripcion,unidad:s.unidad||"UND",cantidad:1,precio_unitario:s.precio_venta||0,descuento_porcentaje:0,impuesto_porcentaje:13,subtotal:0,descuento_monto:0,impuesto_monto:0,total:0,bom_items:[]};t(o=>({...o,items:[...o.items,a]})),u(!1)},V=()=>i.cliente_id?i.items.length===0?(alert("Debe agregar al menos un art√≠culo"),!1):i.codigo_actividad?!0:(alert("Debe especificar el c√≥digo de actividad econ√≥mica"),!1):(alert("Debe seleccionar un cliente"),!1),H=async()=>{if(V()){c(!0);try{const s={origen_tipo:i.origen_tipo,origen_id:i.origen_id,tipo_documento:i.tipo_documento,moneda:i.moneda,tipo_cambio:i.tipo_cambio,condicion_venta:i.condicion_venta,medio_pago:i.medio_pago,observaciones:i.observaciones,cliente_id:i.cliente_id,lineas:i.items.map(a=>({id_item:a.id_item,tipo_item:a.tipo_item,descripcion:a.descripcion,unidad:a.unidad,cantidad:a.cantidad,precio_unit:a.precio_unitario,descuento_pct:a.descuento_porcentaje,impuesto_pct:a.impuesto_porcentaje,total:a.total}))};await f(s)}finally{c(!1)}}},J=async()=>{if(!i.cliente_id){alert("Debe seleccionar un cliente");return}const s={...i,estado_local:"borrador"};await w(s)},I=B(v);return e.jsxs("div",{className:"bg-white rounded-lg shadow",children:[e.jsx("div",{className:"px-6 py-4 border-b border-gray-200",children:e.jsx("div",{className:"flex items-center justify-between",children:[{num:1,title:"Selecci√≥n de Origen",icon:"ri-file-search-line"},{num:2,title:"Encabezado de Factura",icon:"ri-file-edit-line"},{num:3,title:"Detalle de Productos",icon:"ri-shopping-cart-line"},{num:4,title:"Confirmaci√≥n",icon:"ri-check-line"}].map((s,a)=>e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:`flex items-center justify-center w-10 h-10 rounded-full border-2 ${p>=s.num?"bg-blue-600 border-blue-600 text-white":"border-gray-300 text-gray-500"}`,children:p>s.num?e.jsx("i",{className:"ri-check-line"}):e.jsx("i",{className:s.icon})}),e.jsx("div",{className:"ml-3 hidden sm:block",children:e.jsx("p",{className:`text-sm font-medium ${p>=s.num?"text-blue-600":"text-gray-500"}`,children:s.title})}),a<3&&e.jsx("div",{className:`hidden sm:block w-16 h-0.5 ml-4 ${p>s.num?"bg-blue-600":"bg-gray-300"}`})]},s.num))})}),e.jsxs("div",{className:"p-6",children:[p===1&&e.jsxs("div",{className:"space-y-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Selecci√≥n de Origen"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Origen del documento *"}),e.jsxs("select",{value:i.origen_tipo,onChange:s=>t(a=>({...a,origen_tipo:s.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0,children:[e.jsx("option",{value:"",children:"Seleccionar origen..."}),e.jsx("option",{value:"pedido",children:"Desde Pedido Confirmado"}),e.jsx("option",{value:"cotizacion",children:"Desde Cotizaci√≥n Aprobada"})]})]}),i.origen_tipo&&e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Buscar ",i.origen_tipo]}),e.jsx("input",{type:"text",value:v,onChange:s=>k(s.target.value),placeholder:"Buscar por c√≥digo o cliente...",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]})]}),I.length>0&&e.jsx("div",{className:"border border-gray-200 rounded-lg",children:e.jsx("div",{className:"max-h-64 overflow-y-auto",children:I.map(s=>e.jsx("div",{onClick:()=>L(s),className:"p-4 border-b border-gray-100 hover:bg-gray-50 cursor-pointer last:border-b-0",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900",children:s.codigo}),e.jsxs("div",{className:"text-sm text-gray-500",children:["Cliente: ",s.cliente?.nombre_razon_social]}),e.jsx("div",{className:"text-sm text-gray-500",children:s.cliente?.identificacion})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-medium text-gray-900",children:d(s.total,"CRC")}),e.jsx("div",{className:"text-sm text-gray-500",children:new Date(s.fecha_emision||s.fecha_creacion).toLocaleDateString()})]})]})},s.id))})}),e.jsx("div",{className:"flex justify-end",children:e.jsxs("button",{onClick:()=>m(2),disabled:!i.origen_id&&!b,className:"px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer whitespace-nowrap",children:["Continuar",e.jsx("i",{className:"ri-arrow-right-line ml-2"})]})})]}),p===2&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Encabezado de Factura"}),e.jsxs("button",{onClick:()=>m(1),className:"text-blue-600 hover:text-blue-800 cursor-pointer",children:[e.jsx("i",{className:"ri-arrow-left-line mr-1"}),"Volver"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Tipo de documento *"}),e.jsxs("select",{value:i.tipo_documento,onChange:s=>t(a=>({...a,tipo_documento:s.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"FE",children:"Factura Electr√≥nica (FE)"}),e.jsx("option",{value:"TE",children:"Tiquete Electr√≥nico (TE)"}),e.jsx("option",{value:"NC",children:"Nota de Cr√©dito (NC)"}),e.jsx("option",{value:"ND",children:"Nota de D√©bito (ND)"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Moneda"}),e.jsxs("select",{value:i.moneda,onChange:s=>t(a=>({...a,moneda:s.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"CRC",children:"Colones (CRC)"}),e.jsx("option",{value:"USD",children:"D√≥lares (USD)"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Tipo de cambio"}),e.jsx("input",{type:"number",step:"0.01",value:i.tipo_cambio,onChange:s=>t(a=>({...a,tipo_cambio:parseFloat(s.target.value)||1})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Condici√≥n de venta *"}),e.jsxs("select",{value:i.condicion_venta,onChange:s=>t(a=>({...a,condicion_venta:s.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"contado",children:"Contado"}),e.jsx("option",{value:"credito",children:"Cr√©dito"}),e.jsx("option",{value:"apartado",children:"Apartado"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Medio de pago *"}),e.jsxs("select",{value:i.medio_pago,onChange:s=>t(a=>({...a,medio_pago:s.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"efectivo",children:"Efectivo"}),e.jsx("option",{value:"transferencia",children:"Transferencia"}),e.jsx("option",{value:"tarjeta",children:"Tarjeta"}),e.jsx("option",{value:"cheque",children:"Cheque"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Fecha de emisi√≥n *"}),e.jsx("input",{type:"date",value:i.fecha_emision,onChange:s=>t(a=>({...a,fecha_emision:s.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"C√≥digo actividad econ√≥mica *"}),e.jsx("input",{type:"text",value:i.codigo_actividad,onChange:s=>t(a=>({...a,codigo_actividad:s.target.value})),placeholder:"Ej: 722001",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Cliente *"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("div",{className:"flex-1 p-3 border border-gray-300 rounded-lg bg-gray-50",children:i.cliente?e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:i.cliente.nombre_razon_social}),e.jsx("div",{className:"text-sm text-gray-500",children:i.cliente.identificacion}),e.jsx("div",{className:"text-sm text-gray-500",children:i.cliente.correo_principal})]}):e.jsx("span",{className:"text-gray-500",children:"Seleccionar cliente"})}),e.jsx("button",{type:"button",onClick:()=>y(!0),className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 cursor-pointer",children:e.jsx("i",{className:"ri-search-line"})})]})]}),F&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-md",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Seleccionar Cliente"}),e.jsx("button",{onClick:()=>y(!1),className:"text-gray-500 hover:text-gray-700 cursor-pointer",children:e.jsx("i",{className:"ri-close-line text-xl"})})]}),e.jsx("div",{className:"space-y-2",children:n.map(s=>e.jsxs("div",{onClick:()=>G(s),className:"p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer",children:[e.jsx("div",{className:"font-medium",children:s.nombre_razon_social}),e.jsx("div",{className:"text-sm text-gray-500",children:s.identificacion}),e.jsx("div",{className:"text-sm text-gray-500",children:s.correo_principal})]},s.id))})]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Observaciones"}),e.jsx("textarea",{value:i.observaciones,onChange:s=>t(a=>({...a,observaciones:s.target.value})),rows:3,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"Observaciones adicionales..."})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("button",{onClick:()=>m(1),className:"px-6 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 cursor-pointer whitespace-nowrap",children:[e.jsx("i",{className:"ri-arrow-left-line mr-2"}),"Anterior"]}),e.jsxs("button",{onClick:()=>m(3),className:"px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 cursor-pointer whitespace-nowrap",children:["Continuar",e.jsx("i",{className:"ri-arrow-right-line ml-2"})]})]})]}),p===3&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Detalle de Productos/Servicios"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>m(2),className:"text-blue-600 hover:text-blue-800 cursor-pointer",children:[e.jsx("i",{className:"ri-arrow-left-line mr-1"}),"Volver"]}),e.jsxs("button",{onClick:()=>u(!0),className:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 cursor-pointer",children:[e.jsx("i",{className:"ri-add-line mr-2"}),"Agregar"]})]})]}),S&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-md",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Seleccionar Producto"}),e.jsx("button",{onClick:()=>u(!1),className:"text-gray-500 hover:text-gray-700 cursor-pointer",children:e.jsx("i",{className:"ri-close-line text-xl"})})]}),e.jsx("div",{className:"space-y-2",children:j.map(s=>e.jsxs("div",{onClick:()=>M(s),className:"p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer",children:[e.jsx("div",{className:"font-medium",children:s.descripcion}),e.jsxs("div",{className:"text-sm text-gray-500",children:["C√≥digo: ",s.codigo]}),e.jsxs("div",{className:"text-sm text-gray-500",children:["Precio: ",d(s.precio_venta,"CRC")]})]},s.id))})]})}),i.items.length===0?e.jsxs("div",{className:"text-center py-12 text-gray-500",children:[e.jsx("i",{className:"ri-shopping-cart-line text-4xl mb-4"}),e.jsx("p",{className:"text-lg font-medium",children:"No hay productos agregados"}),e.jsx("p",{children:'Use el bot√≥n "Agregar" para a√±adir productos o servicios'})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"C√≥digo"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Descripci√≥n"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Unidad"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Cantidad"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Precio Unit."}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Desc. %"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Imp. %"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Total"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Acciones"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:i.items.map((s,a)=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:s.codigo}),e.jsx("td",{className:"px-6 py-4 text-sm text-gray-900",children:e.jsxs("div",{className:"max-w-xs",children:[e.jsx("div",{className:"font-medium",children:s.descripcion}),s.bom_items&&s.bom_items.length>0&&e.jsx("div",{className:"mt-2 text-xs text-gray-500",children:e.jsxs("details",{className:"cursor-pointer",children:[e.jsxs("summary",{className:"font-medium",children:["√çtems utilizados (",s.bom_items.length,")"]}),e.jsx("div",{className:"mt-1 pl-4 border-l-2 border-blue-200",children:s.bom_items.map((o,x)=>e.jsxs("div",{className:"py-1",children:[e.jsx("span",{className:"font-medium",children:o.descripcion}),e.jsxs("span",{className:"ml-2 text-gray-400",children:[o.cantidad_total," ",o.unidad]})]},x))})]})})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:s.unidad}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("input",{type:"number",step:"0.001",value:s.cantidad,onChange:o=>D(a,"cantidad",parseFloat(o.target.value)||0),className:"w-20 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("input",{type:"number",step:"0.01",value:s.precio_unitario,onChange:o=>D(a,"precio_unitario",parseFloat(o.target.value)||0),className:"w-24 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("input",{type:"number",step:"0.01",value:s.descuento_porcentaje,onChange:o=>D(a,"descuento_porcentaje",parseFloat(o.target.value)||0),className:"w-16 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("input",{type:"number",step:"0.01",value:s.impuesto_porcentaje,onChange:o=>D(a,"impuesto_porcentaje",parseFloat(o.target.value)||0),className:"w-16 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900",children:d(s.total,i.moneda)}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("button",{onClick:()=>q(a),className:"text-red-600 hover:text-red-800 p-1 hover:bg-red-50 rounded cursor-pointer",children:e.jsx("i",{className:"ri-delete-bin-line"})})})]},a))})]})}),i.items.length>0&&e.jsx("div",{className:"border-t pt-6",children:e.jsxs("div",{className:"max-w-md ml-auto space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Subtotal:"}),e.jsx("span",{children:d(g.subtotal,i.moneda)})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Descuentos:"}),e.jsxs("span",{children:["-",d(g.descuento_total,i.moneda)]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Impuestos:"}),e.jsx("span",{children:d(g.impuesto_total,i.moneda)})]}),e.jsxs("div",{className:"flex justify-between text-lg font-semibold border-t pt-2",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{children:d(g.total,i.moneda)})]})]})}),e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("button",{onClick:()=>m(2),className:"px-6 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 cursor-pointer whitespace-nowrap",children:[e.jsx("i",{className:"ri-arrow-left-line mr-2"}),"Anterior"]}),e.jsxs("button",{onClick:()=>m(4),disabled:i.items.length===0,className:"px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer whitespace-nowrap",children:["Continuar",e.jsx("i",{className:"ri-arrow-right-line ml-2"})]})]})]}),p===4&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Confirmaci√≥n y Emisi√≥n"}),e.jsxs("button",{onClick:()=>m(3),className:"text-blue-600 hover:text-blue-800 cursor-pointer",children:[e.jsx("i",{className:"ri-arrow-left-line mr-1"}),"Volver"]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"bg-gray-50 rounded-lg p-6",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"Informaci√≥n General"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Tipo de documento:"}),e.jsx("span",{className:"font-medium",children:i.tipo_documento})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Cliente:"}),e.jsx("span",{className:"font-medium",children:i.cliente?.nombre_razon_social})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Moneda:"}),e.jsx("span",{className:"font-medium",children:i.moneda})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Condici√≥n de venta:"}),e.jsx("span",{className:"font-medium",children:i.condicion_venta})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Medio de pago:"}),e.jsx("span",{className:"font-medium",children:i.medio_pago})]})]})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-6",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"Totales"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Subtotal:"}),e.jsx("span",{children:d(g.subtotal,i.moneda)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Descuentos:"}),e.jsxs("span",{children:["-",d(g.descuento_total,i.moneda)]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Impuestos:"}),e.jsx("span",{children:d(g.impuesto_total,i.moneda)})]}),e.jsxs("div",{className:"flex justify-between text-lg font-semibold border-t pt-3",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{children:d(g.total,i.moneda)})]})]})]})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-6",children:[e.jsxs("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:["Productos/Servicios (",i.items.length,")"]}),e.jsx("div",{className:"space-y-2",children:i.items.map((s,a)=>e.jsxs("div",{className:"flex justify-between items-center py-2 border-b border-gray-200 last:border-b-0",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:s.descripcion}),e.jsxs("span",{className:"text-gray-500 ml-2",children:["(",s.codigo,")"]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-medium",children:d(s.total,i.moneda)}),e.jsxs("div",{className:"text-sm text-gray-500",children:[s.cantidad," √ó ",d(s.precio_unitario,i.moneda)]})]})]},a))})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("button",{onClick:()=>m(3),className:"px-6 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 cursor-pointer whitespace-nowrap",children:[e.jsx("i",{className:"ri-arrow-left-line mr-2"}),"Anterior"]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("button",{onClick:J,disabled:_,className:"px-6 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 cursor-pointer whitespace-nowrap",children:[e.jsx("i",{className:"ri-save-line mr-2"}),"Guardar Borrador"]}),e.jsx("button",{onClick:H,disabled:_||r,className:"px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer whitespace-nowrap",children:r?e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"ri-loader-4-line animate-spin mr-2"}),"Firmando y enviando a Hacienda..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"ri-send-plane-line mr-2"}),"Emitir Factura"]})})]})]})]})]})]})}function ae(){const b=Q(),[_,f]=l.useState(!1),[w,z]=l.useState(!1),p=async t=>{f(!0);try{console.log("üì§ Emitiendo factura a Hacienda:",t);const{data:n,error:j}=await N.functions.invoke("facturar-pedido",{body:{pedido_id:t.pedido_id,tipo_documento:t.tipo_documento||"01",condicion_venta:t.condicion_venta||"01",medio_pago:t.medio_pago||"01",plazo_credito:t.plazo_credito||0,items:t.items,notas:t.notas}});if(j)throw console.error("‚ùå Error en Edge Function:",j),new Error(j.message||"Error al emitir factura");console.log("‚úÖ Factura emitida exitosamente:",n),alert(`‚úÖ Factura emitida exitosamente

Clave: ${n.clave}
Consecutivo: ${n.consecutivo}
Estado: ${n.estado}

La factura ha sido enviada a Hacienda y est√° siendo procesada.`),b("/facturacion")}catch(n){console.error("‚ùå Error en emisi√≥n:",n),alert(`‚ùå Error al emitir factura:

${n.message}`)}finally{f(!1)}},m=async t=>{f(!0);try{console.log("üíæ Guardando borrador de factura:",t);const{data:{user:n}}=await N.auth.getUser();if(!n)throw new Error("Usuario no autenticado");const{data:j}=await N.from("usuario_tienda_actual").select("tienda_id").eq("usuario_id",n.id).single();if(!j)throw new Error("No hay tienda asignada");const C=t.items.reduce((u,r)=>u+r.cantidad*r.precio_unitario,0),v=t.items.reduce((u,r)=>u+r.cantidad*r.precio_unitario*(r.descuento_porcentaje||0)/100,0),k=t.items.reduce((u,r)=>{const c=r.cantidad*r.precio_unitario,g=c*(r.descuento_porcentaje||0)/100;return u+(c-g)*(r.impuesto_porcentaje||13)/100},0),F=C-v+k,{data:y,error:S}=await N.from("facturas_electronicas").insert({pedido_id:t.pedido_id,tipo_documento:t.tipo_documento||"01",consecutivo:`BORRADOR-${Date.now()}`,clave:"",fecha_emision:new Date().toISOString(),condicion_venta:t.condicion_venta||"01",medio_pago:t.medio_pago||"01",plazo_credito:t.plazo_credito||0,moneda:t.moneda||"CRC",tipo_cambio:t.tipo_cambio||1,subtotal:C,descuento:v,impuesto:k,total:F,estado:"borrador",notas:t.notas,tienda_id:j.tienda_id,created_by:n.id}).select().single();if(S)throw S;if(t.items&&t.items.length>0){const u=t.items.map(c=>({factura_id:y.id,item_type:c.item_type||"producto",item_id:c.item_id,descripcion:c.descripcion,unidad:c.unidad||"UND",cantidad:c.cantidad,precio_unitario:c.precio_unitario,descuento_porcentaje:c.descuento_porcentaje||0,impuesto_porcentaje:c.impuesto_porcentaje||13,total:c.total})),{error:r}=await N.from("factura_items").insert(u);if(r)throw r}console.log("‚úÖ Borrador guardado:",y),alert("‚úÖ Borrador guardado exitosamente"),b("/facturacion")}catch(n){console.error("‚ùå Error guardando borrador:",n),alert(`‚ùå Error al guardar borrador:

${n.message}`)}finally{f(!1)}},i=()=>{confirm("¬øEst√° seguro que desea cancelar? Se perder√°n los datos ingresados.")&&b("/facturacion")};return e.jsxs("div",{className:"flex h-screen bg-gray-50",children:[e.jsx(W,{isOpen:w,onClose:()=>z(!1)}),e.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden",children:[e.jsx(X,{onMenuClick:()=>z(!w)}),e.jsx("main",{className:"flex-1 overflow-y-auto",children:e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[e.jsx("div",{className:"mb-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Emisi√≥n de Factura"}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Cree una nueva factura electr√≥nica desde cero o basada en un pedido/cotizaci√≥n"})]}),e.jsxs("button",{onClick:i,className:"px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 cursor-pointer whitespace-nowrap",children:[e.jsx("i",{className:"ri-close-line mr-2"}),"Cancelar"]})]})}),e.jsx(Y,{loading:_,onEmitir:p,onGuardarBorrador:m,onCancelar:i})]})})]})]})}export{ae as default};
//# sourceMappingURL=EmisionFacturaPage-6nDb_moS.js.map
