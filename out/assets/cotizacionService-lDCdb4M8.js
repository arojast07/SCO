import{s as c}from"./index-Bb3NupjY.js";class T{static async obtenerTiendaActual(){try{const{data:{user:o}}=await c.auth.getUser();if(!o)return console.error("‚ùå [COTIZACI√ìN SERVICE] No hay usuario autenticado"),null;const{data:t,error:a}=await c.from("usuario_tienda_actual").select("tienda_id").eq("usuario_id",o.id).single();return a?(console.error("‚ùå [COTIZACI√ìN SERVICE] Error obteniendo tienda actual:",a),null):(console.log("‚úÖ [COTIZACI√ìN SERVICE] Tienda actual obtenida:",t?.tienda_id),t?.tienda_id||null)}catch(o){return console.error("‚ùå [COTIZACI√ìN SERVICE] Error obteniendo tienda actual:",o),null}}static async obtenerTipoCambioBCCR(){try{console.log("üí± [COTIZACI√ìN SERVICE] Obteniendo tipo de cambio del BCCR...");try{if((await fetch("https://gee.bccr.fi.cr/indicadoreseconomicos/Cuadros/frmVerCatCuadro.aspx?idioma=1&CodCuadro=%20400")).ok)return console.log("‚úÖ [COTIZACI√ìN SERVICE] Tipo de cambio obtenido del BCCR"),540}catch{console.warn("‚ö†Ô∏è [COTIZACI√ìN SERVICE] No se pudo conectar con BCCR, usando valor por defecto")}const o=540;return console.log("üí± [COTIZACI√ìN SERVICE] Usando tipo de cambio por defecto:",o),o}catch(o){return console.error("‚ùå [COTIZACI√ìN SERVICE] Error obteniendo tipo de cambio:",o),540}}static async obtenerCotizaciones(o){try{console.log("üìã [COTIZACI√ìN SERVICE] Obteniendo cotizaciones...",o);let t=c.from("cotizaciones").select(`
          *,
          clientes (
            id,
            nombre_razon_social,
            identificacion,
            correo_principal,
            telefono_numero
          )
        `).order("created_at",{ascending:!1});o?.cliente_id&&(t=t.eq("cliente_id",o.cliente_id)),o?.estado&&(t=t.eq("estado",o.estado)),o?.moneda&&(t=t.eq("moneda",o.moneda)),o?.fecha_desde&&(t=t.gte("fecha_emision",o.fecha_desde)),o?.fecha_hasta&&(t=t.lte("fecha_emision",o.fecha_hasta));const{data:a,error:s}=await t;if(s)throw s;if(console.log("‚úÖ [COTIZACI√ìN SERVICE] Cotizaciones obtenidas:",a?.length||0),a&&a.length>0){const n=a.filter(r=>r.metadata);console.log("üîç [METADATA CHECK] Cotizaciones con metadata:",n.length),n.forEach(r=>{console.log("üîç [METADATA CHECK] Cotizaci√≥n:",{id:r.id,codigo:r.codigo,metadata_tipo:r.metadata?.tipo,metadata_completa:r.metadata})})}return a||[]}catch(t){throw console.error("‚ùå [COTIZACI√ìN SERVICE] Error obteniendo cotizaciones:",t),t}}static async obtenerCotizacionPorId(o){try{console.log("üìã [COTIZACI√ìN SERVICE] Obteniendo cotizaci√≥n ID:",o);const{data:t,error:a}=await c.from("cotizaciones").select(`
          *,
          clientes (
            id,
            nombre_razon_social,
            identificacion,
            correo_principal,
            telefono_numero,
            otras_senas
          )
        `).eq("id",o).single();if(a)throw a;return console.log("‚úÖ [COTIZACI√ìN SERVICE] Cotizaci√≥n obtenida:",t),t}catch(t){throw console.error("‚ùå [COTIZACI√ìN SERVICE] Error obteniendo cotizaci√≥n:",t),t}}static async actualizarCotizacion(o,t){try{console.log("üìã [COTIZACI√ìN SERVICE] Actualizando cotizaci√≥n ID:",o);const a={cliente_id:parseInt(t.cliente_id),estado:t.estado,fecha_emision:t.fecha_emision,fecha_vencimiento:t.fecha_vencimiento,moneda:t.moneda,tipo_cambio:this.formatNumericValue(t.tipo_cambio,"exchange"),descuento_global:this.formatNumericValue(t.descuento_global||0,"percentage"),descuento_valor:this.formatNumericValue(t.descuento_valor||0,"currency"),impuestos:this.formatNumericValue(t.impuestos,"tax"),flete:this.formatNumericValue(t.flete||0,"currency"),otros:this.formatNumericValue(t.otros||0,"currency"),subtotal:this.formatNumericValue(t.subtotal,"currency"),total:this.formatNumericValue(t.total,"currency"),updated_at:new Date().toISOString()},{data:s,error:n}=await c.from("cotizaciones").update(a).eq("id",o).select().single();if(n)throw n;if(t.items&&t.items.length>0){await c.from("cotizacion_items").delete().eq("cotizacion_id",o);const r=t.items.map(d=>({cotizacion_id:o,producto_id:d.producto_id,tipo_item:d.tipo_item||"normal",descripcion:d.descripcion,cantidad:this.formatNumericValue(d.cantidad,"quantity"),precio_unitario:this.formatNumericValue(d.precio_unitario,"quantity"),descuento:this.formatNumericValue(d.descuento||0,"item_discount"),subtotal:this.formatNumericValue(d.subtotal,"quantity")}));await c.from("cotizacion_items").insert(r)}return console.log("‚úÖ [COTIZACI√ìN SERVICE] Cotizaci√≥n actualizada"),s}catch(a){throw console.error("‚ùå [COTIZACI√ìN SERVICE] Error actualizando cotizaci√≥n:",a),a}}static async eliminarCotizacion(o){try{console.log("üìã [COTIZACI√ìN SERVICE] Eliminando cotizaci√≥n ID:",o),await c.from("cotizacion_items").delete().eq("cotizacion_id",o);const{error:t}=await c.from("cotizaciones").delete().eq("id",o);if(t)throw t;console.log("‚úÖ [COTIZACI√ìN SERVICE] Cotizaci√≥n eliminada")}catch(t){throw console.error("‚ùå [COTIZACI√ìN SERVICE] Error eliminando cotizaci√≥n:",t),t}}static async duplicarCotizacion(o){try{console.log("üìã [COTIZACI√ìN SERVICE] Duplicando cotizaci√≥n ID:",o);const{data:t,error:a}=await c.from("cotizaciones").select("*").eq("id",o).single();if(a)throw a;const{data:s,error:n}=await c.from("cotizacion_items").select("*").eq("cotizacion_id",o);if(n)throw n;const d=`COT-${Date.now().toString().slice(-8)}`,p={...t,id:void 0,codigo:d,estado:"borrador",created_at:new Date().toISOString(),updated_at:new Date().toISOString()},{data:m,error:u}=await c.from("cotizaciones").insert(p).select().single();if(u)throw u;if(s&&s.length>0){const C=s.map(l=>({...l,id:void 0,cotizacion_id:m.id}));await c.from("cotizacion_items").insert(C)}return console.log("‚úÖ [COTIZACI√ìN SERVICE] Cotizaci√≥n duplicada"),m}catch(t){throw console.error("‚ùå [COTIZACI√ìN SERVICE] Error duplicando cotizaci√≥n:",t),t}}static async cambiarEstado(o,t){try{console.log("üìã [COTIZACI√ìN SERVICE] Cambiando estado de cotizaci√≥n ID:",o,"a",t);const{data:a,error:s}=await c.from("cotizaciones").update({estado:t,updated_at:new Date().toISOString()}).eq("id",o).select().single();if(s)throw s;return console.log("‚úÖ [COTIZACI√ìN SERVICE] Estado cambiado"),a}catch(a){throw console.error("‚ùå [COTIZACI√ìN SERVICE] Error cambiando estado:",a),a}}static async crearCotizacion(o){try{console.log("üìã [COTIZACI√ìN SERVICE] Creando cotizaci√≥n...",{tiene_metadata:!!o.metadata,tipo:o.metadata?.tipo,items_optimizador_count:o.items_optimizador?.length||0,items_inventario_count:o.items_inventario?.length||0,items_count:o.items?.length||0});const t=await this.obtenerTiendaActual();if(!t)throw new Error("No tienes una tienda activa asignada. Por favor, selecciona una tienda antes de crear la cotizaci√≥n.");console.log("üè™ [COTIZACI√ìN SERVICE] Usando tienda_id:",t),o.metadata&&console.log("üîç [OPT_QUOTE_DEBUG] Metadata recibida:",{tipo:o.metadata.tipo,proyecto_id:o.metadata.proyecto_id,margen_utilidad:o.metadata.margen_utilidad});const n={codigo:`COT-${Date.now().toString().slice(-8)}`,tienda_id:t,cliente_id:parseInt(o.cliente_id),estado:o.estado,fecha_emision:o.fecha_emision,fecha_vencimiento:o.fecha_vencimiento,moneda:o.moneda,tipo_cambio:this.formatNumericValue(o.tipo_cambio,"exchange"),descuento_global:this.formatNumericValue(o.descuento_global||0,"percentage"),descuento_valor:this.formatNumericValue(o.descuento_valor||0,"currency"),impuestos:this.formatNumericValue(o.impuestos,"tax"),flete:this.formatNumericValue(o.flete||0,"currency"),otros:this.formatNumericValue(o.otros||0,"currency"),subtotal:this.formatNumericValue(o.subtotal,"currency"),total:this.formatNumericValue(o.total,"currency"),metadata:o.metadata||null,created_at:new Date().toISOString()};console.log("üíæ [COTIZACI√ìN SERVICE] Guardando cotizaci√≥n con metadata:",{tiene_metadata:!!n.metadata,metadata_tipo:n.metadata?.tipo,tienda_id:n.tienda_id});const{data:r,error:d}=await c.from("cotizaciones").insert(n).select().single();if(d)throw d;console.log("‚úÖ [COTIZACI√ìN SERVICE] Cotizaci√≥n creada:",{id:r.id,codigo:r.codigo,tiene_metadata:!!r.metadata,metadata_tipo:r.metadata?.tipo});const p=o.items_optimizador||[],m=o.items_inventario||[],u=o.items||[],C=p.length+m.length+u.length;if(C>0){console.log("üì¶ [COTIZACI√ìN SERVICE] Procesando items...",{items_optimizador:p.length,items_inventario:m.length,items_tradicionales:u.length,total:C});const l=[];if(p.length>0&&(console.log("üéØ [OPT_QUOTE_SAVE] Procesando items del OPTIMIZADOR"),p.forEach((e,_)=>{const i=[];e.tapacanto_superior&&i.push(`Sup: ${e.tapacanto_superior}`),e.tapacanto_inferior&&i.push(`Inf: ${e.tapacanto_inferior}`),e.tapacanto_izquierdo&&i.push(`Izq: ${e.tapacanto_izquierdo}`),e.tapacanto_derecho&&i.push(`Der: ${e.tapacanto_derecho}`);const h=i.length>0?i.join(", "):"Sin tapacantos",f=e.material_codigo&&e.material_nombre?`${e.material_codigo} - ${e.material_nombre}`:e.material_codigo||e.material_nombre||"Sin especificar",g=e.largo&&e.ancho?`${e.largo} √ó ${e.ancho} mm`:"-";console.log(`üîç [CNC SAVE] Item ${_+1} "${e.descripcion}":`,{cnc1_codigo:e.cnc1_codigo,cnc1_cantidad:e.cnc1_cantidad,cnc2_codigo:e.cnc2_codigo,cnc2_cantidad:e.cnc2_cantidad,costo_cnc:e.costo_cnc});const E={cotizacion_id:r.id,producto_id:null,tipo_item:"optimizador",descripcion:e.descripcion||`Pieza ${_+1}`,dimensiones:g,material:f,tapacantos:h,cnc1:"",cnc2:"",cantidad:this.formatNumericValue(e.cantidad,"quantity"),precio_unitario:this.formatNumericValue(e.precio_unitario,"quantity"),descuento:this.formatNumericValue(e.descuento||0,"item_discount"),subtotal:this.formatNumericValue(e.subtotal,"quantity"),datos_optimizador:{descripcion:e.descripcion,largo:e.largo,ancho:e.ancho,material_codigo:e.material_codigo,material_nombre:e.material_nombre,veta:e.veta,tapacanto_superior:e.tapacanto_superior,tapacanto_inferior:e.tapacanto_inferior,tapacanto_izquierdo:e.tapacanto_izquierdo,tapacanto_derecho:e.tapacanto_derecho,cnc1_codigo:e.cnc1_codigo||"",cnc1_cantidad:e.cnc1_cantidad||0,cnc2_codigo:e.cnc2_codigo||"",cnc2_cantidad:e.cnc2_cantidad||0,costo_material:e.costo_material||0,costo_tapacantos:e.costo_tapacantos||0,costo_cnc:e.costo_cnc||0,costo_total:e.costo_total||0}};l.push(E)})),m.length>0&&(console.log("üì¶ [INVENTORY_ITEMS] Procesando items del INVENTARIO"),m.forEach(e=>{const _={cotizacion_id:r.id,producto_id:e.inventario_id||null,tipo_item:"optimizador",descripcion:`${e.codigo} - ${e.descripcion}`,dimensiones:null,material:null,tapacantos:null,cnc1:null,cnc2:null,cantidad:this.formatNumericValue(e.cantidad,"quantity"),precio_unitario:this.formatNumericValue(e.precio_unitario,"quantity"),descuento:this.formatNumericValue(e.descuento||0,"item_discount"),subtotal:this.formatNumericValue(e.subtotal,"quantity"),datos_optimizador:null};l.push(_)})),u.length>0){console.log("üìù [COTIZACI√ìN] Procesando items TRADICIONALES");const e=u.map(i=>i.producto_id).filter(i=>i);let _=[];if(e.length>0){const{data:i}=await c.from("productos").select("id_producto, descripcion_producto").in("id_producto",e);_=i||[]}u.forEach(i=>{const h=_.find(g=>g.id_producto===i.producto_id),f={cotizacion_id:r.id,producto_id:i.producto_id,tipo_item:"normal",descripcion:h?.descripcion_producto||`Producto ID: ${i.producto_id}`,dimensiones:null,material:null,tapacantos:null,cnc1:null,cnc2:null,cantidad:this.formatNumericValue(i.cantidad,"quantity"),precio_unitario:this.formatNumericValue(i.precio_unitario,"quantity"),descuento:this.formatNumericValue(i.descuento||0,"item_discount"),subtotal:this.formatNumericValue(i.subtotal,"quantity"),datos_optimizador:null};l.push(f)})}console.log("üíæ [COTIZACI√ìN SERVICE] Guardando items en BD...",{total_items:l.length,items_optimizador:l.filter(e=>e.tipo_item==="optimizador").length,items_inventario:l.filter(e=>e.tipo_item==="inventario").length,items_normales:l.filter(e=>e.tipo_item==="normal").length});const{error:I}=await c.from("cotizacion_items").insert(l);if(I)throw console.error("‚ùå [COTIZACI√ìN SERVICE] Error guardando items:",I),I;console.log("‚úÖ [COTIZACI√ìN SERVICE] Items guardados correctamente")}return r}catch(t){throw console.error("‚ùå [COTIZACI√ìN SERVICE] Error creando cotizaci√≥n:",t),t}}static formatNumericValue(o,t){if(o==null||o==="")return 0;const a=parseFloat(o);if(isNaN(a))return console.warn(`‚ö†Ô∏è [COTIZACI√ìN SERVICE] Valor num√©rico inv√°lido para tipo ${t}:`,o),0;switch(t){case"exchange":case"percentage":case"tax":return Math.min(Math.max(a,0),999.99);case"currency":case"quantity":case"item_discount":return Math.min(Math.max(a,0),999999.99);default:return Math.min(Math.max(a,0),999999.99)}}}export{T as C};
//# sourceMappingURL=cotizacionService-lDCdb4M8.js.map
