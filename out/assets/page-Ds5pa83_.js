import{r as x,j as e,s as y}from"./index-Xz42BvxI.js";import{S as K,T as H}from"./TopBar-BLe2nnBZ.js";import{M as X}from"./MobileNav-CVw3BIlq.js";import{u as O,w as U}from"./xlsx-BojT3SgY.js";function Q({children:l,vistaActual:f,onCambiarVista:k}){const[L,D]=x.useState(!1);return e.jsxs("div",{className:"min-h-screen bg-gray-50 flex",children:[e.jsx(K,{isOpen:L,onClose:()=>D(!1)}),e.jsxs("div",{className:"flex-1 flex flex-col min-w-0",children:[e.jsx(H,{onMenuClick:()=>D(!0)}),e.jsx("div",{className:"bg-white border-b border-gray-200 px-4 lg:px-6",children:e.jsxs("nav",{className:"flex space-x-8 overflow-x-auto",children:[e.jsxs("button",{onClick:()=>k("umbrales"),className:`py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap ${f==="umbrales"?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"}`,children:[e.jsx("i",{className:"ri-dashboard-line mr-2"}),"Umbrales de Stock"]}),e.jsxs("button",{onClick:()=>k("alertas"),className:`py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap ${f==="alertas"?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"}`,children:[e.jsx("i",{className:"ri-alarm-warning-line mr-2"}),"Alertas"]}),e.jsxs("button",{onClick:()=>k("reabastecimiento"),className:`py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap ${f==="reabastecimiento"?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"}`,children:[e.jsx("i",{className:"ri-truck-line mr-2"}),"Reabastecimiento"]}),e.jsxs("button",{onClick:()=>k("kpis"),className:`py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap ${f==="kpis"?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"}`,children:[e.jsx("i",{className:"ri-bar-chart-line mr-2"}),"Dashboard KPIs"]}),e.jsxs("button",{onClick:()=>k("prediccion"),className:`py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap ${f==="prediccion"?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"}`,children:[e.jsx("i",{className:"ri-brain-line mr-2"}),"Predicci√≥n IA"]}),e.jsxs("button",{onClick:()=>k("configuracion"),className:`py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap ${f==="configuracion"?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"}`,children:[e.jsx("i",{className:"ri-settings-line mr-2"}),"Configuraci√≥n"]})]})}),e.jsx("main",{className:"flex-1 p-4 lg:p-6 pb-20 lg:pb-6 overflow-auto",children:e.jsx("div",{className:"max-w-7xl mx-auto",children:l})})]}),e.jsx(X,{})]})}function W({threshold:l,onClose:f,onSuccess:k}){const[L,D]=x.useState(!1),[F,I]=x.useState([]),[$,h]=x.useState(""),[q,b]=x.useState(!1),[v,C]=x.useState(null),[N,S]=x.useState({articulo_id:"",min_qty:0,max_qty:0,safety_stock:0,lead_time_dias:7,lote_minimo:1,activo:!0});x.useEffect(()=>{l?(S({articulo_id:l.articulo_id||"",min_qty:l.min_qty||0,max_qty:l.max_qty||0,safety_stock:l.safety_stock||0,lead_time_dias:l.lead_time_dias||7,lote_minimo:l.lote_minimo||1,activo:l.activo!==!1}),l.inventario&&(C(l.inventario),h(l.inventario.descripcion_articulo))):c()},[l]);const c=async()=>{try{const{data:n}=await y.from("inventario_thresholds").select("articulo_id").eq("activo",!0),w=n?.map(E=>E.articulo_id)||[];let _=y.from("inventario").select("id_articulo, codigo_articulo, descripcion_articulo, categoria_id").eq("activo",!0).order("descripcion_articulo");w.length>0&&(_=_.not("id_articulo","in",`(${w.join(",")})`));const{data:T,error:M}=await _;if(M)throw M;I(T||[])}catch(n){console.error("Error cargando art√≠culos disponibles:",n)}},t=n=>{if(h(n),n.length===0){b(!1),C(null),S(_=>({..._,articulo_id:""}));return}const w=F.filter(_=>_.descripcion_articulo.toLowerCase().includes(n.toLowerCase())||_.codigo_articulo.toLowerCase().includes(n.toLowerCase()));b(w.length>0&&n.length>0)},o=n=>{C(n),h(n.descripcion_articulo),b(!1),S(w=>({...w,articulo_id:n.id_articulo}))},a=async n=>{if(n.preventDefault(),!l&&!N.articulo_id){alert("Por favor seleccione un art√≠culo");return}if(N.min_qty<=0){alert("La cantidad m√≠nima debe ser mayor a 0");return}if(N.max_qty<=N.min_qty){alert("La cantidad m√°xima debe ser mayor a la m√≠nima");return}if(N.safety_stock<0){alert("El stock de seguridad no puede ser negativo");return}if(N.lead_time_dias<=0){alert("El tiempo de entrega debe ser mayor a 0");return}if(N.lote_minimo<=0){alert("El lote m√≠nimo debe ser mayor a 0");return}D(!0);try{l?await u():await d()}catch(w){console.error("Error en submit:",w)}finally{D(!1)}},d=async()=>{try{const{error:n}=await y.from("inventario_thresholds").insert({...N,created_at:new Date().toISOString()});if(n)throw n;k()}catch(n){console.error("Error creando threshold:",n),alert("Error al crear la configuraci√≥n de umbral")}},u=async()=>{try{const{error:n}=await y.from("inventario_thresholds").update({...N,updated_at:new Date().toISOString()}).eq("id",l.id);if(n)throw n;k()}catch(n){console.error("Error actualizando threshold:",n),alert("Error al actualizar la configuraci√≥n")}},s=(n,w)=>{S(_=>({..._,[n]:w}))},m=F.filter(n=>n.descripcion_articulo.toLowerCase().includes($.toLowerCase())||n.codigo_articulo.toLowerCase().includes($.toLowerCase()));return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:l?"Editar Umbral de Stock":"Nuevo Umbral de Stock"}),e.jsx("button",{onClick:f,className:"text-gray-400 hover:text-gray-600 cursor-pointer",children:e.jsx("i",{className:"ri-close-line text-2xl"})})]}),e.jsx("div",{className:"p-6",children:e.jsxs("form",{onSubmit:a,className:"space-y-6",children:[!l&&e.jsxs("div",{className:"relative",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Art√≠culo *"}),e.jsx("input",{type:"text",value:$,onChange:n=>t(n.target.value),placeholder:"Buscar art√≠culo por c√≥digo o descripci√≥n...",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0}),q&&m.length>0&&e.jsx("div",{className:"absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto",children:m.map(n=>e.jsxs("div",{onClick:()=>o(n),className:"px-3 py-2 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-b-0",children:[e.jsx("div",{className:"font-medium",children:n.descripcion_articulo}),e.jsxs("div",{className:"text-sm text-gray-500",children:["C√≥digo: ",n.codigo_articulo]})]},n.id_articulo))}),v&&e.jsxs("div",{className:"mt-2 p-2 bg-green-50 border border-green-200 rounded text-sm",children:[e.jsx("i",{className:"ri-check-line text-green-600 mr-1"}),"Art√≠culo seleccionado: ",e.jsx("strong",{children:v.descripcion_articulo}),e.jsxs("div",{className:"text-gray-600",children:["C√≥digo: ",v.codigo_articulo]})]}),$&&m.length===0&&!v&&e.jsxs("div",{className:"mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded text-sm text-yellow-700",children:[e.jsx("i",{className:"ri-information-line mr-1"}),"No se encontraron art√≠culos disponibles. Solo se muestran art√≠culos sin umbrales configurados."]})]}),l&&l.inventario&&e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsx("h3",{className:"font-medium text-gray-900 mb-2",children:"Art√≠culo"}),e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"C√≥digo:"})," ",l.inventario.codigo_articulo]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Descripci√≥n:"})," ",l.inventario.descripcion_articulo]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Cantidad M√≠nima *"}),e.jsx("input",{type:"number",value:N.min_qty,onChange:n=>s("min_qty",parseInt(n.target.value)||0),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",min:"1",required:!0}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Cantidad m√≠nima antes de generar alerta"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Cantidad M√°xima *"}),e.jsx("input",{type:"number",value:N.max_qty,onChange:n=>s("max_qty",parseInt(n.target.value)||0),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",min:"1",required:!0}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Cantidad m√°xima recomendada en inventario"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Stock de Seguridad"}),e.jsx("input",{type:"number",value:N.safety_stock,onChange:n=>s("safety_stock",parseInt(n.target.value)||0),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",min:"0"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Stock adicional para contingencias"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Tiempo de Entrega (d√≠as) *"}),e.jsx("input",{type:"number",value:N.lead_time_dias,onChange:n=>s("lead_time_dias",parseInt(n.target.value)||0),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",min:"1",required:!0}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"D√≠as que toma recibir el pedido"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Lote M√≠nimo *"}),e.jsx("input",{type:"number",value:N.lote_minimo,onChange:n=>s("lote_minimo",parseInt(n.target.value)||0),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",min:"1",required:!0}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Cantidad m√≠nima por pedido"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",id:"activo",checked:N.activo,onChange:n=>s("activo",n.target.checked),className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"}),e.jsx("label",{htmlFor:"activo",className:"ml-2 block text-sm text-gray-900",children:"Umbral activo"})]})]}),e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg",children:[e.jsxs("h3",{className:"font-medium text-blue-900 mb-2",children:[e.jsx("i",{className:"ri-calculator-line mr-2"}),"Punto de Reorden (ROP) Calculado"]}),e.jsxs("div",{className:"text-sm text-blue-700",children:[e.jsxs("div",{className:"mb-1",children:[e.jsx("strong",{children:"F√≥rmula:"})," Stock de Seguridad + (Demanda Promedio √ó Tiempo de Entrega)"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"ROP estimado:"})," ",N.safety_stock+2.5*N.lead_time_dias," unidades"]}),e.jsx("div",{className:"text-xs mt-1 text-blue-600",children:"* Usando demanda promedio de 2.5 unidades/d√≠a (configurable en Configuraci√≥n)"})]})]}),e.jsxs("div",{className:"flex justify-end space-x-4 pt-6 border-t border-gray-200",children:[e.jsx("button",{type:"button",onClick:f,className:"px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 whitespace-nowrap cursor-pointer",children:"Cancelar"}),e.jsx("button",{type:"submit",disabled:L||!l&&!N.articulo_id,className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed whitespace-nowrap cursor-pointer",children:L?e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"ri-loader-4-line animate-spin mr-2"}),"Guardando..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:l?"ri-save-line mr-2":"ri-add-line mr-2"}),l?"Actualizar":"Crear"," Umbral"]})})]})]})})]})})}function Y({onClose:l,onSuccess:f}){const[k,L]=x.useState(!1),[D,F]=x.useState(null),[I,$]=x.useState(null),[h,q]=x.useState(!1),b=x.useRef(null),v=t=>{t.preventDefault(),t.stopPropagation(),t.type==="dragenter"||t.type==="dragover"?q(!0):t.type==="dragleave"&&q(!1)},C=t=>{t.preventDefault(),t.stopPropagation(),q(!1),t.dataTransfer.files&&t.dataTransfer.files[0]&&S(t.dataTransfer.files[0])},N=t=>{t.target.files&&t.target.files[0]&&S(t.target.files[0])},S=async t=>{if(!t.name.match(/\.(xlsx|xls|csv)$/)){F("Por favor selecciona un archivo Excel (.xlsx, .xls) o CSV");return}L(!0),F(null),$(null);try{new FormData().append("file",t);const d=(await t.text()).split(`
`);if(d.length<2)throw new Error("El archivo debe contener al menos una fila de datos adem√°s del encabezado");const u=d[0].split(",").map(E=>E.trim().replace(/"/g,"")),s=["codigo_articulo","min_qty","max_qty","safety_stock","lead_time_dias","lote_minimo"];if(!s.every(E=>u.some(i=>i.toLowerCase().includes(E.toLowerCase()))))throw new Error(`El archivo debe contener las columnas: ${s.join(", ")}`);const n=d.slice(1).filter(E=>E.trim()),w=[],_=[];for(let E=0;E<n.length;E++){const i=n[E].split(",").map(V=>V.trim().replace(/"/g,""));if(i.length<s.length){_.push(`Fila ${E+2}: Datos incompletos`);continue}const r=i[0],g=parseFloat(i[1]),j=parseFloat(i[2]),p=parseFloat(i[3]),A=parseInt(i[4]),P=parseFloat(i[5])||0;if(!r){_.push(`Fila ${E+2}: C√≥digo de art√≠culo requerido`);continue}if(isNaN(g)||g<0){_.push(`Fila ${E+2}: Cantidad m√≠nima debe ser un n√∫mero ‚â• 0`);continue}if(isNaN(j)||j<g){_.push(`Fila ${E+2}: Cantidad m√°xima debe ser ‚â• cantidad m√≠nima`);continue}if(isNaN(p)||p<0){_.push(`Fila ${E+2}: Stock de seguridad debe ser un n√∫mero ‚â• 0`);continue}if(isNaN(A)||A<0){_.push(`Fila ${E+2}: Lead time debe ser un n√∫mero entero ‚â• 0`);continue}const{data:R,error:z}=await y.from("inventario").select("Id_Articulo").eq("codigo_articulo",r).single();if(z||!R){_.push(`Fila ${E+2}: Art√≠culo '${r}' no encontrado en inventario`);continue}const G=p+1*A;w.push({articulo_id:R.Id_Articulo,min_qty:g,max_qty:j,safety_stock:p,reorder_point:G,lead_time_dias:A,lote_minimo:P,activo:!0})}if(_.length>0)throw new Error(`Errores encontrados:
${_.join(`
`)}`);if(w.length===0)throw new Error("No se encontraron datos v√°lidos para procesar");let T=0,M=0;for(const E of w){const{data:i}=await y.from("inventario_thresholds").select("id").eq("articulo_id",E.articulo_id).single();if(i){const{error:r}=await y.from("inventario_thresholds").update(E).eq("id",i.id);if(r)throw r;M++}else{const{error:r}=await y.from("inventario_thresholds").insert(E);if(r)throw r;T++}}$(`Importaci√≥n exitosa: ${T} umbrales creados, ${M} actualizados`),setTimeout(()=>{f()},2e3)}catch(o){console.error("Error importando umbrales:",o),F(o.message||"Error al procesar el archivo")}finally{L(!1)}},c=()=>{const t=["codigo_articulo","min_qty","max_qty","safety_stock","lead_time_dias","lote_minimo"],o=[["ART001","10","100","15","7","5"],["ART002","5","50","10","3","1"],["ART003","20","200","30","14","10"]],a=[t.join(","),...o.map(m=>m.join(","))].join(`
`),d=new Blob([a],{type:"text/csv;charset=utf-8;"}),u=document.createElement("a"),s=URL.createObjectURL(d);u.setAttribute("href",s),u.setAttribute("download","plantilla_umbrales_stock.csv"),u.style.visibility="hidden",document.body.appendChild(u),u.click(),document.body.removeChild(u)};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Importar Umbrales de Stock"}),e.jsx("button",{onClick:l,className:"text-gray-400 hover:text-gray-600",children:e.jsx("i",{className:"ri-close-line text-xl"})})]}),e.jsxs("div",{className:"mb-6 p-4 bg-blue-50 rounded-lg",children:[e.jsxs("h3",{className:"font-medium text-blue-900 mb-2",children:[e.jsx("i",{className:"ri-information-line mr-2"}),"Instrucciones de importaci√≥n"]}),e.jsxs("ul",{className:"text-sm text-blue-800 space-y-1",children:[e.jsx("li",{children:"‚Ä¢ El archivo debe ser CSV o Excel (.xlsx, .xls)"}),e.jsx("li",{children:"‚Ä¢ Debe contener las columnas: codigo_articulo, min_qty, max_qty, safety_stock, lead_time_dias, lote_minimo"}),e.jsx("li",{children:"‚Ä¢ Los c√≥digos de art√≠culo deben existir en el inventario"}),e.jsx("li",{children:"‚Ä¢ Las cantidades deben ser n√∫meros positivos"}),e.jsx("li",{children:"‚Ä¢ max_qty debe ser mayor o igual a min_qty"})]})]}),e.jsx("div",{className:"mb-6",children:e.jsxs("button",{onClick:c,className:"flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors",children:[e.jsx("i",{className:"ri-download-line mr-2"}),"Descargar Plantilla CSV"]})}),e.jsxs("div",{className:`border-2 border-dashed rounded-lg p-8 text-center transition-colors ${h?"border-blue-500 bg-blue-50":"border-gray-300 hover:border-gray-400"}`,onDragEnter:v,onDragLeave:v,onDragOver:v,onDrop:C,children:[e.jsx("i",{className:"ri-upload-cloud-2-line text-4xl text-gray-400 mb-4"}),e.jsx("p",{className:"text-lg font-medium text-gray-700 mb-2",children:"Arrastra tu archivo aqu√≠ o haz clic para seleccionar"}),e.jsx("p",{className:"text-sm text-gray-500 mb-4",children:"Formatos soportados: CSV, Excel (.xlsx, .xls)"}),e.jsx("input",{ref:b,type:"file",accept:".csv,.xlsx,.xls",onChange:N,className:"hidden"}),e.jsx("button",{onClick:()=>b.current?.click(),disabled:k,className:"px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50",children:k?"Procesando...":"Seleccionar Archivo"})]}),D&&e.jsx("div",{className:"mt-4 p-4 bg-red-50 border border-red-200 rounded-lg",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx("i",{className:"ri-error-warning-line text-red-500 mr-2 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-red-800",children:"Error"}),e.jsx("pre",{className:"text-sm text-red-700 whitespace-pre-wrap",children:D})]})]})}),I&&e.jsx("div",{className:"mt-4 p-4 bg-green-50 border border-green-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("i",{className:"ri-check-line text-green-500 mr-2"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-green-800",children:"√âxito"}),e.jsx("p",{className:"text-sm text-green-700",children:I})]})]})}),k&&e.jsxs("div",{className:"mt-4 flex items-center justify-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"}),e.jsx("span",{className:"ml-2 text-gray-600",children:"Procesando archivo..."})]}),e.jsx("div",{className:"flex justify-end space-x-3 mt-6",children:e.jsx("button",{onClick:l,disabled:k,className:"px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors disabled:opacity-50",children:"Cancelar"})})]})})}function B({thresholds:l,onRefresh:f}){const[k,L]=x.useState(!1),[D,F]=x.useState(!1),[I,$]=x.useState(null),[h,q]=x.useState(""),[b,v]=x.useState("todos"),[C,N]=x.useState([]),[S,c]=x.useState(!1),[t,o]=x.useState({});x.useEffect(()=>{a()},[l]);const a=async()=>{if(l.length===0)return;const r=l.map(p=>p.articulo_id),{data:g,error:j}=await y.from("inventario_niveles").select("*").in("articulo_id",r);if(!j&&g){const p=g.reduce((A,P)=>(A[P.articulo_id]={on_hand:P.on_hand,reservado:P.reservado,disponible:P.on_hand-P.reservado},A),{});o(p)}},d=r=>{$(r),L(!0)},u=()=>{L(!1),$(null)},s=async r=>{if(confirm(`¬øEst√°s seguro de eliminar el umbral para ${r.inventario?.codigo_articulo}?`))try{const{error:g}=await y.from("inventario_thresholds").delete().eq("id",r.id);if(g)throw g;f(),alert("Umbral eliminado exitosamente")}catch(g){console.error("Error eliminando umbral:",g),alert("Error al eliminar el umbral")}},m=async()=>{if(C.length===0){alert("Selecciona al menos un umbral para eliminar");return}if(confirm(`¬øEst√°s seguro de eliminar ${C.length} umbrales seleccionados?`))try{c(!0);const{error:r}=await y.from("inventario_thresholds").delete().in("id",C);if(r)throw r;N([]),f(),alert(`${C.length} umbrales eliminados exitosamente`)}catch(r){console.error("Error eliminando umbrales:",r),alert("Error al eliminar los umbrales")}finally{c(!1)}},n=async()=>{try{c(!0);const r=l.filter(p=>{const A=t[p.articulo_id];return A?A.disponible<p.reorder_point:!1});if(r.length===0){alert("No hay art√≠culos que requieran reabastecimiento en este momento");return}const g=r.map(p=>{const A=t[p.articulo_id];let P=Math.max(p.max_qty-A.disponible,0);return p.lote_minimo>0&&(P=Math.ceil(P/p.lote_minimo)*p.lote_minimo),{articulo_id:p.articulo_id,qty_sugerida:P,motivo:A.disponible<p.min_qty?"below_min":"below_rop",estado:"borrador",created_at:new Date().toISOString(),updated_at:new Date().toISOString()}}),{error:j}=await y.from("replenishment_orders").insert(g);if(j)throw j;alert(`Se generaron ${g.length} √≥rdenes de reabastecimiento`),f(),window.dispatchEvent(new CustomEvent("replenishment-updated"))}catch(r){console.error("Error generando reabastecimiento:",r),alert("Error al generar √≥rdenes de reabastecimiento")}finally{c(!1)}},w=async()=>{try{c(!0);const{data:r}=await y.from("settings").select("value").eq("key","demanda_promedio_dia").single(),g=r?parseFloat(r.value):5,j=l.map(p=>({id:p.id,reorder_point:p.safety_stock+g*p.lead_time_dias}));for(const p of j){const{error:A}=await y.from("inventario_thresholds").update({reorder_point:p.reorder_point}).eq("id",p.id);if(A)throw A}alert("Puntos de reorden recalculados exitosamente"),f()}catch(r){console.error("Error recalculando ROP:",r),alert("Error al recalcular puntos de reorden")}finally{c(!1)}},_=async()=>{try{const r=M.map(P=>{const R=t[P.articulo_id]||{on_hand:0,reservado:0,disponible:0},z=T(P,R);return{"C√≥digo Art√≠culo":P.inventario?.codigo_articulo||"",Descripci√≥n:P.inventario?.descripcion_articulo||"",Disponible:R.disponible.toFixed(2),"En Mano":R.on_hand.toFixed(2),Reservado:R.reservado.toFixed(2),"Min Qty":P.min_qty.toFixed(2),"Max Qty":P.max_qty.toFixed(2),"Safety Stock":P.safety_stock.toFixed(2),"Reorder Point":P.reorder_point.toFixed(2),"Lead Time (d√≠as)":P.lead_time_dias,"Lote M√≠nimo":P.lote_minimo.toFixed(2),"Estado Sem√°foro":z.label}}),g=O.json_to_sheet(r),j=O.book_new();O.book_append_sheet(j,g,"Umbrales de Stock");const p=[{wch:15},{wch:40},{wch:12},{wch:12},{wch:12},{wch:12},{wch:12},{wch:15},{wch:15},{wch:15},{wch:15},{wch:15}];g["!cols"]=p;const A=`umbrales_stock_${new Date().toISOString().split("T")[0]}.xlsx`;U(j,A)}catch(r){console.error("Error exportando a Excel:",r),alert("Error al exportar los datos a Excel")}},T=(r,g)=>{const p=(g||t[r.articulo_id]||{disponible:0}).disponible;return p<=0||p<r.min_qty?{color:"bg-red-500",label:"Cr√≠tico",textColor:"text-red-700"}:p<r.reorder_point?{color:"bg-yellow-500",label:"Advertencia",textColor:"text-yellow-700"}:{color:"bg-green-500",label:"Normal",textColor:"text-green-700"}},M=l.filter(r=>{if(!(r.inventario?.codigo_articulo?.toLowerCase().includes(h.toLowerCase())||r.inventario?.descripcion_articulo?.toLowerCase().includes(h.toLowerCase())))return!1;if(b==="todos")return!0;const j=T(r);return b==="critico"&&j.label==="Cr√≠tico"||b==="advertencia"&&j.label==="Advertencia"||b==="normal"&&j.label==="Normal"}),E=r=>{N(r?M.map(g=>g.id):[])},i=(r,g)=>{N(g?[...C,r]:C.filter(j=>j!==r))};return e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Umbrales de Stock"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs("button",{onClick:w,disabled:S,className:"flex items-center px-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors whitespace-nowrap disabled:opacity-50",children:[e.jsx("i",{className:"ri-refresh-line mr-2"}),"Recalcular ROP"]}),e.jsxs("button",{onClick:n,disabled:S,className:"flex items-center px-3 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors whitespace-nowrap disabled:opacity-50",children:[e.jsx("i",{className:"ri-shopping-cart-line mr-2"}),"Generar Reabastecimiento"]}),e.jsxs("button",{onClick:_,className:"flex items-center px-3 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors whitespace-nowrap",children:[e.jsx("i",{className:"ri-download-line mr-2"}),"Exportar Excel"]}),e.jsxs("button",{onClick:()=>F(!0),className:"flex items-center px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors whitespace-nowrap",children:[e.jsx("i",{className:"ri-upload-line mr-2"}),"Importar Excel"]}),e.jsxs("button",{onClick:()=>L(!0),className:"flex items-center px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors whitespace-nowrap",children:[e.jsx("i",{className:"ri-add-line mr-2"}),"Nuevo Umbral"]})]})]}),C.length>0&&e.jsx("div",{className:"mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"text-blue-800 font-medium",children:[C.length," elementos seleccionados"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:m,disabled:S,className:"flex items-center px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 transition-colors disabled:opacity-50",children:[e.jsx("i",{className:"ri-delete-bin-line mr-1"}),"Eliminar Seleccionados"]}),e.jsxs("button",{onClick:()=>N([]),className:"flex items-center px-3 py-1 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors",children:[e.jsx("i",{className:"ri-close-line mr-1"}),"Cancelar"]})]})]})}),e.jsxs("div",{className:"mb-6 flex flex-col sm:flex-row gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsx("input",{type:"text",placeholder:"Buscar por c√≥digo o descripci√≥n...",value:h,onChange:r=>q(r.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"})}),e.jsxs("select",{value:b,onChange:r=>v(r.target.value),className:"px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent pr-8",children:[e.jsx("option",{value:"todos",children:"Todos los estados"}),e.jsx("option",{value:"critico",children:"üî¥ Cr√≠tico"}),e.jsx("option",{value:"advertencia",children:"üü° Advertencia"}),e.jsx("option",{value:"normal",children:"üü¢ Normal"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-red-50 p-4 rounded-lg",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"w-3 h-3 bg-red-500 rounded-full mr-2"}),e.jsx("span",{className:"text-sm font-medium text-red-700",children:"Cr√≠tico"})]}),e.jsx("p",{className:"text-2xl font-bold text-red-900",children:l.filter(r=>T(r).label==="Cr√≠tico").length})]}),e.jsxs("div",{className:"bg-yellow-50 p-4 rounded-lg",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"w-3 h-3 bg-yellow-500 rounded-full mr-2"}),e.jsx("span",{className:"text-sm font-medium text-yellow-700",children:"Advertencia"})]}),e.jsx("p",{className:"text-2xl font-bold text-yellow-900",children:l.filter(r=>T(r).label==="Advertencia").length})]}),e.jsxs("div",{className:"bg-green-50 p-4 rounded-lg",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"w-3 h-3 bg-green-500 rounded-full mr-2"}),e.jsx("span",{className:"text-sm font-medium text-green-700",children:"Normal"})]}),e.jsx("p",{className:"text-2xl font-bold text-green-900",children:l.filter(r=>T(r).label==="Normal").length})]}),e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("i",{className:"ri-database-2-line text-blue-600 mr-2"}),e.jsx("span",{className:"text-sm font-medium text-blue-700",children:"Total"})]}),e.jsx("p",{className:"text-2xl font-bold text-blue-900",children:l.length})]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left",children:e.jsx("input",{type:"checkbox",checked:C.length===M.length&&M.length>0,onChange:r=>E(r.target.checked),className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500"})}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Estado"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Art√≠culo"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Disponible"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Min / M√°x"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Safety / ROP"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Lead Time"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Acciones"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:M.map(r=>{const g=t[r.articulo_id]||{on_hand:0,reservado:0,disponible:0},j=T(r,g);return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("input",{type:"checkbox",checked:C.includes(r.id),onChange:p=>i(r.id,p.target.checked),className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500"})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:`w-3 h-3 ${j.color} rounded-full mr-2`}),e.jsx("span",{className:`text-sm font-medium ${j.textColor}`,children:j.label})]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:r.inventario?.codigo_articulo}),e.jsx("div",{className:"text-sm text-gray-500 max-w-xs truncate",children:r.inventario?.descripcion_articulo})]})}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[e.jsx("div",{className:"text-sm text-gray-900",children:e.jsx("span",{className:`font-medium ${j.textColor}`,children:g.disponible.toFixed(2)})}),e.jsxs("div",{className:"text-xs text-gray-500",children:["En mano: ",g.on_hand.toFixed(2)]}),e.jsxs("div",{className:"text-xs text-gray-500",children:["Reservado: ",g.reservado.toFixed(2)]})]}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:[e.jsxs("div",{children:["Min: ",r.min_qty.toFixed(2)]}),e.jsxs("div",{children:["M√°x: ",r.max_qty.toFixed(2)]})]}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:[e.jsxs("div",{children:["Safety: ",r.safety_stock.toFixed(2)]}),e.jsxs("div",{children:["ROP: ",r.reorder_point.toFixed(2)]})]}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:[e.jsxs("div",{children:[r.lead_time_dias," d√≠as"]}),r.lote_minimo>0&&e.jsxs("div",{className:"text-xs text-gray-500",children:["Lote: ",r.lote_minimo.toFixed(2)]})]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("button",{onClick:()=>d(r),className:"text-blue-600 hover:text-blue-900",title:"Editar",children:e.jsx("i",{className:"ri-edit-line"})}),e.jsx("button",{onClick:()=>s(r),className:"text-red-600 hover:text-red-900",title:"Eliminar",children:e.jsx("i",{className:"ri-delete-bin-line"})})]})})]},r.id)})})]})}),M.length===0&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx("i",{className:"ri-database-2-line text-4xl text-gray-400 mb-2"}),e.jsx("p",{className:"text-gray-500",children:"No se encontraron art√≠culos con los filtros aplicados"})]}),k&&e.jsx(W,{threshold:I,onClose:u,onSuccess:()=>{u(),f()}}),D&&e.jsx(Y,{onClose:()=>F(!1),onSuccess:()=>{F(!1),f()}})]})}function Z({alertas:l,onRefresh:f}){const[k,L]=x.useState("todos"),[D,F]=x.useState("todos"),[I,$]=x.useState(""),[h,q]=x.useState([]),[b,v]=x.useState(!1),C=s=>{switch(s){case"stockout":return{label:"Sin Stock",color:"bg-red-100 text-red-800",icon:"ri-error-warning-line",iconColor:"text-red-600"};case"below_min":return{label:"Bajo M√≠nimo",color:"bg-orange-100 text-orange-800",icon:"ri-alert-line",iconColor:"text-orange-600"};case"below_rop":return{label:"Bajo ROP",color:"bg-yellow-100 text-yellow-800",icon:"ri-information-line",iconColor:"text-yellow-600"};default:return{label:"Desconocido",color:"bg-gray-100 text-gray-800",icon:"ri-question-line",iconColor:"text-gray-600"}}},N=async s=>{try{const{error:m}=await y.from("inventario_alertas").update({leida:!0}).eq("id",s);if(m)throw m;f()}catch(m){console.error("Error marcando alerta como le√≠da:",m),alert("Error al marcar la alerta como le√≠da")}},S=async()=>{if(h.length===0){alert("Selecciona al menos una alerta");return}try{v(!0);const{error:s}=await y.from("inventario_alertas").update({leida:!0}).in("id",h);if(s)throw s;q([]),f(),alert(`${h.length} alertas marcadas como le√≠das`)}catch(s){console.error("Error marcando alertas como le√≠das:",s),alert("Error al marcar las alertas como le√≠das")}finally{v(!1)}},c=async()=>{if(h.length===0){alert("Selecciona al menos una alerta");return}if(confirm(`¬øEst√°s seguro de eliminar ${h.length} alertas seleccionadas?`))try{v(!0);const{error:s}=await y.from("inventario_alertas").delete().in("id",h);if(s)throw s;q([]),f(),alert(`${h.length} alertas eliminadas exitosamente`)}catch(s){console.error("Error eliminando alertas:",s),alert("Error al eliminar las alertas")}finally{v(!1)}},t=()=>{const s=["Fecha","Tipo","C√≥digo Art√≠culo","Descripci√≥n","Disponible","Umbral","Estado","Le√≠da"],m=a.map(M=>{const E=C(M.tipo),i=M.detalle||{};return[new Date(M.created_at).toLocaleDateString(),E.label,i.articulo_codigo||"",i.articulo_descripcion||"",i.disponible||"0",i.min_qty||i.reorder_point||"0",M.leida?"Le√≠da":"No le√≠da",M.leida?"S√≠":"No"]}),n=[s.join(","),...m.map(M=>M.map(E=>`"${E}"`).join(","))].join(`
`),w=new Blob([n],{type:"text/csv;charset=utf-8;"}),_=document.createElement("a"),T=URL.createObjectURL(w);_.setAttribute("href",T),_.setAttribute("download",`alertas_inventario_${new Date().toISOString().split("T")[0]}.csv`),_.style.visibility="hidden",document.body.appendChild(_),_.click(),document.body.removeChild(_)},o=async()=>{try{v(!0);const{data:s,error:m}=await y.from("inventario_thresholds").select(`
          *,
          inventario:inventario!inner(codigo_articulo, descripcion_articulo)
        `).eq("activo",!0);if(m)throw m;const n=[];for(const w of s||[]){const{data:_}=await y.from("inventario_niveles").select("*").eq("articulo_id",w.articulo_id).single();if(!_)continue;const T=_.on_hand-_.reservado;let M=null;if(T<=0?M="stockout":T<w.min_qty?M="below_min":T<w.reorder_point&&(M="below_rop"),M){const{data:E}=await y.from("inventario_alertas").select("id").eq("articulo_id",w.articulo_id).eq("tipo",M).eq("leida",!1).single();E||n.push({articulo_id:w.articulo_id,tipo:M,detalle:{disponible:T,min_qty:w.min_qty,reorder_point:w.reorder_point,articulo_codigo:w.inventario.codigo_articulo,articulo_descripcion:w.inventario.descripcion_articulo},leida:!1})}}if(n.length>0){const{error:w}=await y.from("inventario_alertas").insert(n);if(w)throw w;alert(`Se generaron ${n.length} nuevas alertas`)}else alert("No se encontraron nuevas alertas para generar");f()}catch(s){console.error("Error generando alertas:",s),alert("Error al generar alertas autom√°ticas")}finally{v(!1)}},a=l.filter(s=>!(!(s.detalle?.articulo_codigo?.toLowerCase().includes(I.toLowerCase())||s.detalle?.articulo_descripcion?.toLowerCase().includes(I.toLowerCase()))||k!=="todos"&&s.tipo!==k||D==="leidas"&&!s.leida||D==="no_leidas"&&s.leida)),d=s=>{q(s?a.map(m=>m.id):[])},u=(s,m)=>{q(m?[...h,s]:h.filter(n=>n!==s))};return e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Alertas de Inventario"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs("button",{onClick:o,disabled:b,className:"flex items-center px-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors whitespace-nowrap disabled:opacity-50",children:[e.jsx("i",{className:"ri-refresh-line mr-2"}),"Generar Alertas"]}),e.jsxs("button",{onClick:t,className:"flex items-center px-3 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors whitespace-nowrap",children:[e.jsx("i",{className:"ri-download-line mr-2"}),"Exportar CSV"]})]})]}),h.length>0&&e.jsx("div",{className:"mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"text-blue-800 font-medium",children:[h.length," alertas seleccionadas"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:S,disabled:b,className:"flex items-center px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 transition-colors disabled:opacity-50",children:[e.jsx("i",{className:"ri-check-line mr-1"}),"Marcar como Le√≠das"]}),e.jsxs("button",{onClick:c,disabled:b,className:"flex items-center px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 transition-colors disabled:opacity-50",children:[e.jsx("i",{className:"ri-delete-bin-line mr-1"}),"Eliminar"]}),e.jsxs("button",{onClick:()=>q([]),className:"flex items-center px-3 py-1 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors",children:[e.jsx("i",{className:"ri-close-line mr-1"}),"Cancelar"]})]})]})}),e.jsxs("div",{className:"mb-6 grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx("input",{type:"text",placeholder:"Buscar por c√≥digo o descripci√≥n...",value:I,onChange:s=>$(s.target.value),className:"px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),e.jsxs("select",{value:k,onChange:s=>L(s.target.value),className:"px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent pr-8",children:[e.jsx("option",{value:"todos",children:"Todos los tipos"}),e.jsx("option",{value:"stockout",children:"üî¥ Sin Stock"}),e.jsx("option",{value:"below_min",children:"üü† Bajo M√≠nimo"}),e.jsx("option",{value:"below_rop",children:"üü° Bajo ROP"})]}),e.jsxs("select",{value:D,onChange:s=>F(s.target.value),className:"px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent pr-8",children:[e.jsx("option",{value:"todos",children:"Todos los estados"}),e.jsx("option",{value:"no_leidas",children:"No le√≠das"}),e.jsx("option",{value:"leidas",children:"Le√≠das"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-red-50 p-4 rounded-lg",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("i",{className:"ri-error-warning-line text-red-600 mr-2"}),e.jsx("span",{className:"text-sm font-medium text-red-700",children:"Sin Stock"})]}),e.jsx("p",{className:"text-2xl font-bold text-red-900",children:l.filter(s=>s.tipo==="stockout").length})]}),e.jsxs("div",{className:"bg-orange-50 p-4 rounded-lg",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("i",{className:"ri-alert-line text-orange-600 mr-2"}),e.jsx("span",{className:"text-sm font-medium text-orange-700",children:"Bajo M√≠nimo"})]}),e.jsx("p",{className:"text-2xl font-bold text-orange-900",children:l.filter(s=>s.tipo==="below_min").length})]}),e.jsxs("div",{className:"bg-yellow-50 p-4 rounded-lg",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("i",{className:"ri-information-line text-yellow-600 mr-2"}),e.jsx("span",{className:"text-sm font-medium text-yellow-700",children:"Bajo ROP"})]}),e.jsx("p",{className:"text-2xl font-bold text-yellow-900",children:l.filter(s=>s.tipo==="below_rop").length})]}),e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("i",{className:"ri-notification-line text-blue-600 mr-2"}),e.jsx("span",{className:"text-sm font-medium text-blue-700",children:"No Le√≠das"})]}),e.jsx("p",{className:"text-2xl font-bold text-blue-900",children:l.filter(s=>!s.leida).length})]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left",children:e.jsx("input",{type:"checkbox",checked:h.length===a.length&&a.length>0,onChange:s=>d(s.target.checked),className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500"})}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Fecha"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Tipo"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Art√≠culo"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Detalle"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Estado"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Acciones"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:a.map(s=>{const m=C(s.tipo),n=s.detalle||{};return e.jsxs("tr",{className:`hover:bg-gray-50 ${s.leida?"":"bg-blue-50"}`,children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("input",{type:"checkbox",checked:h.includes(s.id),onChange:w=>u(s.id,w.target.checked),className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500"})}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:[new Date(s.created_at).toLocaleDateString(),e.jsx("div",{className:"text-xs text-gray-500",children:new Date(s.created_at).toLocaleTimeString()})]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${m.color}`,children:[e.jsx("i",{className:`${m.icon} ${m.iconColor} mr-1`}),m.label]})}),e.jsxs("td",{className:"px-6 py-4",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:n.articulo_codigo}),e.jsx("div",{className:"text-sm text-gray-500 max-w-xs truncate",children:n.articulo_descripcion})]}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:[e.jsxs("div",{children:["Disponible: ",e.jsx("span",{className:"font-medium",children:n.disponible||0})]}),n.min_qty&&e.jsxs("div",{className:"text-xs text-gray-500",children:["M√≠nimo: ",n.min_qty]}),n.reorder_point&&e.jsxs("div",{className:"text-xs text-gray-500",children:["ROP: ",n.reorder_point]})]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:s.leida?e.jsxs("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800",children:[e.jsx("i",{className:"ri-check-line mr-1"}),"Le√≠da"]}):e.jsxs("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800",children:[e.jsx("i",{className:"ri-notification-line mr-1"}),"Nueva"]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium",children:!s.leida&&e.jsx("button",{onClick:()=>N(s.id),className:"text-green-600 hover:text-green-900 mr-3",title:"Marcar como le√≠da",children:e.jsx("i",{className:"ri-check-line"})})})]},s.id)})})]})}),a.length===0&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx("i",{className:"ri-notification-off-line text-4xl text-gray-400 mb-2"}),e.jsx("p",{className:"text-gray-500",children:"No se encontraron alertas con los filtros aplicados"})]})]})}function J({orders:l=[],onRefresh:f}){const[k,L]=x.useState("todos"),[D,F]=x.useState("todos"),[I,$]=x.useState(""),[h,q]=x.useState([]),[b,v]=x.useState(!1),[C,N]=x.useState(null),[S,c]=x.useState(!1),t=Array.isArray(l)?l:[];x.useEffect(()=>{const i=()=>{f()};return window.addEventListener("replenishment-updated",i),()=>{window.removeEventListener("replenishment-updated",i)}},[f]);const o=i=>{switch(i){case"borrador":return{label:"Borrador",color:"bg-gray-100 text-gray-800",icon:"ri-draft-line",iconColor:"text-gray-600"};case"emitida":return{label:"Emitida",color:"bg-blue-100 text-blue-800",icon:"ri-send-plane-line",iconColor:"text-blue-600"};case"completada":return{label:"Completada",color:"bg-green-100 text-green-800",icon:"ri-check-line",iconColor:"text-green-600"};case"cancelada":return{label:"Cancelada",color:"bg-red-100 text-red-800",icon:"ri-close-line",iconColor:"text-red-600"};default:return{label:"Desconocido",color:"bg-gray-100 text-gray-800",icon:"ri-question-line",iconColor:"text-gray-600"}}},a=i=>{switch(i){case"below_min":return{label:"Bajo M√≠nimo",color:"text-red-600",icon:"ri-arrow-down-line"};case"below_rop":return{label:"Bajo ROP",color:"text-yellow-600",icon:"ri-alert-line"};default:return{label:"Otro",color:"text-gray-600",icon:"ri-information-line"}}},d=async(i,r)=>{try{const{error:g}=await y.from("replenishment_orders").update({estado:r,updated_at:new Date().toISOString()}).eq("id",i);if(g)throw g;f()}catch(g){console.error("Error cambiando estado:",g),alert("Error al cambiar el estado de la orden")}},u=async i=>{if(h.length===0){alert("Selecciona al menos una orden");return}if(window.confirm(`¬øCambiar el estado de ${h.length} √≥rdenes a "${i}"?`))try{v(!0);const{error:r}=await y.from("replenishment_orders").update({estado:i,updated_at:new Date().toISOString()}).in("id",h);if(r)throw r;q([]),f(),alert(`${h.length} √≥rdenes actualizadas exitosamente`)}catch(r){console.error("Error cambiando estados:",r),alert("Error al cambiar los estados")}finally{v(!1)}},s=async i=>{if(window.confirm("¬øEst√°s seguro de eliminar esta orden de reabastecimiento?"))try{const{error:r}=await y.from("replenishment_orders").delete().eq("id",i);if(r)throw r;f(),alert("Orden eliminada exitosamente")}catch(r){console.error("Error eliminando orden:",r),alert("Error al eliminar la orden")}},m=async()=>{if(h.length===0){alert("Selecciona al menos una orden");return}if(window.confirm(`¬øEst√°s seguro de eliminar ${h.length} √≥rdenes seleccionadas?`))try{v(!0);const{error:i}=await y.from("replenishment_orders").delete().in("id",h);if(i)throw i;q([]),f(),alert(`${h.length} √≥rdenes eliminadas exitosamente`)}catch(i){console.error("Error eliminando √≥rdenes:",i),alert("Error al eliminar las √≥rdenes")}finally{v(!1)}},n=async()=>{try{const i=T.map(A=>{const P=a(A.motivo),R=o(A.estado);return{"Fecha Creaci√≥n":new Date(A.created_at).toLocaleDateString(),Hora:new Date(A.created_at).toLocaleTimeString(),"C√≥digo Art√≠culo":A.inventario?.codigo_articulo||"",Descripci√≥n:A.inventario?.descripcion_articulo||"","Cantidad Sugerida":A.qty_sugerida.toFixed(2),Motivo:P.label,Estado:R.label,"Generado Por":A.generado_por||"",Notas:A.notas||"","√öltima Actualizaci√≥n":new Date(A.updated_at).toLocaleDateString()}}),r=O.json_to_sheet(i),g=O.book_new();O.book_append_sheet(g,r,"√ìrdenes de Reabastecimiento");const j=[{wch:15},{wch:12},{wch:15},{wch:40},{wch:18},{wch:15},{wch:12},{wch:20},{wch:30},{wch:18}];r["!cols"]=j;const p=`ordenes_reabastecimiento_${new Date().toISOString().split("T")[0]}.xlsx`;U(g,p)}catch(i){console.error("Error exportando a Excel:",i),alert("Error al exportar los datos a Excel")}},w=i=>{N(i),c(!0)},_=async i=>{if(C)try{const{error:r}=await y.from("replenishment_orders").update({notas:i,updated_at:new Date().toISOString()}).eq("id",C.id);if(r)throw r;c(!1),N(null),f()}catch(r){console.error("Error guardando notas:",r),alert("Error al guardar las notas")}},T=t.filter(i=>!(!(i.inventario?.codigo_articulo?.toLowerCase().includes(I.toLowerCase())||i.inventario?.descripcion_articulo?.toLowerCase().includes(I.toLowerCase()))||k!=="todos"&&i.estado!==k||D!=="todos"&&i.motivo!==D)),M=i=>{q(i?T.map(r=>r.id):[])},E=(i,r)=>{q(r?g=>[...g,i]:g=>g.filter(j=>j!==i))};return e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"√ìrdenes de Reabastecimiento"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:e.jsxs("button",{onClick:n,className:"flex items-center px-3 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors whitespace-nowrap",children:[e.jsx("i",{className:"ri-download-line mr-2"}),"Exportar Excel"]})})]}),h.length>0&&e.jsx("div",{className:"mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-2",children:[e.jsxs("span",{className:"text-blue-800 font-medium",children:[h.length," √≥rdenes seleccionadas"]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs("button",{onClick:()=>u("emitida"),disabled:b,className:"flex items-center px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors disabled:opacity-50 text-sm",children:[e.jsx("i",{className:"ri-send-plane-line mr-1"}),"Emitir"]}),e.jsxs("button",{onClick:()=>u("completada"),disabled:b,className:"flex items-center px-2 py-1 bg-green-600 text-white rounded hover:bg-green-700 transition-colors disabled:opacity-50 text-sm",children:[e.jsx("i",{className:"ri-check-line mr-1"}),"Completar"]}),e.jsxs("button",{onClick:()=>u("cancelada"),disabled:b,className:"flex items-center px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700 transition-colors disabled:opacity-50 text-sm",children:[e.jsx("i",{className:"ri-close-line mr-1"}),"Cancelar"]}),e.jsxs("button",{onClick:m,disabled:b,className:"flex items-center px-2 py-1 bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors disabled:opacity-50 text-sm",children:[e.jsx("i",{className:"ri-delete-bin-line mr-1"}),"Eliminar"]}),e.jsxs("button",{onClick:()=>q([]),className:"flex items-center px-2 py-1 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors text-sm",children:[e.jsx("i",{className:"ri-close-line mr-1"}),"Cancelar"]})]})]})}),e.jsxs("div",{className:"mb-6 grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx("input",{type:"text",placeholder:"Buscar por c√≥digo o descripci√≥n...",value:I,onChange:i=>$(i.target.value),className:"px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),e.jsxs("select",{value:k,onChange:i=>L(i.target.value),className:"px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent pr-8",children:[e.jsx("option",{value:"todos",children:"Todos los estados"}),e.jsx("option",{value:"borrador",children:"üìù Borrador"}),e.jsx("option",{value:"emitida",children:"üì§ Emitida"}),e.jsx("option",{value:"completada",children:"‚úÖ Completada"}),e.jsx("option",{value:"cancelada",children:"‚ùå Cancelada"})]}),e.jsxs("select",{value:D,onChange:i=>F(i.target.value),className:"px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent pr-8",children:[e.jsx("option",{value:"todos",children:"Todos los motivos"}),e.jsx("option",{value:"below_min",children:"üî¥ Bajo M√≠nimo"}),e.jsx("option",{value:"below_rop",children:"üü° Bajo ROP"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("i",{className:"ri-draft-line text-gray-600 mr-2"}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Borradores"})]}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:t.filter(i=>i.estado==="borrador").length})]}),e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("i",{className:"ri-send-plane-line text-blue-600 mr-2"}),e.jsx("span",{className:"text-sm font-medium text-blue-700",children:"Emitidas"})]}),e.jsx("p",{className:"text-2xl font-bold text-blue-900",children:t.filter(i=>i.estado==="emitida").length})]}),e.jsxs("div",{className:"bg-green-50 p-4 rounded-lg",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("i",{className:"ri-check-line text-green-600 mr-2"}),e.jsx("span",{className:"text-sm font-medium text-green-700",children:"Completadas"})]}),e.jsx("p",{className:"text-2xl font-bold text-green-900",children:t.filter(i=>i.estado==="completada").length})]}),e.jsxs("div",{className:"bg-orange-50 p-4 rounded-lg",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("i",{className:"ri-shopping-cart-line text-orange-600 mr-2"}),e.jsx("span",{className:"text-sm font-medium text-orange-700",children:"Total"})]}),e.jsx("p",{className:"text-2xl font-bold text-orange-900",children:t.length})]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left",children:e.jsx("input",{type:"checkbox",checked:h.length===T.length&&T.length>0,onChange:i=>M(i.target.checked),className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500"})}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Fecha"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Art√≠culo"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Cantidad"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Motivo"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Estado"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Acciones"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:T.map(i=>{const r=o(i.estado),g=a(i.motivo);return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("input",{type:"checkbox",checked:h.includes(i.id),onChange:j=>E(i.id,j.target.checked),className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500"})}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:[new Date(i.created_at).toLocaleDateString(),e.jsx("div",{className:"text-xs text-gray-500",children:new Date(i.created_at).toLocaleTimeString()})]}),e.jsxs("td",{className:"px-6 py-4",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:i.inventario?.codigo_articulo}),e.jsx("div",{className:"text-sm text-gray-500 max-w-xs truncate",children:i.inventario?.descripcion_articulo})]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium",children:i.qty_sugerida.toFixed(2)}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("span",{className:`inline-flex items-center text-sm font-medium ${g.color}`,children:[e.jsx("i",{className:`${g.icon} mr-1`}),g.label]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${r.color}`,children:[e.jsx("i",{className:`${r.icon} ${r.iconColor} mr-1`}),r.label]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[i.estado==="borrador"&&e.jsx("button",{onClick:()=>d(i.id,"emitida"),className:"text-blue-600 hover:text-blue-900",title:"Emitir orden",children:e.jsx("i",{className:"ri-send-plane-line"})}),i.estado==="emitida"&&e.jsx("button",{onClick:()=>d(i.id,"completada"),className:"text-green-600 hover:text-green-900",title:"Marcar como completada",children:e.jsx("i",{className:"ri-check-line"})}),e.jsx("button",{onClick:()=>w(i),className:"text-gray-600 hover:text-gray-900",title:"Editar notas",children:e.jsx("i",{className:"ri-edit-line"})}),e.jsx("button",{onClick:()=>s(i.id),className:"text-red-600 hover:text-red-900",title:"Eliminar",children:e.jsx("i",{className:"ri-delete-bin-line"})})]})})]},i.id)})})]})}),T.length===0&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx("i",{className:"ri-shopping-cart-line text-4xl text-gray-400 mb-2"}),e.jsx("p",{className:"text-gray-500",children:"No se encontraron √≥rdenes con los filtros aplicados"})]}),S&&C&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-md mx-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Editar Notas"}),e.jsx("button",{onClick:()=>c(!1),className:"text-gray-400 hover:text-gray-600",children:e.jsx("i",{className:"ri-close-line text-xl"})})]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("p",{className:"text-sm text-gray-600 mb-2",children:["Orden para: ",C.inventario?.codigo_articulo]}),e.jsx("textarea",{defaultValue:C.notas||"",placeholder:"Agregar notas sobre esta orden...",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",rows:4,onKeyDown:i=>{i.key==="Enter"&&i.ctrlKey&&_(i.target.value)},ref:i=>{i&&(i.focus(),i.setSelectionRange(i.value.length,i.value.length))}})]}),e.jsxs("div",{className:"flex justify-end space-x-3",children:[e.jsx("button",{onClick:()=>c(!1),className:"px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors",children:"Cancelar"}),e.jsx("button",{onClick:()=>{const i=document.querySelector("textarea");_(i.value)},className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:"Guardar"})]})]})})]})}function ee(){const[l,f]=x.useState([]),[k,L]=x.useState(!0),[D,F]=x.useState(!1),[I,$]=x.useState({});x.useEffect(()=>{h()},[]);const h=async()=>{try{L(!0);const{data:c,error:t}=await y.from("settings").select("*").order("key");if(t)throw t;f(c||[]);const o={};c?.forEach(a=>{a.type==="boolean"?o[a.key]=a.value==="true":a.type==="number"?o[a.key]=parseFloat(a.value)||0:o[a.key]=a.value}),$(o)}catch(c){console.error("Error cargando configuraci√≥n:",c)}finally{L(!1)}},q=async()=>{try{F(!0);const c=l.map(t=>{let o=I[t.key];return t.type==="boolean"?o=o?"true":"false":t.type==="number"&&(o=o.toString()),{id:t.id,value:o,updated_at:new Date().toISOString()}});for(const t of c){const{error:o}=await y.from("settings").update({value:t.value,updated_at:t.updated_at}).eq("id",t.id);if(o)throw o}alert("Configuraci√≥n guardada exitosamente"),h()}catch(c){console.error("Error guardando configuraci√≥n:",c),alert("Error al guardar la configuraci√≥n")}finally{F(!1)}},b=(c,t)=>{$(o=>({...o,[c]:t}))},v=c=>{const t=I[c.key];switch(c.type){case"boolean":return e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",id:c.key,checked:t||!1,onChange:o=>b(c.key,o.target.checked),className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"}),e.jsx("label",{htmlFor:c.key,className:"ml-2 text-sm text-gray-700",children:t?"Habilitado":"Deshabilitado"})]});case"number":return e.jsx("input",{type:"number",step:"0.01",value:t||0,onChange:o=>b(c.key,parseFloat(o.target.value)||0),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"});default:return e.jsx("input",{type:"text",value:t||"",onChange:o=>b(c.key,o.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"})}},C=c=>{switch(c){case"demanda_promedio_dia":return"ri-line-chart-line";case"z_score_safety":return"ri-shield-check-line";case"permitir_stock_negativo":return"ri-error-warning-line";case"auto_generar_alertas":return"ri-alarm-warning-line";case"dias_vencimiento_alertas":return"ri-calendar-line";default:return"ri-settings-line"}},N=c=>c.includes("demanda")||c.includes("z_score")?"C√°lculos de Stock":c.includes("alerta")?"Gesti√≥n de Alertas":c.includes("stock")||c.includes("negativo")?"Pol√≠ticas de Inventario":"General",S=l.reduce((c,t)=>{const o=N(t.key);return c[o]||(c[o]=[]),c[o].push(t),c},{});return k?e.jsxs("div",{className:"p-8 text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"}),e.jsx("p",{className:"mt-2 text-gray-600",children:"Cargando configuraci√≥n..."})]}):e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h2",{className:"text-lg font-medium text-gray-900 mb-2",children:"Configuraci√≥n del Sistema de Inventario"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Ajusta los par√°metros globales para el c√°lculo de stock inteligente y gesti√≥n de alertas."})]}),e.jsx("div",{className:"space-y-8",children:Object.entries(S).map(([c,t])=>e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-6",children:[e.jsxs("h3",{className:"text-md font-medium text-gray-900 mb-4 flex items-center",children:[e.jsx("i",{className:"ri-folder-settings-line mr-2 text-blue-600"}),c]}),e.jsx("div",{className:"space-y-6",children:t.map(o=>e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-start gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx("i",{className:`${C(o.key)} text-gray-500 mr-2`}),e.jsx("label",{className:"text-sm font-medium text-gray-900",children:o.key.replace(/_/g," ").replace(/\b\w/g,a=>a.toUpperCase())})]}),e.jsx("p",{className:"text-sm text-gray-600 mb-3",children:o.description})]}),e.jsx("div",{className:"sm:w-64",children:v(o)})]},o.key))})]},c))}),e.jsx("div",{className:"mt-8 bg-blue-50 border border-blue-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx("i",{className:"ri-information-line text-blue-600 mr-2 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-blue-900 mb-1",children:"Informaci√≥n sobre los par√°metros"}),e.jsxs("ul",{className:"text-sm text-blue-800 space-y-1",children:[e.jsxs("li",{children:["‚Ä¢ ",e.jsx("strong",{children:"Demanda promedio d√≠a:"})," Valor por defecto para calcular el punto de reorden (ROP)"]}),e.jsxs("li",{children:["‚Ä¢ ",e.jsx("strong",{children:"Z-score safety:"})," Factor estad√≠stico para c√°lculo de stock de seguridad (1.65 = 90% confianza)"]}),e.jsxs("li",{children:["‚Ä¢ ",e.jsx("strong",{children:"Permitir stock negativo:"})," Si est√° deshabilitado, el sistema bloquear√° operaciones que resulten en stock negativo"]}),e.jsxs("li",{children:["‚Ä¢ ",e.jsx("strong",{children:"Auto generar alertas:"})," Crear alertas autom√°ticamente cuando se alcancen los umbrales"]}),e.jsxs("li",{children:["‚Ä¢ ",e.jsx("strong",{children:"D√≠as vencimiento alertas:"})," Tiempo despu√©s del cual las alertas se consideran obsoletas"]})]})]})]})}),e.jsxs("div",{className:"mt-8 flex justify-end space-x-3",children:[e.jsxs("button",{onClick:h,disabled:D,className:"px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50",children:[e.jsx("i",{className:"ri-refresh-line mr-2"}),"Recargar"]}),e.jsx("button",{onClick:q,disabled:D,className:"px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-lg hover:bg-blue-700 disabled:opacity-50",children:D?e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"ri-loader-4-line mr-2 animate-spin"}),"Guardando..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"ri-save-line mr-2"}),"Guardar Configuraci√≥n"]})})]})]})}function te(){const[l,f]=x.useState({rotacionInventario:0,valorInventarioTotal:0,articulosBajoMinimo:0,ordenesReabastecimiento:0,alertasActivas:0,eficienciaStock:0,costoAlmacenamiento:0,tiempoPromedioReposicion:0}),[k,L]=x.useState([]),[D,F]=x.useState(!0);x.useEffect(()=>{I(),$()},[]);const I=async()=>{try{const{data:b}=await y.from("inventario_niveles").select(`
          on_hand,
          inventario!inner(precio_unitario)
        `),v=b?.reduce((m,n)=>m+n.on_hand*n.inventario.precio_unitario,0)||0,{data:C}=await y.from("inventario_thresholds").select(`
          *,
          inventario_niveles!inner(disponible)
        `).lt("inventario_niveles.disponible","min_qty"),{data:N}=await y.from("inventario_alertas").select("*").eq("leida",!1),{data:S}=await y.from("replenishment_orders").select("*").in("estado",["borrador","emitida"]),c=new Date;c.setMonth(c.getMonth()-1);const{data:t}=await y.from("inventario_movimientos").select("cantidad, tipo").eq("tipo","venta").gte("created_at",c.toISOString()),o=t?.reduce((m,n)=>m+Math.abs(n.cantidad),0)||0,a=v>0?o*12/v:0,{data:d}=await y.from("inventario_thresholds").select(`
          *,
          inventario_niveles!inner(disponible)
        `),u=d?.filter(m=>m.inventario_niveles.disponible>=m.min_qty&&m.inventario_niveles.disponible<=m.max_qty).length||0,s=d?.length?u/d.length*100:0;f({rotacionInventario:a,valorInventarioTotal:v,articulosBajoMinimo:C?.length||0,ordenesReabastecimiento:S?.length||0,alertasActivas:N?.length||0,eficienciaStock:s,costoAlmacenamiento:v*.15,tiempoPromedioReposicion:7})}catch(b){console.error("Error cargando KPIs:",b)}},$=async()=>{try{const b=new Date;b.setDate(b.getDate()-30);const{data:v}=await y.from("inventario_movimientos").select(`
          created_at,
          cantidad,
          tipo,
          inventario!inner(precio_unitario)
        `).gte("created_at",b.toISOString()).order("created_at"),C=v?.reduce((S,c)=>{const t=new Date(c.created_at).toISOString().split("T")[0];S[t]||(S[t]={entradas:0,salidas:0,valor:0});const o=Math.abs(c.cantidad)*c.inventario.precio_unitario;return["compra","ajuste"].includes(c.tipo)&&c.cantidad>0?S[t].entradas+=Math.abs(c.cantidad):["venta","reserva"].includes(c.tipo)&&(S[t].salidas+=Math.abs(c.cantidad)),S[t].valor+=o,S},{})||{},N=Object.entries(C).map(([S,c])=>({fecha:S,...c})).sort((S,c)=>S.fecha.localeCompare(c.fecha));L(N)}catch(b){console.error("Error cargando tendencias:",b)}finally{F(!1)}},h=b=>new Intl.NumberFormat("es-CR",{style:"currency",currency:"CRC"}).format(b),q=(b,v=1)=>new Intl.NumberFormat("es-CR",{minimumFractionDigits:v,maximumFractionDigits:v}).format(b);return D?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Dashboard de KPIs"}),e.jsx("p",{className:"text-gray-600",children:"M√©tricas de rotaci√≥n y eficiencia del inventario"})]}),e.jsxs("button",{onClick:()=>{I(),$()},className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors",children:[e.jsx("i",{className:"ri-refresh-line mr-2"}),"Actualizar"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-sm border border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Rotaci√≥n Anual"}),e.jsxs("p",{className:"text-2xl font-bold text-gray-900",children:[q(l.rotacionInventario),"x"]})]}),e.jsx("div",{className:"w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center",children:e.jsx("i",{className:"ri-refresh-line text-blue-600 text-xl"})})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-2",children:l.rotacionInventario>6?"Excelente":l.rotacionInventario>3?"Bueno":"Mejorable"})]}),e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-sm border border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Valor Total"}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:h(l.valorInventarioTotal)})]}),e.jsx("div",{className:"w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center",children:e.jsx("i",{className:"ri-money-dollar-circle-line text-green-600 text-xl"})})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-2",children:"Inventario total"})]}),e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-sm border border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Eficiencia Stock"}),e.jsxs("p",{className:"text-2xl font-bold text-gray-900",children:[q(l.eficienciaStock),"%"]})]}),e.jsx("div",{className:"w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center",children:e.jsx("i",{className:"ri-speed-up-line text-purple-600 text-xl"})})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-2",children:l.eficienciaStock>80?"Excelente":l.eficienciaStock>60?"Bueno":"Cr√≠tico"})]}),e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-sm border border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Alertas Activas"}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:l.alertasActivas})]}),e.jsx("div",{className:`w-12 h-12 rounded-lg flex items-center justify-center ${l.alertasActivas>5?"bg-red-100":l.alertasActivas>0?"bg-yellow-100":"bg-green-100"}`,children:e.jsx("i",{className:`text-xl ${l.alertasActivas>5?"ri-alarm-warning-line text-red-600":l.alertasActivas>0?"ri-error-warning-line text-yellow-600":"ri-checkbox-circle-line text-green-600"}`})})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-2",children:"Requieren atenci√≥n"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-sm border border-gray-200",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Resumen de Stock"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-gray-600",children:"Art√≠culos bajo m√≠nimo"}),e.jsx("span",{className:"font-semibold text-red-600",children:l.articulosBajoMinimo})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-gray-600",children:"√ìrdenes pendientes"}),e.jsx("span",{className:"font-semibold text-blue-600",children:l.ordenesReabastecimiento})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-gray-600",children:"Tiempo promedio reposici√≥n"}),e.jsxs("span",{className:"font-semibold text-gray-900",children:[l.tiempoPromedioReposicion," d√≠as"]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-gray-600",children:"Costo almacenamiento anual"}),e.jsx("span",{className:"font-semibold text-gray-900",children:h(l.costoAlmacenamiento)})]})]})]}),e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-sm border border-gray-200",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Tendencia de Movimientos (30 d√≠as)"}),e.jsx("div",{className:"space-y-3",children:k.slice(-7).map((b,v)=>e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:new Date(b.fecha).toLocaleDateString("es-CR")}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"w-3 h-3 bg-green-500 rounded-full mr-2"}),e.jsx("span",{className:"text-sm text-gray-900",children:b.entradas})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"w-3 h-3 bg-red-500 rounded-full mr-2"}),e.jsx("span",{className:"text-sm text-gray-900",children:b.salidas})]}),e.jsx("span",{className:"text-sm font-medium text-gray-900",children:h(b.valor)})]})]},v))}),e.jsx("div",{className:"mt-4 pt-4 border-t border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"w-3 h-3 bg-green-500 rounded-full mr-2"}),e.jsx("span",{className:"text-gray-600",children:"Entradas"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"w-3 h-3 bg-red-500 rounded-full mr-2"}),e.jsx("span",{className:"text-gray-600",children:"Salidas"})]})]})})]})]}),e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-sm border border-gray-200",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Recomendaciones Inteligentes"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[l.rotacionInventario<3&&e.jsx("div",{className:"p-4 bg-yellow-50 border border-yellow-200 rounded-lg",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx("i",{className:"ri-lightbulb-line text-yellow-600 text-lg mr-3 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-yellow-800",children:"Mejorar Rotaci√≥n"}),e.jsx("p",{className:"text-sm text-yellow-700",children:"La rotaci√≥n est√° por debajo del promedio. Considera revisar pol√≠ticas de compra y promociones."})]})]})}),l.articulosBajoMinimo>5&&e.jsx("div",{className:"p-4 bg-red-50 border border-red-200 rounded-lg",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx("i",{className:"ri-alarm-warning-line text-red-600 text-lg mr-3 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-red-800",children:"Stock Cr√≠tico"}),e.jsx("p",{className:"text-sm text-red-700",children:"M√∫ltiples art√≠culos bajo m√≠nimo. Generar √≥rdenes de reabastecimiento urgente."})]})]})}),l.eficienciaStock>85&&e.jsx("div",{className:"p-4 bg-green-50 border border-green-200 rounded-lg",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx("i",{className:"ri-checkbox-circle-line text-green-600 text-lg mr-3 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-green-800",children:"Excelente Gesti√≥n"}),e.jsx("p",{className:"text-sm text-green-700",children:"La eficiencia de stock es excelente. Mantener las pol√≠ticas actuales."})]})]})}),l.ordenesReabastecimiento===0&&l.articulosBajoMinimo>0&&e.jsx("div",{className:"p-4 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx("i",{className:"ri-truck-line text-blue-600 text-lg mr-3 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-blue-800",children:"Generar √ìrdenes"}),e.jsx("p",{className:"text-sm text-blue-700",children:"Hay art√≠culos bajo m√≠nimo sin √≥rdenes de reabastecimiento. Generar autom√°ticamente."})]})]})})]})]})]})}function ae(){const[l,f]=x.useState([]),[k,L]=x.useState(!0),[D,F]=x.useState("todas"),[I,$]=x.useState("demanda");x.useEffect(()=>{h()},[]);const h=async()=>{try{L(!0);const a=new Date;a.setMonth(a.getMonth()-6);const{data:d}=await y.from("inventario_movimientos").select(`
          articulo_id,
          cantidad,
          created_at,
          inventario!inner(codigo_articulo, descripcion_articulo)
        `).eq("tipo","venta").gte("created_at",a.toISOString()).order("created_at");if(!d||d.length===0){f([]);return}const u=new Map;d.forEach(m=>{const n=m.articulo_id;u.has(n)||u.set(n,{articulo_id:n,codigo_articulo:m.inventario.codigo_articulo,descripcion_articulo:m.inventario.descripcion_articulo,movimientos:[]}),u.get(n).movimientos.push({cantidad:Math.abs(m.cantidad),fecha:new Date(m.created_at)})});const s=[];for(const[m,n]of u){const w=q(n);w&&s.push(w)}f(s)}catch(a){console.error("Error calculando predicciones:",a)}finally{L(!1)}},q=a=>{const d=a.movimientos;if(d.length<3)return null;const u=b(d);if(u.length<4)return null;const{pendiente:s,r2:m}=v(u);C(u,4);const n=u.reduce((p,A)=>p+A,0)/u.length;N(u);const w=Math.max(0,(n+s*4)*4.33),_=Math.max(0,(n+s*8)*4.33*2),T=Math.max(0,(n+s*12)*4.33*3);let M="estable";Math.abs(s)>n*.1&&(M=s>0?"creciente":"decreciente");const E=Math.min(95,Math.max(30,m*100*(d.length/20))),g=Math.ceil(w/4*2*1.5),j=Math.ceil(_/2);return{articulo_id:a.articulo_id,codigo_articulo:a.codigo_articulo,descripcion_articulo:a.descripcion_articulo,demanda_historica:u,prediccion_30_dias:Math.round(w),prediccion_60_dias:Math.round(_),prediccion_90_dias:Math.round(T),tendencia:M,confianza:Math.round(E),rop_sugerido:g,max_sugerido:j}},b=a=>{const d=new Map;return a.forEach(u=>{const s=new Date(u.fecha),m=new Date(s);m.setDate(s.getDate()-s.getDay());const n=m.toISOString().split("T")[0];d.set(n,(d.get(n)||0)+u.cantidad)}),Array.from(d.values()).sort()},v=a=>{const d=a.length,u=a.map((j,p)=>p),s=a,m=u.reduce((j,p)=>j+p,0),n=s.reduce((j,p)=>j+p,0),w=u.reduce((j,p,A)=>j+p*s[A],0),_=u.reduce((j,p)=>j+p*p,0),T=(d*w-m*n)/(d*_-m*m),M=(n-T*m)/d,E=n/d,i=s.reduce((j,p)=>j+Math.pow(p-E,2),0),g=1-s.reduce((j,p,A)=>j+Math.pow(p-(T*u[A]+M),2),0)/i;return{pendiente:T,intercepto:M,r2:Math.max(0,g)}},C=(a,d)=>{const u=[];for(let s=d-1;s<a.length;s++){const m=a.slice(s-d+1,s+1).reduce((n,w)=>n+w,0);u.push(m/d)}return u},N=a=>{const d=a.reduce((s,m)=>s+m,0)/a.length,u=a.reduce((s,m)=>s+Math.pow(m-d,2),0)/a.length;return Math.sqrt(u)},S=async a=>{try{const{error:d}=await y.from("inventario_thresholds").upsert({articulo_id:a.articulo_id,min_qty:Math.ceil(a.rop_sugerido*.7),max_qty:a.max_sugerido,safety_stock:Math.ceil(a.rop_sugerido*.3),reorder_point:a.rop_sugerido,lead_time_dias:14,activo:!0},{onConflict:"articulo_id"});d?(console.error("Error aplicando umbrales:",d),alert("Error al aplicar umbrales sugeridos")):(alert("Umbrales aplicados exitosamente"),h())}catch(d){console.error("Error aplicando umbrales:",d)}},c=l.filter(a=>D==="todas"||a.tendencia===D).sort((a,d)=>{switch(I){case"demanda":return d.prediccion_30_dias-a.prediccion_30_dias;case"confianza":return d.confianza-a.confianza;case"tendencia":return a.tendencia.localeCompare(d.tendencia);default:return 0}}),t=a=>{switch(a){case"creciente":return"ri-arrow-up-line text-green-600";case"decreciente":return"ri-arrow-down-line text-red-600";default:return"ri-arrow-right-line text-gray-600"}},o=a=>a>=80?"text-green-600 bg-green-100":a>=60?"text-yellow-600 bg-yellow-100":"text-red-600 bg-red-100";return k?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Predicci√≥n de Demanda"}),e.jsx("p",{className:"text-gray-600",children:"An√°lisis predictivo basado en machine learning"})]}),e.jsxs("button",{onClick:h,className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors",children:[e.jsx("i",{className:"ri-refresh-line mr-2"}),"Recalcular"]})]}),e.jsx("div",{className:"bg-white p-4 rounded-lg shadow-sm border border-gray-200",children:e.jsxs("div",{className:"flex flex-wrap gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Filtrar por tendencia"}),e.jsxs("select",{value:D,onChange:a=>F(a.target.value),className:"border border-gray-300 rounded-lg px-3 py-2 text-sm",children:[e.jsx("option",{value:"todas",children:"Todas"}),e.jsx("option",{value:"creciente",children:"Creciente"}),e.jsx("option",{value:"estable",children:"Estable"}),e.jsx("option",{value:"decreciente",children:"Decreciente"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Ordenar por"}),e.jsxs("select",{value:I,onChange:a=>$(a.target.value),className:"border border-gray-300 rounded-lg px-3 py-2 text-sm",children:[e.jsx("option",{value:"demanda",children:"Demanda predicha"}),e.jsx("option",{value:"confianza",children:"Confianza"}),e.jsx("option",{value:"tendencia",children:"Tendencia"})]})]})]})}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden",children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Art√≠culo"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Tendencia"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Predicci√≥n 30d"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Predicci√≥n 60d"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Predicci√≥n 90d"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Confianza"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"ROP Sugerido"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Acciones"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:c.map(a=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:a.codigo_articulo}),e.jsx("div",{className:"text-sm text-gray-500",children:a.descripcion_articulo})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("i",{className:`${t(a.tendencia)} mr-2`}),e.jsx("span",{className:"text-sm text-gray-900 capitalize",children:a.tendencia})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:a.prediccion_30_dias.toLocaleString()}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:a.prediccion_60_dias.toLocaleString()}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:a.prediccion_90_dias.toLocaleString()}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("span",{className:`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${o(a.confianza)}`,children:[a.confianza,"%"]})}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[e.jsxs("div",{className:"text-sm text-gray-900",children:["ROP: ",a.rop_sugerido]}),e.jsxs("div",{className:"text-sm text-gray-500",children:["Max: ",a.max_sugerido]})]}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium",children:[e.jsx("button",{onClick:()=>S(a),className:"text-blue-600 hover:text-blue-900 mr-3",title:"Aplicar umbrales sugeridos",children:e.jsx("i",{className:"ri-check-line"})}),e.jsx("button",{className:"text-gray-600 hover:text-gray-900",title:"Ver detalles",children:e.jsx("i",{className:"ri-eye-line"})})]})]},a.articulo_id))})]})}),c.length===0&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx("i",{className:"ri-bar-chart-line text-4xl text-gray-400 mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No hay predicciones disponibles"}),e.jsx("p",{className:"text-gray-500",children:"Se necesitan al menos 3 movimientos de venta en los √∫ltimos 6 meses para generar predicciones."})]})]}),e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx("i",{className:"ri-information-line text-blue-600 text-lg mr-3 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-blue-800 mb-2",children:"Sobre las Predicciones"}),e.jsxs("div",{className:"text-sm text-blue-700 space-y-1",children:[e.jsx("p",{children:"‚Ä¢ Las predicciones se basan en an√°lisis de regresi√≥n lineal de datos hist√≥ricos"}),e.jsx("p",{children:"‚Ä¢ Se requieren al menos 4 semanas de datos de ventas para generar predicciones confiables"}),e.jsx("p",{children:"‚Ä¢ La confianza se calcula basada en la correlaci√≥n (R¬≤) y cantidad de datos disponibles"}),e.jsx("p",{children:"‚Ä¢ Los umbrales sugeridos incluyen factores de seguridad y lead time estimado"})]})]})]})})]})}function re({onNuevaNotificacion:l}){const[f,k]=x.useState([]),[L,D]=x.useState(!1),[F,I]=x.useState(0);x.useEffect(()=>{$();const t=y.channel("inventario_changes").on("postgres_changes",{event:"INSERT",schema:"public",table:"inventario_alertas"},o=>{h(o.new)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"inventario_niveles"},o=>{q(o.new,o.old)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"replenishment_orders"},o=>{b(o.new,o.old)}).subscribe();return()=>{t.unsubscribe()}},[]);const $=async()=>{try{const{data:t}=await y.from("inventario_alertas").select(`
          *,
          inventario!inner(codigo_articulo, descripcion_articulo)
        `).order("created_at",{ascending:!1}).limit(10),o=t?.map(a=>({id:`alerta_${a.id}`,tipo:"nueva_alerta",titulo:v(a.tipo),mensaje:`${a.inventario.codigo_articulo} - ${a.inventario.descripcion_articulo}`,timestamp:a.created_at,leida:a.leida,datos:a}))||[];k(o),I(o.filter(a=>!a.leida).length)}catch(t){console.error("Error cargando notificaciones:",t)}},h=async t=>{try{const{data:o}=await y.from("inventario").select("codigo_articulo, descripcion_articulo").eq("Id_Articulo",t.articulo_id).single();if(!o)return;const a={id:`alerta_${t.id}`,tipo:"nueva_alerta",titulo:v(t.tipo),mensaje:`${o.codigo_articulo} - ${o.descripcion_articulo}`,timestamp:t.created_at,leida:!1,datos:t};k(d=>[a,...d.slice(0,9)]),I(d=>d+1),"Notification"in window&&Notification.permission==="granted"&&new Notification(a.titulo,{body:a.mensaje,icon:"/favicon.ico",tag:a.id}),l&&l(a)}catch(o){console.error("Error procesando nueva alerta:",o)}},q=async(t,o)=>{if(t.disponible<=0&&o.disponible>0){const{data:a}=await y.from("inventario").select("codigo_articulo, descripcion_articulo").eq("Id_Articulo",t.articulo_id).single();if(a){const d={id:`stock_critico_${t.articulo_id}_${Date.now()}`,tipo:"stock_critico",titulo:"üî¥ Stock Agotado",mensaje:`${a.codigo_articulo} se ha quedado sin stock`,timestamp:new Date().toISOString(),leida:!1,datos:{nivel:t,inventario:a}};k(u=>[d,...u.slice(0,9)]),I(u=>u+1)}}},b=(t,o)=>{if(t.estado==="completada"&&o.estado!=="completada"){const a={id:`orden_completada_${t.id}`,tipo:"orden_completada",titulo:"‚úÖ Orden Completada",mensaje:`Orden de reabastecimiento #${t.id} completada`,timestamp:new Date().toISOString(),leida:!1,datos:t};k(d=>[a,...d.slice(0,9)]),I(d=>d+1)}},v=t=>{switch(t){case"stockout":return"üî¥ Sin Stock";case"below_min":return"üü† Bajo M√≠nimo";case"below_rop":return"üü° Bajo ROP";default:return"‚ö†Ô∏è Alerta"}},C=async t=>{try{const o=f.find(a=>a.id===t);if(!o||o.leida)return;o.tipo==="nueva_alerta"&&o.datos&&await y.from("inventario_alertas").update({leida:!0}).eq("id",o.datos.id),k(a=>a.map(d=>d.id===t?{...d,leida:!0}:d)),I(a=>Math.max(0,a-1))}catch(o){console.error("Error marcando notificaci√≥n como le√≠da:",o)}},N=async()=>{try{const t=f.filter(o=>o.tipo==="nueva_alerta"&&!o.leida&&o.datos).map(o=>o.datos.id);t.length>0&&await y.from("inventario_alertas").update({leida:!0}).in("id",t),k(o=>o.map(a=>({...a,leida:!0}))),I(0)}catch(t){console.error("Error marcando todas como le√≠das:",t)}},S=async()=>{"Notification"in window&&Notification.permission==="default"&&await Notification.requestPermission()==="granted"&&new Notification("Notificaciones activadas",{body:"Ahora recibir√°s alertas de inventario en tiempo real",icon:"/favicon.ico"})},c=t=>{const o=new Date(t),d=new Date().getTime()-o.getTime(),u=Math.floor(d/(1e3*60)),s=Math.floor(d/(1e3*60*60)),m=Math.floor(d/(1e3*60*60*24));return u<1?"Ahora":u<60?`${u}m`:s<24?`${s}h`:`${m}d`};return e.jsxs("div",{className:"relative",children:[e.jsxs("button",{onClick:()=>D(!L),className:"relative p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors",children:[e.jsx("i",{className:"ri-notification-line text-xl"}),F>0&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center",children:F>9?"9+":F})]}),L&&e.jsxs("div",{className:"absolute right-0 top-full mt-2 w-80 bg-white rounded-lg shadow-lg border border-gray-200 z-50",children:[e.jsx("div",{className:"p-4 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:"Notificaciones"}),e.jsxs("div",{className:"flex items-center space-x-2",children:["Notification"in window&&Notification.permission==="default"&&e.jsx("button",{onClick:S,className:"text-xs text-blue-600 hover:text-blue-700",title:"Activar notificaciones push",children:e.jsx("i",{className:"ri-notification-off-line"})}),F>0&&e.jsx("button",{onClick:N,className:"text-xs text-blue-600 hover:text-blue-700",children:"Marcar todas"}),e.jsx("button",{onClick:()=>D(!1),className:"text-gray-400 hover:text-gray-600",children:e.jsx("i",{className:"ri-close-line"})})]})]})}),e.jsx("div",{className:"max-h-96 overflow-y-auto",children:f.length===0?e.jsxs("div",{className:"p-4 text-center text-gray-500",children:[e.jsx("i",{className:"ri-notification-off-line text-2xl mb-2"}),e.jsx("p",{children:"No hay notificaciones"})]}):f.map(t=>e.jsx("div",{className:`p-4 border-b border-gray-100 hover:bg-gray-50 cursor-pointer ${t.leida?"":"bg-blue-50"}`,onClick:()=>C(t.id),children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{className:"text-sm font-medium text-gray-900",children:t.titulo}),!t.leida&&e.jsx("span",{className:"ml-2 w-2 h-2 bg-blue-500 rounded-full"})]}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:t.mensaje})]}),e.jsx("span",{className:"text-xs text-gray-400 ml-2",children:c(t.timestamp)})]})},t.id))}),f.length>0&&e.jsx("div",{className:"p-3 border-t border-gray-200 text-center",children:e.jsx("button",{onClick:()=>{D(!1)},className:"text-sm text-blue-600 hover:text-blue-700",children:"Ver todas las notificaciones"})})]})]})}function ce(){const[l,f]=x.useState("umbrales"),[k,L]=x.useState(!0),[D,F]=x.useState([]),[I,$]=x.useState([]),[h,q]=x.useState([]);x.useEffect(()=>{b()},[]);const b=async()=>{try{L(!0),await Promise.all([v(),C(),N()])}catch(c){console.error("Error cargando datos:",c)}finally{L(!1)}},v=async()=>{const{data:c,error:t}=await y.from("inventario_thresholds").select(`
        *,
        inventario!inner(codigo_articulo, descripcion_articulo)
      `).eq("activo",!0).order("created_at",{ascending:!1});if(t){console.error("Error cargando umbrales:",t);return}F(c||[])},C=async()=>{const{data:c,error:t}=await y.from("inventario_alertas").select(`
        *,
        inventario!inner(codigo_articulo, descripcion_articulo)
      `).order("created_at",{ascending:!1});if(t){console.error("Error cargando alertas:",t);return}$(c||[])},N=async()=>{const{data:c,error:t}=await y.from("replenishment_orders").select(`
        *,
        inventario!inner(codigo_articulo, descripcion_articulo),
        usuarios!inner(nombre_completo)
      `).order("created_at",{ascending:!1});if(t){console.error("Error cargando √≥rdenes:",t);return}q(c||[])},S=()=>{if(k&&["umbrales","alertas","reabastecimiento"].includes(l))return e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})});switch(l){case"umbrales":return e.jsx(B,{thresholds:D,onRefresh:v});case"alertas":return e.jsx(Z,{alertas:I,onRefresh:C});case"reabastecimiento":return e.jsx(J,{replenishments:h,onUpdate:N});case"kpis":return e.jsx(te,{});case"prediccion":return e.jsx(ae,{});case"configuracion":return e.jsx(ee,{});default:return e.jsx(B,{thresholds:D,onRefresh:v})}};return e.jsxs(Q,{vistaActual:l,onCambiarVista:f,children:[e.jsx("div",{className:"fixed top-4 right-4 z-50",children:e.jsx(re,{})}),S()]})}export{ce as default};
//# sourceMappingURL=page-Ds5pa83_.js.map
