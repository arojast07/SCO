import{r as i,a as A,u as O,d as k,j as e,s as g,L as E}from"./index-Xz42BvxI.js";function $(){const[m,p]=i.useState(""),[f,v]=i.useState(""),[h,u]=i.useState(""),[o,l]=i.useState([]),[j,y]=i.useState(!1),[w,s]=i.useState(""),[N,t]=i.useState(!1),{signIn:L,isAuthenticated:S,loading:x}=A(),P=O(),b=k().state?.from?.pathname||"/dashboard";i.useEffect(()=>{S&&!x&&P(b,{replace:!0})},[S,x,P,b]);const C=async r=>{try{y(!0),console.log("üè™ [LoginPage] Cargando tiendas del usuario:",r);const{data:a,error:n}=await g.from("usuario_tiendas").select("tienda_id, tiendas(id, nombre, codigo, activo)").eq("usuario_id",r).eq("activo",!0);if(n){console.error("‚ùå [LoginPage] Error cargando tiendas del usuario:",n),s("Error al cargar tus tiendas. Intenta nuevamente."),l([]);return}const c=(a||[]).filter(d=>d.tiendas&&d.tiendas.activo).map(d=>({id:d.tiendas.id,nombre:d.tiendas.nombre,codigo:d.tiendas.codigo}));console.log("‚úÖ [LoginPage] Tiendas del usuario cargadas:",c.length),l(c),c.length===1&&(u(c[0].id),console.log("‚úÖ [LoginPage] Auto-seleccionada √∫nica tienda:",c[0].nombre))}catch(a){console.error("‚ùå [LoginPage] Error en loadUserStores:",a),s("Error al cargar tus tiendas. Intenta nuevamente."),l([])}finally{y(!1)}},I=async r=>{if(r.preventDefault(),s(""),o.length===0){t(!0);try{console.log("üîê [LoginPage] PASO 1: Autenticando para obtener tiendas...");const{data:a,error:n}=await g.auth.signInWithPassword({email:m,password:f});if(n){console.error("‚ùå [LoginPage] Error de autenticaci√≥n:",n),n.message?.includes("Invalid login credentials")?s("Email o contrase√±a incorrectos"):n.message?.includes("Email not confirmed")?s("Tu cuenta a√∫n no ha sido confirmada. Por favor revisa tu correo electr√≥nico y haz clic en el enlace de confirmaci√≥n. Si no recibiste el correo, contacta al administrador."):n.message?.includes("Email link is invalid or has expired")?s("El enlace de confirmaci√≥n ha expirado. Por favor solicita un nuevo enlace de confirmaci√≥n."):n.message?.includes("User not found")?s("No existe una cuenta con este correo electr√≥nico"):s(`Error al iniciar sesi√≥n: ${n.message||"Intenta nuevamente"}`),t(!1);return}if(!a.session?.user){s("Error al iniciar sesi√≥n. Intenta nuevamente."),t(!1);return}console.log("‚úÖ [LoginPage] Autenticaci√≥n exitosa, cargando tiendas..."),await C(a.session.user.id),t(!1),o.length===0&&(s("No tienes tiendas asignadas. Contacta al administrador."),await g.auth.signOut());return}catch(a){console.error("‚ùå [LoginPage] Error inesperado en PASO 1:",a),s(`Error inesperado: ${a?.message||"Intenta nuevamente"}`),t(!1);return}}if(!h){s("Por favor selecciona una tienda");return}t(!0);try{console.log("üîê [LoginPage] PASO 2: Completando login con tienda seleccionada...");const{error:a}=await L(m,f,h);a?(console.error("‚ùå [LoginPage] Error de login:",a),s(`Error al iniciar sesi√≥n: ${a.message||"Intenta nuevamente"}`),t(!1),a.message?.includes("No tienes acceso")&&(l([]),u(""))):console.log("‚úÖ [LoginPage] Login exitoso, redirigiendo a:",b)}catch(a){console.error("‚ùå [LoginPage] Error inesperado en PASO 2:",a),s(`Error inesperado: ${a?.message||"Intenta nuevamente"}`),t(!1)}};return x?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Verificando sesi√≥n..."})]})}):e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4",children:e.jsxs("div",{className:"max-w-md w-full space-y-8",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"mx-auto h-20 w-20 mb-4 flex items-center justify-center",children:e.jsx("img",{src:"https://static.readdy.ai/image/96746b7ba583c55b81aa58d37fd022fd/8044848901197a0577b8befd634c6da9.png",alt:"Logo del Sistema",className:"h-16 w-auto object-contain"})}),e.jsx("h2",{className:"text-3xl font-bold text-gray-900 mb-2",children:"SCO"}),e.jsx("p",{className:"text-gray-600",children:"Ingresa a tu cuenta para continuar"})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-8",children:[e.jsxs("form",{onSubmit:I,className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"email",className:"block text-sm font-medium text-gray-700 mb-2",children:"Correo electr√≥nico"}),e.jsx("input",{id:"email",name:"email",type:"email",autoComplete:"email",required:!0,value:m,onChange:r=>p(r.target.value),disabled:o.length>0,className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 disabled:bg-gray-100 disabled:cursor-not-allowed",placeholder:"tu@email.com"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"password",className:"block text-sm font-medium text-gray-700 mb-2",children:"Contrase√±a"}),e.jsx("input",{id:"password",name:"password",type:"password",autoComplete:"current-password",required:!0,value:f,onChange:r=>v(r.target.value),disabled:o.length>0,className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 disabled:bg-gray-100 disabled:cursor-not-allowed",placeholder:"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"})]}),o.length>0&&e.jsxs("div",{children:[e.jsx("label",{htmlFor:"store",className:"block text-sm font-medium text-gray-700 mb-2",children:"Selecciona tu tienda"}),j?e.jsx("div",{className:"w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50 text-gray-500",children:"Cargando tus tiendas..."}):e.jsxs("select",{id:"store",name:"store",required:!0,value:h,onChange:r=>u(r.target.value),className:"w-full px-3 py-2 pr-8 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500",children:[e.jsx("option",{value:"",children:"Selecciona una tienda"}),o.map(r=>e.jsxs("option",{value:r.id,children:[r.nombre," (",r.codigo,")"]},r.id))]}),e.jsx("button",{type:"button",onClick:async()=>{await g.auth.signOut(),l([]),u(""),p(""),v(""),s("")},className:"mt-2 text-sm text-indigo-600 hover:text-indigo-500",children:"‚Üê Usar otra cuenta"})]}),w&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-md p-3",children:e.jsx("p",{className:"text-sm text-red-600",children:w})}),o.length===0&&e.jsx("div",{className:"flex items-center justify-between",children:e.jsx(E,{to:"/auth/forgot-password",className:"text-sm text-indigo-600 hover:text-indigo-500",children:"¬øOlvidaste tu contrase√±a?"})}),e.jsx("button",{type:"submit",disabled:N||j,className:"w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed whitespace-nowrap",children:N?e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),o.length===0?"Verificando...":"Iniciando sesi√≥n..."]}):o.length===0?"Continuar":"Iniciar sesi√≥n"})]}),e.jsx("div",{className:"mt-6 text-center",children:e.jsxs("p",{className:"text-sm text-gray-600",children:["¬øNo tienes una cuenta?"," ",e.jsx(E,{to:"/auth/register",className:"font-medium text-indigo-600 hover:text-indigo-500",children:"Reg√≠strate aqu√≠"})]})})]})]})})}export{$ as default};
//# sourceMappingURL=LoginPage-GHSYpJTx.js.map
