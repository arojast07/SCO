import{s as i}from"./index-Bb3NupjY.js";class d{baseUrlSandbox="https://api.comprobanteselectronicos.go.cr/recepcion-sandbox/v1";baseUrlProduccion="https://api.comprobanteselectronicos.go.cr/recepcion/v1";idpUrlSandbox="https://idp.comprobanteselectronicos.go.cr/auth/realms/rut-stag/protocol/openid-connect/token";idpUrlProduccion="https://idp.comprobanteselectronicos.go.cr/auth/realms/rut/protocol/openid-connect/token";async getSettings(){try{const{data:o,error:e}=await i.from("settings").select("value").eq("key","hacienda_config").single();return e?(console.error("Error obteniendo configuración:",e),null):o?.value?typeof o.value=="string"?JSON.parse(o.value):o.value:null}catch(o){return console.error("Error parseando configuración:",o),null}}async saveSettings(o){try{const{error:e}=await i.from("settings").upsert({key:"hacienda_config",value:JSON.stringify(o),updated_at:new Date().toISOString()});if(e)throw e;return!0}catch(e){return console.error("Error guardando configuración:",e),!1}}async testConnection(){try{const o=await this.getSettings();return o?await this.getAccessToken(o)?{success:!0,message:"Conexión exitosa con Hacienda"}:{success:!1,message:"Error obteniendo token de acceso"}:{success:!1,message:"No hay configuración de Hacienda"}}catch(o){return{success:!1,message:`Error: ${o}`}}}async getAccessToken(o){try{const e=o.ambiente==="sandbox"?this.idpUrlSandbox:this.idpUrlProduccion,t=await fetch(e,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"password",client_id:"api-prod",username:o.usuario_idp,password:o.password_idp_encrypted,scope:"openid"})});if(!t.ok)throw new Error(`Error HTTP: ${t.status}`);return(await t.json()).access_token}catch(e){return console.error("Error obteniendo token:",e),null}}async getNextConsecutivo(o,e="001",t="00001"){try{const{data:n,error:r}=await i.rpc("get_next_consecutivo",{p_tipo_documento:o,p_sucursal:e,p_terminal:t});if(r)throw r;const a=n.toString().padStart(10,"0");return`${e}${t}${o}${a}`}catch(n){throw console.error("Error obteniendo consecutivo:",n),n}}generateClave(o="506",e,t,n,r,a,c="1",s="12345678"){return`${o}${e}${t}${n}${r}${a}${c}${s}`}async generateXML(o,e){const t=new Date(o.fecha_emision),n=t.toISOString();if(!o.clave){const a=t.getDate().toString().padStart(2,"0"),c=(t.getMonth()+1).toString().padStart(2,"0"),s=t.getFullYear().toString().slice(-2);o.clave=this.generateClave("506",a,c,s,e.cedula_emisor,o.consecutivo,"1",Math.random().toString().slice(2,10))}return`<?xml version="1.0" encoding="UTF-8"?>
<FacturaElectronica xmlns="https://cdn.comprobanteselectronicos.go.cr/xml-schemas/v4.3/facturaElectronica" 
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
                   xsi:schemaLocation="https://cdn.comprobanteselectronicos.go.cr/xml-schemas/v4.3/facturaElectronica https://www.hacienda.go.cr/ATV/ComprobanteElectronico/docs/esquemas/2016/v4.3/FacturaElectronica_V4.3.xsd">
  <Clave>${o.clave}</Clave>
  <CodigoActividad>${e.codigo_actividad_economica}</CodigoActividad>
  <NumeroConsecutivo>${o.consecutivo}</NumeroConsecutivo>
  <FechaEmision>${n}</FechaEmision>
  <Emisor>
    <Nombre>OLO</Nombre>
    <Identificacion>
      <Tipo>02</Tipo>
      <Numero>${e.cedula_emisor}</Numero>
    </Identificacion>
    <Ubicacion>
      <Provincia>1</Provincia>
      <Canton>01</Canton>
      <Distrito>01</Distrito>
      <OtrasSenas>San José, Costa Rica</OtrasSenas>
    </Ubicacion>
    <Telefono>
      <CodigoPais>506</CodigoPais>
      <NumTelefono>22052525</NumTelefono>
    </Telefono>
    <CorreoElectronico>info@olo.cr</CorreoElectronico>
  </Emisor>
  <Receptor>
    <Nombre>${o.cliente?.razon_social||o.cliente?.nombre_completo||"Cliente"}</Nombre>
    <Identificacion>
      <Tipo>01</Tipo>
      <Numero>${o.cliente?.identificacion||"000000000"}</Numero>
    </Identificacion>
    <Ubicacion>
      <Provincia>1</Provincia>
      <Canton>01</Canton>
      <Distrito>01</Distrito>
      <OtrasSenas>${o.cliente?.direccion||"San José, Costa Rica"}</OtrasSenas>
    </Ubicacion>
    <Telefono>
      <CodigoPais>506</CodigoPais>
      <NumTelefono>${o.cliente?.telefono||"00000000"}</NumTelefono>
    </Telefono>
    <CorreoElectronico>${o.cliente?.correo||"cliente@ejemplo.com"}</CorreoElectronico>
  </Receptor>
  <CondicionVenta>${o.condicion_venta}</CondicionVenta>
  ${o.plazo_credito>0?`<PlazoCredito>${o.plazo_credito}</PlazoCredito>`:""}
  <MedioPago>${o.medio_pago}</MedioPago>
  <DetalleServicio>
    ${o.lineas?.map((a,c)=>`
    <LineaDetalle>
      <NumeroLinea>${c+1}</NumeroLinea>
      <Codigo>
        <Tipo>01</Tipo>
        <Codigo>${a.codigo_articulo||"SIN-CODIGO"}</Codigo>
      </Codigo>
      <Cantidad>${a.cantidad}</Cantidad>
      <UnidadMedida>${a.unidad_medida}</UnidadMedida>
      <Detalle>${a.descripcion}</Detalle>
      <PrecioUnitario>${a.precio_unitario}</PrecioUnitario>
      <MontoTotal>${a.total_linea}</MontoTotal>
      ${a.descuento_monto>0?`
      <Descuento>
        <MontoDescuento>${a.descuento_monto}</MontoDescuento>
        <NaturalezaDescuento>Descuento comercial</NaturalezaDescuento>
      </Descuento>`:""}
      <SubTotal>${a.subtotal_linea}</SubTotal>
      ${a.impuesto_monto>0?`
      <Impuesto>
        <Codigo>01</Codigo>
        <CodigoTarifa>08</CodigoTarifa>
        <Tarifa>${a.impuesto_porcentaje}</Tarifa>
        <Monto>${a.impuesto_monto}</Monto>
      </Impuesto>`:""}
      <MontoTotalLinea>${a.total_linea}</MontoTotalLinea>
    </LineaDetalle>`).join("")}
  </DetalleServicio>
  ${o.referencia_clave?`
  <InformacionReferencia>
    <TipoDoc>${o.tipo_documento}</TipoDoc>
    <Numero>${o.referencia_clave}</Numero>
    <FechaEmision>${n}</FechaEmision>
    <Codigo>${o.referencia_codigo}</Codigo>
    <Razon>${o.referencia_razon}</Razon>
  </InformacionReferencia>`:""}
  <ResumenFactura>
    <CodigoTipoMoneda>
      <CodigoMoneda>${o.moneda}</CodigoMoneda>
      <TipoCambio>${o.tipo_cambio}</TipoCambio>
    </CodigoTipoMoneda>
    <TotalServGravados>${o.subtotal}</TotalServGravados>
    <TotalServExentos>0.00</TotalServExentos>
    <TotalServExonerados>0.00</TotalServExonerados>
    <TotalMercanciasGravadas>0.00</TotalMercanciasGravadas>
    <TotalMercanciasExentas>0.00</TotalMercanciasExentas>
    <TotalMercanciasExoneradas>0.00</TotalMercanciasExoneradas>
    <TotalGravado>${o.subtotal}</TotalGravado>
    <TotalExento>0.00</TotalExento>
    <TotalExonerado>0.00</TotalExonerado>
    <TotalVenta>${o.subtotal}</TotalVenta>
    ${o.descuento_total>0?`
    <TotalDescuentos>${o.descuento_total}</TotalDescuentos>`:""}
    <TotalVentaNeta>${o.subtotal-o.descuento_total}</TotalVentaNeta>
    <TotalImpuesto>${o.impuesto_total}</TotalImpuesto>
    <TotalIVADevuelto>0.00</TotalIVADevuelto>
    <TotalOtrosCargos>0.00</TotalOtrosCargos>
    <TotalComprobante>${o.total}</TotalComprobante>
  </ResumenFactura>
</FacturaElectronica>`}async signXML(o,e){try{return btoa(unescape(encodeURIComponent(o)))}catch(t){throw console.error("Error firmando XML:",t),t}}async sendToHacienda(o,e){try{const t=await this.getSettings();if(!t)throw new Error("No hay configuración de Hacienda");const n=await this.getAccessToken(t);if(!n)throw new Error("No se pudo obtener token de acceso");const r=t.ambiente==="sandbox"?this.baseUrlSandbox:this.baseUrlProduccion,a={clave:o.clave,fecha:o.fecha_emision,emisor:{tipoIdentificacion:"02",numeroIdentificacion:t.cedula_emisor},receptor:{tipoIdentificacion:"01",numeroIdentificacion:o.cliente?.identificacion||"000000000"},comprobanteXml:e},c=await fetch(`${r}/recepcion`,{method:"POST",headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json"},body:JSON.stringify(a)}),s={factura_id:o.id,tipo_envio:"factura",request_payload:JSON.stringify(a),response_payload:await c.text(),status_code:c.status,location_header:c.headers.get("Location")||void 0,estado:c.ok?"enviado":"error",intentos:1,ultimo_intento:new Date().toISOString(),created_at:new Date().toISOString()};return await i.from("hacienda_envios").insert(s),s}catch(t){throw console.error("Error enviando a Hacienda:",t),t}}async consultarEstado(o){try{const e=await this.getSettings();if(!e)return null;const t=await this.getAccessToken(e);if(!t)return null;const n=e.ambiente==="sandbox"?this.baseUrlSandbox:this.baseUrlProduccion,r=await fetch(`${n}/recepcion/${o}`,{headers:{Authorization:`Bearer ${t}`}});return r.ok?await r.json():null}catch(e){return console.error("Error consultando estado:",e),null}}async saveFactura(o){try{const{data:e,error:t}=await i.from("facturas_electronicas").insert(o).select("id,numero_consecutivo,clave_numerica,estado,total_general,notas").single();if(t)throw t;return e}catch(e){return console.error("Error guardando factura:",e),null}}async updateFactura(o,e){try{const{error:t}=await i.from("facturas_electronicas").update({...e,updated_at:new Date().toISOString()}).eq("id",o).select("id,consecutivo,clave,estado_hacienda");return!t}catch(t){return console.error("Error actualizando factura:",t),!1}}async getFacturas(o){try{let e=i.from("facturas_electronicas").select(`
          *,
          cliente:clientes(*),
          lineas:factura_items(*)
        `).order("created_at",{ascending:!1});o?.fecha_desde&&(e=e.gte("fecha_emision",o.fecha_desde)),o?.fecha_hasta&&(e=e.lte("fecha_emision",o.fecha_hasta)),o?.estado_local&&(e=e.eq("estado_local",o.estado_local)),o?.cliente_id&&(e=e.eq("cliente_id",o.cliente_id));const{data:t,error:n}=await e;if(n)throw n;return t||[]}catch(e){return console.error("Error obteniendo facturas:",e),[]}}async getFacturaById(o){try{const{data:e,error:t}=await i.from("facturas_electronicas").select(`
          *,
          cliente:clientes(*),
          lineas:factura_items(*),
          envios:hacienda_envios(*)
        `).eq("id",o).single();if(t)throw t;return e}catch(e){return console.error("Error obteniendo factura:",e),null}}async saveFacturaLineas(o,e){try{await i.from("factura_items").delete().eq("factura_id",o);const t=e.map(r=>({...r,factura_id:o})),{error:n}=await i.from("factura_items").insert(t);return!n}catch(t){return console.error("Error guardando líneas:",t),!1}}async auditLog(o,e,t,n,r){try{await i.from("hacienda_auditoria").insert({accion:o,tabla_afectada:e,registro_id:t,datos_anteriores:n,datos_nuevos:r,created_at:new Date().toISOString()})}catch(a){console.error("Error en auditoría:",a)}}}const m=new d;export{m as h};
//# sourceMappingURL=haciendaService-CkwWVDHi.js.map
