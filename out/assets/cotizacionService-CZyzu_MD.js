import{s as n}from"./index-Xz42BvxI.js";class V{static async obtenerTipoCambioBCCR(){try{console.log("üí± [COTIZACI√ìN SERVICE] Obteniendo tipo de cambio del BCCR...");try{if((await fetch("https://gee.bccr.fi.cr/indicadoreseconomicos/Cuadros/frmVerCatCuadro.aspx?idioma=1&CodCuadro=%20400")).ok)return console.log("‚úÖ [COTIZACI√ìN SERVICE] Tipo de cambio obtenido del BCCR"),540}catch{console.warn("‚ö†Ô∏è [COTIZACI√ìN SERVICE] No se pudo conectar con BCCR, usando valor por defecto")}const o=540;return console.log("üí± [COTIZACI√ìN SERVICE] Usando tipo de cambio por defecto:",o),o}catch(o){return console.error("‚ùå [COTIZACI√ìN SERVICE] Error obteniendo tipo de cambio:",o),540}}static async obtenerCotizaciones(o){try{console.log("üìã [COTIZACI√ìN SERVICE] Obteniendo cotizaciones...",o);let e=n.from("cotizaciones").select(`
          *,
          clientes (
            id,
            nombre_razon_social,
            identificacion,
            correo_principal,
            telefono_numero
          )
        `).order("created_at",{ascending:!1});o?.cliente_id&&(e=e.eq("cliente_id",o.cliente_id)),o?.estado&&(e=e.eq("estado",o.estado)),o?.moneda&&(e=e.eq("moneda",o.moneda)),o?.fecha_desde&&(e=e.gte("fecha_emision",o.fecha_desde)),o?.fecha_hasta&&(e=e.lte("fecha_emision",o.fecha_hasta));const{data:a,error:r}=await e;if(r)throw r;if(console.log("‚úÖ [COTIZACI√ìN SERVICE] Cotizaciones obtenidas:",a?.length||0),a&&a.length>0){const c=a.filter(d=>d.metadata);console.log("üîç [METADATA CHECK] Cotizaciones con metadata:",c.length),c.forEach(d=>{console.log("üîç [METADATA CHECK] Cotizaci√≥n:",{id:d.id,codigo:d.codigo,metadata_tipo:d.metadata?.tipo,metadata_completa:d.metadata})})}return a||[]}catch(e){throw console.error("‚ùå [COTIZACI√ìN SERVICE] Error obteniendo cotizaciones:",e),e}}static async obtenerCotizacionPorId(o){try{console.log("üìã [COTIZACI√ìN SERVICE] Obteniendo cotizaci√≥n ID:",o);const{data:e,error:a}=await n.from("cotizaciones").select(`
          *,
          clientes (
            id,
            nombre_razon_social,
            identificacion,
            correo_principal,
            telefono_numero,
            otras_senas
          )
        `).eq("id",o).single();if(a)throw a;return console.log("‚úÖ [COTIZACI√ìN SERVICE] Cotizaci√≥n obtenida:",e),e}catch(e){throw console.error("‚ùå [COTIZACI√ìN SERVICE] Error obteniendo cotizaci√≥n:",e),e}}static async actualizarCotizacion(o,e){try{console.log("üìã [COTIZACI√ìN SERVICE] Actualizando cotizaci√≥n ID:",o);const a={cliente_id:parseInt(e.cliente_id),estado:e.estado,fecha_emision:e.fecha_emision,fecha_vencimiento:e.fecha_vencimiento,moneda:e.moneda,tipo_cambio:this.formatNumericValue(e.tipo_cambio,"exchange"),descuento_global:this.formatNumericValue(e.descuento_global||0,"percentage"),descuento_valor:this.formatNumericValue(e.descuento_valor||0,"currency"),impuestos:this.formatNumericValue(e.impuestos,"tax"),flete:this.formatNumericValue(e.flete||0,"currency"),otros:this.formatNumericValue(e.otros||0,"currency"),subtotal:this.formatNumericValue(e.subtotal,"currency"),total:this.formatNumericValue(e.total,"currency"),updated_at:new Date().toISOString()},{data:r,error:c}=await n.from("cotizaciones").update(a).eq("id",o).select().single();if(c)throw c;if(e.items&&e.items.length>0){await n.from("cotizacion_items").delete().eq("cotizacion_id",o);const d=e.items.map(s=>({cotizacion_id:o,producto_id:s.producto_id,tipo_item:s.tipo_item||"normal",descripcion:s.descripcion,cantidad:this.formatNumericValue(s.cantidad,"quantity"),precio_unitario:this.formatNumericValue(s.precio_unitario,"quantity"),descuento:this.formatNumericValue(s.descuento||0,"item_discount"),subtotal:this.formatNumericValue(s.subtotal,"quantity")}));await n.from("cotizacion_items").insert(d)}return console.log("‚úÖ [COTIZACI√ìN SERVICE] Cotizaci√≥n actualizada"),r}catch(a){throw console.error("‚ùå [COTIZACI√ìN SERVICE] Error actualizando cotizaci√≥n:",a),a}}static async eliminarCotizacion(o){try{console.log("üìã [COTIZACI√ìN SERVICE] Eliminando cotizaci√≥n ID:",o),await n.from("cotizacion_items").delete().eq("cotizacion_id",o);const{error:e}=await n.from("cotizaciones").delete().eq("id",o);if(e)throw e;console.log("‚úÖ [COTIZACI√ìN SERVICE] Cotizaci√≥n eliminada")}catch(e){throw console.error("‚ùå [COTIZACI√ìN SERVICE] Error eliminando cotizaci√≥n:",e),e}}static async duplicarCotizacion(o){try{console.log("üìã [COTIZACI√ìN SERVICE] Duplicando cotizaci√≥n ID:",o);const{data:e,error:a}=await n.from("cotizaciones").select("*").eq("id",o).single();if(a)throw a;const{data:r,error:c}=await n.from("cotizacion_items").select("*").eq("cotizacion_id",o);if(c)throw c;const s=`COT-${Date.now().toString().slice(-8)}`,_={...e,id:void 0,codigo:s,estado:"borrador",created_at:new Date().toISOString(),updated_at:new Date().toISOString()},{data:u,error:p}=await n.from("cotizaciones").insert(_).select().single();if(p)throw p;if(r&&r.length>0){const l=r.map(C=>({...C,id:void 0,cotizacion_id:u.id}));await n.from("cotizacion_items").insert(l)}return console.log("‚úÖ [COTIZACI√ìN SERVICE] Cotizaci√≥n duplicada"),u}catch(e){throw console.error("‚ùå [COTIZACI√ìN SERVICE] Error duplicando cotizaci√≥n:",e),e}}static async cambiarEstado(o,e){try{console.log("üìã [COTIZACI√ìN SERVICE] Cambiando estado de cotizaci√≥n ID:",o,"a",e);const{data:a,error:r}=await n.from("cotizaciones").update({estado:e,updated_at:new Date().toISOString()}).eq("id",o).select().single();if(r)throw r;return console.log("‚úÖ [COTIZACI√ìN SERVICE] Estado cambiado"),a}catch(a){throw console.error("‚ùå [COTIZACI√ìN SERVICE] Error cambiando estado:",a),a}}static async crearCotizacion(o){try{console.log("üìã [COTIZACI√ìN SERVICE] Creando cotizaci√≥n...",{tiene_metadata:!!o.metadata,tipo:o.metadata?.tipo,items_optimizador_count:o.items_optimizador?.length||0,items_inventario_count:o.items_inventario?.length||0,items_count:o.items?.length||0}),o.metadata&&console.log("üîç [OPT_QUOTE_DEBUG] Metadata recibida:",{tipo:o.metadata.tipo,proyecto_id:o.metadata.proyecto_id,margen_utilidad:o.metadata.margen_utilidad});const r={codigo:`COT-${Date.now().toString().slice(-8)}`,cliente_id:parseInt(o.cliente_id),estado:o.estado,fecha_emision:o.fecha_emision,fecha_vencimiento:o.fecha_vencimiento,moneda:o.moneda,tipo_cambio:this.formatNumericValue(o.tipo_cambio,"exchange"),descuento_global:this.formatNumericValue(o.descuento_global||0,"percentage"),descuento_valor:this.formatNumericValue(o.descuento_valor||0,"currency"),impuestos:this.formatNumericValue(o.impuestos,"tax"),flete:this.formatNumericValue(o.flete||0,"currency"),otros:this.formatNumericValue(o.otros||0,"currency"),subtotal:this.formatNumericValue(o.subtotal,"currency"),total:this.formatNumericValue(o.total,"currency"),metadata:o.metadata||null,created_at:new Date().toISOString()};console.log("üíæ [COTIZACI√ìN SERVICE] Guardando cotizaci√≥n con metadata:",{tiene_metadata:!!r.metadata,metadata_tipo:r.metadata?.tipo});const{data:c,error:d}=await n.from("cotizaciones").insert(r).select().single();if(d)throw d;console.log("‚úÖ [COTIZACI√ìN SERVICE] Cotizaci√≥n creada:",{id:c.id,codigo:c.codigo,tiene_metadata:!!c.metadata,metadata_tipo:c.metadata?.tipo});const s=o.items_optimizador||[],_=o.items_inventario||[],u=o.items||[],p=s.length+_.length+u.length;if(p>0){console.log("üì¶ [COTIZACI√ìN SERVICE] Procesando items...",{items_optimizador:s.length,items_inventario:_.length,items_tradicionales:u.length,total:p});const l=[];if(s.length>0&&(console.log("üéØ [OPT_QUOTE_SAVE] Procesando items del OPTIMIZADOR"),s.forEach((t,m)=>{const i=[];t.tapacanto_superior&&i.push(`Sup: ${t.tapacanto_superior}`),t.tapacanto_inferior&&i.push(`Inf: ${t.tapacanto_inferior}`),t.tapacanto_izquierdo&&i.push(`Izq: ${t.tapacanto_izquierdo}`),t.tapacanto_derecho&&i.push(`Der: ${t.tapacanto_derecho}`);const I=i.length>0?i.join(", "):"Sin tapacantos",h=t.material_codigo&&t.material_nombre?`${t.material_codigo} - ${t.material_nombre}`:t.material_codigo||t.material_nombre||"Sin especificar",f=t.largo&&t.ancho?`${t.largo} √ó ${t.ancho} mm`:"-";console.log(`üîç [CNC SAVE] Item ${m+1} "${t.descripcion}":`,{cnc1_codigo:t.cnc1_codigo,cnc1_cantidad:t.cnc1_cantidad,cnc2_codigo:t.cnc2_codigo,cnc2_cantidad:t.cnc2_cantidad,costo_cnc:t.costo_cnc});const g={cotizacion_id:c.id,producto_id:null,tipo_item:"optimizador",descripcion:t.descripcion||`Pieza ${m+1}`,dimensiones:f,material:h,tapacantos:I,cnc1:"",cnc2:"",cantidad:this.formatNumericValue(t.cantidad,"quantity"),precio_unitario:this.formatNumericValue(t.precio_unitario,"quantity"),descuento:this.formatNumericValue(t.descuento||0,"item_discount"),subtotal:this.formatNumericValue(t.subtotal,"quantity"),datos_optimizador:{descripcion:t.descripcion,largo:t.largo,ancho:t.ancho,material_codigo:t.material_codigo,material_nombre:t.material_nombre,veta:t.veta,tapacanto_superior:t.tapacanto_superior,tapacanto_inferior:t.tapacanto_inferior,tapacanto_izquierdo:t.tapacanto_izquierdo,tapacanto_derecho:t.tapacanto_derecho,cnc1_codigo:t.cnc1_codigo||"",cnc1_cantidad:t.cnc1_cantidad||0,cnc2_codigo:t.cnc2_codigo||"",cnc2_cantidad:t.cnc2_cantidad||0,costo_material:t.costo_material||0,costo_tapacantos:t.costo_tapacantos||0,costo_cnc:t.costo_cnc||0,costo_total:t.costo_total||0}};l.push(g)})),_.length>0&&(console.log("üì¶ [INVENTORY_ITEMS] Procesando items del INVENTARIO"),_.forEach(t=>{const m={cotizacion_id:c.id,producto_id:t.inventario_id||null,tipo_item:"optimizador",descripcion:`${t.codigo} - ${t.descripcion}`,dimensiones:null,material:null,tapacantos:null,cnc1:null,cnc2:null,cantidad:this.formatNumericValue(t.cantidad,"quantity"),precio_unitario:this.formatNumericValue(t.precio_unitario,"quantity"),descuento:this.formatNumericValue(t.descuento||0,"item_discount"),subtotal:this.formatNumericValue(t.subtotal,"quantity"),datos_optimizador:null};l.push(m)})),u.length>0){console.log("üìù [COTIZACI√ìN] Procesando items TRADICIONALES");const t=u.map(i=>i.producto_id).filter(i=>i);let m=[];if(t.length>0){const{data:i}=await n.from("productos").select("id_producto, descripcion_producto").in("id_producto",t);m=i||[]}u.forEach(i=>{const I=m.find(f=>f.id_producto===i.producto_id),h={cotizacion_id:c.id,producto_id:i.producto_id,tipo_item:"normal",descripcion:I?.descripcion_producto||`Producto ID: ${i.producto_id}`,dimensiones:null,material:null,tapacantos:null,cnc1:null,cnc2:null,cantidad:this.formatNumericValue(i.cantidad,"quantity"),precio_unitario:this.formatNumericValue(i.precio_unitario,"quantity"),descuento:this.formatNumericValue(i.descuento||0,"item_discount"),subtotal:this.formatNumericValue(i.subtotal,"quantity"),datos_optimizador:null};l.push(h)})}console.log("üíæ [COTIZACI√ìN SERVICE] Guardando items en BD...",{total_items:l.length,items_optimizador:l.filter(t=>t.tipo_item==="optimizador").length,items_inventario:l.filter(t=>t.tipo_item==="inventario").length,items_normales:l.filter(t=>t.tipo_item==="normal").length});const{error:C}=await n.from("cotizacion_items").insert(l);if(C)throw console.error("‚ùå [COTIZACI√ìN SERVICE] Error guardando items:",C),C;console.log("‚úÖ [COTIZACI√ìN SERVICE] Items guardados correctamente")}return c}catch(e){throw console.error("‚ùå [COTIZACI√ìN SERVICE] Error creando cotizaci√≥n:",e),e}}static formatNumericValue(o,e){if(o==null||o==="")return 0;const a=parseFloat(o);if(isNaN(a))return console.warn(`‚ö†Ô∏è [COTIZACI√ìN SERVICE] Valor num√©rico inv√°lido para tipo ${e}:`,o),0;switch(e){case"exchange":case"percentage":case"tax":return Math.min(Math.max(a,0),999.99);case"currency":case"quantity":case"item_discount":return Math.min(Math.max(a,0),999999.99);default:return Math.min(Math.max(a,0),999999.99)}}}export{V as C};
//# sourceMappingURL=cotizacionService-CZyzu_MD.js.map
