import{j as e,r as n,s as m,a as $e,b as Ge,C as Ze,u as Qe}from"./index-Bb3NupjY.js";import{u as Ve,S as Xe,T as He}from"./TopBar-BP5RF_Jd.js";import{r as Je,u as we,w as Ke}from"./xlsx-BojT3SgY.js";import{f as se}from"./currency-BmxXlzML.js";import{N as We}from"./NotificationPopup-Br5iZ8zM.js";function Ye({children:r,stats:a,onNuevaTarea:t,onConfigEncargados:i,onConfigColaboradores:c,onExportar:p,canCreate:w,canManage:_}){return e.jsxs("main",{className:"flex-1 overflow-auto p-6",children:[e.jsx("div",{className:"mb-6",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Tareas"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"GestiÃ³n de Ã³rdenes de trabajo y seguimiento de producciÃ³n"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:p,className:"px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors flex items-center gap-2 whitespace-nowrap cursor-pointer",children:[e.jsx("i",{className:"ri-download-line"}),"Exportar"]}),_&&e.jsxs("button",{onClick:c,className:"px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors flex items-center gap-2 whitespace-nowrap cursor-pointer",children:[e.jsx("i",{className:"ri-team-line"}),"Colaboradores"]}),_&&e.jsxs("button",{onClick:i,className:"px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors flex items-center gap-2 whitespace-nowrap cursor-pointer",children:[e.jsx("i",{className:"ri-user-settings-line"}),"Encargados"]}),w&&e.jsxs("button",{onClick:t,className:"px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2 whitespace-nowrap cursor-pointer",children:[e.jsx("i",{className:"ri-add-line"}),"Nueva Tarea"]})]})]})}),a&&e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-4 border-l-4 border-gray-400",children:[e.jsx("div",{className:"text-2xl font-bold text-gray-900",children:a.en_cola}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"En Cola"})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-4 border-l-4 border-blue-500",children:[e.jsx("div",{className:"text-2xl font-bold text-gray-900",children:a.en_proceso}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"En Proceso"})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-4 border-l-4 border-purple-500",children:[e.jsx("div",{className:"text-2xl font-bold text-gray-900",children:a.produciendo}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"Produciendo"})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-4 border-l-4 border-yellow-500",children:[e.jsx("div",{className:"text-2xl font-bold text-gray-900",children:a.esperando_suministros}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"Esperando"})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-4 border-l-4 border-green-500",children:[e.jsx("div",{className:"text-2xl font-bold text-gray-900",children:a.terminado}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"Terminado"})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-4 border-l-4 border-gray-600",children:[e.jsx("div",{className:"text-2xl font-bold text-gray-900",children:a.finalizado}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"Finalizado"})]})]}),r]})}const eo=["En Cola","En Proceso","Produciendo","Esperando suministros","Terminado","Finalizado"],oo=r=>({"En Cola":"bg-gray-100 text-gray-800","En Proceso":"bg-blue-100 text-blue-800",Produciendo:"bg-purple-100 text-purple-800","Esperando suministros":"bg-yellow-100 text-yellow-800",Terminado:"bg-green-100 text-green-800",Finalizado:"bg-gray-200 text-gray-600"})[r]||"bg-gray-100 text-gray-800";function to({tareas:r,loading:a,filtros:t,onFiltroChange:i,onProcesar:c,onRefresh:p}){const[w,_]=n.useState(t.busqueda||""),A=u=>{_(u),i({...t,busqueda:u})},O=u=>{i({...t,estado:u})};return e.jsxs("div",{className:"bg-white rounded-lg shadow-sm",children:[e.jsx("div",{className:"p-4 border-b border-gray-200",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx("i",{className:"ri-search-line absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Buscar por consecutivo o descripciÃ³n...",value:w,onChange:u=>A(u.target.value),className:"w-full pl-10 pr-4 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]})}),e.jsx("div",{className:"sm:w-48",children:e.jsxs("select",{value:t.estado||"",onChange:u=>O(u.target.value),className:"w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"",children:"Todos (sin Finalizado)"}),eo.map(u=>e.jsx("option",{value:u,children:u},u))]})}),e.jsxs("button",{onClick:p,className:"px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors flex items-center gap-2 whitespace-nowrap cursor-pointer",children:[e.jsx("i",{className:"ri-refresh-line"}),"Refrescar"]})]})}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Tarea"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Fecha Estimada"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Solicitante"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Cantidad"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"DescripciÃ³n"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Estado"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Acciones"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:a?e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"px-4 py-8 text-center",children:e.jsxs("div",{className:"flex items-center justify-center gap-2 text-gray-500",children:[e.jsx("i",{className:"ri-loader-4-line animate-spin"}),"Cargando tareas..."]})})}):r.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"px-4 py-8 text-center text-gray-500",children:"No hay tareas para mostrar"})}):r.map(u=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsxs("td",{className:"px-4 py-3",children:[e.jsx("button",{onClick:()=>c(u),className:"text-blue-600 hover:text-blue-800 font-medium cursor-pointer",children:u.consecutivo}),e.jsx("div",{className:"text-xs text-gray-500",children:new Date(u.created_at).toLocaleDateString()})]}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-900",children:u.fecha_estimada_entrega?e.jsx("span",{className:new Date(u.fecha_estimada_entrega)<new Date?"text-red-600 font-medium":"",children:new Date(u.fecha_estimada_entrega).toLocaleDateString()}):e.jsx("span",{className:"text-gray-400",children:"Sin definir"})}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-900",children:u.email_solicitante}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-900",children:u.cantidad_unidades||"-"}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-900 max-w-xs truncate",children:u.descripcion_breve||"-"}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("span",{className:`inline-flex px-2 py-1 text-xs font-medium rounded-full ${oo(u.estado)}`,children:u.estado})}),e.jsx("td",{className:"px-4 py-3 text-right",children:e.jsx("button",{onClick:()=>c(u),className:"px-3 py-1.5 text-xs font-medium text-white bg-blue-600 rounded hover:bg-blue-700 transition-colors cursor-pointer whitespace-nowrap",children:"Procesar"})})]},u.id))})]})}),!a&&r.length>0&&e.jsxs("div",{className:"px-4 py-3 border-t border-gray-200 text-sm text-gray-500",children:["Mostrando ",r.length," tarea",r.length!==1?"s":""]})]})}class ao{async getTareas(a){try{const{data:{user:t}}=await m.auth.getUser();if(!t)throw new Error("Usuario no autenticado");const{data:i}=await m.from("usuario_tienda_actual").select("tienda_id").eq("usuario_id",t.id).single();if(!i)throw new Error("No hay tienda asignada");let c=m.from("tareas").select(`
          *,
          items:tareas_items(
            id,
            producto_id,
            inventario_id,
            descripcion,
            cantidad,
            costo_unitario,
            costo_total
          ),
          personal_asignado:tareas_personal_asignado(
            id,
            colaborador_id,
            colaborador:tareas_colaboradores(
              id,
              nombre,
              email,
              telefono
            )
          )
        `).eq("tienda_id",i.tienda_id).order("created_at",{ascending:!1});a?.estado&&(c=c.eq("estado",a.estado)),a?.fecha_desde&&(c=c.gte("created_at",a.fecha_desde)),a?.fecha_hasta&&(c=c.lte("created_at",a.fecha_hasta)),a?.busqueda&&(c=c.or(`consecutivo.ilike.%${a.busqueda}%,descripcion_breve.ilike.%${a.busqueda}%`)),a?.solicitante_id&&(c=c.eq("solicitante_id",a.solicitante_id));const{data:p,error:w}=await c;if(w)throw w;return p||[]}catch(t){throw console.error("âŒ Error obteniendo tareas:",t),t}}async getTareaById(a){try{const{data:t,error:i}=await m.from("tareas").select(`
          *,
          items:tareas_items(
            id,
            producto_id,
            inventario_id,
            descripcion,
            cantidad,
            costo_unitario,
            costo_total
          ),
          personal_asignado:tareas_personal_asignado(
            id,
            colaborador_id,
            colaborador:tareas_colaboradores(
              id,
              nombre,
              email,
              telefono
            )
          )
        `).eq("id",a).single();if(i)throw i;return t}catch(t){return console.error("âŒ Error obteniendo tarea:",t),null}}async createTarea(a){try{const{data:{user:t}}=await m.auth.getUser();if(!t)throw new Error("Usuario no autenticado");const{data:i}=await m.from("usuario_tienda_actual").select("tienda_id").eq("usuario_id",t.id).single();if(!i)throw new Error("No hay tienda asignada");const{data:c,error:p}=await m.from("tareas").insert({tienda_id:i.tienda_id,solicitante_id:t.id,email_solicitante:t.email||"",datos_formulario:a.datos_formulario,cotizacion_id:a.cotizacion_id,fecha_estimada_entrega:a.fecha_estimada_entrega,cantidad_unidades:a.cantidad_unidades,descripcion_breve:a.descripcion_breve,estado:"En Cola",total_costo:0,created_by:t.id}).select().single();if(p)throw p;return console.log("âœ… Tarea creada:",c.consecutivo),this.enviarNotificacionSegura(c.id,"En Cola"),this.getTareaById(c.id)}catch(t){throw console.error("âŒ Error creando tarea:",t),t}}async updateTarea(a,t){try{const{data:{user:i}}=await m.auth.getUser();if(!i)throw new Error("Usuario no autenticado");const{data:c}=await m.from("tareas").select("estado").eq("id",a).single(),p=c?.estado;let w=0;t.items&&(w=t.items.reduce((A,O)=>A+O.cantidad*O.costo_unitario,0));const{error:_}=await m.from("tareas").update({fecha_estimada_entrega:t.fecha_estimada_entrega,cantidad_unidades:t.cantidad_unidades,descripcion_breve:t.descripcion_breve,cantidad_personas:t.cantidad_personas,fecha_inicio:t.fecha_inicio,fecha_cierre:t.fecha_cierre,entregado_a:t.entregado_a,estado:t.estado,total_costo:t.items?w:void 0,updated_by:i.id}).eq("id",a);if(_)throw _;if(t.items&&(await m.from("tareas_items").delete().eq("tarea_id",a),t.items.length>0)){const A=t.items.map(u=>({tarea_id:a,producto_id:u.producto_id,inventario_id:u.inventario_id,descripcion:u.descripcion,cantidad:u.cantidad,costo_unitario:u.costo_unitario})),{error:O}=await m.from("tareas_items").insert(A);if(O)throw O}if(t.personal_asignado&&(await m.from("tareas_personal_asignado").delete().eq("tarea_id",a),t.personal_asignado.length>0)){const A=t.personal_asignado.map(u=>({tarea_id:a,colaborador_id:u})),{error:O}=await m.from("tareas_personal_asignado").insert(A);if(O)throw O}return console.log("âœ… Tarea actualizada:",a),t.estado&&p&&t.estado!==p&&this.enviarNotificacionCambioEstadoSegura(a,p,t.estado),this.getTareaById(a)}catch(i){throw console.error("âŒ Error actualizando tarea:",i),i}}async deleteTarea(a){const{error:t}=await m.from("tareas").delete().eq("id",a);if(t)throw new Error(`Error eliminando tarea: ${JSON.stringify(t)}`)}async getStats(){try{const{data:{user:a}}=await m.auth.getUser();if(!a)throw new Error("Usuario no autenticado");const{data:t}=await m.from("usuario_tienda_actual").select("tienda_id").eq("usuario_id",a.id).single();if(!t)throw new Error("No hay tienda asignada");const{data:i,error:c}=await m.from("tareas").select("estado").eq("tienda_id",t.tienda_id);if(c)throw c;return{total:i?.length||0,en_cola:i?.filter(w=>w.estado==="En Cola").length||0,en_proceso:i?.filter(w=>w.estado==="En Proceso").length||0,produciendo:i?.filter(w=>w.estado==="Produciendo").length||0,esperando_suministros:i?.filter(w=>w.estado==="Esperando suministros").length||0,terminado:i?.filter(w=>w.estado==="Terminado").length||0,finalizado:i?.filter(w=>w.estado==="Finalizado").length||0}}catch(a){throw console.error("âŒ Error obteniendo estadÃ­sticas:",a),a}}async getConfigCampos(){try{const{data:{user:a}}=await m.auth.getUser();if(!a)throw new Error("Usuario no autenticado");const{data:t}=await m.from("usuario_tienda_actual").select("tienda_id").eq("usuario_id",a.id).single();if(!t)throw new Error("No hay tienda asignada");const{data:i,error:c}=await m.from("tareas_config_campos").select("*").eq("tienda_id",t.tienda_id).eq("activo",!0).order("orden",{ascending:!0});if(c)throw c;return i||[]}catch(a){throw console.error("âŒ Error obteniendo configuraciÃ³n de campos:",a),a}}async getEncargados(){try{const{data:{user:a}}=await m.auth.getUser();if(!a)throw new Error("Usuario no autenticado");const{data:t}=await m.from("usuario_tienda_actual").select("tienda_id").eq("usuario_id",a.id).single();if(!t)throw new Error("No hay tienda asignada");const{data:i,error:c}=await m.from("tareas_encargados").select("*").eq("tienda_id",t.tienda_id);if(c)throw c;return i||[]}catch(a){throw console.error("âŒ Error obteniendo encargados:",a),a}}async addEncargado(a){try{const{data:{user:t}}=await m.auth.getUser();if(!t)throw new Error("Usuario no autenticado");const{data:i}=await m.from("usuario_tienda_actual").select("tienda_id").eq("usuario_id",t.id).single();if(!i)throw new Error("No hay tienda asignada");const{error:c}=await m.from("tareas_encargados").insert({tienda_id:i.tienda_id,usuario_id:a,created_by:t.id});if(c)throw c;console.log("âœ… Encargado agregado")}catch(t){throw console.error("âŒ Error agregando encargado:",t),t}}async removeEncargado(a){try{const{error:t}=await m.from("tareas_encargados").delete().eq("id",a);if(t)throw t;console.log("âœ… Encargado removido")}catch(t){throw console.error("âŒ Error removiendo encargado:",t),t}}async getColaboradores(){try{const{data:{user:a}}=await m.auth.getUser();if(!a)throw new Error("Usuario no autenticado");const{data:t}=await m.from("usuario_tienda_actual").select("tienda_id").eq("usuario_id",a.id).single();if(!t)throw new Error("No hay tienda asignada");const{data:i,error:c}=await m.from("tareas_colaboradores").select("*").eq("tienda_id",t.tienda_id).eq("activo",!0).order("nombre",{ascending:!0});if(c)throw c;return i||[]}catch(a){throw console.error("âŒ Error obteniendo colaboradores:",a),a}}async createColaborador(a){try{const{data:{user:t}}=await m.auth.getUser();if(!t)throw new Error("Usuario no autenticado");const{data:i}=await m.from("usuario_tienda_actual").select("tienda_id").eq("usuario_id",t.id).single();if(!i)throw new Error("No hay tienda asignada");const{error:c}=await m.from("tareas_colaboradores").insert({tienda_id:i.tienda_id,nombre:a.nombre,email:a.email,telefono:a.telefono,activo:!0});if(c)throw c;console.log("âœ… Colaborador creado")}catch(t){throw console.error("âŒ Error creando colaborador:",t),t}}async enviarNotificacionNuevaTarea(a,t){try{const{data:{session:i}}=await m.auth.getSession();if(!i){console.warn("âš ï¸ No hay sesiÃ³n activa para enviar notificaciÃ³n");return}const c=await m.functions.invoke("enviar-notificacion-tarea",{body:{tarea_id:a,estado_nuevo:t}});c.error?console.error("âŒ Error en Edge Function:",c.error):console.log("âœ… NotificaciÃ³n enviada:",c.data)}catch(i){console.error("âŒ Error enviando notificaciÃ³n:",i)}}async enviarNotificacionCambioEstado(a,t,i){try{const{data:{session:c}}=await m.auth.getSession();if(!c){console.warn("âš ï¸ No hay sesiÃ³n activa para enviar notificaciÃ³n");return}const p=await m.functions.invoke("enviar-notificacion-tarea",{body:{tarea_id:a,estado_anterior:t,estado_nuevo:i}});p.error?console.error("âŒ Error en Edge Function:",p.error):console.log("âœ… NotificaciÃ³n de cambio de estado enviada:",p.data)}catch(c){console.error("âŒ Error enviando notificaciÃ³n:",c)}}enviarNotificacionSegura(a,t){setTimeout(async()=>{try{const{data:{session:i}}=await m.auth.getSession();if(!i){console.log("â„¹ï¸ No hay sesiÃ³n para enviar notificaciÃ³n");return}const c=await m.functions.invoke("enviar-notificacion-tarea",{body:{tarea_id:a,estado_nuevo:t}});c.error?console.log("â„¹ï¸ No se pudo enviar notificaciÃ³n (no crÃ­tico):",c.error.message):console.log("âœ… NotificaciÃ³n enviada")}catch{console.log("â„¹ï¸ NotificaciÃ³n no enviada (servicio no disponible)")}},0)}enviarNotificacionCambioEstadoSegura(a,t,i){setTimeout(async()=>{try{const{data:{session:c}}=await m.auth.getSession();if(!c){console.log("â„¹ï¸ No hay sesiÃ³n para enviar notificaciÃ³n");return}const p=await m.functions.invoke("enviar-notificacion-tarea",{body:{tarea_id:a,estado_anterior:t,estado_nuevo:i}});p.error?console.log("â„¹ï¸ No se pudo enviar notificaciÃ³n (no crÃ­tico):",p.error.message):console.log("âœ… NotificaciÃ³n de cambio de estado enviada")}catch{console.log("â„¹ï¸ NotificaciÃ³n no enviada (servicio no disponible)")}},0)}async importarDesdeCotizacion(a){try{const{data:t,error:i}=await m.from("cotizacion_items").select("*").eq("cotizacion_id",a);if(i)throw i;return(t||[]).map(p=>({id:"",tarea_id:"",producto_id:p.producto_id,inventario_id:null,descripcion:p.descripcion,cantidad:p.cantidad,costo_unitario:p.precio_unitario,costo_total:p.subtotal,created_at:new Date().toISOString()}))}catch(t){throw console.error("âŒ Error importando desde cotizaciÃ³n:",t),t}}}const oe=new ao;function so({onClose:r,onSave:a}){const[t,i]=n.useState(!1),[c,p]=n.useState(null),{hasPermission:w}=Ve(),[_,A]=n.useState(""),[O,u]=n.useState(null),[C,f]=n.useState([]),[G,L]=n.useState(!1),[R,H]=n.useState(!1),[I,W]=n.useState(""),[q,he]=n.useState(""),[J,me]=n.useState(""),[re,ne]=n.useState(""),[be,te]=n.useState(""),[z,V]=n.useState([{codigo:"",cantidad:0}]),[K,P]=n.useState([{descripcion:"",cantidad:0,motivo:""}]),[Z,ue]=n.useState([]),[M,xe]=n.useState(!1),[Te,Y]=n.useState([]),[Ne,Be]=n.useState(""),[_e,De]=n.useState(null),[Ce,Re]=n.useState(""),[fe,ke]=n.useState(""),qe=new Date().toISOString().split("T")[0];Z.length,n.useEffect(()=>{j(),Le()},[]),n.useEffect(()=>{if(_.length>=3){const s=setTimeout(()=>{ye(_)},300);return()=>clearTimeout(s)}else f([]),L(!1)},[_]);const j=async()=>{try{const{data:{user:s}}=await m.auth.getUser();s&&p(s)}catch(s){console.error("Error cargando usuario:",s)}},ye=async s=>{if(s.length<3){f([]);return}try{H(!0);const{data:x}=await m.from("usuario_tienda_actual").select("tienda_id").eq("usuario_id",c?.id).single();console.log("ğŸ” Buscando cotizaciones con tÃ©rmino:",s),console.log("ğŸ‘¤ Usuario ID:",c?.id),console.log("ğŸª Tienda actual:",x?.tienda_id);let v=m.from("cotizaciones").select(`
          id,
          codigo,
          total,
          tienda_id,
          clientes!cotizaciones_cliente_id_fkey(nombre_razon_social),
          cotizacion_items(*)
        `).ilike("codigo",`%${s}%`).order("created_at",{ascending:!1}).limit(10),N=m.from("cotizaciones").select(`
          id,
          codigo,
          total,
          tienda_id,
          clientes!cotizaciones_cliente_id_fkey(nombre_razon_social),
          cotizacion_items(*)
        `).ilike("clientes.nombre_razon_social",`%${s}%`).order("created_at",{ascending:!1}).limit(10);const[B,k]=await Promise.all([v,N]);console.log("ğŸ“Š Resultados por cÃ³digo:",B.data?.length||0),console.log("ğŸ“Š Resultados por cliente:",k.data?.length||0),B.error&&console.error("âŒ Error en bÃºsqueda por cÃ³digo:",B.error),k.error&&console.error("âŒ Error en bÃºsqueda por cliente:",k.error);const E=[...B.data||[],...k.data||[]];console.log("ğŸ“¦ Total combinados:",E.length);const U=new Set,T=E.filter(F=>U.has(F.id)?!1:(U.add(F.id),!0));console.log("âœ… Resultados Ãºnicos:",T.length);const ee=T.filter(F=>F.clientes!==null).map(F=>({id:F.id,codigo:F.codigo,cliente_nombre:F.clientes?.nombre_razon_social||"Sin cliente",total:F.total,items:F.cotizacion_items||[]}));f(ee),L(ee.length>0),ee.length===0&&console.log("âš ï¸ No se encontraron cotizaciones con el tÃ©rmino:",s)}catch(x){console.error("âŒ Error en buscarCotizaciones:",x)}finally{H(!1)}},X=async s=>{u(s),A(`${s.codigo} - ${s.cliente_nombre}`),L(!1),fe||ke(`CotizaciÃ³n ${s.codigo} - ${s.cliente_nombre}`);try{console.log("ğŸ”„ Cargando items de la cotizaciÃ³n:",s.id);const{data:x,error:v}=await m.from("cotizacion_items").select("producto_id, cantidad").eq("cotizacion_id",s.id);if(v){console.error("Error obteniendo items de cotizaciÃ³n:",v);return}if(console.log("ğŸ“¦ Items de cotizaciÃ³n encontrados:",x?.length||0),!x||x.length===0){console.log("â„¹ï¸ La cotizaciÃ³n no tiene productos");return}const N=[];for(const B of x){if(!B.producto_id)continue;console.log("ğŸ” Buscando BOM para producto:",B.producto_id);const{data:k,error:E}=await m.from("bom_items").select(`
            id_componente,
            cantidad_x_unidad,
            inventario!bom_items_id_componente_fkey(
              id_articulo,
              codigo_articulo,
              descripcion_articulo,
              costo_articulo
            )
          `).eq("product_id",B.producto_id);if(E){console.error("Error obteniendo BOM:",E);continue}k&&k.length>0&&(console.log("âœ… BOM encontrado:",k.length,"componentes"),k.forEach(U=>{const T=U.cantidad_x_unidad*B.cantidad,ee=U.inventario.costo_articulo||0,F=N.find(Me=>Me.id_articulo===U.inventario.id_articulo);F?F.cantidad+=T:N.push({id_articulo:U.inventario.id_articulo,codigo:U.inventario.codigo_articulo,descripcion:U.inventario.descripcion_articulo,cantidad:T,costo_unitario:ee,tipo:"inventario"})}))}if(console.log("ğŸ“Š Total de componentes Ãºnicos:",N.length),N.length>0){const B=N.map(E=>({id_articulo:E.id_articulo,codigo:E.codigo,descripcion:E.descripcion,cantidad:E.cantidad,tipo:"inventario"}));V(B);const k=N.map(E=>({descripcion:`${E.codigo} - ${E.descripcion}`,cantidad:E.cantidad,motivo:`CotizaciÃ³n ${s.codigo}`,precio:E.costo_unitario}));P(k),console.log(`âœ… Se cargaron ${N.length} componentes en ambas tablas`),alert(`âœ… Se cargaron ${N.length} componentes desde la cotizaciÃ³n

Los productos se han agregado a:
â€¢ Ãtems consumidos (CÃ³digo y Cantidad)
â€¢ Consumo de Inventario (DescripciÃ³n, Cantidad y Precio)`)}else console.log("â„¹ï¸ Los productos de la cotizaciÃ³n no tienen componentes BOM definidos"),alert("â„¹ï¸ Los productos de la cotizaciÃ³n no tienen componentes BOM definidos")}catch(x){console.error("Error cargando items de BOM:",x),alert("Error al cargar los componentes de la cotizaciÃ³n")}},le=()=>{u(null),A(""),f([])},Ee=()=>{O&&window.open(`/cotizaciones/${O.id}`,"_blank")},ie=()=>{V([...z,{codigo:"",cantidad:0}])},Fe=s=>{z.length>1&&V(z.filter((x,v)=>v!==s))},ae=(s,x,v)=>{const N=[...z];N[s]={...N[s],[x]:v},V(N)},Se=()=>{P([...K,{descripcion:"",cantidad:0,motivo:""}])},Ae=s=>{K.length>1&&P(K.filter((x,v)=>v!==s))},je=(s,x,v)=>{const N=[...K];N[s]={...N[s],[x]:v},P(N)},ge=async s=>{const x=s.target.files?.[0];if(x)try{const v=await x.arrayBuffer(),N=Je(v),B=N.Sheets[N.SheetNames[0]],k=we.sheet_to_json(B);if(k.length>0){const E=k[0];if("Codigo"in E||"codigo"in E){const U=k.map(T=>({codigo:T.Codigo||T.codigo||"",cantidad:parseFloat(T.Cantidad||T.cantidad||0)}));V(U)}else if("Descripcion"in E||"descripcion"in E){const U=k.map(T=>({descripcion:T.Descripcion||T.descripcion||"",cantidad:parseFloat(T.Cantidad||T.cantidad||0),motivo:T.Motivo||T.motivo||""}));P(U)}}De(x),alert("Archivo Excel cargado exitosamente")}catch(v){console.error("Error procesando Excel:",v),alert("Error al procesar el archivo Excel")}},ze=()=>{const s=ce(),x=ve();let v,N;if(s){const k=[{Codigo:"PROD-001",Cantidad:100},{Codigo:"PROD-002",Cantidad:50},{Codigo:"PROD-003",Cantidad:75}];v=we.json_to_sheet(k),N="Plantilla_Codigos_Cantidades.xlsx"}else if(x){const k=[{Descripcion:"Pallets de madera",Cantidad:50,Motivo:"ExportaciÃ³n"},{Descripcion:"Contenedores plÃ¡sticos",Cantidad:20,Motivo:"Almacenamiento"},{Descripcion:"Cajas de cartÃ³n",Cantidad:100,Motivo:"Empaque"}];v=we.json_to_sheet(k),N="Plantilla_Descripcion_Cantidad_Motivo.xlsx"}else{const k=[{Codigo:"PROD-001",Cantidad:100}];v=we.json_to_sheet(k),N="Plantilla_Productos.xlsx"}const B=we.book_new();we.book_append_sheet(B,v,"Datos"),Ke(B,N)},ce=()=>I==="Servicio al Cliente"&&q==="EPA"?["CÃ³digos de Barra","Registros sanitarios","TraducciÃ³n","Usos Delta Plus"].includes(J):I==="Servicio al Cliente"&&q==="COFERSA",ve=()=>I==="Servicio al Cliente"&&q==="EPA"?["Licencias / contenedores / Pallets","Suministros"].includes(J):!1,Oe=async s=>{if(s.preventDefault(),!I){alert("Debe seleccionar un departamento solicitante");return}if(I==="Servicio al Cliente"&&!q){alert("Debe seleccionar un cliente");return}if(I==="Servicio al Cliente"&&q==="EPA"&&!J){alert("Debe seleccionar quÃ© desea solicitar");return}if(I==="Servicio al Cliente"&&q==="COFERSA"&&!re){alert("Debe seleccionar quÃ© desea solicitar");return}if(I==="Servicio al Cliente"&&q==="COFERSA"&&!be){alert("Debe seleccionar el tipo de trabajo");return}i(!0);try{const x=c;if(!x)throw new Error("Usuario no autenticado");const v=await m.from("usuario_tienda_actual").select("tienda_id").eq("usuario_id",x.id).single();if(!v.data)throw new Error("No hay tienda seleccionada");const N={departamento_solicitante:I,cliente:q||null,solicitud_epa:J||null,solicitud_cofersa:re||null,tipo_trabajo:be||null};ce()&&(N.items_tabla_simple=z.filter(T=>T.codigo&&T.cantidad>0)),ve()&&(N.items_tabla_completa=K.filter(T=>T.descripcion&&T.cantidad>0));let B=0;N.items_tabla_simple&&(B=N.items_tabla_simple.reduce((T,ee)=>T+ee.cantidad,0)),N.items_tabla_completa&&(B+=N.items_tabla_completa.reduce((T,ee)=>T+ee.cantidad,0));const k=Math.round(B);let E=fe;E||(O?E=`CotizaciÃ³n ${O.codigo}`:(E=`${I} - ${q||"General"}`,J&&(E+=` - ${J}`),re&&(E+=` - ${re}`))),E.length>100&&(E=E.substring(0,97)+"...");const U={tienda_id:v.data.tienda_id,solicitante_id:x.id,email_solicitante:x.email||"",datos_formulario:N,estado:"En Cola",cotizacion_id:O?.id,fecha_estimada_entrega:Ce||void 0,cantidad_unidades:k>0?k:void 0,descripcion_breve:E,personal_asignado:Z};await oe.createTarea(U),console.log("âœ… Tarea creada exitosamente"),a()}catch(x){console.error("Error creando tarea:",x),alert("Error al crear la tarea: "+x.message)}finally{i(!1)}},Le=async()=>{try{const s=await oe.getColaboradores();Y(s.filter(x=>x.activo))}catch(s){console.error("Error cargando colaboradores:",s)}},Ue=s=>{Z.includes(s)||ue([...Z,s])},Ie=s=>{ue(Z.filter(x=>x!==s))},Pe=Te.filter(s=>s.nombre.toLowerCase().includes(Ne.toLowerCase())||s.email&&s.email.toLowerCase().includes(Ne.toLowerCase())),pe=Te.filter(s=>Z.includes(s.id));return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200 sticky top-0 bg-white z-10",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900",children:"Nueva Solicitud de Trabajo"}),e.jsxs("p",{className:"text-sm text-gray-500 mt-1",children:["Solicitante: ",c?.email||"Cargando..."]})]}),e.jsx("button",{onClick:r,type:"button",className:"text-gray-400 hover:text-gray-600 transition-colors cursor-pointer",children:e.jsx("i",{className:"ri-close-line text-xl"})})]}),e.jsxs("form",{onSubmit:Oe,className:"p-6 space-y-6",children:[e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsxs("h3",{className:"text-sm font-semibold text-blue-900 mb-3 flex items-center gap-2",children:[e.jsx("i",{className:"ri-file-list-3-line"}),"Â¿Desea importar datos desde una cotizaciÃ³n existente?"]}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",value:_,onChange:s=>{A(s.target.value),s.target.value||le()},onFocus:()=>C.length>0&&L(!0),placeholder:"Buscar por cÃ³digo de cotizaciÃ³n o nombre del cliente...",className:"w-full px-4 py-2 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"}),R&&e.jsx("div",{className:"absolute right-3 top-1/2 -translate-y-1/2",children:e.jsx("i",{className:"ri-loader-4-line animate-spin text-gray-400"})}),O&&e.jsx("button",{type:"button",onClick:le,className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 cursor-pointer",children:e.jsx("i",{className:"ri-close-circle-line text-xl"})})]}),G&&C.length>0&&e.jsx("div",{className:"absolute z-20 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto",children:C.map(s=>e.jsx("button",{type:"button",onClick:()=>X(s),className:"w-full px-4 py-3 text-left hover:bg-gray-50 border-b border-gray-100 last:border-b-0 cursor-pointer transition-colors",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium text-gray-900",children:s.codigo}),e.jsx("div",{className:"text-sm text-gray-600",children:s.cliente_nombre})]}),e.jsxs("div",{className:"text-sm font-semibold text-blue-600",children:["â‚¡",s.total.toLocaleString("es-CR",{minimumFractionDigits:2})]})]})},s.id))}),_.length>=3&&!R&&C.length===0&&e.jsx("div",{className:"mt-2 text-sm text-gray-500 text-center",children:"No se encontraron cotizaciones"}),O&&e.jsx("div",{className:"mt-3 p-3 bg-green-50 border border-green-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center gap-2 text-green-800",children:[e.jsx("i",{className:"ri-checkbox-circle-line"}),e.jsxs("span",{className:"text-sm font-medium",children:["CotizaciÃ³n seleccionada: ",O.codigo]})]})})]}),e.jsxs("div",{className:"space-y-6 border-t border-gray-200 pt-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"InformaciÃ³n de la Solicitud"}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Departamento Solicitante ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:I,onChange:s=>{W(s.target.value),he(""),me(""),ne(""),te("")},required:!0,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"",children:"Seleccionar departamento..."}),e.jsx("option",{value:"Servicio al Cliente",children:"Servicio al Cliente"}),e.jsx("option",{value:"Zona Franca",children:"Zona Franca"}),e.jsx("option",{value:"Otros",children:"Otros"})]})]}),I==="Servicio al Cliente"&&e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Cliente ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:q,onChange:s=>{he(s.target.value),me(""),ne(""),te("")},required:!0,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"",children:"Seleccionar cliente..."}),e.jsx("option",{value:"EPA",children:"EPA"}),e.jsx("option",{value:"COFERSA",children:"COFERSA"})]})]}),I==="Servicio al Cliente"&&q==="EPA"&&e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Â¿QuÃ© deseas solicitar? ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:J,onChange:s=>me(s.target.value),required:!0,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"",children:"Seleccionar tipo de solicitud..."}),e.jsx("option",{value:"CÃ³digos de Barra",children:"CÃ³digos de Barra"}),e.jsx("option",{value:"Registros sanitarios",children:"Registros sanitarios"}),e.jsx("option",{value:"Licencias / contenedores / Pallets",children:"Licencias / contenedores / Pallets"}),e.jsx("option",{value:"TraducciÃ³n",children:"TraducciÃ³n"}),e.jsx("option",{value:"Suministros",children:"Suministros"}),e.jsx("option",{value:"Usos Delta Plus",children:"Usos Delta Plus"}),e.jsx("option",{value:"Armado de sillas",children:"Armado de sillas"})]})]}),I==="Servicio al Cliente"&&q==="COFERSA"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Â¿QuÃ© deseas solicitar? ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:re,onChange:s=>ne(s.target.value),required:!0,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"",children:"Seleccionar tipo de solicitud..."}),e.jsx("option",{value:"Etiquetado",children:"Etiquetado"}),e.jsx("option",{value:"Cambio de imagen",children:"Cambio de imagen"}),e.jsx("option",{value:"Licencias",children:"Licencias"}),e.jsx("option",{value:"Suministros",children:"Suministros"}),e.jsx("option",{value:"Re-empacar productos",children:"Re-empacar productos"})]})]}),re&&e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["El siguiente trabajo es para: ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:be,onChange:s=>te(s.target.value),required:!0,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"",children:"Seleccionar tipo de trabajo..."}),e.jsx("option",{value:"Trabajo Interno (Stock)",children:"Trabajo Interno (Stock)"}),e.jsx("option",{value:"Clientes de Cofersa",children:"Clientes de Cofersa"})]})]})]}),ce()&&e.jsxs("div",{className:"border border-gray-300 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("label",{className:"text-sm font-medium text-gray-700",children:[q==="COFERSA"?"CÃ³digo y cantidades a etiquetar":"CÃ³digo y cantidades"," ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{type:"button",onClick:ze,className:"px-3 py-1.5 text-xs font-medium text-green-600 bg-green-50 border border-green-200 rounded cursor-pointer hover:bg-green-100 transition-colors whitespace-nowrap",children:[e.jsx("i",{className:"ri-download-2-line mr-1"}),"Descargar Plantilla"]}),e.jsxs("label",{className:"px-3 py-1.5 text-xs font-medium text-blue-600 bg-blue-50 border border-blue-200 rounded cursor-pointer hover:bg-blue-100 transition-colors whitespace-nowrap",children:[e.jsx("i",{className:"ri-file-excel-2-line mr-1"}),"Cargar Excel",e.jsx("input",{type:"file",accept:".xlsx,.xls",onChange:ge,className:"hidden"})]}),e.jsxs("button",{type:"button",onClick:ie,className:"px-3 py-1.5 text-xs font-medium text-white bg-green-600 rounded hover:bg-green-700 transition-colors cursor-pointer whitespace-nowrap",children:[e.jsx("i",{className:"ri-add-line mr-1"}),"Agregar Fila"]})]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-50",children:[e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-700 border border-gray-300",children:"CÃ³digo"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-700 border border-gray-300",children:"Cantidad"}),e.jsx("th",{className:"px-3 py-2 text-center text-xs font-medium text-gray-700 border border-gray-300 w-20",children:"Acciones"})]})}),e.jsx("tbody",{children:z.map((s,x)=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"border border-gray-300 p-1",children:e.jsx("input",{type:"text",value:s.codigo,onChange:v=>ae(x,"codigo",v.target.value),placeholder:"CÃ³digo del producto",className:"w-full px-2 py-1 text-sm border-0 focus:ring-1 focus:ring-blue-500"})}),e.jsx("td",{className:"border border-gray-300 p-1",children:e.jsx("input",{type:"number",value:s.cantidad,onChange:v=>ae(x,"cantidad",parseFloat(v.target.value)||0),placeholder:"0",min:"0",step:"0.01",className:"w-full px-2 py-1 text-sm border-0 focus:ring-1 focus:ring-blue-500"})}),e.jsx("td",{className:"border border-gray-300 p-1 text-center",children:e.jsx("button",{type:"button",onClick:()=>Fe(x),disabled:z.length===1,className:"text-red-600 hover:text-red-800 disabled:text-gray-300 disabled:cursor-not-allowed cursor-pointer",children:e.jsx("i",{className:"ri-delete-bin-line"})})})]},x))})]})}),e.jsx("p",{className:"text-xs text-gray-500 mt-2",children:'Formato Excel: Columnas "Codigo" y "Cantidad"'})]}),ve()&&e.jsxs("div",{className:"border border-gray-300 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("label",{className:"text-sm font-medium text-gray-700",children:["DescripciÃ³n, cantidad y motivo ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{type:"button",onClick:ze,className:"px-3 py-1.5 text-xs font-medium text-green-600 bg-green-50 border border-green-200 rounded cursor-pointer hover:bg-green-100 transition-colors whitespace-nowrap",children:[e.jsx("i",{className:"ri-download-2-line mr-1"}),"Descargar Plantilla"]}),e.jsxs("label",{className:"px-3 py-1.5 text-xs font-medium text-blue-600 bg-blue-50 border border-blue-200 rounded cursor-pointer hover:bg-blue-100 transition-colors whitespace-nowrap",children:[e.jsx("i",{className:"ri-file-excel-2-line mr-1"}),"Cargar Excel",e.jsx("input",{type:"file",accept:".xlsx,.xls",onChange:ge,className:"hidden"})]}),e.jsxs("button",{type:"button",onClick:Se,className:"px-3 py-1.5 text-xs font-medium text-white bg-green-600 rounded hover:bg-green-700 transition-colors cursor-pointer whitespace-nowrap",children:[e.jsx("i",{className:"ri-add-line mr-1"}),"Agregar Fila"]})]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-50",children:[e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-700 border border-gray-300",children:"DescripciÃ³n"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-700 border border-gray-300",children:"Cantidad"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-700 border border-gray-300",children:"Motivo"}),e.jsx("th",{className:"px-3 py-2 text-center text-xs font-medium text-gray-700 border border-gray-300 w-20",children:"Acciones"})]})}),e.jsx("tbody",{children:K.map((s,x)=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"border border-gray-300 p-1",children:e.jsx("input",{type:"text",value:s.descripcion,onChange:v=>je(x,"descripcion",v.target.value),placeholder:"DescripciÃ³n del item",className:"w-full px-2 py-1 text-sm border-0 focus:ring-1 focus:ring-blue-500"})}),e.jsx("td",{className:"border border-gray-300 p-1",children:e.jsx("input",{type:"number",value:s.cantidad,onChange:v=>je(x,"cantidad",parseFloat(v.target.value)||0),placeholder:"0",min:"0",step:"0.01",className:"w-full px-2 py-1 text-sm border-0 focus:ring-1 focus:ring-blue-500"})}),e.jsx("td",{className:"border border-gray-300 p-1",children:e.jsx("input",{type:"text",value:s.motivo,onChange:v=>je(x,"motivo",v.target.value),placeholder:"Motivo de la solicitud",className:"w-full px-2 py-1 text-sm border-0 focus:ring-1 focus:ring-blue-500"})}),e.jsx("td",{className:"border border-gray-300 p-1 text-center",children:e.jsx("button",{type:"button",onClick:()=>Ae(x),disabled:K.length===1,className:"text-red-600 hover:text-red-800 disabled:text-gray-300 disabled:cursor-not-allowed cursor-pointer",children:e.jsx("i",{className:"ri-delete-bin-line"})})})]},x))})]})}),e.jsx("p",{className:"text-xs text-gray-500 mt-2",children:'Formato Excel: Columnas "Descripcion", "Cantidad" y "Motivo"'})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 border-t border-gray-200 pt-6",children:e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Fecha Estimada de Entrega"}),e.jsx("input",{type:"date",value:Ce,onChange:s=>Re(s.target.value),min:qe,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"DescripciÃ³n Breve"}),e.jsx("input",{type:"text",value:fe,onChange:s=>ke(s.target.value),placeholder:"Resumen de la solicitud...",maxLength:100,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:[fe.length,"/100 caracteres"]})]}),O&&w("cotizaciones:read")&&e.jsxs("div",{children:[e.jsxs("button",{type:"button",onClick:Ee,className:"w-full px-4 py-3 text-sm font-medium text-blue-700 bg-blue-50 border border-blue-300 rounded-lg hover:bg-blue-100 transition-colors cursor-pointer flex items-center justify-center gap-2",children:[e.jsx("i",{className:"ri-external-link-line"}),"Ver CotizaciÃ³n Completa"]}),e.jsx("p",{className:"text-xs text-gray-500 mt-2 text-center",children:"Se abrirÃ¡ en una nueva pestaÃ±a para revisar o modificar"})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 border-t border-gray-200 pt-6 sticky bottom-0 bg-white",children:[e.jsx("button",{type:"button",onClick:r,className:"px-6 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors cursor-pointer whitespace-nowrap",children:"Cancelar"}),e.jsx("button",{type:"submit",disabled:t,className:"px-6 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors cursor-pointer whitespace-nowrap",children:t?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("i",{className:"ri-loader-4-line animate-spin"}),"Guardando..."]}):e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("i",{className:"ri-save-line"}),"Guardar y Enviar"]})})]})]}),M&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[80vh] overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900",children:"Asignar Personal"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Seleccione el personal que trabajarÃ¡ en esta tarea"})]}),e.jsx("button",{onClick:()=>xe(!1),type:"button",className:"text-gray-400 hover:text-gray-600 transition-colors cursor-pointer",children:e.jsx("i",{className:"ri-close-line text-xl"})})]}),e.jsx("div",{className:"p-4 border-b border-gray-200",children:e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",value:Ne,onChange:s=>Be(s.target.value),placeholder:"Buscar por nombre o email...",className:"w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"}),e.jsx("i",{className:"ri-search-line absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"})]})}),pe.length>0&&e.jsxs("div",{className:"p-4 bg-blue-50 border-b border-blue-200",children:[e.jsx("div",{className:"flex items-center justify-between mb-2",children:e.jsxs("h4",{className:"text-sm font-semibold text-blue-900",children:["Personal Asignado (",pe.length,")"]})}),e.jsx("div",{className:"flex flex-wrap gap-2",children:pe.map(s=>e.jsxs("div",{className:"inline-flex items-center gap-2 px-3 py-1.5 bg-white border border-blue-300 rounded-lg text-sm",children:[e.jsx("i",{className:"ri-user-line text-blue-600"}),e.jsx("span",{className:"text-gray-900",children:s.nombre}),e.jsx("button",{type:"button",onClick:()=>Ie(s.id),className:"text-red-500 hover:text-red-700 cursor-pointer",children:e.jsx("i",{className:"ri-close-line"})})]},s.id))})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:Pe.length===0?e.jsxs("div",{className:"text-center text-gray-500 py-8",children:[e.jsx("i",{className:"ri-user-search-line text-4xl text-gray-300 mb-2"}),e.jsx("p",{children:"No se encontraron colaboradores"})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:Pe.map(s=>{const x=Z.includes(s.id);return e.jsx("div",{className:`p-4 border rounded-lg transition-all cursor-pointer ${x?"border-blue-500 bg-blue-50":"border-gray-300 hover:border-blue-300 hover:bg-gray-50"}`,onClick:()=>{x?Ie(s.id):Ue(s.id)},children:e.jsx("div",{className:"flex items-start justify-between",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-900",children:s.nombre}),x&&e.jsx("i",{className:"ri-checkbox-circle-fill text-blue-600"})]}),s.email&&e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:[e.jsx("i",{className:"ri-mail-line mr-1"}),s.email]}),s.telefono&&e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:[e.jsx("i",{className:"ri-phone-line mr-1"}),s.telefono]})]})})},s.id)})})}),e.jsxs("div",{className:"flex justify-between items-center p-4 border-t border-gray-200 bg-gray-50",children:[e.jsxs("div",{className:"text-sm text-gray-600",children:[pe.length," persona",pe.length!==1?"s":""," seleccionada",pe.length!==1?"s":""]}),e.jsx("button",{type:"button",onClick:()=>xe(!1),className:"px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors cursor-pointer whitespace-nowrap",children:"Confirmar SelecciÃ³n"})]})]})})]})})}const ro=["En Cola","En Proceso","Produciendo","Esperando suministros","Terminado","Finalizado"];function io({tarea:r,onClose:a,onSave:t}){const{tiendaActual:i}=$e(),{notification:c,showNotification:p,hideNotification:w,confirmation:_}=Ge(),[A,O]=n.useState(!1),[u,C]=n.useState("info"),[f,G]=n.useState(r.fecha_estimada_entrega||""),[L,R]=n.useState(r.cantidad_unidades?.toString()||""),[H,I]=n.useState(r.descripcion_breve||""),[W,q]=n.useState(r.fecha_inicio?new Date(r.fecha_inicio).toISOString().split("T")[0]:""),[he,J]=n.useState(r.fecha_cierre?new Date(r.fecha_cierre).toISOString().split("T")[0]:""),[me,re]=n.useState(r.entregado_a||""),[ne,be]=n.useState(r.estado),[te,z]=n.useState(r.items||[]),[V,K]=n.useState([]),[P,Z]=n.useState(r.personal_asignado?.map(o=>o.colaborador_id)||[]),[ue,M]=n.useState(!1),[xe,Te]=n.useState(""),[Y,Ne]=n.useState(!1),[Be,_e]=n.useState(!1),[De,Ce]=n.useState([]),[Re,fe]=n.useState(!1),[ke,qe]=n.useState(""),[j,ye]=n.useState({descripcion:"",cantidad:0,costo_unitario:0,item_type:"inventario",producto_id:null,inventario_id:null}),[X,le]=n.useState(""),[Ee,ie]=n.useState([]),[Fe,ae]=n.useState(!1),[Se,Ae]=n.useState(!1),[je,ge]=n.useState([]),[ze,ce]=n.useState(!1),ve=2,Oe=400;n.useEffect(()=>{(async()=>{if(!(!r.cotizacion_id||te.length>0)){console.log("=".repeat(50)),console.log("ğŸ”„ CARGANDO COMPONENTES BOM AUTOMÃTICAMENTE"),console.log("=".repeat(50)),console.log("ğŸ“¦ CotizaciÃ³n ID:",r.cotizacion_id);try{console.log("ğŸ“¡ Consultando items de cotizaciÃ³n en Supabase...");const{data:l,error:h}=await m.from("cotizacion_items").select("producto_id, cantidad").eq("cotizacion_id",r.cotizacion_id);if(console.log("ğŸ“¥ Respuesta de items recibida"),console.log("   - Error:",h),console.log("   - Data:",l),console.log("   - Cantidad de items:",l?.length||0),h){console.error("âŒ ERROR AL OBTENER ITEMS DE COTIZACIÃ“N:",h);return}if(!l||l.length===0){console.log("âš ï¸ La cotizaciÃ³n no tiene items asociados");return}console.log("ğŸ”„ Procesando items de cotizaciÃ³n...");const y=new Map;for(const d of l){console.log("=".repeat(50)),console.log("ğŸ“¦ Procesando item de cotizaciÃ³n"),console.log("   - Producto ID:",d.producto_id),console.log("   - Cantidad:",d.cantidad),console.log("ğŸ“¡ Consultando BOM del producto...");const{data:g,error:S}=await m.from("bom_items").select(`
              id_componente,
              cantidad_x_unidad,
              inventario!bom_items_id_componente_fkey(
                id_articulo,
                codigo_articulo,
                descripcion_articulo,
                costo_articulo
              )
            `).eq("product_id",d.producto_id);if(console.log("ğŸ“¥ Respuesta de BOM recibida"),console.log("   - Error:",S),console.log("   - Data:",g),console.log("   - Cantidad de componentes:",g?.length||0),S){console.error("âŒ ERROR AL OBTENER BOM:",S);continue}if(!g||g.length===0){console.log("âš ï¸ El producto no tiene BOM definido");continue}console.log("ğŸ”„ Procesando componentes BOM...");for(const D of g){if(!D.inventario){console.log("âš ï¸ Componente sin inventario asociado:",D.id_componente);continue}const $=d.cantidad*D.cantidad_x_unidad,Q=D.inventario.id_articulo;if(console.log("   ğŸ“¦ Componente:",{id:Q,codigo:D.inventario.codigo_articulo,descripcion:D.inventario.descripcion_articulo,cantidadPorUnidad:D.cantidad_x_unidad,cantidadProducto:d.cantidad,cantidadTotal:$,costo:D.inventario.costo_articulo}),y.has(Q)){const de=y.get(Q);console.log("   â™»ï¸ Componente duplicado, sumando cantidades"),console.log("      - Cantidad anterior:",de.cantidad),console.log("      - Cantidad a sumar:",$),console.log("      - Cantidad nueva:",de.cantidad+$),y.set(Q,{...de,cantidad:de.cantidad+$})}else console.log("   âœ… Nuevo componente agregado al mapa"),y.set(Q,{cantidad:$,costo:D.inventario.costo_articulo||0,codigo:D.inventario.codigo_articulo,descripcion:D.inventario.descripcion_articulo})}}console.log("=".repeat(50)),console.log("ğŸ“Š RESUMEN DE COMPONENTES"),console.log("=".repeat(50)),console.log("Total de componentes Ãºnicos:",y.size),console.log("Detalle:"),y.forEach((d,g)=>{console.log(`   - ${d.codigo}: ${d.cantidad} unidades @ ${se(d.costo)}`)}),console.log("ğŸ”„ Convirtiendo mapa a array de items...");const b=Array.from(y.entries()).map(([d,g])=>{const S={id:`temp-${Date.now()}-${Math.random()}`,tarea_id:r.id,item_type:"inventario",inventario_id:d,producto_id:null,descripcion:g.descripcion,cantidad:g.cantidad,costo_unitario:g.costo,total:g.cantidad*g.costo,created_at:new Date().toISOString(),updated_at:new Date().toISOString()};return console.log("   âœ… Item creado:",S),S});console.log("ğŸ“Š Total de items a agregar:",b.length),z(b),console.log("âœ… COMPONENTES BOM CARGADOS AUTOMÃTICAMENTE"),console.log("=".repeat(50))}catch(l){console.error("ğŸ’¥ ERROR CRÃTICO EN CARGA AUTOMÃTICA:",l)}}})()},[r.cotizacion_id,r.id]),n.useEffect(()=>{if(console.log("=".repeat(50)),console.log("ğŸ”„ useEffect de bÃºsqueda ejecutado"),console.log("ğŸ“ Estado actual:",{itemBusqueda:X,tipo:j.item_type,tiendaActual:i?.tienda_id,tiendaActualCompleto:i,longitudBusqueda:X.length,MIN_CHARS:ve,DEBOUNCE_MS:Oe}),!X||X.length<ve){console.log("â¸ï¸ BÃšSQUEDA CANCELADA: Texto muy corto o vacÃ­o"),console.log("   - itemBusqueda:",X),console.log("   - Longitud:",X.length),console.log("   - MÃ­nimo requerido:",ve),ie([]),ae(!1),ge([]),ce(!1),console.log("=".repeat(50));return}j.item_type!=="cotizacion"&&(i?.tienda_id?console.log("âœ… Tienda actual encontrada:",i.tienda_id):(console.log("âš ï¸ ADVERTENCIA: Sin tienda actual, buscando sin filtro de tienda"),console.log("   - Tipo:",j.item_type),console.log("   - Tienda actual:",i),console.log("   - Se procederÃ¡ con la bÃºsqueda sin filtro de tienda"))),console.log("âœ… Validaciones pasadas, iniciando debounce..."),console.log("â±ï¸ Esperando",Oe,"ms antes de buscar");const o=setTimeout(async()=>{console.log("=".repeat(50)),console.log("ğŸš€ INICIANDO BÃšSQUEDA"),console.log("ğŸ“Š ParÃ¡metros de bÃºsqueda:",{tipo:j.item_type,termino:X,tienda:i?.tienda_id||"SIN TIENDA"}),Ae(!0),console.log("â³ Estado loading activado");try{const l=X.trim();if(console.log("ğŸ”¤ TÃ©rmino limpio:",l),j.item_type==="cotizacion"){console.log("=".repeat(50)),console.log("ğŸ” BÃšSQUEDA EN COTIZACIONES"),console.log("=".repeat(50)),console.log("ğŸ“¡ Construyendo query de Supabase..."),console.log("   - Tabla: cotizaciones"),console.log("   - Select: id, codigo, total, clientes"),console.log("   - Filtro: codigo.ilike.%"+l+"%"),console.log("   - Order: created_at DESC"),console.log("   - Limit: 10");const{data:h,error:y}=await m.from("cotizaciones").select(`
              id,
              codigo,
              total,
              clientes!cotizaciones_cliente_id_fkey(
                id,
                nombre_razon_social
              )
            `).or(`codigo.ilike.%${l}%`).order("created_at",{ascending:!1}).limit(10);if(console.log("ğŸ“¥ Respuesta de Supabase recibida"),console.log("   - Error:",y),console.log("   - Data:",h),console.log("   - Cantidad de resultados:",h?.length||0),y){console.log("=".repeat(50)),console.error("âŒ ERROR EN BÃšSQUEDA DE COTIZACIONES:",y),console.error("   - Mensaje:",y.message),console.error("   - CÃ³digo:",y.code),console.error("   - Detalles:",y.details),console.log("=".repeat(50));return}console.log("ğŸ”„ Procesando resultados...");const b=(h||[]).filter(d=>{const g=d.clientes!==null;return console.log("   - CotizaciÃ³n",d.codigo,"â†’ Cliente:",g?d.clientes?.nombre_razon_social:"NULL"),g}).map(d=>{const g={id:d.id,codigo:d.codigo,cliente_nombre:d.clientes?.nombre_razon_social||"Sin cliente",total:d.total};return console.log("   âœ… OpciÃ³n creada:",g),g});console.log("ğŸ“Š Total de opciones procesadas:",b.length),console.log("ğŸ“‹ Opciones finales:",b),ge(b),ce(b.length>0),console.log("âœ… Estado actualizado"),console.log("   - Opciones:",b.length),console.log("   - Dropdown visible:",b.length>0)}else if(j.item_type==="inventario"){console.log("ğŸ” Buscando en inventario con tÃ©rmino:",l);let h=m.from("inventario").select("id_articulo, codigo_articulo, descripcion_articulo, costo_articulo");i?.tienda_id?(console.log("   - Filtro tienda: tienda_id =",i.tienda_id),h=h.eq("tienda_id",i.tienda_id)):console.log("   - âš ï¸ SIN FILTRO DE TIENDA (buscando en todas las tiendas)");const{data:y,error:b}=await h.or(`codigo_articulo.ilike.%${l}%,descripcion_articulo.ilike.%${l}%`).limit(10);if(console.log("ğŸ“¥ Respuesta de Supabase recibida"),console.log("   - Error:",b),console.log("   - Data:",y),console.log("   - Cantidad de resultados:",y?.length||0),b){console.log("=".repeat(50)),console.error("âŒ ERROR EN BÃšSQUEDA DE INVENTARIO"),console.error("   - Mensaje:",b.message),console.error("   - CÃ³digo:",b.code),console.error("   - Detalles:",b),console.log("=".repeat(50)),ie([]),ae(!1);return}console.log("ğŸ”„ Procesando resultados...");const d=(y||[]).map(g=>{const S={tipo:"inventario",id:g.id_articulo,codigo:g.codigo_articulo,nombre:g.descripcion_articulo,precio:g.costo_articulo||0};return console.log("   âœ… OpciÃ³n creada:",S),S});console.log("ğŸ“Š Total de opciones procesadas:",d.length),console.log("ğŸ“‹ Opciones finales:",d),ie(d),ae(d.length>0),console.log("âœ… Estado actualizado"),console.log("   - Opciones:",d.length),console.log("   - Dropdown visible:",d.length>0)}else{console.log("ğŸ” Buscando en productos con tÃ©rmino:",l);let h=m.from("productos").select("id_producto, codigo_producto, descripcion_producto, costo_total_bom");console.log("ğŸ“¡ Construyendo query de Supabase..."),console.log("   - Tabla: productos"),console.log("   - Select: id_producto, codigo_producto, descripcion_producto, costo_total_bom"),i?.tienda_id?(h=h.eq("tienda_id",i.tienda_id),console.log("   - Filtro tienda: tienda_id =",i.tienda_id)):console.log("   - âš ï¸ SIN FILTRO DE TIENDA (buscando en todas las tiendas)");const{data:y,error:b}=await h.or(`codigo_producto.ilike.%${l}%,descripcion_producto.ilike.%${l}%`).limit(10);if(console.log("   - Filtro bÃºsqueda: codigo_producto.ilike.%"+l+"% OR descripcion_producto.ilike.%"+l+"%"),console.log("   - Limit: 10"),console.log("ğŸ“¥ Respuesta de Supabase recibida"),console.log("   - Error:",b),console.log("   - Data:",y),console.log("   - Cantidad de resultados:",y?.length||0),b){console.log("=".repeat(50)),console.error("âŒ ERROR EN BÃšSQUEDA DE PRODUCTOS"),console.error("   - Mensaje:",b.message),console.error("   - CÃ³digo:",b.code),console.error("   - Detalles:",b),console.log("=".repeat(50)),ie([]),ae(!1);return}console.log("ğŸ”„ Procesando resultados...");const d=(y||[]).map(g=>{const S={tipo:"producto",id:g.id_producto,codigo:g.codigo_producto,nombre:g.descripcion_producto,precio:g.costo_total_bom||0};return console.log("   âœ… OpciÃ³n creada:",S),S});console.log("ğŸ“Š Total de opciones procesadas:",d.length),console.log("ğŸ“‹ Opciones finales:",d),ie(d),ae(d.length>0),console.log("âœ… Estado actualizado"),console.log("   - Opciones:",d.length),console.log("   - Dropdown visible:",d.length>0)}}catch(l){console.log("=".repeat(50)),console.error("âŒ Error buscando items:",l)}finally{Ae(!1)}},Oe);return console.log("ğŸ”„ Timer creado, ID:",o),console.log("=".repeat(50)),()=>{console.log("ğŸ§¹ Cleanup: Cancelando timer",o),clearTimeout(o)}},[X,j.item_type,i]),n.useEffect(()=>{Le()},[]);const Le=async()=>{try{const o=await oe.getColaboradores();K(o)}catch(o){console.error("Error cargando colaboradores:",o)}},Ue=async o=>{if(o.item_type!=="producto"||!o.producto_id){p("warning","Este item no es un producto o no tiene ID de producto");return}fe(!0),_e(!0),qe(o.descripcion);try{const{data:l,error:h}=await m.from("bom_items").select(`
          id_componente,
          cantidad_x_unidad,
          inventario!bom_items_id_componente_fkey(
            id_articulo,
            codigo_articulo,
            descripcion_articulo
          )
        `).eq("product_id",o.producto_id);if(h){console.error("Error obteniendo BOM:",h),p("error","Error al cargar los componentes del producto"),_e(!1);return}if(!l||l.length===0){Ce([]);return}const y=l.map(b=>({id_componente:b.id_componente,codigo_articulo:b.inventario.codigo_articulo,descripcion_articulo:b.inventario.descripcion_articulo,cantidad_x_unidad:b.cantidad_x_unidad,cantidad_total:b.cantidad_x_unidad*o.cantidad}));Ce(y)}catch(l){console.error("Error cargando BOM:",l),p("error","Error al cargar los componentes del producto"),_e(!1)}finally{fe(!1)}},Ie=o=>{console.log("=".repeat(50)),console.log("ğŸ¯ ITEM SELECCIONADO"),console.log("=".repeat(50)),console.log("ğŸ“¦ Item:",o),console.log("   - Tipo:",o.tipo),console.log("   - ID:",o.id),console.log("   - CÃ³digo:",o.codigo),console.log("   - Nombre:",o.nombre),console.log("   - Precio:",o.precio),ye({...j,descripcion:o.nombre,costo_unitario:o.precio,producto_id:o.tipo==="producto"?o.id:null,inventario_id:o.tipo==="inventario"?o.id:null}),console.log("âœ… Estado nuevoItem actualizado:",{...j,descripcion:o.nombre,costo_unitario:o.precio}),le(o.codigo),ae(!1),ie([]),console.log("âœ… Estados de bÃºsqueda limpiados"),console.log("   - itemBusqueda:",o.codigo),console.log("   - mostrarItemsOpciones: false"),console.log("   - itemsOpciones: []"),console.log("=".repeat(50))},Pe=async o=>{console.log("=".repeat(50)),console.log("ğŸ¯ COTIZACIÃ“N SELECCIONADA"),console.log("=".repeat(50)),console.log("ğŸ“¦ CotizaciÃ³n:",o),console.log("   - ID:",o.id),console.log("   - CÃ³digo:",o.codigo),console.log("   - Cliente:",o.cliente_nombre),console.log("   - Total:",o.total),le(o.codigo),ce(!1),ge([]),console.log("âœ… Estados de bÃºsqueda limpiados"),console.log("ğŸ”„ Iniciando importaciÃ³n de items de cotizaciÃ³n...");try{console.log("ğŸ“¡ Consultando items de cotizaciÃ³n en Supabase..."),console.log("   - Tabla: cotizacion_items"),console.log("   - Filtro: cotizacion_id =",o.id);const{data:l,error:h}=await m.from("cotizacion_items").select("producto_id, cantidad").eq("cotizacion_id",o.id);if(console.log("ğŸ“¥ Respuesta de items recibida"),console.log("   - Error:",h),console.log("   - Data:",l),console.log("   - Cantidad de items:",l?.length||0),h){console.log("=".repeat(50)),console.error("âŒ ERROR AL OBTENER ITEMS DE COTIZACIÃ“N:",h),console.error("   - Mensaje:",h.message),console.error("   - CÃ³digo:",h.code),console.log("=".repeat(50));return}if(!l||l.length===0){console.log("âš ï¸ La cotizaciÃ³n no tiene items asociados"),console.log("=".repeat(50));return}console.log("ğŸ”„ Procesando items de cotizaciÃ³n...");const y=new Map;for(const d of l){console.log("=".repeat(50)),console.log("ğŸ“¦ Procesando item de cotizaciÃ³n"),console.log("   - Producto ID:",d.producto_id),console.log("   - Cantidad:",d.cantidad),console.log("ğŸ“¡ Consultando BOM del producto..."),console.log("   - Tabla: bom_items"),console.log("   - Filtro: producto_id =",d.producto_id);const{data:g,error:S}=await m.from("bom_items").select(`
            id_componente,
            cantidad_x_unidad,
            inventario!bom_items_id_componente_fkey(
              id_articulo,
              codigo_articulo,
              descripcion_articulo,
              costo_articulo
            )
          `).eq("product_id",d.producto_id);if(console.log("ğŸ“¥ Respuesta de BOM recibida"),console.log("   - Error:",S),console.log("   - Data:",g),console.log("   - Cantidad de componentes:",g?.length||0),S){console.log("=".repeat(50)),console.error("âŒ ERROR AL OBTENER BOM:",S),console.error("   - Mensaje:",S.message),console.error("   - CÃ³digo:",S.code);continue}if(!g||g.length===0){console.log("âš ï¸ El producto no tiene BOM definido");continue}console.log("ğŸ”„ Procesando componentes BOM...");for(const D of g){if(!D.inventario){console.log("âš ï¸ Componente sin inventario asociado:",D.id_componente);continue}const $=d.cantidad*D.cantidad_x_unidad,Q=D.inventario.id_articulo;if(console.log("   ğŸ“¦ Componente:",{id:Q,codigo:D.inventario.codigo_articulo,descripcion:D.inventario.descripcion_articulo,cantidadPorUnidad:D.cantidad_x_unidad,cantidadProducto:d.cantidad,cantidadTotal:$,costo:D.inventario.costo_articulo}),y.has(Q)){const de=y.get(Q);console.log("   â™»ï¸ Componente duplicado, sumando cantidades"),console.log("      - Cantidad anterior:",de.cantidad),console.log("      - Cantidad a sumar:",$),console.log("      - Cantidad nueva:",de.cantidad+$),y.set(Q,{...de,cantidad:de.cantidad+$})}else console.log("   âœ… Nuevo componente agregado al mapa"),y.set(Q,{cantidad:$,costo:D.inventario.costo_articulo||0,codigo:D.inventario.codigo_articulo,descripcion:D.inventario.descripcion_articulo})}}console.log("=".repeat(50)),console.log("ğŸ“Š RESUMEN DE COMPONENTES"),console.log("=".repeat(50)),console.log("Total de componentes Ãºnicos:",y.size),console.log("Detalle:"),y.forEach((d,g)=>{console.log(`   - ${d.codigo}: ${d.cantidad} unidades @ ${se(d.costo)}`)}),console.log("ğŸ”„ Convirtiendo mapa a array de items...");const b=Array.from(y.entries()).map(([d,g])=>{const S={id:`temp-${Date.now()}-${Math.random()}`,tarea_id:r.id,item_type:"inventario",inventario_id:d,producto_id:null,descripcion:g.descripcion,cantidad:g.cantidad,costo_unitario:g.costo,total:g.cantidad*g.costo,created_at:new Date().toISOString(),updated_at:new Date().toISOString()};return console.log("   âœ… Item creado:",S),S});console.log("ğŸ“Š Total de items a agregar:",b.length),console.log("ğŸ“‹ Items finales:",b),z(d=>{const g=[...d,...b];return console.log("âœ… Estado items actualizado"),console.log("   - Items anteriores:",d.length),console.log("   - Items nuevos:",b.length),console.log("   - Total items:",g.length),g}),console.log("âœ… IMPORTACIÃ“N COMPLETADA EXITOSAMENTE"),console.log("=".repeat(50)),p("success",`Se importaron ${b.length} componentes desde la cotizaciÃ³n`)}catch(l){console.log("=".repeat(50)),console.error("ğŸ’¥ ERROR CRÃTICO EN IMPORTACIÃ“N"),console.error("Error:",l),console.error("Stack:",l instanceof Error?l.stack:"No stack trace"),console.log("=".repeat(50))}},pe=()=>{le(""),ie([]),ae(!1),ge([]),ce(!1),ye({descripcion:"",costo_unitario:0,producto_id:null,inventario_id:null})},s=()=>{if(!j.descripcion||j.cantidad<=0){p("warning","Complete todos los campos del item");return}const o={id:`temp-${Date.now()}`,tarea_id:r.id,item_type:j.item_type,producto_id:j.producto_id,inventario_id:j.inventario_id,descripcion:j.descripcion,cantidad:j.cantidad,costo_unitario:j.costo_unitario,total:j.cantidad*j.costo_unitario,created_at:new Date().toISOString(),updated_at:new Date().toISOString()};z(l=>[...l,o]),ye({descripcion:"",cantidad:0,costo_unitario:0,item_type:"inventario",producto_id:null,inventario_id:null}),le("")},x=o=>{z(l=>l.filter((h,y)=>y!==o))},v=async()=>{if(!r.cotizacion_id){p("warning","Esta tarea no tiene una cotizaciÃ³n asociada");return}console.log("=".repeat(50)),console.log("ğŸ”„ IMPORTANDO COMPONENTES BOM DESDE COTIZACIÃ“N"),console.log("=".repeat(50)),console.log("ğŸ“¦ CotizaciÃ³n ID:",r.cotizacion_id);try{console.log("ğŸ“¡ Consultando items de cotizaciÃ³n en Supabase...");const{data:o,error:l}=await m.from("cotizacion_items").select("producto_id, cantidad").eq("cotizacion_id",r.cotizacion_id);if(console.log("ğŸ“¥ Respuesta de items recibida"),console.log("   - Error:",l),console.log("   - Data:",o),console.log("   - Cantidad de items:",o?.length||0),l){console.error("âŒ ERROR AL OBTENER ITEMS DE COTIZACIÃ“N:",l),p("error","Error al obtener items de la cotizaciÃ³n");return}if(!o||o.length===0){console.log("âš ï¸ La cotizaciÃ³n no tiene items asociados"),p("warning","La cotizaciÃ³n no tiene items asociados");return}console.log("ğŸ”„ Procesando items de cotizaciÃ³n...");const h=new Map;for(const b of o){console.log("=".repeat(50)),console.log("ğŸ“¦ Procesando item de cotizaciÃ³n"),console.log("   - Producto ID:",b.producto_id),console.log("   - Cantidad:",b.cantidad),console.log("ğŸ“¡ Consultando BOM del producto...");const{data:d,error:g}=await m.from("bom_items").select(`
            id_componente,
            cantidad_x_unidad,
            inventario!bom_items_id_componente_fkey(
              id_articulo,
              codigo_articulo,
              descripcion_articulo,
              costo_articulo
            )
          `).eq("product_id",b.producto_id);if(console.log("ğŸ“¥ Respuesta de BOM recibida"),console.log("   - Error:",g),console.log("   - Data:",d),console.log("   - Cantidad de componentes:",d?.length||0),g){console.error("âŒ ERROR AL OBTENER BOM:",g);continue}if(!d||d.length===0){console.log("âš ï¸ El producto no tiene BOM definido");continue}console.log("ğŸ”„ Procesando componentes BOM...");for(const S of d){if(!S.inventario){console.log("âš ï¸ Componente sin inventario asociado:",S.id_componente);continue}const D=b.cantidad*S.cantidad_x_unidad,$=S.inventario.id_articulo;if(console.log("   ğŸ“¦ Componente:",{id:$,codigo:S.inventario.codigo_articulo,descripcion:S.inventario.descripcion_articulo,cantidadPorUnidad:S.cantidad_x_unidad,cantidadProducto:b.cantidad,cantidadTotal:D,costo:S.inventario.costo_articulo}),h.has($)){const Q=h.get($);console.log("   â™»ï¸ Componente duplicado, sumando cantidades"),console.log("      - Cantidad anterior:",Q.cantidad),console.log("      - Cantidad a sumar:",D),console.log("      - Cantidad nueva:",Q.cantidad+D),h.set($,{...Q,cantidad:Q.cantidad+D})}else console.log("   âœ… Nuevo componente agregado al mapa"),h.set($,{cantidad:D,costo:S.inventario.costo_articulo||0,codigo:S.inventario.codigo_articulo,descripcion:S.inventario.descripcion_articulo})}}console.log("=".repeat(50)),console.log("ğŸ“Š RESUMEN DE COMPONENTES"),console.log("=".repeat(50)),console.log("Total de componentes Ãºnicos:",h.size),console.log("Detalle:"),h.forEach((b,d)=>{console.log(`   - ${b.codigo}: ${b.cantidad} unidades @ ${se(b.costo)}`)}),console.log("ğŸ”„ Convirtiendo mapa a array de items...");const y=Array.from(h.entries()).map(([b,d])=>{const g={id:`temp-${Date.now()}-${Math.random()}`,tarea_id:r.id,item_type:"inventario",inventario_id:b,producto_id:null,descripcion:d.descripcion,cantidad:d.cantidad,costo_unitario:d.costo,total:d.cantidad*d.costo,created_at:new Date().toISOString(),updated_at:new Date().toISOString()};return console.log("   âœ… Item creado:",g),g});console.log("ğŸ“Š Total de items a agregar:",y.length),z(b=>[...b,...y]),console.log("âœ… IMPORTACIÃ“N COMPLETADA EXITOSAMENTE"),console.log("=".repeat(50)),p("success",`Se importaron ${y.length} componentes desde la cotizaciÃ³n`)}catch(o){console.error("ğŸ’¥ ERROR CRÃTICO EN IMPORTACIÃ“N:",o),p("error","Error al importar componentes de la cotizaciÃ³n")}},N=(o,l)=>{Z(l?h=>[...h,o]:h=>h.filter(y=>y!==o))},B=o=>{P.includes(o)||Z([...P,o])},k=o=>{Z(P.filter(l=>l!==o))},E=()=>te.reduce((o,l)=>{const h=l.cantidad*l.costo_unitario;return o+h},0),U=async o=>{if(o.preventDefault(),!A)try{O(!0);const l={fecha_estimada_entrega:f||void 0,cantidad_unidades:L?parseFloat(L):void 0,descripcion_breve:H||void 0,cantidad_personas:P.length,fecha_inicio:W||void 0,fecha_cierre:he||void 0,entregado_a:me||void 0,estado:ne,items:te.map(h=>({item_type:h.item_type,item_id:h.item_id,descripcion:h.descripcion,cantidad:h.cantidad,costo_unitario:h.costo_unitario})),personal_asignado:P};await oe.updateTarea(r.id,l),console.log("âœ… Tarea actualizada exitosamente"),t()}catch(l){console.error("Error actualizando tarea:",l),p("error","Error al actualizar la tarea: "+l.message)}finally{O(!1)}},T=P.length,ee=V.filter(o=>o.nombre.toLowerCase().includes(xe.toLowerCase())||o.email&&o.email.toLowerCase().includes(xe.toLowerCase())),F=V.filter(o=>P.includes(o.id)),Me=r.datos_formulario?.items_tabla_simple&&r.datos_formulario.items_tabla_simple.length>5||r.datos_formulario?.items_tabla_completa&&r.datos_formulario.items_tabla_completa.length>5;return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-xl font-bold text-gray-900",children:["Procesar Orden: ",r.consecutivo]}),e.jsxs("p",{className:"text-sm text-gray-500 mt-1",children:["Solicitante: ",r.email_solicitante," â€¢ Creada: ",new Date(r.created_at).toLocaleDateString()]})]}),e.jsx("button",{onClick:a,className:"text-gray-400 hover:text-gray-600 transition-colors cursor-pointer",children:e.jsx("i",{className:"ri-close-line text-xl"})})]}),e.jsxs("div",{className:"flex border-b border-gray-200",children:[e.jsxs("button",{onClick:()=>C("info"),className:`px-6 py-3 text-sm font-medium border-b-2 transition-colors cursor-pointer ${u==="info"?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700"}`,children:[e.jsx("i",{className:"ri-information-line mr-2"}),"InformaciÃ³n General"]}),e.jsxs("button",{onClick:()=>C("consumo"),className:`px-6 py-3 text-sm font-medium border-b-2 transition-colors cursor-pointer ${u==="consumo"?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700"}`,children:[e.jsx("i",{className:"ri-shopping-cart-line mr-2"}),"Consumo e Inventario"]}),e.jsxs("button",{onClick:()=>C("personal"),className:`px-6 py-3 text-sm font-medium border-b-2 transition-colors cursor-pointer ${u==="personal"?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700"}`,children:[e.jsx("i",{className:"ri-team-line mr-2"}),"Personal Asignado"]})]}),e.jsxs("form",{onSubmit:U,className:"flex-1 overflow-y-auto",children:[u==="info"&&e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"Solicitud Original"}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-6 space-y-4",children:[e.jsxs("div",{className:"flex items-start border-b border-gray-200 pb-3",children:[e.jsx("span",{className:"text-sm font-semibold text-gray-700 w-48",children:"NÃºmero de Caso:"}),e.jsx("span",{className:"text-sm text-gray-900",children:r.consecutivo||"N/A"})]}),e.jsxs("div",{className:"flex items-start border-b border-gray-200 pb-3",children:[e.jsx("span",{className:"text-sm font-semibold text-gray-700 w-48",children:"Estado:"}),e.jsx("span",{className:`text-sm px-2 py-1 rounded ${r.estado==="Completado"?"bg-green-100 text-green-800":r.estado==="En Proceso"?"bg-blue-100 text-blue-800":r.estado==="En Cola"?"bg-yellow-100 text-yellow-800":"bg-gray-100 text-gray-800"}`,children:r.estado})]}),r.datos_formulario?.cliente&&e.jsxs("div",{className:"flex items-start border-b border-gray-200 pb-3",children:[e.jsx("span",{className:"text-sm font-semibold text-gray-700 w-48",children:"Cliente:"}),e.jsx("span",{className:"text-sm text-gray-900",children:r.datos_formulario.cliente})]}),r.datos_formulario?.departamento_solicitante&&e.jsxs("div",{className:"flex items-start border-b border-gray-200 pb-3",children:[e.jsx("span",{className:"text-sm font-semibold text-gray-700 w-48",children:"Departamento Solicitante:"}),e.jsx("span",{className:"text-sm text-gray-900",children:r.datos_formulario.departamento_solicitante})]}),r.datos_formulario?.solicitud_epa&&e.jsxs("div",{className:"flex items-start border-b border-gray-200 pb-3",children:[e.jsx("span",{className:"text-sm font-semibold text-gray-700 w-48",children:"Tipo de Solicitud:"}),e.jsx("span",{className:"text-sm text-gray-900",children:r.datos_formulario.solicitud_epa})]}),r.datos_formulario?.solicitud_cofersa&&e.jsxs("div",{className:"flex items-start border-b border-gray-200 pb-3",children:[e.jsx("span",{className:"text-sm font-semibold text-gray-700 w-48",children:"Tipo de Solicitud:"}),e.jsx("span",{className:"text-sm text-gray-900",children:r.datos_formulario.solicitud_cofersa})]}),r.datos_formulario?.tipo_trabajo&&e.jsxs("div",{className:"flex items-start border-b border-gray-200 pb-3",children:[e.jsx("span",{className:"text-sm font-semibold text-gray-700 w-48",children:"Tipo de Trabajo:"}),e.jsx("span",{className:"text-sm text-gray-900",children:r.datos_formulario.tipo_trabajo})]}),r.cantidad_unidades&&e.jsxs("div",{className:"flex items-start border-b border-gray-200 pb-3",children:[e.jsx("span",{className:"text-sm font-semibold text-gray-700 w-48",children:"Cantidad de Etiquetas:"}),e.jsx("span",{className:"text-sm text-gray-900",children:r.cantidad_unidades.toLocaleString()})]}),e.jsxs("div",{className:"flex items-start border-b border-gray-200 pb-3",children:[e.jsx("span",{className:"text-sm font-semibold text-gray-700 w-48",children:"Personal a cargo:"}),e.jsx("span",{className:"text-sm text-gray-900",children:r.encargado_nombre||r.encargado_email||"No especificado"})]}),e.jsxs("div",{className:"flex items-start border-b border-gray-200 pb-3",children:[e.jsx("span",{className:"text-sm font-semibold text-gray-700 w-48",children:"Entregado a:"}),e.jsx("span",{className:"text-sm text-gray-900",children:r.solicitante_nombre||r.email_solicitante||"No especificado"})]}),r.datos_formulario?.observaciones&&e.jsxs("div",{className:"flex items-start",children:[e.jsx("span",{className:"text-sm font-semibold text-gray-700 w-48",children:"Observaciones:"}),e.jsx("span",{className:"text-sm text-gray-900 flex-1",children:r.datos_formulario.observaciones})]}),r.datos_formulario?.items_tabla_simple&&r.datos_formulario.items_tabla_simple.length>0&&e.jsxs("div",{className:"mt-6",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-700",children:"Detalle de Productos:"}),Me&&e.jsxs("button",{type:"button",onClick:()=>Ne(!Y),className:"flex items-center gap-2 px-3 py-1 text-xs font-medium text-blue-600 bg-blue-50 border border-blue-200 rounded hover:bg-blue-100 transition-colors cursor-pointer",children:[e.jsx("i",{className:`${Y?"ri-eye-off-line":"ri-eye-line"}`}),Y?"Ocultar":"Ver todo"]})]}),e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 border border-gray-200 rounded-lg",children:[e.jsx("thead",{className:"bg-gray-100",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider",children:"CÃ³digo"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider",children:"Cantidad"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:(Y?r.datos_formulario.items_tabla_simple:r.datos_formulario.items_tabla_simple.slice(0,5)).map((o,l)=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-2 text-sm text-gray-900",children:o.codigo}),e.jsx("td",{className:"px-4 py-2 text-sm text-gray-900",children:o.cantidad.toLocaleString()})]},l))})]}),!Y&&r.datos_formulario.items_tabla_simple.length>5&&e.jsxs("div",{className:"text-center py-2 text-xs text-gray-500 bg-gray-50 border-t border-gray-200",children:["Mostrando 5 de ",r.datos_formulario.items_tabla_simple.length," productos"]})]})]}),r.datos_formulario?.items_tabla_completa&&r.datos_formulario.items_tabla_completa.length>0&&e.jsxs("div",{className:"mt-6",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-700",children:"Detalle de Productos:"}),Me&&e.jsxs("button",{type:"button",onClick:()=>Ne(!Y),className:"flex items-center gap-2 px-3 py-1 text-xs font-medium text-blue-600 bg-blue-50 border border-blue-200 rounded hover:bg-blue-100 transition-colors cursor-pointer",children:[e.jsx("i",{className:`${Y?"ri-eye-off-line":"ri-eye-line"}`}),Y?"Ocultar":"Ver todo"]})]}),e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 border border-gray-200 rounded-lg",children:[e.jsx("thead",{className:"bg-gray-100",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider",children:"DescripciÃ³n"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider",children:"Cantidad"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider",children:"Motivo"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:(Y?r.datos_formulario.items_tabla_completa:r.datos_formulario.items_tabla_completa.slice(0,5)).map((o,l)=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-2 text-sm text-gray-900",children:o.descripcion}),e.jsx("td",{className:"px-4 py-2 text-sm text-gray-900",children:o.cantidad.toLocaleString()}),e.jsx("td",{className:"px-4 py-2 text-sm text-gray-900",children:o.motivo})]},l))})]}),!Y&&r.datos_formulario.items_tabla_completa.length>5&&e.jsxs("div",{className:"text-center py-2 text-xs text-gray-500 bg-gray-50 border-t border-gray-200",children:["Mostrando 5 de ",r.datos_formulario.items_tabla_completa.length," productos"]})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Fecha Estimada de Entrega"}),e.jsx("input",{type:"date",value:f,onChange:o=>G(o.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Cantidad de Unidades"}),e.jsx("input",{type:"number",value:L,onChange:o=>R(o.target.value),min:"0",step:"0.01",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"DescripciÃ³n Breve"}),e.jsx("textarea",{value:H,onChange:o=>I(o.target.value),rows:2,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none"})]})]}),e.jsxs("div",{className:"border-t border-gray-200 pt-6",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"AnÃ¡lisis y Seguimiento"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Cantidad de Personas"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx("input",{type:"text",value:`${T} ${T===1?"persona":"personas"}`,readOnly:!0,className:"w-full px-3 py-2 pr-10 border border-gray-300 rounded-lg bg-gray-50 text-gray-700 cursor-not-allowed"}),e.jsx("div",{className:"absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none",children:e.jsx("i",{className:"ri-team-line text-gray-400 text-lg"})})]}),e.jsxs("button",{type:"button",onClick:()=>M(!0),className:"px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors cursor-pointer whitespace-nowrap flex items-center gap-2",children:[e.jsx("i",{className:"ri-user-add-line"}),"Asignar Personal"]})]}),e.jsxs("p",{className:"mt-1 text-xs text-gray-500",children:[e.jsx("i",{className:"ri-information-line mr-1"}),"Se calcula automÃ¡ticamente segÃºn el personal asignado"]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Estado"}),e.jsx("select",{value:ne,onChange:o=>be(o.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:ro.map(o=>e.jsx("option",{value:o,children:o},o))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Fecha de Inicio"}),e.jsx("input",{type:"date",value:W,onChange:o=>q(o.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Fecha de Cierre"}),e.jsx("input",{type:"date",value:he,onChange:o=>J(o.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Entregado A"}),e.jsx("input",{type:"text",value:me,onChange:o=>re(o.target.value),placeholder:"Nombre de la persona que recibe",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]})]})]})]}),u==="consumo"&&e.jsxs("div",{className:"p-6 space-y-6",children:[r.cotizacion_id&&e.jsx("div",{className:"flex justify-end",children:e.jsxs("button",{type:"button",onClick:v,className:"px-4 py-2 text-sm font-medium text-blue-700 bg-blue-100 border border-blue-300 rounded-lg hover:bg-blue-200 transition-colors cursor-pointer whitespace-nowrap",children:[e.jsx("i",{className:"ri-download-line mr-2"}),"Importar desde CotizaciÃ³n Asociada"]})}),e.jsxs("div",{className:"border border-gray-200 rounded-lg p-4",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"Agregar Item"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Tipo"}),e.jsxs("select",{value:j.item_type,onChange:o=>{const l=o.target.value;ye(h=>({...h,item_type:l,descripcion:"",costo_unitario:0,producto_id:null,inventario_id:null})),le(""),ie([]),ae(!1),ge([]),ce(!1)},className:"w-full px-3 py-2 pr-8 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"inventario",children:"Inventario"}),e.jsx("option",{value:"producto",children:"Productos"}),e.jsx("option",{value:"cotizacion",children:"CotizaciÃ³n"})]})]}),e.jsxs("div",{className:"md:col-span-2 relative",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[j.item_type==="cotizacion"?"Buscar CotizaciÃ³n":"DescripciÃ³n",e.jsx("span",{className:"text-xs text-gray-500 ml-2",children:j.item_type==="cotizacion"?"(Buscar por cÃ³digo)":j.item_type==="inventario"?"Buscar en inventario...":"Buscar en productos..."})]}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",value:X,onChange:o=>le(o.target.value),placeholder:j.item_type==="cotizacion"?"Buscar cotizaciÃ³n...":j.item_type==="inventario"?"Buscar en inventario...":"Buscar en productos...",className:"w-full px-3 py-2 pr-8 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm backdrop-blur-sm bg-white/90"}),Se&&e.jsx("div",{className:"absolute right-3 top-1/2 -translate-y-1/2",children:e.jsx("i",{className:"ri-loader-4-line animate-spin text-gray-400"})}),X&&!Se&&e.jsx("button",{type:"button",onClick:pe,className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 cursor-pointer",children:e.jsx("i",{className:"ri-close-line"})}),ze&&je.length>0&&e.jsx("div",{className:"absolute z-50 w-full mt-1 bg-white/95 backdrop-blur-md border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto",children:je.map(o=>e.jsx("button",{type:"button",onClick:()=>Pe(o),className:"w-full px-3 py-2 text-left hover:bg-blue-50 border-b border-gray-100 last:border-b-0 transition-colors cursor-pointer",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium text-gray-900 text-sm",children:o.codigo}),e.jsx("div",{className:"text-xs text-gray-600",children:o.cliente_nombre})]}),e.jsx("div",{className:"text-sm font-semibold text-blue-600 ml-2",children:se(o.total)})]})},o.id))}),Fe&&Ee.length>0&&e.jsx("div",{className:"absolute z-50 w-full mt-1 bg-white/95 backdrop-blur-md border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto",children:Ee.map(o=>e.jsx("button",{type:"button",onClick:()=>Ie(o),className:"w-full px-3 py-2 text-left hover:bg-blue-50 border-b border-gray-100 last:border-b-0 transition-colors cursor-pointer",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium text-gray-900 text-sm",children:o.codigo}),e.jsx("div",{className:"text-xs text-gray-600",children:o.nombre})]}),e.jsx("div",{className:"text-sm font-semibold text-blue-600 ml-2",children:se(o.precio)})]})},o.id))}),X.length>=2&&!Se&&Ee.length===0&&je.length===0&&e.jsx("div",{className:"absolute z-50 w-full mt-1 bg-white/95 backdrop-blur-md border border-gray-300 rounded-lg shadow-lg p-3",children:e.jsxs("div",{className:"text-sm text-gray-500 text-center",children:[e.jsx("i",{className:"ri-search-line mr-1"}),"No se encontraron resultados"]})})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Cantidad"}),e.jsx("input",{type:"number",value:j.cantidad||"",onChange:o=>ye(l=>({...l,cantidad:parseFloat(o.target.value)||0})),min:"0",step:"0.001",placeholder:"0",disabled:j.item_type==="cotizacion",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-100 disabled:cursor-not-allowed"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Costo Unit."}),e.jsx("input",{type:"text",value:se(j.costo_unitario),readOnly:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-700 cursor-not-allowed",title:"El costo unitario se obtiene automÃ¡ticamente del registro seleccionado"})]})]}),j.item_type!=="cotizacion"&&e.jsxs("div",{className:"flex justify-between items-center mt-4",children:[e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsx("span",{className:"font-medium",children:"Total:"})," ",se(j.cantidad*j.costo_unitario)]}),e.jsxs("button",{type:"button",onClick:s,disabled:!j.descripcion||j.cantidad<=0,className:"px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors cursor-pointer whitespace-nowrap",children:[e.jsx("i",{className:"ri-add-line mr-2"}),"Agregar"]})]}),j.item_type==="cotizacion"&&e.jsx("div",{className:"mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("i",{className:"ri-information-line text-blue-600 mt-0.5"}),e.jsxs("div",{className:"text-sm text-blue-800",children:[e.jsx("p",{className:"font-medium",children:"Importar desde CotizaciÃ³n"}),e.jsx("p",{className:"text-xs mt-1",children:"Busca una cotizaciÃ³n y selecciÃ³nala para importar automÃ¡ticamente todos sus componentes BOM."})]})]})})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"Items Consumidos"}),te.length===0?e.jsxs("div",{className:"text-center text-gray-500 py-8 border border-gray-200 rounded-lg bg-gray-50",children:[e.jsx("i",{className:"ri-inbox-line text-4xl text-gray-300 mb-2"}),e.jsx("p",{children:"No hay items agregados"}),e.jsx("p",{className:"text-xs mt-1",children:"Agregue items usando el formulario de arriba"})]}):e.jsx("div",{className:"overflow-x-auto border border-gray-200 rounded-lg",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider",children:"Tipo"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider",children:"DescripciÃ³n"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider",children:"Cantidad"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider",children:"Costo Unit."}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider",children:"Total"}),e.jsx("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider w-24",children:"AcciÃ³n"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:te.map((o,l)=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-3 text-sm text-gray-900 capitalize",children:o.item_type==="inventario"?"Inventario":"Producto"}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-900",children:o.descripcion}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-900 text-right",children:o.cantidad.toLocaleString()}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-900 text-right",children:se(o.costo_unitario)}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-gray-900 text-right",children:se(o.cantidad*o.costo_unitario)}),e.jsx("td",{className:"px-4 py-3 text-center",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[o.item_type==="producto"&&o.producto_id&&e.jsx("button",{type:"button",onClick:()=>Ue(o),className:"text-blue-600 hover:text-blue-800 transition-colors cursor-pointer p-1",title:"Ver componentes BOM",children:e.jsx("i",{className:"ri-eye-line text-lg"})}),e.jsx("button",{type:"button",onClick:()=>x(l),className:"text-red-600 hover:text-red-800 transition-colors cursor-pointer p-1",title:"Eliminar item",children:e.jsx("i",{className:"ri-delete-bin-line text-lg"})})]})})]},o.id))}),e.jsx("tfoot",{className:"bg-gray-50 border-t-2 border-gray-300",children:e.jsxs("tr",{children:[e.jsx("td",{colSpan:4,className:"px-4 py-3 text-sm font-bold text-gray-900 text-right",children:"Total General:"}),e.jsx("td",{className:"px-4 py-3 text-sm font-bold text-blue-600 text-right",children:se(E())}),e.jsx("td",{})]})})]})})]})]}),u==="personal"&&e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"Asignar Personal"}),V.length===0?e.jsxs("div",{className:"text-center text-gray-500 py-8",children:[e.jsx("i",{className:"ri-team-line text-4xl text-gray-300 mb-2"}),e.jsx("p",{children:"No hay colaboradores disponibles."}),e.jsx("p",{className:"text-sm",children:"Configure colaboradores en el mÃ³dulo de gestiÃ³n."})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:V.map(o=>e.jsxs("label",{className:"flex items-start p-4 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:P.includes(o.id),onChange:l=>N(o.id,l.target.checked),className:"mt-1 rounded border-gray-300 text-blue-600 focus:ring-blue-500"}),e.jsxs("div",{className:"ml-3 flex-1",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:o.nombre}),o.email&&e.jsx("div",{className:"text-xs text-gray-500",children:o.email}),o.telefono&&e.jsx("div",{className:"text-xs text-gray-500",children:o.telefono})]})]},o.id))})]}),e.jsxs("div",{className:"flex justify-between items-center p-6 border-t border-gray-200 bg-gray-50",children:[e.jsxs("div",{className:"text-sm text-gray-600",children:[u==="consumo"&&e.jsxs("span",{children:["Total de costos: ",se(E())]}),u==="personal"&&e.jsxs("span",{children:[P.length," colaborador",P.length!==1?"es":""," seleccionado",P.length!==1?"s":""]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{type:"button",onClick:a,className:"px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors cursor-pointer whitespace-nowrap",children:"Cancelar"}),e.jsx("button",{type:"submit",disabled:A,className:"px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors cursor-pointer whitespace-nowrap",children:A?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("i",{className:"ri-loader-4-line animate-spin"}),"Guardando..."]}):"Guardar Cambios"})]})]})]}),Be&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[80vh] overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900",children:"Componentes del Producto"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:ke})]}),e.jsx("button",{onClick:()=>_e(!1),type:"button",className:"text-gray-400 hover:text-gray-600 transition-colors cursor-pointer",children:e.jsx("i",{className:"ri-close-line text-xl"})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:Re?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx("i",{className:"ri-loader-4-line animate-spin text-4xl text-blue-600 mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Cargando componentes..."})]})}):De.length===0?e.jsxs("div",{className:"text-center text-gray-500 py-12",children:[e.jsx("i",{className:"ri-inbox-line text-4xl text-gray-300 mb-2"}),e.jsx("p",{children:"Este producto no tiene componentes BOM definidos"})]}):e.jsx("div",{className:"overflow-x-auto border border-gray-200 rounded-lg",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider",children:"CÃ³digo"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider",children:"DescripciÃ³n"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider",children:"Cant. x Unidad"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider",children:"Cantidad Total"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:De.map(o=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-gray-900",children:o.codigo_articulo}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-900",children:o.descripcion_articulo}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-900 text-right",children:o.cantidad_x_unidad.toLocaleString()}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-blue-600 text-right",children:o.cantidad_total.toLocaleString()})]},o.id_componente))})]})})}),e.jsx("div",{className:"flex justify-end p-4 border-t border-gray-200 bg-gray-50",children:e.jsx("button",{type:"button",onClick:()=>_e(!1),className:"px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors cursor-pointer whitespace-nowrap",children:"Cerrar"})})]})}),ue&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[80vh] overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900",children:"Asignar Personal"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Seleccione el personal que trabajarÃ¡ en esta tarea"})]}),e.jsx("button",{onClick:()=>M(!1),type:"button",className:"text-gray-400 hover:text-gray-600 transition-colors cursor-pointer",children:e.jsx("i",{className:"ri-close-line text-xl"})})]}),e.jsx("div",{className:"p-4 border-b border-gray-200",children:e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",value:xe,onChange:o=>Te(o.target.value),placeholder:"Buscar por nombre o email...",className:"w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"}),e.jsx("i",{className:"ri-search-line absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"})]})}),F.length>0&&e.jsxs("div",{className:"p-4 bg-blue-50 border-b border-blue-200",children:[e.jsx("div",{className:"flex items-center justify-between mb-2",children:e.jsxs("h4",{className:"text-sm font-semibold text-blue-900",children:["Personal Asignado (",F.length,")"]})}),e.jsx("div",{className:"flex flex-wrap gap-2",children:F.map(o=>e.jsxs("div",{className:"inline-flex items-center gap-2 px-3 py-1.5 bg-white border border-blue-300 rounded-lg text-sm",children:[e.jsx("i",{className:"ri-user-line text-blue-600"}),e.jsx("span",{className:"text-gray-900",children:o.nombre}),e.jsx("button",{type:"button",onClick:()=>k(o.id),className:"text-red-500 hover:text-red-700 cursor-pointer",children:e.jsx("i",{className:"ri-close-line"})})]},o.id))})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:ee.length===0?e.jsxs("div",{className:"text-center text-gray-500 py-8",children:[e.jsx("i",{className:"ri-user-search-line text-4xl text-gray-300 mb-2"}),e.jsx("p",{children:"No se encontraron colaboradores"})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:ee.map(o=>{const l=P.includes(o.id);return e.jsx("div",{className:`p-4 border rounded-lg transition-all cursor-pointer ${l?"border-blue-500 bg-blue-50":"border-gray-300 hover:border-blue-300 hover:bg-gray-50"}`,onClick:()=>{l?k(o.id):B(o.id)},children:e.jsx("div",{className:"flex items-start justify-between",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-900",children:o.nombre}),l&&e.jsx("i",{className:"ri-checkbox-circle-fill text-blue-600"})]}),o.email&&e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:[e.jsx("i",{className:"ri-mail-line mr-1"}),o.email]}),o.telefono&&e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:[e.jsx("i",{className:"ri-phone-line mr-1"}),o.telefono]})]})})},o.id)})})}),e.jsxs("div",{className:"flex justify-between items-center p-4 border-t border-gray-200 bg-gray-50",children:[e.jsxs("div",{className:"text-sm text-gray-600",children:[F.length," persona",F.length!==1?"s":""," seleccionada",F.length!==1?"s":""]}),e.jsx("button",{type:"button",onClick:()=>M(!1),className:"px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors cursor-pointer whitespace-nowrap",children:"Confirmar SelecciÃ³n"})]})]})}),e.jsx(We,{isOpen:c.isOpen,type:c.type,message:c.message,onClose:w}),e.jsx(Ze,{isOpen:_.isOpen,type:_.type,title:_.title,message:_.message,onConfirm:_.onConfirm,onCancel:_.onCancel})]})})}function no({onClose:r}){const[a,t]=n.useState(!1),[i,c]=n.useState([]),[p,w]=n.useState([]),[_,A]=n.useState([]);n.useEffect(()=>{O()},[]);const O=async()=>{try{t(!0);const{data:{user:f}}=await m.auth.getUser();if(!f)return;const{data:G}=await m.from("usuario_tienda_actual").select("tienda_id").eq("usuario_id",f.id).single();if(!G)return;const{data:L,error:R}=await m.from("usuario_tiendas").select(`
          usuario_id,
          usuarios!inner(
            id,
            email
          )
        `).eq("tienda_id",G.tienda_id);if(R)throw R;const H=(L||[]).map(W=>({id:W.usuarios.id,email:W.usuarios.email}));c(H);const I=await oe.getEncargados();w(I),A(I.map(W=>W.usuario_id))}catch(f){console.error("Error cargando datos:",f)}finally{t(!1)}},u=(f,G)=>{A(G?L=>[...L,f]:L=>L.filter(R=>R!==f))},C=async()=>{try{t(!0);const f=p.map(R=>R.usuario_id),G=_.filter(R=>!f.includes(R)),L=f.filter(R=>!_.includes(R));for(const R of G)await oe.addEncargado(R);for(const R of L){const H=p.find(I=>I.usuario_id===R);H&&await oe.removeEncargado(H.id)}console.log("âœ… ConfiguraciÃ³n de encargados actualizada"),r()}catch(f){console.error("Error guardando encargados:",f),alert("Error al guardar la configuraciÃ³n: "+f.message)}finally{t(!1)}};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl max-w-md w-full max-h-[80vh] overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900",children:"Configurar Encargados"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Seleccione los usuarios que recibirÃ¡n notificaciones de nuevas tareas"})]}),e.jsx("button",{onClick:r,className:"text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx("i",{className:"ri-close-line text-xl"})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:a?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsxs("div",{className:"flex items-center gap-2 text-gray-500",children:[e.jsx("i",{className:"ri-loader-4-line animate-spin"}),"Cargando usuarios..."]})}):i.length===0?e.jsxs("div",{className:"text-center text-gray-500 py-8",children:[e.jsx("i",{className:"ri-user-line text-4xl text-gray-300 mb-2"}),e.jsx("p",{children:"No hay usuarios en esta tienda"})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"text-sm font-medium text-gray-700 mb-4",children:["Usuarios de la tienda (",i.length,"):"]}),i.map(f=>e.jsxs("label",{className:"flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:_.includes(f.id),onChange:G=>u(f.id,G.target.checked),className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500"}),e.jsxs("div",{className:"ml-3 flex-1",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:f.email}),f.nombre&&e.jsx("div",{className:"text-xs text-gray-500",children:f.nombre})]}),p.some(G=>G.usuario_id===f.id)&&e.jsx("div",{className:"text-xs text-green-600 bg-green-100 px-2 py-1 rounded",children:"Actual"})]},f.id))]})}),e.jsxs("div",{className:"flex justify-between items-center p-6 border-t border-gray-200 bg-gray-50",children:[e.jsxs("div",{className:"text-sm text-gray-600",children:[_.length," encargado",_.length!==1?"s":""," seleccionado",_.length!==1?"s":""]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:r,className:"px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors cursor-pointer",children:"Cancelar"}),e.jsx("button",{onClick:C,disabled:a,className:"px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors cursor-pointer whitespace-nowrap",children:a?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("i",{className:"ri-loader-4-line animate-spin"}),"Guardando..."]}):"Guardar Cambios"})]})]})]})})}function lo({onClose:r}){const[a,t]=n.useState(!1),[i,c]=n.useState([]),[p,w]=n.useState(!1),[_,A]=n.useState({nombre:"",email:"",telefono:""});n.useEffect(()=>{O()},[]);const O=async()=>{try{t(!0);const C=await oe.getColaboradores();c(C)}catch(C){console.error("Error cargando colaboradores:",C)}finally{t(!1)}},u=async C=>{if(C.preventDefault(),!_.nombre.trim()){alert("El nombre es requerido");return}try{t(!0),await oe.createColaborador(_),A({nombre:"",email:"",telefono:""}),w(!1),await O(),console.log("âœ… Colaborador creado exitosamente")}catch(f){console.error("Error creando colaborador:",f),alert("Error al crear el colaborador: "+f.message)}finally{t(!1)}};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900",children:"Gestionar Colaboradores"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Administre el personal que puede ser asignado a las tareas"})]}),e.jsx("button",{onClick:r,className:"text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx("i",{className:"ri-close-line text-xl"})})]}),e.jsx("div",{className:"p-6 border-b border-gray-200",children:e.jsxs("button",{onClick:()=>w(!p),className:"px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2 cursor-pointer",children:[e.jsx("i",{className:"ri-add-line"}),"Nuevo Colaborador"]})}),p&&e.jsx("div",{className:"p-6 border-b border-gray-200 bg-gray-50",children:e.jsxs("form",{onSubmit:u,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Nombre *"}),e.jsx("input",{type:"text",value:_.nombre,onChange:C=>A(f=>({...f,nombre:C.target.value})),placeholder:"Nombre completo",required:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Email"}),e.jsx("input",{type:"email",value:_.email,onChange:C=>A(f=>({...f,email:C.target.value})),placeholder:"correo@ejemplo.com",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"TelÃ©fono"}),e.jsx("input",{type:"tel",value:_.telefono,onChange:C=>A(f=>({...f,telefono:C.target.value})),placeholder:"8888-8888",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]})]}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx("button",{type:"button",onClick:()=>w(!1),className:"px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors cursor-pointer",children:"Cancelar"}),e.jsx("button",{type:"submit",disabled:a,className:"px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors cursor-pointer whitespace-nowrap",children:a?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("i",{className:"ri-loader-4-line animate-spin"}),"Creando..."]}):"Crear Colaborador"})]})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:a&&i.length===0?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsxs("div",{className:"flex items-center gap-2 text-gray-500",children:[e.jsx("i",{className:"ri-loader-4-line animate-spin"}),"Cargando colaboradores..."]})}):i.length===0?e.jsxs("div",{className:"text-center text-gray-500 py-8",children:[e.jsx("i",{className:"ri-team-line text-4xl text-gray-300 mb-2"}),e.jsx("p",{children:"No hay colaboradores registrados"}),e.jsx("p",{className:"text-sm",children:"Agregue el primer colaborador usando el botÃ³n de arriba"})]}):e.jsx("div",{className:"divide-y divide-gray-200",children:i.map(C=>e.jsx("div",{className:"p-4 hover:bg-gray-50",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-900",children:C.nombre}),e.jsx("span",{className:`inline-flex px-2 py-1 text-xs font-medium rounded-full ${C.activo?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`,children:C.activo?"Activo":"Inactivo"})]}),e.jsxs("div",{className:"mt-1 space-y-1",children:[C.email&&e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-500",children:[e.jsx("i",{className:"ri-mail-line"}),C.email]}),C.telefono&&e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-500",children:[e.jsx("i",{className:"ri-phone-line"}),C.telefono]})]}),e.jsxs("div",{className:"mt-1 text-xs text-gray-400",children:["Creado: ",new Date(C.created_at).toLocaleDateString()]})]}),e.jsx("div",{className:"flex items-center gap-2 ml-4",children:e.jsx("button",{className:"text-gray-400 hover:text-gray-600 transition-colors cursor-pointer",title:"Editar colaborador",children:e.jsx("i",{className:"ri-edit-line"})})})]})},C.id))})}),e.jsxs("div",{className:"flex justify-between items-center p-6 border-t border-gray-200 bg-gray-50",children:[e.jsxs("div",{className:"text-sm text-gray-600",children:[i.length," colaborador",i.length!==1?"es":""," registrado",i.length!==1?"s":""]}),e.jsx("button",{onClick:r,className:"px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors cursor-pointer",children:"Cerrar"})]})]})})}function po(){Qe();const{hasPermission:r}=$e(),[a,t]=n.useState([]),[i,c]=n.useState(null),[p,w]=n.useState(!0),[_,A]=n.useState(!1),[O,u]=n.useState(!1),[C,f]=n.useState(!1),[G,L]=n.useState(!1),[R,H]=n.useState(!1),[I,W]=n.useState(null),[q,he]=n.useState({estado:"",fecha_desde:"",fecha_hasta:"",busqueda:""});n.useEffect(()=>{J()},[q]);const J=async()=>{try{w(!0);const z={...q};z.estado;const[V,K]=await Promise.all([oe.getTareas(z),oe.getStats()]);let P=V;q.estado||(P=V.filter(Z=>Z.estado!=="Finalizado")),t(P),c(K)}catch(z){console.error("Error cargando tareas:",z)}finally{w(!1)}},me=()=>{W(null),u(!0)},re=z=>{W(z),f(!0)},ne=async()=>{u(!1),f(!1),await J()},be=z=>{he(z)},te=async()=>{try{const z=await oe.getTareas({}),V=["Consecutivo","Estado","Fecha CreaciÃ³n","Fecha Estimada","Solicitante","DescripciÃ³n","Cantidad Unidades","Cantidad Personas","Fecha Inicio","Fecha Cierre","Entregado A","Total Costo"],K=z.map(M=>[M.consecutivo,M.estado,new Date(M.created_at).toLocaleDateString(),M.fecha_estimada_entrega||"",M.email_solicitante,M.descripcion_breve||"",M.cantidad_unidades||"",M.cantidad_personas||"",M.fecha_inicio?new Date(M.fecha_inicio).toLocaleDateString():"",M.fecha_cierre?new Date(M.fecha_cierre).toLocaleDateString():"",M.entregado_a||"",M.total_costo||0]),P=[V.join(","),...K.map(M=>M.map(xe=>`"${xe}"`).join(","))].join(`
`),Z=new Blob([P],{type:"text/csv;charset=utf-8;"}),ue=document.createElement("a");ue.href=URL.createObjectURL(Z),ue.download=`tareas_${new Date().toISOString().split("T")[0]}.csv`,ue.click(),console.log("âœ… ExportaciÃ³n completada")}catch(z){console.error("Error exportando:",z),alert("Error al exportar datos")}};return e.jsxs("div",{className:"flex h-screen bg-gray-50",children:[e.jsx(Xe,{isOpen:_,onClose:()=>A(!1)}),e.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden",children:[e.jsx(He,{onMenuClick:()=>A(!0)}),e.jsx(Ye,{stats:i,onNuevaTarea:me,onConfigEncargados:()=>L(!0),onConfigColaboradores:()=>H(!0),onExportar:te,canCreate:r("tareas:create"),canManage:r("tareas:manage"),children:e.jsx(to,{tareas:a,loading:p,filtros:q,onFiltroChange:be,onProcesar:re,onRefresh:J})})]}),O&&e.jsx(so,{onClose:()=>u(!1),onSave:ne}),C&&I&&e.jsx(io,{tarea:I,onClose:()=>f(!1),onSave:ne}),G&&e.jsx(no,{onClose:()=>L(!1)}),R&&e.jsx(lo,{onClose:()=>H(!1)})]})}export{po as default};
//# sourceMappingURL=page-CjTaBRDg.js.map
