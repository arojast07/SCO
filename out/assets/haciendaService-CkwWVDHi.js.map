{"version":3,"file":"haciendaService-CkwWVDHi.js","sources":["../../src/services/haciendaService.ts"],"sourcesContent":["import { supabase } from '../lib/supabase';\nimport type { \n  HaciendaSettings, \n  FacturaElectronica, \n  FacturaLinea, \n  HaciendaEnvio,\n  TokenResponse,\n  HaciendaResponse \n} from '../types/facturacion';\n\nclass HaciendaService {\n  private baseUrlSandbox = 'https://api.comprobanteselectronicos.go.cr/recepcion-sandbox/v1';\n  private baseUrlProduccion = 'https://api.comprobanteselectronicos.go.cr/recepcion/v1';\n  private idpUrlSandbox = 'https://idp.comprobanteselectronicos.go.cr/auth/realms/rut-stag/protocol/openid-connect/token';\n  private idpUrlProduccion = 'https://idp.comprobanteselectronicos.go.cr/auth/realms/rut/protocol/openid-connect/token';\n\n  async getSettings(): Promise<HaciendaSettings | null> {\n    try {\n      const { data, error } = await supabase\n        .from('settings')\n        .select('value')\n        .eq('key', 'hacienda_config')\n        .single();\n\n      if (error) {\n        console.error('Error obteniendo configuración:', error);\n        return null;\n      }\n\n      if (!data?.value) {\n        return null;\n      }\n\n      // Parsear la configuración JSON\n      const config = typeof data.value === 'string' ? JSON.parse(data.value) : data.value;\n      return config as HaciendaSettings;\n    } catch (error) {\n      console.error('Error parseando configuración:', error);\n      return null;\n    }\n  }\n\n  async saveSettings(settings: Partial<HaciendaSettings>): Promise<boolean> {\n    try {\n      const { error } = await supabase\n        .from('settings')\n        .upsert({\n          key: 'hacienda_config',\n          value: JSON.stringify(settings),\n          updated_at: new Date().toISOString()\n        });\n\n      if (error) throw error;\n      return true;\n    } catch (error) {\n      console.error('Error guardando configuración:', error);\n      return false;\n    }\n  }\n\n  async testConnection(): Promise<{ success: boolean; message: string }> {\n    try {\n      const settings = await this.getSettings();\n      if (!settings) {\n        return { success: false, message: 'No hay configuración de Hacienda' };\n      }\n\n      const token = await this.getAccessToken(settings);\n      if (token) {\n        return { success: true, message: 'Conexión exitosa con Hacienda' };\n      } else {\n        return { success: false, message: 'Error obteniendo token de acceso' };\n      }\n    } catch (error) {\n      return { success: false, message: `Error: ${error}` };\n    }\n  }\n\n  async getAccessToken(settings: HaciendaSettings): Promise<string | null> {\n    try {\n      const idpUrl = settings.ambiente === 'sandbox' ? this.idpUrlSandbox : this.idpUrlProduccion;\n      \n      const response = await fetch(idpUrl, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/x-www-form-urlencoded',\n        },\n        body: new URLSearchParams({\n          grant_type: 'password',\n          client_id: 'api-prod',\n          username: settings.usuario_idp,\n          password: settings.password_idp_encrypted, // En producción debe estar encriptado\n          scope: 'openid'\n        })\n      });\n\n      if (!response.ok) {\n        throw new Error(`Error HTTP: ${response.status}`);\n      }\n\n      const tokenData: TokenResponse = await response.json();\n      return tokenData.access_token;\n    } catch (error) {\n      console.error('Error obteniendo token:', error);\n      return null;\n    }\n  }\n\n  async getNextConsecutivo(tipoDocumento: string, sucursal: string = '001', terminal: string = '00001'): Promise<string> {\n    try {\n      // Obtener y actualizar consecutivo de forma atómica\n      const { data, error } = await supabase.rpc('get_next_consecutivo', {\n        p_tipo_documento: tipoDocumento,\n        p_sucursal: sucursal,\n        p_terminal: terminal\n      });\n\n      if (error) throw error;\n\n      const consecutivo = data.toString().padStart(10, '0');\n      return `${sucursal}${terminal}${tipoDocumento}${consecutivo}`;\n    } catch (error) {\n      console.error('Error obteniendo consecutivo:', error);\n      throw error;\n    }\n  }\n\n  generateClave(\n    pais: string = '506',\n    dia: string,\n    mes: string,\n    ano: string,\n    cedula: string,\n    consecutivo: string,\n    situacion: string = '1',\n    codigoSeguridad: string = '12345678'\n  ): string {\n    return `${pais}${dia}${mes}${ano}${cedula}${consecutivo}${situacion}${codigoSeguridad}`;\n  }\n\n  async generateXML(factura: FacturaElectronica, settings: HaciendaSettings): Promise<string> {\n    const fecha = new Date(factura.fecha_emision);\n    const fechaISO = fecha.toISOString();\n    \n    // Generar clave si no existe\n    if (!factura.clave) {\n      const dia = fecha.getDate().toString().padStart(2, '0');\n      const mes = (fecha.getMonth() + 1).toString().padStart(2, '0');\n      const ano = fecha.getFullYear().toString().slice(-2);\n      \n      factura.clave = this.generateClave(\n        '506',\n        dia,\n        mes,\n        ano,\n        settings.cedula_emisor,\n        factura.consecutivo,\n        '1',\n        Math.random().toString().slice(2, 10)\n      );\n    }\n\n    const xml = `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<FacturaElectronica xmlns=\"https://cdn.comprobanteselectronicos.go.cr/xml-schemas/v4.3/facturaElectronica\" \n                   xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" \n                   xsi:schemaLocation=\"https://cdn.comprobanteselectronicos.go.cr/xml-schemas/v4.3/facturaElectronica https://www.hacienda.go.cr/ATV/ComprobanteElectronico/docs/esquemas/2016/v4.3/FacturaElectronica_V4.3.xsd\">\n  <Clave>${factura.clave}</Clave>\n  <CodigoActividad>${settings.codigo_actividad_economica}</CodigoActividad>\n  <NumeroConsecutivo>${factura.consecutivo}</NumeroConsecutivo>\n  <FechaEmision>${fechaISO}</FechaEmision>\n  <Emisor>\n    <Nombre>OLO</Nombre>\n    <Identificacion>\n      <Tipo>02</Tipo>\n      <Numero>${settings.cedula_emisor}</Numero>\n    </Identificacion>\n    <Ubicacion>\n      <Provincia>1</Provincia>\n      <Canton>01</Canton>\n      <Distrito>01</Distrito>\n      <OtrasSenas>San José, Costa Rica</OtrasSenas>\n    </Ubicacion>\n    <Telefono>\n      <CodigoPais>506</CodigoPais>\n      <NumTelefono>22052525</NumTelefono>\n    </Telefono>\n    <CorreoElectronico>info@olo.cr</CorreoElectronico>\n  </Emisor>\n  <Receptor>\n    <Nombre>${factura.cliente?.razon_social || factura.cliente?.nombre_completo || 'Cliente'}</Nombre>\n    <Identificacion>\n      <Tipo>01</Tipo>\n      <Numero>${factura.cliente?.identificacion || '000000000'}</Numero>\n    </Identificacion>\n    <Ubicacion>\n      <Provincia>1</Provincia>\n      <Canton>01</Canton>\n      <Distrito>01</Distrito>\n      <OtrasSenas>${factura.cliente?.direccion || 'San José, Costa Rica'}</OtrasSenas>\n    </Ubicacion>\n    <Telefono>\n      <CodigoPais>506</CodigoPais>\n      <NumTelefono>${factura.cliente?.telefono || '00000000'}</NumTelefono>\n    </Telefono>\n    <CorreoElectronico>${factura.cliente?.correo || 'cliente@ejemplo.com'}</CorreoElectronico>\n  </Receptor>\n  <CondicionVenta>${factura.condicion_venta}</CondicionVenta>\n  ${factura.plazo_credito > 0 ? `<PlazoCredito>${factura.plazo_credito}</PlazoCredito>` : ''}\n  <MedioPago>${factura.medio_pago}</MedioPago>\n  <DetalleServicio>\n    ${factura.lineas?.map((linea, index) => `\n    <LineaDetalle>\n      <NumeroLinea>${index + 1}</NumeroLinea>\n      <Codigo>\n        <Tipo>01</Tipo>\n        <Codigo>${linea.codigo_articulo || 'SIN-CODIGO'}</Codigo>\n      </Codigo>\n      <Cantidad>${linea.cantidad}</Cantidad>\n      <UnidadMedida>${linea.unidad_medida}</UnidadMedida>\n      <Detalle>${linea.descripcion}</Detalle>\n      <PrecioUnitario>${linea.precio_unitario}</PrecioUnitario>\n      <MontoTotal>${linea.total_linea}</MontoTotal>\n      ${linea.descuento_monto > 0 ? `\n      <Descuento>\n        <MontoDescuento>${linea.descuento_monto}</MontoDescuento>\n        <NaturalezaDescuento>Descuento comercial</NaturalezaDescuento>\n      </Descuento>` : ''}\n      <SubTotal>${linea.subtotal_linea}</SubTotal>\n      ${linea.impuesto_monto > 0 ? `\n      <Impuesto>\n        <Codigo>01</Codigo>\n        <CodigoTarifa>08</CodigoTarifa>\n        <Tarifa>${linea.impuesto_porcentaje}</Tarifa>\n        <Monto>${linea.impuesto_monto}</Monto>\n      </Impuesto>` : ''}\n      <MontoTotalLinea>${linea.total_linea}</MontoTotalLinea>\n    </LineaDetalle>`).join('')}\n  </DetalleServicio>\n  ${factura.referencia_clave ? `\n  <InformacionReferencia>\n    <TipoDoc>${factura.tipo_documento}</TipoDoc>\n    <Numero>${factura.referencia_clave}</Numero>\n    <FechaEmision>${fechaISO}</FechaEmision>\n    <Codigo>${factura.referencia_codigo}</Codigo>\n    <Razon>${factura.referencia_razon}</Razon>\n  </InformacionReferencia>` : ''}\n  <ResumenFactura>\n    <CodigoTipoMoneda>\n      <CodigoMoneda>${factura.moneda}</CodigoMoneda>\n      <TipoCambio>${factura.tipo_cambio}</TipoCambio>\n    </CodigoTipoMoneda>\n    <TotalServGravados>${factura.subtotal}</TotalServGravados>\n    <TotalServExentos>0.00</TotalServExentos>\n    <TotalServExonerados>0.00</TotalServExonerados>\n    <TotalMercanciasGravadas>0.00</TotalMercanciasGravadas>\n    <TotalMercanciasExentas>0.00</TotalMercanciasExentas>\n    <TotalMercanciasExoneradas>0.00</TotalMercanciasExoneradas>\n    <TotalGravado>${factura.subtotal}</TotalGravado>\n    <TotalExento>0.00</TotalExento>\n    <TotalExonerado>0.00</TotalExonerado>\n    <TotalVenta>${factura.subtotal}</TotalVenta>\n    ${factura.descuento_total > 0 ? `\n    <TotalDescuentos>${factura.descuento_total}</TotalDescuentos>` : ''}\n    <TotalVentaNeta>${factura.subtotal - factura.descuento_total}</TotalVentaNeta>\n    <TotalImpuesto>${factura.impuesto_total}</TotalImpuesto>\n    <TotalIVADevuelto>0.00</TotalIVADevuelto>\n    <TotalOtrosCargos>0.00</TotalOtrosCargos>\n    <TotalComprobante>${factura.total}</TotalComprobante>\n  </ResumenFactura>\n</FacturaElectronica>`;\n\n    return xml;\n  }\n\n  async signXML(xml: string, settings: HaciendaSettings): Promise<string> {\n    // En un entorno real, aquí se implementaría la firma XAdES-EPES\n    // Por ahora retornamos el XML en Base64 como placeholder\n    try {\n      // Simular proceso de firma\n      const xmlSigned = xml; // En producción: aplicar firma XAdES-EPES con certificado .p12\n      return btoa(unescape(encodeURIComponent(xmlSigned)));\n    } catch (error) {\n      console.error('Error firmando XML:', error);\n      throw error;\n    }\n  }\n\n  async sendToHacienda(factura: FacturaElectronica, xmlFirmado: string): Promise<HaciendaEnvio> {\n    try {\n      const settings = await this.getSettings();\n      if (!settings) throw new Error('No hay configuración de Hacienda');\n\n      const token = await this.getAccessToken(settings);\n      if (!token) throw new Error('No se pudo obtener token de acceso');\n\n      const baseUrl = settings.ambiente === 'sandbox' ? this.baseUrlSandbox : this.baseUrlProduccion;\n      \n      const payload = {\n        clave: factura.clave,\n        fecha: factura.fecha_emision,\n        emisor: {\n          tipoIdentificacion: '02',\n          numeroIdentificacion: settings.cedula_emisor\n        },\n        receptor: {\n          tipoIdentificacion: '01',\n          numeroIdentificacion: factura.cliente?.identificacion || '000000000'\n        },\n        comprobanteXml: xmlFirmado\n      };\n\n      const response = await fetch(`${baseUrl}/recepcion`, {\n        method: 'POST',\n        headers: {\n          'Authorization': `Bearer ${token}`,\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify(payload)\n      });\n\n      const envio: HaciendaEnvio = {\n        factura_id: factura.id,\n        tipo_envio: 'factura',\n        request_payload: JSON.stringify(payload),\n        response_payload: await response.text(),\n        status_code: response.status,\n        location_header: response.headers.get('Location') || undefined,\n        estado: response.ok ? 'enviado' : 'error',\n        intentos: 1,\n        ultimo_intento: new Date().toISOString(),\n        created_at: new Date().toISOString()\n      };\n\n      // Guardar envío en base de datos\n      await supabase.from('hacienda_envios').insert(envio);\n\n      return envio;\n    } catch (error) {\n      console.error('Error enviando a Hacienda:', error);\n      throw error;\n    }\n  }\n\n  async consultarEstado(clave: string): Promise<HaciendaResponse | null> {\n    try {\n      const settings = await this.getSettings();\n      if (!settings) return null;\n\n      const token = await this.getAccessToken(settings);\n      if (!token) return null;\n\n      const baseUrl = settings.ambiente === 'sandbox' ? this.baseUrlSandbox : this.baseUrlProduccion;\n      \n      const response = await fetch(`${baseUrl}/recepcion/${clave}`, {\n        headers: {\n          'Authorization': `Bearer ${token}`\n        }\n      });\n\n      if (response.ok) {\n        return await response.json();\n      }\n\n      return null;\n    } catch (error) {\n      console.error('Error consultando estado:', error);\n      return null;\n    }\n  }\n\n  async saveFactura(factura: Partial<FacturaElectronica>): Promise<FacturaElectronica | null> {\n    try {\n      const { data, error } = await supabase\n        .from('facturas_electronicas')\n        .insert(factura)\n        .select('id,numero_consecutivo,clave_numerica,estado,total_general,notas') // USAR NOMBRES REALES\n        .single();\n\n      if (error) throw error;\n      return data;\n    } catch (error) {\n      console.error('Error guardando factura:', error);\n      return null;\n    }\n  }\n\n  async updateFactura(id: number, updates: Partial<FacturaElectronica>): Promise<boolean> {\n    try {\n      const { error } = await supabase\n        .from('facturas_electronicas')\n        .update({ ...updates, updated_at: new Date().toISOString() })\n        .eq('id', id)\n        .select('id,consecutivo,clave,estado_hacienda'); // Solo campos necesarios\n\n      return !error;\n    } catch (error) {\n      console.error('Error actualizando factura:', error);\n      return false;\n    }\n  }\n\n  async getFacturas(filters?: any): Promise<FacturaElectronica[]> {\n    try {\n      let query = supabase\n        .from('facturas_electronicas')\n        .select(`\n          *,\n          cliente:clientes(*),\n          lineas:factura_items(*)\n        `)\n        .order('created_at', { ascending: false });\n\n      if (filters?.fecha_desde) {\n        query = query.gte('fecha_emision', filters.fecha_desde);\n      }\n      if (filters?.fecha_hasta) {\n        query = query.lte('fecha_emision', filters.fecha_hasta);\n      }\n      if (filters?.estado_local) {\n        query = query.eq('estado_local', filters.estado_local);\n      }\n      if (filters?.cliente_id) {\n        query = query.eq('cliente_id', filters.cliente_id);\n      }\n\n      const { data, error } = await query;\n      if (error) throw error;\n\n      return data || [];\n    } catch (error) {\n      console.error('Error obteniendo facturas:', error);\n      return [];\n    }\n  }\n\n  async getFacturaById(id: number): Promise<FacturaElectronica | null> {\n    try {\n      const { data, error } = await supabase\n        .from('facturas_electronicas')\n        .select(`\n          *,\n          cliente:clientes(*),\n          lineas:factura_items(*),\n          envios:hacienda_envios(*)\n        `)\n        .eq('id', id)\n        .single();\n\n      if (error) throw error;\n      return data;\n    } catch (error) {\n      console.error('Error obteniendo factura:', error);\n      return null;\n    }\n  }\n\n  async saveFacturaLineas(facturaId: number, lineas: FacturaLinea[]): Promise<boolean> {\n    try {\n      // Eliminar líneas existentes\n      await supabase\n        .from('factura_items')\n        .delete()\n        .eq('factura_id', facturaId);\n\n      // Insertar nuevas líneas\n      const lineasConId = lineas.map(linea => ({\n        ...linea,\n        factura_id: facturaId\n      }));\n\n      const { error } = await supabase\n        .from('factura_items')\n        .insert(lineasConId);\n\n      return !error;\n    } catch (error) {\n      console.error('Error guardando líneas:', error);\n      return false;\n    }\n  }\n\n  async auditLog(accion: string, tabla: string, registroId?: number, datosAnteriores?: any, datosNuevos?: any): Promise<void> {\n    try {\n      await supabase.from('hacienda_auditoria').insert({\n        accion,\n        tabla_afectada: tabla,\n        registro_id: registroId,\n        datos_anteriores: datosAnteriores,\n        datos_nuevos: datosNuevos,\n        created_at: new Date().toISOString()\n      });\n    } catch (error) {\n      console.error('Error en auditoría:', error);\n    }\n  }\n}\n\nexport const haciendaService = new HaciendaService();"],"names":["HaciendaService","data","error","supabase","settings","idpUrl","response","tipoDocumento","sucursal","terminal","consecutivo","pais","dia","mes","ano","cedula","situacion","codigoSeguridad","factura","fecha","fechaISO","linea","index","xml","xmlFirmado","token","baseUrl","payload","envio","clave","id","updates","filters","query","facturaId","lineas","lineasConId","accion","tabla","registroId","datosAnteriores","datosNuevos","haciendaService"],"mappings":"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"}