const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/pdf-qm8zKpvE.js","assets/index-Bb3NupjY.js","assets/index-CnuGJBy6.css"])))=>i.map(i=>d[i]);
import{s as b,_ as A,b as L,r as u,j as e,C as z}from"./index-Bb3NupjY.js";import{S as G,T as B}from"./TopBar-BP5RF_Jd.js";const $="https://xmdjzqpmmmcqnsinrdou.supabase.co/functions/v1/costbot-ingest-pdf";async function q(t){console.log("ðŸ“„ [PDF] Iniciando extracciÃ³n de texto del PDF..."),console.log("ðŸ“„ [PDF] Archivo:",{name:t.name,size:t.size,type:t.type});try{console.log("ðŸ“¦ [PDF] Importando pdfjs-dist...");const r=await A(()=>import("./pdf-qm8zKpvE.js").then(n=>n.p),__vite__mapDeps([0,1,2]));r.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js",console.log("âœ… [PDF] Worker configurado"),console.log("ðŸ“¥ [PDF] Leyendo archivo...");const a=await t.arrayBuffer();console.log("âœ… [PDF] Archivo leÃ­do:",a.byteLength,"bytes"),console.log("ðŸ”„ [PDF] Cargando documento PDF...");const l=await r.getDocument({data:a}).promise;console.log("âœ… [PDF] Documento cargado:",l.numPages,"pÃ¡gina(s)");let o="";for(let n=1;n<=l.numPages;n++){console.log(`ðŸ“„ [PDF] Procesando pÃ¡gina ${n}/${l.numPages}...`);const p=(await(await l.getPage(n)).getTextContent()).items.map(x=>x&&typeof x.str=="string"?x.str:"").filter(x=>x.length>0).join(" ").trim();console.log(`  âœ… [PDF] PÃ¡gina ${n}: ${p.length} caracteres extraÃ­dos`),p.length>0&&(o+=(o?`

`:"")+p)}console.log("âœ… [PDF] ExtracciÃ³n completada"),console.log(`ðŸ“Š [PDF] Total de texto extraÃ­do: ${o.length} caracteres`);const c=o.substring(0,300).replace(/\s+/g," ").trim();if(console.log("ðŸ“ [PDF] Preview del texto extraÃ­do (primeros 300 caracteres):"),console.log(`"${c}..."`),o.length===0)throw new Error("No se pudo extraer texto del PDF. Verifica que el PDF contenga texto seleccionable (no sea una imagen escaneada).");return o}catch(r){throw console.error("âŒ [PDF] Error al extraer texto:",r),new Error(`No se pudo extraer texto del PDF. Verifica que: (1) El PDF contenga texto seleccionable (no sea una imagen escaneada), (2) El PDF no estÃ© protegido o encriptado, (3) El PDF tenga un formato estÃ¡ndar. Error tÃ©cnico: ${r.message}`)}}async function R(t,r,a,i,l){if(!t)throw new Error("No se seleccionÃ³ ningÃºn archivo PDF.");if(!r)throw new Error("Debes indicar un ID de documento (sourceId).");console.log("ðŸ“¤ [INGEST] Iniciando ingesta de PDF:",{fileName:t.name,fileSize:t.size,sourceId:r,roleScope:a,pageScope:i}),console.log("ðŸ” [INGEST] Obteniendo sesiÃ³n de autenticaciÃ³n...");const{data:{session:o},error:c}=await b.auth.getSession();if(c)throw console.error("âŒ [INGEST] Error al obtener sesiÃ³n:",c),new Error("Error al obtener la sesiÃ³n de usuario.");if(!o)throw console.error("âŒ [INGEST] No hay sesiÃ³n activa"),new Error("No hay sesiÃ³n activa. Por favor, inicia sesiÃ³n.");if(!o.access_token)throw console.error("âŒ [INGEST] No hay access_token en la sesiÃ³n"),new Error("No se pudo obtener el token de acceso.");console.log("âœ… [INGEST] SesiÃ³n obtenida correctamente:",{userId:o.user.id,email:o.user.email,hasAccessToken:!!o.access_token}),console.log("ðŸ“„ [INGEST] Extrayendo texto del PDF en el navegador...");const n=await q(t);console.log("âœ… [INGEST] Texto extraÃ­do exitosamente:",{textLength:n.length,preview:n.substring(0,100)+"..."});const d={textContent:n,sourceId:r,sourceType:"pdf",roleScope:a||"public",pageScope:i||"general",metadata:{...l,filename:t.name,fileSize:t.size}};console.log("ðŸ“¡ [INGEST] Enviando payload a costbot-ingest-pdf...",{sourceId:d.sourceId,roleScope:d.roleScope,pageScope:d.pageScope,textLength:n.length,hasMetadata:!!l});const m=await fetch($,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o.access_token}`},body:JSON.stringify(d)});if(console.log("ðŸ“¥ [INGEST] Respuesta recibida:",{status:m.status,statusText:m.statusText,ok:m.ok}),!m.ok){const x=await m.text();console.error("âŒ [INGEST] Error del servidor:",x);let h=`Error ${m.status}: ${m.statusText}`;try{h=JSON.parse(x).error||h}catch{h=x||h}throw new Error(h)}const p=await m.json();return console.log("âœ… [INGEST] PDF ingestado exitosamente:",{sourceId:p.sourceId,deletedChunks:p.deletedChunks,createdChunks:p.createdChunks}),p}async function M(){console.log("ðŸ“Š [STATS] Obteniendo estadÃ­sticas de chunks...");const{data:{session:t},error:r}=await b.auth.getSession();if(r||!t)throw console.error("ðŸ” [STATS] Error de sesiÃ³n:",r),new Error("No se pudo obtener la sesiÃ³n de usuario.");try{const{data:a,error:i}=await b.from("costbot_chunks").select("source_id, role_scope, page_scope");if(i)throw console.error("âŒ [STATS] Error al obtener chunks:",i),new Error("Error al obtener estadÃ­sticas de chunks");const l=new Set(a?.map(d=>d.source_id)||[]),o={},c={};a?.forEach(d=>{o[d.role_scope]=(o[d.role_scope]||0)+1,c[d.page_scope]=(c[d.page_scope]||0)+1});const n={totalChunks:a?.length||0,totalDocuments:l.size,byRole:o,byContext:c};return console.log("âœ… [STATS] EstadÃ­sticas obtenidas:",n),n}catch(a){throw console.error("âŒ [STATS] Error:",a),a}}async function J(){console.log("ðŸ“‹ [LIST] Listando documentos...");const{data:{session:t},error:r}=await b.auth.getSession();if(r||!t)throw console.error("ðŸ” [LIST] Error de sesiÃ³n:",r),new Error("No se pudo obtener la sesiÃ³n de usuario.");try{const{data:a,error:i}=await b.from("costbot_chunks").select("source_id, role_scope, page_scope, created_at").order("created_at",{ascending:!1});if(i)throw console.error("âŒ [LIST] Error al obtener chunks:",i),new Error("Error al listar documentos");const l=new Map;a?.forEach(c=>{const n=l.get(c.source_id);n?n.chunksCount++:l.set(c.source_id,{sourceId:c.source_id,roleScope:c.role_scope,pageScope:c.page_scope,chunksCount:1,createdAt:c.created_at})});const o=Array.from(l.values());return console.log("âœ… [LIST] Documentos listados:",o.length),o}catch(a){throw console.error("âŒ [LIST] Error:",a),a}}async function U(t){console.log("ðŸ—‘ï¸ [DELETE] Eliminando documento:",t);const{data:{session:r},error:a}=await b.auth.getSession();if(a||!r)throw console.error("ðŸ” [DELETE] Error de sesiÃ³n:",a),new Error("No se pudo obtener la sesiÃ³n de usuario.");try{const{data:i,error:l}=await b.from("costbot_chunks").delete().eq("source_id",t).select();if(l)throw console.error("âŒ [DELETE] Error al eliminar chunks:",l),new Error("Error al eliminar documento");const o=i?.length||0;return console.log("âœ… [DELETE] Documento eliminado:",{sourceId:t,deletedChunks:o}),{success:!0,deletedChunks:o}}catch(i){throw console.error("âŒ [DELETE] Error:",i),i}}function H(){const{showNotification:t}=L(),[r,a]=u.useState(null),[i,l]=u.useState([]),[o,c]=u.useState(!1),[n,d]=u.useState(!1),[m,p]=u.useState(!1),[x,h]=u.useState({isOpen:!1,sourceId:"",documentName:""}),[f,y]=u.useState(null),[j,v]=u.useState(""),[E,T]=u.useState("public"),[w,P]=u.useState("general"),[D,S]=u.useState("");u.useEffect(()=>{N()},[]);const N=async()=>{c(!0);try{const[s,g]=await Promise.all([M(),J()]);a(s),l(g)}catch(s){console.error("Error al cargar datos:",s),t("error","Error al cargar datos de CostBot")}finally{c(!1)}},C=s=>{const g=s.target.files?.[0];if(g){if(g.type!=="application/pdf"){t("error","Solo se permiten archivos PDF");return}if(y(g),!j){const O=g.name.replace(".pdf","").replace(/[^a-zA-Z0-9]/g,"_").toLowerCase();v(O)}}},F=async()=>{if(!f||!j){t("error","Selecciona un archivo y proporciona un ID de documento");return}d(!0);try{const s=await R(f,j,E,w,{description:D,version:"1.0"});t("success",`PDF ingestado: ${s.chunksInserted} fragmentos creados`),y(null),v(""),S(""),N()}catch(s){console.error("Error al ingestar PDF:",s),t("error",s.message||"Error al ingestar PDF")}finally{d(!1)}},_=s=>{h({isOpen:!0,sourceId:s,documentName:s})},k=async()=>{const{sourceId:s}=x;h({isOpen:!1,sourceId:"",documentName:""});try{const g=await U(s);t("success",`Documento eliminado: ${g} fragmentos eliminados`),N()}catch(g){console.error("Error al eliminar documento:",g),t("error",g.message||"Error al eliminar documento")}},I=()=>{h({isOpen:!1,sourceId:"",documentName:""})};return e.jsxs("div",{className:"flex h-screen bg-gray-50",children:[e.jsx(G,{isOpen:m,onClose:()=>p(!1)}),e.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden",children:[e.jsx(B,{onToggleSidebar:()=>p(!m)}),e.jsx("main",{className:"flex-1 overflow-y-auto",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center",children:e.jsx("i",{className:"ri-robot-2-line text-2xl text-blue-600"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:"AdministraciÃ³n de CostBot"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Gestiona documentos y conocimiento del asistente"})]})]}),r&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 mt-6",children:[e.jsx("div",{className:"bg-blue-50 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-blue-600 font-medium",children:"Total Fragmentos"}),e.jsx("p",{className:"text-2xl font-bold text-blue-900",children:r.total_chunks})]}),e.jsx("i",{className:"ri-file-text-line text-3xl text-blue-400"})]})}),e.jsx("div",{className:"bg-green-50 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-green-600 font-medium",children:"Documentos"}),e.jsx("p",{className:"text-2xl font-bold text-green-900",children:r.sources_count})]}),e.jsx("i",{className:"ri-folder-line text-3xl text-green-400"})]})}),e.jsx("div",{className:"bg-purple-50 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-purple-600 font-medium",children:"Roles"}),e.jsx("p",{className:"text-2xl font-bold text-purple-900",children:Object.keys(r.role_scopes||{}).length})]}),e.jsx("i",{className:"ri-shield-user-line text-3xl text-purple-400"})]})}),e.jsx("div",{className:"bg-orange-50 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-orange-600 font-medium",children:"Contextos"}),e.jsx("p",{className:"text-2xl font-bold text-orange-900",children:Object.keys(r.page_scopes||{}).length})]}),e.jsx("i",{className:"ri-pages-line text-3xl text-orange-400"})]})})]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2",children:[e.jsx("i",{className:"ri-upload-cloud-line text-blue-600"}),"Ingestar Nuevo Documento PDF"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Archivo PDF"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("label",{className:"flex-1 flex items-center justify-center px-4 py-3 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-blue-500 transition-colors",children:[e.jsx("div",{className:"text-center",children:f?e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"ri-file-pdf-line text-3xl text-red-500 mb-1"}),e.jsx("p",{className:"text-sm text-gray-700 font-medium",children:f.name}),e.jsxs("p",{className:"text-xs text-gray-500",children:[(f.size/1024).toFixed(2)," KB"]})]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"ri-upload-cloud-2-line text-3xl text-gray-400 mb-1"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Haz clic para seleccionar un PDF"})]})}),e.jsx("input",{type:"file",accept:"application/pdf",onChange:C,className:"hidden"})]}),f&&e.jsx("button",{onClick:()=>y(null),className:"px-4 py-3 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition-colors cursor-pointer",children:e.jsx("i",{className:"ri-close-line"})})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"ID del Documento *"}),e.jsx("input",{type:"text",value:j,onChange:s=>v(s.target.value),placeholder:"ej: manual_optimizador_v1",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Identificador Ãºnico para este documento (sin espacios)"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Alcance por Rol"}),e.jsxs("select",{value:E,onChange:s=>T(s.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent cursor-pointer",children:[e.jsx("option",{value:"public",children:"PÃºblico (todos los usuarios)"}),e.jsx("option",{value:"operador",children:"Operador"}),e.jsx("option",{value:"supervisor",children:"Supervisor"}),e.jsx("option",{value:"admin",children:"Administrador"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Contexto de PÃ¡gina"}),e.jsxs("select",{value:w,onChange:s=>P(s.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent cursor-pointer",children:[e.jsx("option",{value:"general",children:"General (todas las pÃ¡ginas)"}),e.jsx("option",{value:"dashboard",children:"Dashboard"}),e.jsx("option",{value:"optimizador_cortes",children:"Optimizador de Cortes"}),e.jsx("option",{value:"bom",children:"BOM / Productos"}),e.jsx("option",{value:"inventario",children:"Inventario"}),e.jsx("option",{value:"cotizaciones",children:"Cotizaciones"}),e.jsx("option",{value:"pedidos",children:"Pedidos"}),e.jsx("option",{value:"facturacion",children:"FacturaciÃ³n"}),e.jsx("option",{value:"tareas",children:"Tareas"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"DescripciÃ³n (opcional)"}),e.jsx("textarea",{value:D,onChange:s=>S(s.target.value),placeholder:"DescripciÃ³n del contenido del documento...",rows:3,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsx("button",{onClick:F,disabled:!f||!j||n,className:"w-full px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center justify-center gap-2 font-medium cursor-pointer whitespace-nowrap",children:n?e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"ri-loader-4-line animate-spin"}),"Procesando PDF..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"ri-upload-line"}),"Ingestar Documento"]})})]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-900 flex items-center gap-2",children:[e.jsx("i",{className:"ri-file-list-line text-blue-600"}),"Documentos Ingestados"]}),e.jsx("button",{onClick:N,disabled:o,className:"px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors disabled:opacity-50 cursor-pointer whitespace-nowrap",children:e.jsx("i",{className:`ri-refresh-line ${o?"animate-spin":""}`})})]}),o?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("i",{className:"ri-loader-4-line text-3xl text-blue-600 animate-spin"}),e.jsx("p",{className:"text-sm text-gray-600 mt-2",children:"Cargando documentos..."})]}):i.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("i",{className:"ri-file-forbid-line text-4xl text-gray-400 mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"No hay documentos ingestados"})]}):e.jsx("div",{className:"space-y-3",children:i.map(s=>e.jsx("div",{className:"border border-gray-200 rounded-lg p-4 hover:border-blue-300 transition-colors",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("i",{className:"ri-file-pdf-line text-xl text-red-500"}),e.jsx("h4",{className:"font-semibold text-gray-900",children:s.source_id})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 mb-2",children:[e.jsxs("span",{className:"text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded",children:[s.chunks_count," fragmentos"]}),e.jsxs("span",{className:"text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded",children:["Rol: ",s.role_scope]}),e.jsxs("span",{className:"text-xs bg-green-100 text-green-700 px-2 py-1 rounded",children:["Contexto: ",s.page_scope]})]}),s.metadata?.description&&e.jsx("p",{className:"text-sm text-gray-600",children:s.metadata.description}),s.metadata?.filename&&e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Archivo: ",s.metadata.filename]})]}),e.jsx("button",{onClick:()=>_(s.source_id),className:"ml-4 px-3 py-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition-colors cursor-pointer whitespace-nowrap",title:"Eliminar documento",children:e.jsx("i",{className:"ri-delete-bin-line"})})]})},s.source_id))})]}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-6",children:[e.jsxs("h4",{className:"font-semibold text-blue-900 mb-3 flex items-center gap-2",children:[e.jsx("i",{className:"ri-information-line"}),"Instrucciones de Uso"]}),e.jsxs("ul",{className:"space-y-2 text-sm text-blue-800",children:[e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("i",{className:"ri-checkbox-circle-line text-blue-600 mt-0.5"}),e.jsx("span",{children:"Sube documentos PDF con informaciÃ³n relevante para CostBot"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("i",{className:"ri-checkbox-circle-line text-blue-600 mt-0.5"}),e.jsx("span",{children:"Configura el alcance por rol para controlar quiÃ©n puede ver cada documento"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("i",{className:"ri-checkbox-circle-line text-blue-600 mt-0.5"}),e.jsx("span",{children:"Asigna un contexto de pÃ¡gina para que CostBot use el documento en secciones especÃ­ficas"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("i",{className:"ri-checkbox-circle-line text-blue-600 mt-0.5"}),e.jsx("span",{children:"Los documentos se dividen automÃ¡ticamente en fragmentos y se generan embeddings"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("i",{className:"ri-checkbox-circle-line text-blue-600 mt-0.5"}),e.jsx("span",{children:"CostBot usarÃ¡ estos documentos para responder preguntas de forma contextual"})]})]})]})]})})})]}),e.jsx(z,{isOpen:x.isOpen,type:"danger",title:"Eliminar Documento",message:`Â¿EstÃ¡ seguro que desea eliminar el documento "${x.documentName}"? Esta acciÃ³n eliminarÃ¡ todos los fragmentos asociados y no se puede deshacer.`,confirmText:"SÃ­, Eliminar",cancelText:"Cancelar",onConfirm:k,onCancel:I})]})}export{H as default};
//# sourceMappingURL=CostBotAdmin-BaL-gepf.js.map
