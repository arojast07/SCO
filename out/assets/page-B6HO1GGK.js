import{j as e,s as H,a as me,r as P,b as fe,R as Me,u as Le}from"./index-Xz42BvxI.js";import{S as ze,T as Fe}from"./TopBar-BLe2nnBZ.js";import{M as ke}from"./MobileNav-CVw3BIlq.js";import{r as Ce,u as X,w as je}from"./xlsx-BojT3SgY.js";import{f as le}from"./currency-BmxXlzML.js";import{B as Be}from"./BuscarClienteModal-B1gnyqTO.js";import{C as Ze}from"./cotizacionService-CZyzu_MD.js";import"./clienteService-DdYWakNw.js";function qe({children:a}){return e.jsxs("div",{className:"flex h-screen bg-gray-50",children:[e.jsx(ze,{}),e.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden",children:[e.jsx(Fe,{}),e.jsx("main",{className:"flex-1 overflow-y-auto",children:e.jsx("div",{className:"max-w-[1920px] mx-auto p-6",children:a})})]}),e.jsx(ke,{})]})}function Ue({modo:a,onCambiarModo:i,productoBOM:t}){return e.jsxs("div",{className:"space-y-3",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Modo de Trabajo"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("button",{onClick:()=>i("bom"),className:`relative p-4 rounded-lg border-2 transition-all ${a==="bom"?"border-blue-500 bg-blue-50":"border-gray-200 bg-white hover:border-gray-300"}`,children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:`w-10 h-10 rounded-lg flex items-center justify-center ${a==="bom"?"bg-blue-500 text-white":"bg-gray-100 text-gray-600"}`,children:e.jsx("i",{className:"ri-file-list-3-line text-xl"})}),e.jsxs("div",{className:"flex-1 text-left",children:[e.jsx("h3",{className:"font-semibold text-gray-900 mb-1",children:"Modo BOM"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Cargar piezas desde un producto existente"}),a==="bom"&&t&&e.jsx("div",{className:"mt-2 px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded",children:t.nombre})]})]}),a==="bom"&&e.jsx("div",{className:"absolute top-2 right-2",children:e.jsx("i",{className:"ri-checkbox-circle-fill text-blue-500 text-xl"})})]}),e.jsxs("button",{onClick:()=>i("manual"),className:`relative p-4 rounded-lg border-2 transition-all ${a==="manual"?"border-blue-500 bg-blue-50":"border-gray-200 bg-white hover:border-gray-300"}`,children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:`w-10 h-10 rounded-lg flex items-center justify-center ${a==="manual"?"bg-blue-500 text-white":"bg-gray-100 text-gray-600"}`,children:e.jsx("i",{className:"ri-edit-box-line text-xl"})}),e.jsxs("div",{className:"flex-1 text-left",children:[e.jsx("h3",{className:"font-semibold text-gray-900 mb-1",children:"Modo Manual"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Agregar piezas personalizadas una por una"})]})]}),a==="manual"&&e.jsx("div",{className:"absolute top-2 right-2",children:e.jsx("i",{className:"ri-checkbox-circle-fill text-blue-500 text-xl"})})]})]})]})}const Ve=async(a={},i)=>{if(!i)return{data:[],error:{message:"No hay tienda seleccionada"}};try{let t=H.from("productos").select(`
        *,
        categoria:categorias(nombre)
      `).eq("tienda_id",i.id);a.search&&(t=t.or(`nombre.ilike.%${a.search}%,codigo.ilike.%${a.search}%,descripcion.ilike.%${a.search}%`)),a.categoria&&(t=t.eq("categoria_id",a.categoria)),a.activo!==void 0&&(t=t.eq("activo",a.activo)),t=t.order("created_at",{ascending:!1});const{data:v,error:N}=await t;return{data:v||[],error:N}}catch(t){return console.error("Error fetching productos:",t),{data:[],error:t}}};function He({onSeleccionar:a}){const{tiendaActual:i}=me(),[t,v]=P.useState([]),[N,_]=P.useState(""),[p,b]=P.useState(!1);P.useEffect(()=>{g()},[i]);const g=async()=>{b(!0);try{const{data:o}=await Ve({activo:!0},i);v(o||[])}catch(o){console.error("Error cargando productos:",o)}finally{b(!1)}},n=t.filter(o=>o.nombre.toLowerCase().includes(N.toLowerCase())||o.codigo.toLowerCase().includes(N.toLowerCase()));return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",value:N,onChange:o=>_(o.target.value),placeholder:"Buscar producto por nombre o cÃ³digo...",className:"w-full px-4 py-3 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),e.jsx("i",{className:"ri-search-line absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"})]}),p?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("i",{className:"ri-loader-4-line animate-spin text-3xl text-gray-400"}),e.jsx("p",{className:"text-gray-600 mt-2",children:"Cargando productos..."})]}):n.length>0?e.jsx("div",{className:"grid grid-cols-1 gap-3 max-h-96 overflow-y-auto",children:n.map(o=>e.jsx("button",{onClick:()=>a(o.id,o.nombre),className:"p-4 bg-white border border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all text-left",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center",children:e.jsx("i",{className:"ri-product-hunt-line text-blue-600 text-xl"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"bg-gray-100 text-gray-700 text-xs px-2 py-0.5 rounded",children:o.codigo}),e.jsx("span",{className:"font-semibold text-gray-900",children:o.nombre})]}),o.descripcion&&e.jsx("p",{className:"text-sm text-gray-600 line-clamp-1",children:o.descripcion})]}),e.jsx("i",{className:"ri-arrow-right-line text-gray-400"})]})},o.id))}):e.jsxs("div",{className:"text-center py-8 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300",children:[e.jsx("i",{className:"ri-inbox-line text-3xl text-gray-400 mb-2"}),e.jsx("p",{className:"text-gray-600",children:N?"No se encontraron productos":"No hay productos disponibles"})]})]})}async function be(a="",i="articulo",t){try{if(console.log("ðŸ” [OPTIMIZADOR] buscarArticulosInventario - INICIO",{search:a,tipo:i,tienda:t?.nombre}),!t?.id)return console.error("âŒ [OPTIMIZADOR] No hay tienda seleccionada"),{data:[],error:{message:"No hay tienda seleccionada"}};if(i===null){console.log("ðŸ” [OPTIMIZADOR] â­ BÃšSQUEDA GENERAL - Sin restricciÃ³n de categorÃ­a"),console.log("ðŸ” [OPTIMIZADOR] ParÃ¡metros de bÃºsqueda:",{termino:a||"(sin tÃ©rmino - mostrar primeros 50)",filtro_tienda:t.nombre,filtro_categoria:"NINGUNA (busca en todas)"});let d=H.from("inventario").select("*").eq("activo",!0).or(`tienda_id.eq.${t.id},tienda_id.is.null`);if(a&&a.trim().length>0){const m=`%${a.trim()}%`;console.log("ðŸ” [OPTIMIZADOR] Buscando tÃ©rmino:",m),d=d.or(`codigo_articulo.ilike.${m},descripcion_articulo.ilike.${m}`)}d=d.limit(50);const{data:S,error:y}=await d;if(y)return console.error("âŒ [OPTIMIZADOR] Error en query general:",y),{data:[],error:y};console.log("âœ… [OPTIMIZADOR] Resultados encontrados:",{total:S?.length||0,primeros_5:S?.slice(0,5).map(m=>({codigo:m.codigo_articulo,descripcion:m.descripcion_articulo,categoria_id:m.categoria_id,precio:m.precio_articulo}))});const T=[...new Set(S?.map(m=>m.categoria_id).filter(Boolean))];let C=new Map;if(T.length>0){const{data:m}=await H.from("categorias_inventario").select("id_categoria, nombre_categoria").in("id_categoria",T);m&&m.forEach(s=>{C.set(s.id_categoria,s.nombre_categoria)})}return console.log("âœ… [OPTIMIZADOR] BÃºsqueda GENERAL completada:",{total_resultados:S?.length||0,categorias_encontradas:C.size,primeros_3:S?.slice(0,3).map(m=>({codigo:m.codigo_articulo,descripcion:m.descripcion_articulo,categoria:C.get(m.categoria_id)||"Sin categorÃ­a",precio:m.precio_articulo}))}),{data:(S||[]).map(m=>({id:m.id_articulo,id_articulo:m.id_articulo,codigo_articulo:m.codigo_articulo,descripcion_articulo:m.descripcion_articulo,categoria_nombre:C.get(m.categoria_id)||"Sin categorÃ­a",espesor_mm:m.espesor_mm||0,largo_lamina:m.largo_lamina_mm||0,ancho_lamina:m.ancho_lamina_mm||0,largo_lamina_mm:m.largo_lamina_mm||0,ancho_lamina_mm:m.ancho_lamina_mm||0,ancho_tapacanto_mm:m.ancho_tapacanto_mm||0,grosor_tapacanto_mm:m.grosor_tapacanto_mm||0,precio_unitario:m.precio_articulo||0})),error:null}}let v="LAMINAS";i==="tapacanto"?(v="TAPACANTOS",console.log("ðŸ” [OPTIMIZADOR] Buscando TAPACANTOS en inventario...")):i==="lamina"?(v="LAMINAS",console.log("ðŸ“‚ [OPTIMIZADOR] Buscando LAMINAS en inventario...")):i==="mecanizado"&&(v="MECANIZADO",console.log("ðŸ”§ [OPTIMIZADOR] Buscando MECANIZADO en inventario...")),console.log(`ðŸ“‚ [OPTIMIZADOR] Buscando categorÃ­a "${v}" en categorias_inventario...`);const{data:N,error:_}=await H.from("categorias_inventario").select("id_categoria").eq("nombre_categoria",v).single();if(_||!N)return console.error(`âŒ [OPTIMIZADOR] No se encontrÃ³ la categorÃ­a ${v}:`,_),{data:[],error:_};console.log(`âœ… [OPTIMIZADOR] CategorÃ­a ${v} encontrada:`,N);let p=H.from("inventario").select(`
        id_articulo,
        codigo_articulo,
        descripcion_articulo,
        categoria_id,
        espesor_mm,
        largo_lamina_mm,
        ancho_lamina_mm,
        ancho_tapacanto_mm,
        grosor_tapacanto_mm,
        precio_articulo,
        activo
      `).eq("categoria_id",N.id_categoria).eq("activo",!0);if(t?.id&&(p=p.or(`tienda_id.eq.${t.id},tienda_id.is.null`),console.log("ðŸª [OPTIMIZADOR] Filtrando por tienda:",t.nombre,"(incluye artÃ­culos globales)")),a&&a.trim().length>0){const d=`%${a.trim()}%`,[S,y]=await Promise.all([H.from("inventario").select(`
            id_articulo,
            codigo_articulo,
            descripcion_articulo,
            categoria_id,
            espesor_mm,
            largo_lamina_mm,
            ancho_lamina_mm,
            ancho_tapacanto_mm,
            grosor_tapacanto_mm,
            precio_articulo,
            activo
          `).eq("categoria_id",N.id_categoria).eq("activo",!0).or(`tienda_id.eq.${t?.id||""},tienda_id.is.null`).ilike("codigo_articulo",d).limit(25),H.from("inventario").select(`
            id_articulo,
            codigo_articulo,
            descripcion_articulo,
            categoria_id,
            espesor_mm,
            largo_lamina_mm,
            ancho_lamina_mm,
            ancho_tapacanto_mm,
            grosor_tapacanto_mm,
            precio_articulo,
            activo
          `).eq("categoria_id",N.id_categoria).eq("activo",!0).or(`tienda_id.eq.${t?.id||""},tienda_id.is.null`).ilike("descripcion_articulo",d).limit(25)]),T=[...S.data||[],...y.data||[]],C=Array.from(new Map(T.map(s=>[s.id_articulo,s])).values());console.log(`âœ… [OPTIMIZADOR] Query exitosa - Resultados RAW (${v}):`,{total_resultados:C.length,primeros_3:C.slice(0,3).map(s=>({codigo:s.codigo_articulo,descripcion:s.descripcion_articulo,categoria_id:s.categoria_id,espesor:s.espesor_mm,largo:s.largo_lamina_mm,ancho:s.ancho_lamina_mm,grosor_tc:s.grosor_tapacanto_mm,precio:s.precio_articulo}))});let j=C;return i==="lamina"?(j=C.filter(s=>{const c=s.espesor_mm!=null&&s.espesor_mm>0,r=s.largo_lamina_mm!=null&&s.largo_lamina_mm>0,f=s.ancho_lamina_mm!=null&&s.ancho_lamina_mm>0;return!c||!r||!f?(console.warn("âš ï¸ [OPTIMIZADOR] LÃ¡mina descartada (faltan dimensiones):",{codigo:s.codigo_articulo,descripcion:s.descripcion_articulo,espesor:s.espesor_mm,largo:s.largo_lamina_mm,ancho:s.ancho_lamina_mm}),!1):!0}),console.log("ðŸŽ‰ [OPTIMIZADOR] LÃ¡minas vÃ¡lidas encontradas:",{total:j.length,laminas:j.map(s=>({codigo:s.codigo_articulo,descripcion:s.descripcion_articulo,dimensiones:`${s.largo_lamina_mm}x${s.ancho_lamina_mm}x${s.espesor_mm}mm`,precio:s.precio_articulo}))})):i==="tapacanto"?console.log("ðŸŽ‰ [OPTIMIZADOR] Tapacantos encontrados:",{total:j.length,tapacantos:j.map(s=>({codigo:s.codigo_articulo,descripcion:s.descripcion_articulo,grosor:s.grosor_tapacanto_mm,precio:s.precio_articulo}))}):i==="mecanizado"&&console.log("ðŸŽ‰ [OPTIMIZADOR] ArtÃ­culos de MECANIZADO encontrados:",{total:j.length,articulos:j.map(s=>({codigo:s.codigo_articulo,descripcion:s.descripcion_articulo,precio:s.precio_articulo}))}),{data:j.map(s=>({id:s.id_articulo,id_articulo:s.id_articulo,codigo_articulo:s.codigo_articulo,descripcion_articulo:s.descripcion_articulo,categoria_nombre:v,espesor_mm:s.espesor_mm||0,largo_lamina:s.largo_lamina_mm||0,ancho_lamina:s.ancho_lamina_mm||0,largo_lamina_mm:s.largo_lamina_mm||0,ancho_lamina_mm:s.ancho_lamina_mm||0,ancho_tapacanto_mm:s.ancho_tapacanto_mm||0,grosor_tapacanto_mm:s.grosor_tapacanto_mm||0,precio_unitario:s.precio_articulo||0})),error:null}}p=p.limit(50),console.log("â³ [OPTIMIZADOR] Ejecutando query en Supabase...");const{data:b,error:g}=await p;if(g)return console.error("âŒ [OPTIMIZADOR] Error en query:",g),{data:[],error:g};console.log(`âœ… [OPTIMIZADOR] Query exitosa - Resultados RAW (${v}):`,{total_resultados:b?.length||0,primeros_3:b?.slice(0,3).map(d=>({codigo:d.codigo_articulo,descripcion:d.descripcion_articulo,categoria_id:d.categoria_id,espesor:d.espesor_mm,largo:d.largo_lamina_mm,ancho:d.ancho_lamina_mm,grosor_tc:d.grosor_tapacanto_mm,precio:d.precio_articulo}))});let n=b;return i==="lamina"?(n=b.filter(d=>{const S=d.espesor_mm!=null&&d.espesor_mm>0,y=d.largo_lamina_mm!=null&&d.largo_lamina_mm>0,T=d.ancho_lamina_mm!=null&&d.ancho_lamina_mm>0;return!S||!y||!T?(console.warn("âš ï¸ [OPTIMIZADOR] LÃ¡mina descartada (faltan dimensiones):",{codigo:d.codigo_articulo,descripcion:d.descripcion_articulo,espesor:d.espesor_mm,largo:d.largo_lamina_mm,ancho:d.ancho_lamina_mm}),!1):!0}),console.log("ðŸŽ‰ [OPTIMIZADOR] LÃ¡minas vÃ¡lidas encontradas:",{total:n.length,laminas:n.map(d=>({codigo:d.codigo_articulo,descripcion:d.descripcion_articulo,dimensiones:`${d.largo_lamina_mm}x${d.ancho_lamina_mm}x${d.espesor_mm}mm`,precio:d.precio_articulo}))})):i==="tapacanto"?console.log("ðŸŽ‰ [OPTIMIZADOR] Tapacantos encontrados:",{total:n.length,tapacantos:n.map(d=>({codigo:d.codigo_articulo,descripcion:d.descripcion_articulo,grosor:d.grosor_tapacanto_mm,precio:d.precio_articulo}))}):i==="mecanizado"&&console.log("ðŸŽ‰ [OPTIMIZADOR] ArtÃ­culos de MECANIZADO encontrados:",{total:n.length,articulos:n.map(d=>({codigo:d.codigo_articulo,descripcion:d.descripcion_articulo,precio:d.precio_articulo}))}),{data:n.map(d=>({id:d.id_articulo,id_articulo:d.id_articulo,codigo_articulo:d.codigo_articulo,descripcion_articulo:d.descripcion_articulo,categoria_nombre:v,espesor_mm:d.espesor_mm||0,largo_lamina:d.largo_lamina_mm||0,ancho_lamina:d.ancho_lamina_mm||0,largo_lamina_mm:d.largo_lamina_mm||0,ancho_lamina_mm:d.ancho_lamina_mm||0,ancho_tapacanto_mm:d.ancho_tapacanto_mm||0,grosor_tapacanto_mm:d.grosor_tapacanto_mm||0,precio_unitario:d.precio_articulo||0})),error:null}}catch(v){return console.error("âŒ [OPTIMIZADOR] Error inesperado:",v),{data:[],error:v}}}const Xe=async(a,i=null)=>{if(!i)return{data:null,error:{message:"No hay tienda seleccionada"}};try{const{data:t,error:v}=await H.from("bom_items").select(`
        id,
        id_componente,
        cantidad_x_unidad,
        unidad_id,
        precio_ajustado,
        inventario!inner(
          id_articulo,
          codigo_articulo,
          descripcion_articulo,
          categoria_id,
          espesor_mm,
          largo_lamina_mm,
          ancho_lamina_mm,
          precio_articulo
        ),
        unidades_medida!inner(simbolo)
      `).eq("id_producto",a);if(v)throw v;return{data:(t||[]).filter(_=>{const p=_.inventario;return p.largo_lamina_mm&&p.ancho_lamina_mm}).map(_=>{const p=_.inventario,b=p.largo_lamina_mm||0,g=p.ancho_lamina_mm||0;return{id:`bom-${_.id}`,descripcion:p.descripcion_articulo,material_id:p.id_articulo,material_codigo:p.codigo_articulo,material_descripcion:p.descripcion_articulo,material_precio:_.precio_ajustado||p.precio_articulo,material_espesor_mm:p.espesor_mm,material_largo_lamina_mm:p.largo_lamina_mm,material_ancho_lamina_mm:p.ancho_lamina_mm,largo:b,ancho:g,cantidad:_.cantidad_x_unidad,veta:Je(b,g),tapacantos:[],cnc1:"",cnc2:"",color:ea()}}),error:null}}catch(t){return console.error("Error cargando piezas desde BOM:",t),{data:null,error:t}}};async function Ge(a,i){const t=a.largo,v=a.ancho;console.log(`  ðŸ“ [COMPENSACIÃ“N TC] Calculando dimensiones de corte para "${a.descripcion}"`),console.log(`    ðŸ“ Dimensiones originales (finales): ${t} Ã— ${v} mm`);let N=0,_=0;if(a.tapacantos&&a.tapacantos.length>0)for(const g of a.tapacantos){if(!g.codigo||g.codigo==="Sin TC")continue;const o=i.get(g.codigo)?.grosor_mm||g.grosor_mm||0;if(o<=0){console.warn(`    âš ï¸ [COMPENSACIÃ“N TC] Tapacanto "${g.codigo}" sin grosor definido en inventario`);continue}switch(console.log(`    ðŸ”§ [COMPENSACIÃ“N TC] ${g.lado}: "${g.codigo}" - Grosor: ${o} mm`),g.lado){case"superior":case"inferior":_+=o,console.log(`      â†’ Reducir ANCHO en ${o} mm`);break;case"izquierdo":case"derecho":N+=o,console.log(`      â†’ Reducir LARGO en ${o} mm`);break}}const p=t-N,b=v-_;if(console.log(`    ðŸ“Š [COMPENSACIÃ“N TC] Ajustes totales: Largo -${N} mm, Ancho -${_} mm`),console.log(`    âœ‚ï¸ [COMPENSACIÃ“N TC] Dimensiones de corte: ${p} Ã— ${b} mm`),p<=0){const g=`âŒ DimensiÃ³n de corte LARGO invÃ¡lida (${p} mm). El grosor de los tapacantos izquierdo/derecho (${N} mm) excede la dimensiÃ³n original (${t} mm).`;return console.error(`    ${g}`),{largo_corte_mm:p,ancho_corte_mm:b,error:g}}if(b<=0){const g=`âŒ DimensiÃ³n de corte ANCHO invÃ¡lida (${b} mm). El grosor de los tapacantos superior/inferior (${_} mm) excede la dimensiÃ³n original (${v} mm).`;return console.error(`    ${g}`),{largo_corte_mm:p,ancho_corte_mm:b,error:g}}return console.log("    âœ… [COMPENSACIÃ“N TC] Dimensiones de corte vÃ¡lidas"),{largo_corte_mm:p,ancho_corte_mm:b}}async function We(a,i){const t=new Map;if(a.length===0)return t;try{console.log("ðŸ” [INVENTARIO TC] Buscando informaciÃ³n de tapacantos:",a);const{data:v,error:N}=await H.from("inventario").select("codigo_articulo, grosor_tapacanto_mm, precio_articulo").in("codigo_articulo",a);if(N)return console.error("âŒ [INVENTARIO TC] Error buscando tapacantos:",N),t;v&&(v.forEach(_=>{t.set(_.codigo_articulo,{grosor_mm:_.grosor_tapacanto_mm||0,precio:_.precio_articulo||0})}),console.log("âœ… [INVENTARIO TC] InformaciÃ³n obtenida:",{total:t.size,detalle:Array.from(t.entries()).map(([_,p])=>({codigo:_,grosor:p.grosor_mm,precio:p.precio}))}))}catch(v){console.error("âŒ [INVENTARIO TC] Error inesperado:",v)}return t}const Ye=async(a,i,t=null)=>{if(console.log("ðŸš€ [OPTIMIZADOR] Iniciando optimizaciÃ³n de cortes",{total_piezas:a.length,configuracion:i}),!a||a.length===0)throw console.error("âŒ [OPTIMIZADOR] No hay piezas para optimizar"),new Error("No hay piezas para optimizar");const v=new Set;a.forEach(T=>{T.tapacantos&&T.tapacantos.forEach(C=>{C.codigo&&C.codigo!=="Sin TC"&&v.add(C.codigo)})});const N=await We(Array.from(v)),_=[],p=[];for(const T of a){const C=await Ge(T,N);if(C?.error){p.push(`Pieza "${T.descripcion}": ${C.error}`);continue}if(C){const j={...T,largo_corte_mm:C.largo_corte_mm,ancho_corte_mm:C.ancho_corte_mm};_.push(j),j.tapacantos&&j.tapacantos.forEach(m=>{if(m.codigo&&m.codigo!=="Sin TC"){const s=N.get(m.codigo);s&&(m.grosor_mm=s.grosor_mm)}})}}if(p.length>0){const T=`Errores de validaciÃ³n de dimensiones:
${p.join(`
`)}`;throw console.error("âŒ [OPTIMIZADOR] "+T),new Error(T)}console.log(`âœ… [OPTIMIZADOR] Dimensiones de corte calculadas para ${_.length} piezas`);const b=new Map;_.forEach(T=>{if(!T.material_codigo){console.warn("âš ï¸ [OPTIMIZADOR] Pieza sin material asignado:",T);return}const C=T.material_codigo;b.has(C)||b.set(C,[]),b.get(C).push(T)}),console.log("ðŸ“¦ [OPTIMIZADOR] Piezas agrupadas por material:",{materiales_distintos:b.size,detalle:Array.from(b.entries()).map(([T,C])=>({codigo:T,cantidad_piezas:C.length,dimensiones_lamina:`${C[0].material_largo_lamina_mm} Ã— ${C[0].material_ancho_lamina_mm} mm`,espesor:`${C[0].material_espesor_mm} mm`}))});const g=[],n=[],o=[];let d=1;b.forEach((T,C)=>{console.log(`
ðŸ”§ [OPTIMIZADOR] Optimizando material: ${C}`);const j=T[0];if(!j.material_largo_lamina_mm||!j.material_ancho_lamina_mm){console.error(`âŒ [OPTIMIZADOR] Material ${C} sin dimensiones de lÃ¡mina en inventario`),console.error("   Las piezas de este material no se pueden optimizar"),o.push(...T);return}const m={id:j.material_id||0,codigo_articulo:j.material_codigo||"",descripcion_articulo:j.material_descripcion||"",precio_unitario:j.material_precio||0,largo_lamina_mm:j.material_largo_lamina_mm,ancho_lamina_mm:j.material_ancho_lamina_mm,espesor_mm:j.material_espesor_mm||18};console.log("  ðŸ“ [OPTIMIZADOR] Dimensiones de lÃ¡mina desde inventario:",{codigo:m.codigo_articulo,largo:m.largo_lamina_mm,ancho:m.ancho_lamina_mm,espesor:m.espesor_mm});const{laminas:s,piezasSinAsignar:c}=aa(T,m,i,d);if(T.length>c.length&&s.length===0)throw console.error("âŒ [OPTIMIZADOR] ERROR CRÃTICO: Hay piezas vÃ¡lidas pero no se generaron lÃ¡minas"),new Error(`Error en optimizaciÃ³n: No se generaron lÃ¡minas para material ${C}`);d+=s.length;const r=s.length,f=s.reduce((D,M)=>D+M.area_utilizada,0),x=s.reduce((D,M)=>D+M.area_sobrante,0),A=r>0?s.reduce((D,M)=>D+M.porcentaje_aprovechamiento,0)/r:0,l=r*m.precio_unitario;console.log(`âœ… [OPTIMIZADOR] Material ${C} optimizado:`,{laminas_usadas:r,piezas_asignadas:T.length-c.length,aprovechamiento_promedio:`${A.toFixed(1)}%`,costo_total:l}),r>0&&(g.push({material_id:m.id,material_codigo:m.codigo_articulo,material_descripcion:m.descripcion_articulo,espesor_mm:m.espesor_mm,largo_lamina_mm:m.largo_lamina_mm,ancho_lamina_mm:m.ancho_lamina_mm,precio_unitario_lamina:m.precio_unitario,laminas:s,total_laminas:r,area_total_utilizada:f,area_total_sobrante:x,porcentaje_aprovechamiento_promedio:A,costo_total_laminas:l,piezas_asignadas:T.length-c.length}),n.push(...s)),o.push(...c)});const S=_.length-o.length;if(S>0&&n.length===0)throw console.error("âŒ [OPTIMIZADOR] ERROR CRÃTICO: Hay piezas vÃ¡lidas pero no se generaron lÃ¡minas"),new Error("Error en optimizaciÃ³n: No se pudieron generar lÃ¡minas para las piezas vÃ¡lidas");const y=Ke(g,n,o);if(console.log("ðŸ” [OPTIMIZADOR] Validando estructura del resultado:",{tiene_resultado:!0,total_laminas:y.total_laminas,laminas_array_length:y.laminas.length,resultados_por_material_length:y.resultados_por_material.length,piezas_sin_asignar:y.piezas_sin_asignar.length}),y.total_laminas===0&&S>0)throw console.error("âŒ [OPTIMIZADOR] ERROR: total_laminas = 0 pero hay piezas vÃ¡lidas"),new Error("Error en optimizaciÃ³n: No se generaron lÃ¡minas");return console.log("ðŸŽ‰ [OPTIMIZADOR] OptimizaciÃ³n completada exitosamente:",{materiales_procesados:g.length,total_laminas:y.total_laminas,aprovechamiento_global:`${y.porcentaje_aprovechamiento_global.toFixed(1)}%`,costo_total:y.costo_total}),y};function we(a,i){return console.log(`  ðŸ’° [COSTO] Creando lÃ¡mina ${a} con precio: ${i.precio_unitario}`),{id:a,numero_lamina:a,material_id:i.id,material_codigo:i.codigo_articulo,material_descripcion:i.descripcion_articulo,largo:i.largo_lamina_mm,ancho:i.ancho_lamina_mm,espesor:i.espesor_mm,piezas:[],area_total:i.largo_lamina_mm*i.ancho_lamina_mm,area_utilizada:0,area_sobrante:i.largo_lamina_mm*i.ancho_lamina_mm,porcentaje_aprovechamiento:0,costo_lamina:i.precio_unitario,costo_piezas:0}}function Ae(a){const i=a.largo*a.ancho;let t=0,v=0;a.piezas.forEach(N=>{const _=N.rotada?N.ancho:N.largo,p=N.rotada?N.largo:N.ancho,b=_*p;t+=b,v+=N.costo_pieza||0}),a.area_utilizada=t,a.area_sobrante=i-t,a.porcentaje_aprovechamiento=i>0?t/i*100:0,a.costo_piezas=v}function Qe(a,i){const t=a.rotada?a.ancho:a.largo,v=a.rotada?a.largo:a.ancho,N=t*v/1e6,_=i.largo*i.ancho/1e6;a.costo_material=_>0?N/_*i.costo_lamina:0,console.log(`    ðŸ’° [COSTO] Pieza "${a.descripcion}":`,{area_pieza_m2:N.toFixed(4),area_lamina_m2:_.toFixed(4),precio_lamina:i.costo_lamina,costo_material:a.costo_material.toFixed(2)}),a.costo_tapacantos=0,a.metros_tapacanto_total=0,a.tapacantos&&a.tapacantos.length>0&&(a.tapacantos.forEach(n=>{if(n.precio_unitario&&n.metros_lineales){const o=n.metros_lineales/1e3*n.precio_unitario;a.costo_tapacantos+=o,a.metros_tapacanto_total+=n.metros_lineales/1e3}}),a.costo_tapacantos>0&&console.log(`    ðŸ’° [COSTO] Tapacantos: ${a.costo_tapacantos.toFixed(2)} (${a.metros_tapacanto_total.toFixed(2)}m)`));const b=(t+v)*2/10+5;a.hh_segundos=b;const g=0;a.costo_hh=b*g,a.costo_total=a.costo_material+a.costo_tapacantos+a.costo_hh,a.costo_pieza=a.costo_material,console.log(`    ðŸ’° [COSTO] Total pieza: ${a.costo_total.toFixed(2)}`)}function Ke(a,i,t){const v=i.length,N=i.reduce((S,y)=>S+y.area_utilizada,0),_=i.reduce((S,y)=>S+y.area_sobrante,0),p=N+_,b=p>0?N/p*100:0;let g=0,n=0,o=0;i.forEach(S=>{g+=S.costo_lamina,S.piezas.forEach(y=>{n+=y.costo_tapacantos||0,o+=y.costo_hh||0})});const d=g+n+o;return console.log("ðŸ’° [COSTOS] Resumen de costos calculados:",{materiales:g.toFixed(2),tapacantos:n.toFixed(2),hh:o.toFixed(2),total:d.toFixed(2)}),{laminas:i,total_laminas:v,area_total_utilizada:N,area_total_sobrante:_,porcentaje_aprovechamiento_global:b,costo_total_materiales:g,costo_total_tapacantos:n,costo_total_hh:o,costo_total:d,piezas_sin_asignar:t,resultados_por_material:a}}function Je(a,i){return a>i*1.5?"S":i>a*1.5?"X":"N"}function ea(){const a=["#3B82F6","#EF4444","#10B981","#F59E0B","#8B5CF6","#EC4899","#14B8A6","#F97316","#6366F1","#84CC16"];return a[Math.floor(Math.random()*a.length)]}function aa(a,i,t,v){console.log("  ðŸ”§ [OPTIMIZADOR] optimizarGrupoDePiezas - INICIO",{total_piezas:a.length,lamina_base:`${i.largo_lamina_mm} Ã— ${i.ancho_lamina_mm} mm`,piezas_detalle:a.map(s=>({desc:s.descripcion,dim_final:`${s.largo} Ã— ${s.ancho}`,dim_corte:`${s.largo_corte_mm||s.largo} Ã— ${s.ancho_corte_mm||s.ancho}`,cant:s.cantidad,veta:s.veta}))});const N=[];let _=v;const p=Math.max(i.largo_lamina_mm,i.ancho_lamina_mm),b=Math.min(i.largo_lamina_mm,i.ancho_lamina_mm);console.log("  ðŸ“ [VETA] LÃ¡mina base:",{dimensiones:`${i.largo_lamina_mm} Ã— ${i.ancho_lamina_mm}`,lado_largo:p,lado_corto:b,nota:"La veta de la lÃ¡mina va en la direcciÃ³n del lado mÃ¡s largo"});const g=[];a.forEach(s=>{console.log(`    ðŸ“¦ [OPTIMIZADOR] Expandiendo pieza "${s.descripcion}" Ã— ${s.cantidad}`);for(let c=0;c<s.cantidad;c++)g.push({...s,id:`${s.id}-${c}`,cantidad:1})}),console.log(`  âœ… [OPTIMIZADOR] Piezas expandidas: ${g.length}`);const n=[],o=[],d=t.espesor_sierra+t.margen_seguridad;if(g.forEach(s=>{const c=s.largo_corte_mm||s.largo,r=s.ancho_corte_mm||s.ancho,f=Math.max(c,r),x=Math.min(c,r);let A=!1,l="";s.veta==="S"?f+d<=p&&x+d<=b?A=!0:l=`Veta S requiere lado largo (${f}mm) â‰¤ lado largo lÃ¡mina (${p}mm)`:s.veta==="X"?f+d<=b&&x+d<=p?A=!0:l=`Veta X requiere lado largo (${f}mm) â‰¤ lado corto lÃ¡mina (${b}mm)`:c+d<=i.largo_lamina_mm&&r+d<=i.ancho_lamina_mm||r+d<=i.largo_lamina_mm&&c+d<=i.ancho_lamina_mm?A=!0:l=`Dimensiones de corte (${c}Ã—${r}) exceden lÃ¡mina (${i.largo_lamina_mm}Ã—${i.ancho_lamina_mm})`,A?n.push(s):(console.warn(`  âš ï¸ [VALIDACIÃ“N VETA] Pieza "${s.descripcion}" INVÃLIDA: ${l}`),o.push(s))}),console.log(`  ðŸ“Š [VALIDACIÃ“N VETA] Piezas vÃ¡lidas: ${n.length}, Piezas invÃ¡lidas: ${o.length}`),n.length===0)return console.warn("  âš ï¸ [OPTIMIZADOR] No hay piezas vÃ¡lidas para optimizar"),{laminas:[],piezasSinAsignar:o};const S=[...n].sort((s,c)=>{const r=(s.largo_corte_mm||s.largo)*(s.ancho_corte_mm||s.ancho);return(c.largo_corte_mm||c.largo)*(c.ancho_corte_mm||c.ancho)-r});let y=0;const T=50;let C=0;const j=3;for(;S.length>0&&y<T;){y++,console.log(`
  ðŸ”„ [OPTIMIZADOR] IteraciÃ³n ${y} - Piezas restantes: ${S.length}`);const s=we(_++,i);console.log(`    ðŸ“‹ [OPTIMIZADOR] LÃ¡mina ${s.id} creada: ${s.largo} Ã— ${s.ancho} mm`);const c=oa(S,s,t,i);if(console.log(`  âœ‚ï¸ [OPTIMIZADOR] LÃ¡mina ${s.id}: ${c.piezasColocadas} piezas colocadas`),s.piezas.length>0?(Ae(s),N.push(s),C=0):(C++,console.warn(`  âš ï¸ [OPTIMIZADOR] LÃ¡mina ${s.id} vacÃ­a (${C}/${j})`)),C>=j){console.error(`  âŒ [OPTIMIZADOR] ${j} lÃ¡minas vacÃ­as consecutivas - DETENIENDO`);break}}y>=T&&console.error(`  âŒ [OPTIMIZADOR] LÃ­mite de iteraciones alcanzado (${T})`);const m=[...S,...o];if(console.log("  ðŸ [OPTIMIZADOR] optimizarGrupoDePiezas - FIN",{laminas_creadas:N.length,piezas_sin_asignar:m.length}),n.length>0&&N.length===0){console.warn("  âš ï¸ [OPTIMIZADOR] CORRECCIÃ“N: Creando lÃ¡mina mÃ­nima para piezas vÃ¡lidas");const s=we(_++,i);Ae(s),N.push(s)}return{laminas:N,piezasSinAsignar:m}}function oa(a,i,t,v){let N=0;const _=t.espesor_sierra+t.margen_seguridad;Math.max(v.largo_lamina_mm,v.ancho_lamina_mm),Math.min(v.largo_lamina_mm,v.ancho_lamina_mm);const p=[{x:0,y:0,ancho:i.largo,alto:i.ancho}];let b=0;const g=a.length;for(;a.length>0&&b<g;){let n=!1;for(let o=0;o<a.length;o++){const d=a[o];let S=-1,y=1/0,T=!1;const C=d.largo_corte_mm||d.largo,j=d.ancho_corte_mm||d.ancho;for(let m=0;m<p.length;m++){const s=p[m],c=ta(d,t);for(const r of c){const f=r.rotada?j:C,x=r.rotada?C:j,A=f+_,l=x+_;if(A<=s.ancho&&l<=s.alto){const D=s.ancho*s.alto-A*l;D<y&&(y=D,S=m,T=r.rotada)}}}if(S!==-1){const m=p[S],s=T,c=s?j:C,r=s?C:j,f=c+_,x=r+_;d.posicion_x=m.x,d.posicion_y=m.y,d.rotada=s,d.lamina_asignada=i.id,d.largo=C,d.ancho=j,Qe(d,i),i.piezas.push(d),p.splice(S,1);const A=m.ancho-f,l=m.alto-x;A>10&&p.push({x:m.x+f,y:m.y,ancho:A,alto:x}),l>10&&p.push({x:m.x,y:m.y+x,ancho:m.ancho,alto:l}),p.sort((D,M)=>M.ancho*M.alto-D.ancho*D.alto),a.splice(o,1),N++,n=!0,b=0;break}}n||b++}return{piezasColocadas:N}}function ta(a,i){const t=[];return a.veta==="N"?(t.push({rotada:!1}),i.permitir_rotacion&&t.push({rotada:!0})):a.veta==="S"?t.push({rotada:!1}):a.veta==="X"&&(i.permitir_rotacion?t.push({rotada:!0}):t.push({rotada:!1})),t}function ie({tipoArticulo:a=null,onSeleccionar:i,onCancelar:t,placeholder:v="Buscar artÃ­culo...",permitirLimpiar:N=!1,onLimpiar:_,tiendaActual:p}){const[b,g]=P.useState(""),[n,o]=P.useState([]),[d,S]=P.useState(!1),[y,T]=P.useState(!1),[C,j]=P.useState(!1),m=P.useRef(null),s=P.useRef(null);P.useEffect(()=>{console.log("ðŸŽ¯ [BUSCADOR BLUR] Componente montado",{tipoArticulo:a,placeholder:v,tiendaActual:p?.id}),m.current?.focus()},[]),P.useEffect(()=>{console.log("ðŸ”„ [BUSCADOR BLUR] useEffect bÃºsqueda",{busqueda:b,longitud:b.length,tipoArticulo:a,tiendaActual:p?.id});const x=setTimeout(()=>{b.length>=2?(console.log("â° [BUSCADOR BLUR] Timer completado, iniciando bÃºsqueda"),c()):(console.log("âš ï¸ [BUSCADOR BLUR] BÃºsqueda muy corta, limpiando resultados"),o([]),j(!1),T(!1))},300);return()=>{console.log("ðŸ§¹ [BUSCADOR BLUR] Limpiando timer"),clearTimeout(x)}},[b,p]),P.useEffect(()=>{if(!t)return;const x=A=>{s.current&&!s.current.contains(A.target)&&(console.log("ðŸ‘† [BUSCADOR BLUR] Click fuera del componente, cancelando"),t())};return document.addEventListener("mousedown",x),()=>document.removeEventListener("mousedown",x)},[t]);const c=async()=>{if(!p){console.error("âŒ [BUSCADOR BLUR] No hay tienda seleccionada"),o([]),j(!1);return}console.log("ðŸš€ [BUSCADOR BLUR] Iniciando bÃºsqueda",{busqueda:b,tipoArticulo:a||"TODAS LAS CATEGORÃAS",tiendaActual:p?.id}),S(!0),j(!1);try{const{data:x}=await be(b,a,p);console.log("âœ… [BUSCADOR BLUR] BÃºsqueda completada",{resultados:x?.length||0,articulos:x?.map(A=>({codigo:A.codigo_articulo,descripcion:A.descripcion_articulo,categoria:A.categoria_nombre,tipo:A.tipo_articulo}))}),o(x||[]),T(!0),j(!0)}catch(x){console.error("âŒ [BUSCADOR BLUR] Error buscando artÃ­culos:",x),o([]),j(!0)}finally{S(!1)}},r=x=>{console.log("âœ¨ [BUSCADOR BLUR] ArtÃ­culo seleccionado",{id:x.id,codigo:x.codigo_articulo,descripcion:x.descripcion_articulo,tipo:x.tipo_articulo}),i(x),T(!1),j(!1),g("")},f=x=>{x.key==="Escape"&&t&&(console.log("âŒ¨ï¸ [BUSCADOR BLUR] ESC presionado, cancelando"),t())};return e.jsxs("div",{ref:s,className:"relative z-50",children:[e.jsxs("div",{className:"flex gap-1",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx("input",{ref:m,type:"text",value:b,onChange:x=>{console.log("âŒ¨ï¸ [BUSCADOR BLUR] Input onChange",{valor:x.target.value,longitud:x.target.value.length}),g(x.target.value)},onKeyDown:f,onFocus:()=>{console.log("ðŸ‘ï¸ [BUSCADOR BLUR] Input enfocado")},placeholder:v,className:"w-full px-3 py-1.5 pl-9 text-sm border-2 border-blue-500 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-600 shadow-lg",autoComplete:"off"}),e.jsx("i",{className:"ri-search-line absolute left-3 top-1/2 -translate-y-1/2 text-blue-500"}),d&&e.jsx("i",{className:"ri-loader-4-line animate-spin absolute right-3 top-1/2 -translate-y-1/2 text-blue-500"})]}),N&&_&&e.jsx("button",{onClick:()=>{console.log("ðŸ§¹ [BUSCADOR BLUR] BotÃ³n limpiar presionado"),_()},className:"px-3 py-1.5 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm whitespace-nowrap",title:"Limpiar selecciÃ³n",children:e.jsx("i",{className:"ri-close-line"})}),t&&e.jsx("button",{onClick:()=>{console.log("âŒ [BUSCADOR BLUR] BotÃ³n cancelar presionado"),t()},className:"px-3 py-1.5 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm",title:"Cancelar",children:e.jsx("i",{className:"ri-close-line"})})]}),y&&n.length>0&&e.jsx("div",{className:"absolute top-full left-0 right-0 mt-2 bg-white/95 backdrop-blur-md border-2 border-blue-500 rounded-lg shadow-2xl max-h-80 overflow-y-auto z-50 min-w-[600px]",children:e.jsxs("div",{className:"p-2",children:[e.jsxs("div",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wider px-3 py-2 bg-gray-50 rounded-t-lg",children:[n.length," resultado",n.length!==1?"s":""," encontrado",n.length!==1?"s":""]}),n.map(x=>e.jsx("button",{onClick:()=>r(x),className:"w-full p-3 hover:bg-blue-50 transition-colors text-left border-b border-gray-100 last:border-0 rounded-lg",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("div",{className:"w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center text-white font-bold shadow-sm",children:x.codigo_articulo.substring(0,2).toUpperCase()})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1 flex-wrap",children:[e.jsx("span",{className:"bg-blue-100 text-blue-800 text-xs px-2 py-0.5 rounded font-semibold whitespace-nowrap",children:x.codigo_articulo}),x.categoria_nombre&&e.jsx("span",{className:"bg-gray-100 text-gray-700 text-xs px-2 py-0.5 rounded whitespace-nowrap",children:x.categoria_nombre})]}),e.jsx("div",{className:"text-sm font-medium text-gray-900 mb-1",children:x.descripcion_articulo}),e.jsxs("div",{className:"flex items-center gap-3 text-xs text-gray-600 flex-wrap",children:[x.largo_lamina&&x.ancho_lamina&&e.jsxs("span",{className:"flex items-center gap-1 whitespace-nowrap",children:[e.jsx("i",{className:"ri-ruler-line"}),x.largo_lamina," Ã— ",x.ancho_lamina," mm"]}),x.espesor&&e.jsxs("span",{className:"flex items-center gap-1 whitespace-nowrap",children:[e.jsx("i",{className:"ri-stack-line"}),x.espesor," mm"]}),x.precio_unitario!=null&&e.jsxs("span",{className:"flex items-center gap-1 text-green-600 font-semibold whitespace-nowrap",children:[e.jsx("i",{className:"ri-price-tag-3-line"}),"â‚¡",x.precio_unitario.toLocaleString("es-CR")]})]})]})]})},x.id))]})}),y&&C&&b.length>=2&&!d&&n.length===0&&e.jsxs("div",{className:"absolute top-full left-0 right-0 mt-2 bg-white/95 backdrop-blur-md border-2 border-gray-300 rounded-lg shadow-xl p-6 text-center z-50 min-w-[400px]",children:[e.jsx("i",{className:"ri-search-line text-4xl text-gray-400 mb-2"}),e.jsxs("p",{className:"text-sm text-gray-600",children:['No se encontraron artÃ­culos para "',b,'"']}),a&&e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Tipo: ",a]})]}),!C&&b.length>0&&b.length<2&&e.jsxs("div",{className:"absolute top-full left-0 right-0 mt-2 bg-white/95 backdrop-blur-md border-2 border-gray-300 rounded-lg shadow-xl p-4 text-center z-50 min-w-[400px]",children:[e.jsx("i",{className:"ri-information-line text-2xl text-blue-500 mb-2"}),e.jsx("p",{className:"text-xs text-gray-600",children:"Escribe al menos 2 caracteres para buscar"})]})]})}function sa({piezas:a,onEditar:i,onEliminar:t,onDuplicar:v,tiendaActual:N}){const[_,p]=P.useState(null),[b,g]=P.useState(null);if(a.length===0)return e.jsxs("div",{className:"text-center py-12 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300",children:[e.jsx("i",{className:"ri-inbox-line text-4xl text-gray-400 mb-3"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-1",children:"Sin piezas"}),e.jsx("p",{className:"text-gray-600",children:"Agrega piezas manualmente, importa desde Excel o carga desde un producto BOM"})]});const n=(c,r,f)=>{const x=a[c],A={...x,[r]:f};if(r==="largo"||r==="ancho"){const l=r==="largo"?parseFloat(f):x.largo,D=r==="ancho"?parseFloat(f):x.ancho;l>D?A.veta="S":D>l?A.veta="X":A.veta="N"}i(c,A)},o=(c,r)=>{const x={...a[c],material_id:r.id,material_codigo:r.codigo_articulo,material_descripcion:r.descripcion_articulo,material_precio:r.precio_unitario,material_espesor_mm:r.espesor_mm,material_largo_lamina_mm:r.largo_lamina_mm,material_ancho_lamina_mm:r.ancho_lamina_mm};i(c,x),p(null),g(null)},d=(c,r,f)=>{const x=a[c],A=Array.isArray(x.tapacantos)?[...x.tapacantos]:[],l=A.findIndex(D=>D.lado===r);f?l>=0?A[l]={lado:r,articulo_id:f.id,codigo:f.codigo_articulo,descripcion:f.descripcion_articulo,precio_unitario:f.precio_unitario,grosor_mm:f.grosor_tapacanto_mm||0}:A.push({lado:r,articulo_id:f.id,codigo:f.codigo_articulo,descripcion:f.descripcion_articulo,precio_unitario:f.precio_unitario,grosor_mm:f.grosor_tapacanto_mm||0}):l>=0&&A.splice(l,1),i(c,{...x,tapacantos:A}),p(null),g(null)},S=(c,r,f)=>{const A={...a[c],[r]:f.codigo_articulo};i(c,A),p(null),g(null)},y=(c,r)=>{if(!(!c.tapacantos||!Array.isArray(c.tapacantos)))return c.tapacantos.find(f=>f.lado===r)},T=c=>{v&&v(c)},C=c=>{let r=0,f=0;return c.tapacantos&&c.tapacantos.length>0&&c.tapacantos.forEach(x=>{const A=x.grosor_mm||0;if(A>0)switch(x.lado){case"superior":case"inferior":f+=A;break;case"izquierdo":case"derecho":r+=A;break}}),{largo_corte:c.largo-r,ancho_corte:c.ancho-f,ajuste_largo:r,ajuste_ancho:f}},j=a.reduce((c,r)=>c+Number(r.cantidad||0),0),m=a.reduce((c,r)=>{const f=Number(r.largo||0)*Number(r.ancho||0)*Number(r.cantidad||0)/1e6;return c+f},0),s=c=>{switch(c){case"S":return{icon:"ri-arrow-right-line",label:"S - Hacia largo",color:"text-teal-600"};case"X":return{icon:"ri-arrow-down-line",label:"X - Cruzada",color:"text-orange-600"};case"N":return{icon:"ri-close-circle-line",label:"N - Sin veta",color:"text-gray-400"};default:return{icon:"ri-question-line",label:"Desconocida",color:"text-gray-400"}}};return e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border",children:[e.jsx("div",{className:"overflow-x-auto max-h-[500px] overflow-y-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 sticky top-0 z-10",children:e.jsxs("tr",{className:"border-b",children:[e.jsx("th",{className:"px-2 py-2 text-left text-xs font-semibold text-gray-700 w-12",children:"#"}),e.jsx("th",{className:"px-2 py-2 text-left text-xs font-semibold text-gray-700 min-w-[150px]",children:"DescripciÃ³n"}),e.jsx("th",{className:"px-2 py-2 text-left text-xs font-semibold text-gray-700 min-w-[200px]",children:"Material"}),e.jsx("th",{className:"px-2 py-2 text-center text-xs font-semibold text-gray-700 w-32",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{children:"Medida Final"}),e.jsx("span",{className:"text-[10px] text-gray-500 font-normal",children:"(Largo Ã— Ancho)"})]})}),e.jsx("th",{className:"px-2 py-2 text-center text-xs font-semibold text-gray-700 w-32",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{children:"Corte Ajustado"}),e.jsx("span",{className:"text-[10px] text-gray-500 font-normal",children:"(con TC)"})]})}),e.jsx("th",{className:"px-2 py-2 text-center text-xs font-semibold text-gray-700 w-20",children:"Cant."}),e.jsx("th",{className:"px-2 py-2 text-center text-xs font-semibold text-gray-700 w-28",children:"Veta"}),e.jsx("th",{className:"px-2 py-2 text-left text-xs font-semibold text-gray-700 min-w-[120px]",children:"TC Superior"}),e.jsx("th",{className:"px-2 py-2 text-left text-xs font-semibold text-gray-700 min-w-[120px]",children:"TC Inferior"}),e.jsx("th",{className:"px-2 py-2 text-left text-xs font-semibold text-gray-700 min-w-[120px]",children:"TC Izquierdo"}),e.jsx("th",{className:"px-2 py-2 text-left text-xs font-semibold text-gray-700 min-w-[120px]",children:"TC Derecho"}),e.jsx("th",{className:"px-2 py-2 text-left text-xs font-semibold text-gray-700 min-w-[140px]",children:"CNC1"}),e.jsx("th",{className:"px-2 py-2 text-left text-xs font-semibold text-gray-700 min-w-[140px]",children:"CNC2"}),e.jsx("th",{className:"px-2 py-2 text-center text-xs font-semibold text-gray-700 w-24",children:"Acciones"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:a.map((c,r)=>{const f=s(c.veta||"N");(Number(c.largo||0)*Number(c.ancho||0)/1e6).toFixed(2);const x=C(c),A=x.ajuste_largo>0||x.ajuste_ancho>0;return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-2 py-2",children:e.jsx("div",{className:"w-6 h-6 rounded flex items-center justify-center text-white font-semibold text-xs",style:{backgroundColor:c.color},children:r+1})}),e.jsx("td",{className:"px-2 py-2",children:e.jsx("input",{type:"text",value:c.descripcion,onChange:l=>n(r,"descripcion",l.target.value),className:"w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"DescripciÃ³n"})}),e.jsx("td",{className:"px-2 py-2",children:_===r&&b==="material"?e.jsx(ie,{tipoArticulo:"lamina",tiendaActual:N,onSeleccionar:l=>o(r,l),onCancelar:()=>{p(null),g(null)},placeholder:"Buscar material..."}):e.jsx("button",{onClick:()=>{p(r),g("material")},className:"w-full text-left px-2 py-1 text-xs border border-gray-300 rounded hover:bg-gray-50 transition-colors",children:c.material_codigo?e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900",children:c.material_codigo}),e.jsx("div",{className:"text-gray-500 truncate",children:c.material_descripcion})]}):e.jsx("span",{className:"text-red-600",children:"Seleccionar material..."})})}),e.jsx("td",{className:"px-2 py-2",children:e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("input",{type:"number",value:c.largo,onChange:l=>n(r,"largo",parseFloat(l.target.value)||0),className:"w-16 px-2 py-1 text-xs text-center border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent",min:"0",step:"1",title:"Largo final (mm)"}),e.jsx("span",{className:"text-gray-400 text-xs",children:"Ã—"}),e.jsx("input",{type:"number",value:c.ancho,onChange:l=>n(r,"ancho",parseFloat(l.target.value)||0),className:"w-16 px-2 py-1 text-xs text-center border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent",min:"0",step:"1",title:"Ancho final (mm)"})]}),e.jsxs("div",{className:"text-[10px] text-gray-500 text-center",children:[c.largo," Ã— ",c.ancho," mm"]})]})}),e.jsx("td",{className:"px-2 py-2",children:e.jsx("div",{className:"flex flex-col items-center gap-1",children:A?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-xs font-semibold text-orange-700 bg-orange-50 px-2 py-1 rounded border border-orange-200 cursor-help",title:`Ajuste por tapacanto:
Largo: -${x.ajuste_largo}mm
Ancho: -${x.ajuste_ancho}mm`,children:[x.largo_corte," Ã— ",x.ancho_corte]}),e.jsxs("div",{className:"text-[10px] text-orange-600 flex items-center gap-1",children:[e.jsx("i",{className:"ri-scissors-cut-line"}),e.jsxs("span",{children:["-",x.ajuste_largo+x.ajuste_ancho,"mm"]})]})]}):e.jsx("div",{className:"text-xs text-gray-400",children:"Sin ajuste"})})}),e.jsx("td",{className:"px-2 py-2",children:e.jsx("input",{type:"number",value:c.cantidad,onChange:l=>n(r,"cantidad",parseInt(l.target.value)||1),className:"w-20 px-2 py-1 text-xs text-center border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent",min:"1",step:"1"})}),e.jsxs("td",{className:"px-2 py-2",children:[e.jsxs("select",{value:c.veta||"N",onChange:l=>n(r,"veta",l.target.value),className:"w-28 px-2 py-1 text-xs border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[e.jsx("option",{value:"S",children:"S - Hacia largo"}),e.jsx("option",{value:"X",children:"X - Cruzada"}),e.jsx("option",{value:"N",children:"N - Sin veta"})]}),e.jsxs("div",{className:"flex items-center gap-1 mt-1",children:[e.jsx("i",{className:`${f.icon} ${f.color} text-xs`}),e.jsx("span",{className:`${f.color} text-[10px]`,children:f.label})]})]}),e.jsx("td",{className:"px-2 py-2",children:_===r&&b==="tc_superior"?e.jsx(ie,{tipoArticulo:"tapacanto",tiendaActual:N,onSeleccionar:l=>d(r,"superior",l),onCancelar:()=>{p(null),g(null)},placeholder:"Buscar tapacanto..."}):e.jsx("button",{onClick:()=>{p(r),g("tc_superior")},className:"w-full text-left px-2 py-1 text-xs border border-gray-300 rounded hover:bg-gray-50 transition-colors",children:y(c,"superior")?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:y(c,"superior")?.codigo}),y(c,"superior")?.grosor_mm&&e.jsxs("span",{className:"text-[10px] text-orange-600 font-semibold",children:[y(c,"superior")?.grosor_mm,"mm"]})]}):e.jsx("span",{className:"text-gray-400",children:"Sin TC"})})}),e.jsx("td",{className:"px-2 py-2",children:_===r&&b==="tc_inferior"?e.jsx(ie,{tipoArticulo:"tapacanto",tiendaActual:N,onSeleccionar:l=>d(r,"inferior",l),onCancelar:()=>{p(null),g(null)},placeholder:"Buscar tapacanto..."}):e.jsx("button",{onClick:()=>{p(r),g("tc_inferior")},className:"w-full text-left px-2 py-1 text-xs border border-gray-300 rounded hover:bg-gray-50 transition-colors",children:y(c,"inferior")?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:y(c,"inferior")?.codigo}),y(c,"inferior")?.grosor_mm&&e.jsxs("span",{className:"text-[10px] text-orange-600 font-semibold",children:[y(c,"inferior")?.grosor_mm,"mm"]})]}):e.jsx("span",{className:"text-gray-400",children:"Sin TC"})})}),e.jsx("td",{className:"px-2 py-2",children:_===r&&b==="tc_izquierdo"?e.jsx(ie,{tipoArticulo:"tapacanto",tiendaActual:N,onSeleccionar:l=>d(r,"izquierdo",l),onCancelar:()=>{p(null),g(null)},placeholder:"Buscar tapacanto..."}):e.jsx("button",{onClick:()=>{p(r),g("tc_izquierdo")},className:"w-full text-left px-2 py-1 text-xs border border-gray-300 rounded hover:bg-gray-50 transition-colors",children:y(c,"izquierdo")?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:y(c,"izquierdo")?.codigo}),y(c,"izquierdo")?.grosor_mm&&e.jsxs("span",{className:"text-[10px] text-orange-600 font-semibold",children:[y(c,"izquierdo")?.grosor_mm,"mm"]})]}):e.jsx("span",{className:"text-gray-400",children:"Sin TC"})})}),e.jsx("td",{className:"px-2 py-2",children:_===r&&b==="tc_derecho"?e.jsx(ie,{tipoArticulo:"tapacanto",tiendaActual:N,onSeleccionar:l=>d(r,"derecho",l),onCancelar:()=>{p(null),g(null)},placeholder:"Buscar tapacanto..."}):e.jsx("button",{onClick:()=>{p(r),g("tc_derecho")},className:"w-full text-left px-2 py-1 text-xs border border-gray-300 rounded hover:bg-gray-50 transition-colors",children:y(c,"derecho")?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:y(c,"derecho")?.codigo}),y(c,"derecho")?.grosor_mm&&e.jsxs("span",{className:"text-[10px] text-orange-600 font-semibold",children:[y(c,"derecho")?.grosor_mm,"mm"]})]}):e.jsx("span",{className:"text-gray-400",children:"Sin TC"})})}),e.jsx("td",{className:"text-xs border-b border-gray-200 px-2 py-2",children:_===r&&b==="cnc1"?e.jsx(ie,{tipoArticulo:"mecanizado",tiendaActual:N,onSeleccionar:l=>S(r,"cnc1",l),onCancelar:()=>{p(null),g(null)},placeholder:"Buscar CNC1..."}):e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:()=>{p(r),g("cnc1")},className:`flex-1 text-left px-2 py-1 text-xs rounded transition-colors ${c.cnc1&&c.cnc1.trim()!==""?"bg-blue-50 text-blue-700 border border-blue-300 hover:bg-blue-100":"text-gray-400 border border-dashed border-gray-300 hover:border-gray-400 hover:bg-gray-50"}`,title:"Buscar artÃ­culo CNC1",children:c.cnc1&&c.cnc1.trim()!==""?c.cnc1:"+ Buscar CNC1"}),e.jsx("input",{type:"number",value:c.cnc1_cantidad||0,onChange:l=>n(r,"cnc1_cantidad",parseInt(l.target.value)||0),disabled:!c.cnc1||c.cnc1.trim()==="",className:"w-14 px-1 py-1 text-xs text-center border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:bg-gray-100 disabled:cursor-not-allowed disabled:text-gray-400",min:"0",step:"1",placeholder:"Cant",title:c.cnc1&&c.cnc1.trim()!==""?"Cantidad CNC1":"Seleccione un CNC1 primero"})]})}),e.jsx("td",{className:"text-xs border-b border-gray-200 px-2 py-2",children:_===r&&b==="cnc2"?e.jsx(ie,{tipoArticulo:"mecanizado",tiendaActual:N,onSeleccionar:l=>S(r,"cnc2",l),onCancelar:()=>{p(null),g(null)},placeholder:"Buscar CNC2..."}):e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:()=>{p(r),g("cnc2")},className:`flex-1 text-left px-2 py-1 text-xs rounded transition-colors ${c.cnc2&&c.cnc2.trim()!==""?"bg-blue-50 text-blue-700 border border-blue-300 hover:bg-blue-100":"text-gray-400 border border-dashed border-gray-300 hover:border-gray-400 hover:bg-gray-50"}`,title:"Buscar artÃ­culo CNC2",children:c.cnc2&&c.cnc2.trim()!==""?c.cnc2:"+ Buscar CNC2"}),e.jsx("input",{type:"number",value:c.cnc2_cantidad||0,onChange:l=>n(r,"cnc2_cantidad",parseInt(l.target.value)||0),disabled:!c.cnc2||c.cnc2.trim()==="",className:"w-14 px-1 py-1 text-xs text-center border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:bg-gray-100 disabled:cursor-not-allowed disabled:text-gray-400",min:"0",step:"1",placeholder:"Cant",title:c.cnc2&&c.cnc2.trim()!==""?"Cantidad CNC2":"Seleccione un CNC2 primero"})]})}),e.jsx("td",{className:"px-2 py-2",children:e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[v&&e.jsx("button",{onClick:()=>T(r),className:"p-1.5 text-green-600 hover:bg-green-50 rounded transition-colors",title:"Duplicar",children:e.jsx("i",{className:"ri-file-copy-line text-sm"})}),e.jsx("button",{onClick:()=>t(r),className:"p-1.5 text-red-600 hover:bg-red-50 rounded transition-colors",title:"Eliminar",children:e.jsx("i",{className:"ri-delete-bin-line text-sm"})})]})})]},c.id)})})]})}),e.jsx("div",{className:"px-4 py-3 border-t bg-gray-50",children:e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"font-semibold text-gray-700",children:"Totales:"}),e.jsxs("div",{className:"flex items-center gap-6",children:[e.jsxs("span",{className:"text-gray-600",children:["Piezas: ",e.jsx("strong",{className:"text-gray-900",children:j})]}),e.jsxs("span",{className:"text-gray-600",children:["Ãrea: ",e.jsxs("strong",{className:"text-gray-900",children:[m.toFixed(2)," mÂ²"]})]})]})]})})]})}const Ie=["#3B82F6","#EF4444","#10B981","#F59E0B","#8B5CF6","#EC4899","#14B8A6","#F97316","#6366F1","#84CC16","#06B6D4","#F43F5E","#92400E","#6B7280","#7C3AED","#22C55E","#EAB308","#DC2626","#0EA5E9","#D946EF"];function Se({onImportar:a}){const{showNotification:i}=fe(),{currentStore:t}=me(),[v,N]=P.useState(!1),[_,p]=P.useState(null),[b,g]=P.useState([]),[n,o]=P.useState(!1),d=C=>{const j=C.target.files?.[0];j&&(p(j),S(j))},S=C=>{const j=new FileReader;j.onload=m=>{try{const s=m.target?.result,c=Ce(s,{type:"binary"}),r=c.SheetNames[0],f=c.Sheets[r],x=X.sheet_to_json(f);g(x.slice(0,5))}catch(s){console.error("Error leyendo archivo:",s),i("error","Error al leer el archivo Excel")}},j.readAsBinaryString(C)},y=async()=>{if(!_)return;o(!0);const C=new FileReader;C.onload=async j=>{try{const m=j.target?.result,s=Ce(m,{type:"binary"}),c=s.SheetNames[0],r=s.Sheets[c],f=X.sheet_to_json(r);console.log("ðŸ“¥ [IMPORTAR] Iniciando importaciÃ³n de",f.length,"filas");const x=h=>{if(!h)return"";let O=String(h).trim();return O.endsWith(".0")&&(O=O.slice(0,-2)),O},A=new Set,l=new Set,D=new Set;f.forEach(h=>{const O=x(h.Material||h.material);O&&A.add(O);const E=x(h["TC Superior"]||h.tc_superior),k=x(h["TC Inferior"]||h.tc_inferior),I=x(h["TC Izquierdo"]||h.tc_izquierdo),Z=x(h["TC Derecho"]||h.tc_derecho);E&&E!=="Sin TC"&&E!=="0"&&l.add(E),k&&k!=="Sin TC"&&k!=="0"&&l.add(k),I&&I!=="Sin TC"&&I!=="0"&&l.add(I),Z&&Z!=="Sin TC"&&Z!=="0"&&l.add(Z);const w=x(h.CNC1||h.cnc1),V=x(h.CNC2||h.cnc2);w&&w!=="0"&&D.add(w),V&&V!=="0"&&D.add(V)}),console.log("ðŸ” [IMPORTAR] CÃ³digos a validar:",{materiales:Array.from(A),tapacantos:Array.from(l),cnc:Array.from(D)});const M=new Map;for(const h of A){const{data:O}=await be(h,"lamina",t);if(O&&O.length>0){const E=O.find(k=>k.codigo_articulo.toLowerCase().trim()===h.toLowerCase().trim());E&&(M.set(h,E),console.log("âœ… [IMPORTAR] Material encontrado:",h,"â†’",E.descripcion_articulo))}}console.log("ðŸ“Š [IMPORTAR] Resumen de materiales encontrados:",{total_buscados:A.size,total_encontrados:M.size,materiales_encontrados:Array.from(M.keys()),materiales_no_encontrados:Array.from(A).filter(h=>!M.has(h))});const F=new Map;if(l.size>0)for(const h of l){const{data:O}=await be(h,"tapacanto",t);if(console.log(`ðŸ” [tapacanto_resolve] Buscando "${h}":`,{columna:"TC",codigo_normalizado:h,encontrado:O&&O.length>0,resultados:O?.length||0}),O&&O.length>0){const E=O.find(k=>k.codigo_articulo.toLowerCase().trim()===h.toLowerCase().trim());E&&(F.set(h,E),console.log("âœ… [tapacanto_resolve]",{columna:"TC",codigo_normalizado:h,encontrado:!0,id_articulo:E.id,codigo_articulo:E.codigo_articulo,descripcion:E.descripcion_articulo}))}}console.log("ðŸ“Š [IMPORTAR] Resumen de tapacantos encontrados:",{total_buscados:l.size,total_encontrados:F.size,tapacantos_encontrados:Array.from(F.keys()),tapacantos_no_encontrados:Array.from(l).filter(h=>!F.has(h))});const B=new Map;if(D.size>0){const{data:h,error:O}=await H.from("inventario").select(`
              id_articulo,
              codigo_articulo,
              descripcion_articulo,
              precio_articulo
            `).in("codigo_articulo",Array.from(D)).eq("id_tienda",t?.id).eq("activo",!0);!O&&h&&h.forEach(E=>{B.set(E.codigo_articulo,E),console.log("âœ… [IMPORTAR] CNC encontrado:",E.codigo_articulo,"â†’",E.descripcion_articulo,"- Precio:",E.precio_articulo)})}const L=[],z=[];if(f.forEach((h,O)=>{const E=h.DescripciÃ³n||h.Descripcion||h.descripcion||`Pieza ${O+1}`,k=x(h.Material||h.material),I=parseFloat(h.Largo||h.largo||"0"),Z=parseFloat(h.Ancho||h.ancho||"0"),w=parseInt(h.Cantidad||h.cantidad||"1"),V=(h.Veta||h.veta||"S").toString().toUpperCase(),u=x(h.CNC1||h.cnc1),R=parseInt(h["CNC1 Cantidad"]||h.cnc1_cantidad||"0"),q=x(h.CNC2||h.cnc2),re=parseInt(h["CNC2 Cantidad"]||h.cnc2_cantidad||"0");if(!k){z.push(`Fila ${O+1}: Sin cÃ³digo de material`);return}const W=M.get(k);if(!W){z.push(`Fila ${O+1}: Material "${k}" no encontrado en inventario.
   â€¢ Verifica que el cÃ³digo sea correcto
   â€¢ AsegÃºrate de que estÃ© en la categorÃ­a LAMINAS
   â€¢ Verifica que estÃ© activo y tenga dimensiones completas`);return}const J=[];[{lado:"superior",codigo:x(h["TC Superior"]||h.tc_superior)},{lado:"inferior",codigo:x(h["TC Inferior"]||h.tc_inferior)},{lado:"izquierdo",codigo:x(h["TC Izquierdo"]||h.tc_izquierdo)},{lado:"derecho",codigo:x(h["TC Derecho"]||h.tc_derecho)}].forEach(({lado:G,codigo:oe})=>{if(oe&&oe!=="Sin TC"&&oe!=="0"){const te=F.get(oe);te?(J.push({lado:G,articulo_id:te.id,codigo:te.codigo_articulo,descripcion:te.descripcion_articulo,precio_unitario:te.precio_articulo||0,grosor_mm:te.grosor_tapacanto_mm||0,metros_lineales:0}),console.log(`âœ… [IMPORTAR] Tapacanto asignado a "${E}" - ${G}: ${oe}`)):console.warn(`âš ï¸ [IMPORTAR] Tapacanto "${oe}" no encontrado para pieza "${E}" - lado: ${G}`)}}),console.log("ðŸ“¦ [pieza_mapeada]",{desc:E,tcSup:J.find(G=>G.lado==="superior")?.codigo||null,tcInf:J.find(G=>G.lado==="inferior")?.codigo||null,tcIzq:J.find(G=>G.lado==="izquierdo")?.codigo||null,tcDer:J.find(G=>G.lado==="derecho")?.codigo||null});let se="S";const ae=String(V).toUpperCase().trim();ae==="S"||ae==="X"||ae==="N"?se=ae:ae==="Y"||ae==="YES"||ae==="SI"||ae==="SÃ"?se="N":se=I>Z?"S":Z>I?"X":"N";const ge=Ie[O%Ie.length];L.push({id:`excel-${Date.now()}-${O}`,descripcion:E,material_id:W.id,material_codigo:W.codigo_articulo,material_descripcion:W.descripcion_articulo,material_precio:W.precio_unitario||0,material_espesor_mm:W.espesor_mm,material_largo_lamina_mm:W.largo_lamina_mm,material_ancho_lamina_mm:W.ancho_lamina_mm,largo:I,ancho:Z,cantidad:w,veta:se,tapacantos:J,cnc1:u,cnc1_codigo:u,cnc1_cantidad:R,cnc2:q,cnc2_codigo:q,cnc2_cantidad:re,color:ge}),console.log(`âœ… [IMPORTAR] Pieza "${E}" creada:`,{material:k,tapacantos:J.length,cnc1:u?`${u} x ${R}`:"-",cnc2:q?`${q} x ${re}`:"-"})}),z.length>0){console.error("âŒ [IMPORTAR] Errores de validaciÃ³n:",z);const h=z.slice(0,5).join(`

`),O=`âŒ Se encontraron ${z.length} error(es) de validaciÃ³n:

${h}${z.length>5?`

... y mÃ¡s errores`:""}

ðŸ’¡ Sugerencias:

1. Verifica que los cÃ³digos de material existan en tu inventario
2. AsegÃºrate de que los materiales estÃ©n en la categorÃ­a LAMINAS
3. Verifica que los materiales estÃ©n activos
4. AsegÃºrate de que tengan dimensiones completas (largo, ancho, espesor)
5. Revisa la consola del navegador (F12) para mÃ¡s detalles

ðŸ“‹ Materiales buscados: ${Array.from(A).join(", ")}
âœ… Materiales encontrados: ${Array.from(M.keys()).join(", ")||"Ninguno"}`;alert(O),i("error",`${z.length} error(es) de validaciÃ³n. Revisa el mensaje.`)}L.length>0?(a(L),i("success",`âœ… Se importaron ${L.length} piezas correctamente`),N(!1),p(null),g([])):i("error","No se pudo importar ninguna pieza. Verifica los cÃ³digos de material."),o(!1)}catch(m){console.error("Error importando:",m),i("error","Error al importar el archivo. Verifica el formato."),o(!1)}},C.readAsBinaryString(_)},T=()=>{const C=[{DescripciÃ³n:"Tapa superior",Material:"MEL001",Largo:2e3,Ancho:600,Cantidad:1,Veta:"S","TC Superior":"TC001","TC Inferior":"TC001","TC Izquierdo":"TC001","TC Derecho":"TC001",CNC1:"77788","CNC1 Cantidad":1,CNC2:"77788","CNC2 Cantidad":2},{DescripciÃ³n:"Lateral izquierdo",Material:"MEL001",Largo:1800,Ancho:400,Cantidad:1,Veta:"S","TC Superior":"TC001","TC Inferior":"","TC Izquierdo":"TC001","TC Derecho":"TC001",CNC1:"77788","CNC1 Cantidad":1,CNC2:"","CNC2 Cantidad":0},{DescripciÃ³n:"EntrepaÃ±o",Material:"MEL001",Largo:400,Ancho:1800,Cantidad:2,Veta:"X","TC Superior":"TC001","TC Inferior":"TC001","TC Izquierdo":"","TC Derecho":"",CNC1:"","CNC1 Cantidad":0,CNC2:"","CNC2 Cantidad":0}],j=X.json_to_sheet(C);j["!cols"]=[{wch:30},{wch:15},{wch:10},{wch:10},{wch:10},{wch:8},{wch:15},{wch:15},{wch:15},{wch:15},{wch:15},{wch:15},{wch:15},{wch:15}];const m=X.book_new();X.book_append_sheet(m,j,"Piezas"),je(m,"plantilla_optimizador.xlsx"),i("success","Plantilla descargada correctamente")};return e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>N(!0),className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2 whitespace-nowrap",children:[e.jsx("i",{className:"ri-folder-open-line"}),"Cargar Proyecto"]}),v&&e.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden",children:[e.jsx("div",{className:"bg-gradient-to-r from-blue-600 to-blue-700 text-white p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center",children:e.jsx("i",{className:"ri-file-excel-2-line text-2xl"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Cargar Proyecto desde Excel"}),e.jsx("p",{className:"text-blue-100 text-sm",children:"Importa la lista de piezas desde un archivo Excel (.xlsx)"})]})]}),e.jsx("button",{onClick:()=>{N(!1),p(null),g([])},className:"text-white hover:bg-white/20 p-2 rounded-lg transition-colors",disabled:n,children:e.jsx("i",{className:"ri-close-line text-2xl"})})]})}),e.jsxs("div",{className:"p-6 overflow-y-auto max-h-[calc(90vh-200px)]",children:[e.jsxs("div",{className:"bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-6",children:[e.jsxs("h3",{className:"font-semibold text-blue-900 mb-3 flex items-center gap-2",children:[e.jsx("i",{className:"ri-information-line"}),"Formato del Archivo Excel"]}),e.jsxs("div",{className:"text-sm text-blue-800 space-y-2",children:[e.jsx("p",{children:"El archivo debe contener las siguientes columnas:"}),e.jsxs("div",{className:"bg-white rounded-lg p-3 font-mono text-xs overflow-x-auto",children:[e.jsxs("div",{className:"grid grid-cols-7 gap-2 min-w-max",children:[e.jsx("div",{className:"font-bold",children:"1. DescripciÃ³n"}),e.jsx("div",{className:"font-bold",children:"2. Material"}),e.jsx("div",{className:"font-bold",children:"3. Largo"}),e.jsx("div",{className:"font-bold",children:"4. Ancho"}),e.jsx("div",{className:"font-bold",children:"5. Cantidad"}),e.jsx("div",{className:"font-bold",children:"6. Veta"}),e.jsx("div",{className:"font-bold",children:"7. TC Superior"})]}),e.jsxs("div",{className:"grid grid-cols-7 gap-2 min-w-max mt-2",children:[e.jsx("div",{className:"font-bold",children:"8. TC Inferior"}),e.jsx("div",{className:"font-bold",children:"9. TC Izquierdo"}),e.jsx("div",{className:"font-bold",children:"10. TC Derecho"}),e.jsx("div",{className:"font-bold",children:"11. CNC1"}),e.jsx("div",{className:"font-bold",children:"12. CNC1 Cantidad"}),e.jsx("div",{className:"font-bold",children:"13. CNC2"}),e.jsx("div",{className:"font-bold",children:"14. CNC2 Cantidad"})]})]}),e.jsx("div",{className:"bg-amber-50 border border-amber-200 rounded p-2 mt-2",children:e.jsxs("p",{className:"text-xs text-amber-900",children:[e.jsx("strong",{children:"Importante:"})," Los cÃ³digos de Material, Tapacantos y CNC deben existir en tu inventario"]})}),e.jsx("div",{className:"bg-green-50 border border-green-200 rounded p-2 mt-2",children:e.jsxs("p",{className:"text-xs text-green-900",children:[e.jsx("strong",{children:"Veta:"})," Usa ",e.jsx("strong",{children:"S"})," (hacia largo), ",e.jsx("strong",{children:"X"})," (cruzada), o ",e.jsx("strong",{children:"N"})," (sin veta)"]})}),e.jsx("div",{className:"bg-purple-50 border border-purple-200 rounded p-2 mt-2",children:e.jsxs("p",{className:"text-xs text-purple-900",children:[e.jsx("strong",{children:"CNC:"}),' Ingresa el cÃ³digo del artÃ­culo CNC y su cantidad. Ejemplo: CNC1 = "77788", CNC1 Cantidad = 1']})})]})]}),e.jsx("div",{className:"mb-6",children:e.jsxs("button",{onClick:T,className:"w-full px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center gap-2",disabled:n,children:[e.jsx("i",{className:"ri-download-2-line text-xl"}),"Descargar Plantilla de Ejemplo"]})}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Seleccionar archivo Excel"}),e.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-500 transition-colors",children:[e.jsx("input",{type:"file",accept:".xlsx,.xls",onChange:d,className:"hidden",id:"file-upload",disabled:n}),e.jsxs("label",{htmlFor:"file-upload",className:`${n?"cursor-not-allowed opacity-50":"cursor-pointer"} flex flex-col items-center gap-3`,children:[e.jsx("div",{className:"w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center",children:e.jsx("i",{className:`${n?"ri-loader-4-line animate-spin":"ri-upload-cloud-2-line"} text-3xl text-blue-600`})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-lg font-semibold text-gray-900",children:n?"Validando cÃ³digos...":_?_.name:"Haz clic para seleccionar un archivo"}),e.jsx("p",{className:"text-sm text-gray-600",children:n?"Por favor espera...":"o arrastra y suelta aquÃ­"})]}),e.jsx("p",{className:"text-xs text-gray-500",children:"Formatos soportados: .xlsx, .xls"})]})]})]}),b.length>0&&!n&&e.jsxs("div",{className:"mb-6",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 mb-3 flex items-center gap-2",children:[e.jsx("i",{className:"ri-eye-line text-blue-600"}),"PrevisualizaciÃ³n (primeras 5 filas)"]}),e.jsx("div",{className:"overflow-x-auto border border-gray-200 rounded-lg",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 text-xs",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsx("tr",{children:Object.keys(b[0]).map(C=>e.jsx("th",{className:"px-3 py-2 text-left font-semibold text-gray-700 whitespace-nowrap",children:C},C))})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:b.map((C,j)=>e.jsx("tr",{className:"hover:bg-gray-50",children:Object.values(C).map((m,s)=>e.jsx("td",{className:"px-3 py-2 text-gray-900 whitespace-nowrap",children:m},s))},j))})]})}),e.jsx("p",{className:"text-xs text-gray-600 mt-2",children:"Se validarÃ¡n todos los cÃ³digos de material y tapacantos antes de importar"})]})]}),e.jsxs("div",{className:"bg-gray-50 px-6 py-4 border-t border-gray-200 flex gap-3",children:[e.jsx("button",{onClick:()=>{N(!1),p(null),g([])},className:"flex-1 px-6 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors font-semibold",disabled:n,children:"Cancelar"}),e.jsx("button",{onClick:y,disabled:!_||n,className:"flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors font-semibold flex items-center justify-center gap-2",children:n?e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"ri-loader-4-line text-xl animate-spin"}),"Validando..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"ri-check-line text-xl"}),"Cargar Piezas"]})})]})]})})]})}const ra=({modo:a,piezas:i,laminaBase:t,onCargarBOM:v,onAgregarPieza:N,onEditarPieza:_,onEliminarPieza:p,onSeleccionarLamina:b,onLimpiar:g})=>{const[n,o]=Me.useState(!1),{currentStore:d}=me(),S=C=>{const j=i[C],m={...j,id:`${j.id}-dup-${Date.now()}`,descripcion:`${j.descripcion} (Copia)`,tapacantos:[...j.tapacantos]};N(m)},y=()=>{const C=["#3B82F6","#10B981","#F59E0B","#EF4444","#8B5CF6","#EC4899"],j=C[Math.floor(Math.random()*C.length)],m={id:`pieza-${Date.now()}`,descripcion:"",largo:0,ancho:0,cantidad:1,veta:"S",tapacantos:[],color:j};N(m)},T=C=>{C.map(m=>({...m,tapacantos:Array.isArray(m.tapacantos)?m.tapacantos:[]})).forEach(m=>N(m)),o(!1)};return e.jsxs("div",{className:"space-y-4",children:[a==="bom"&&e.jsx("div",{className:"bg-white rounded-lg shadow-sm border p-4",children:e.jsx(He,{onSeleccionar:v})}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border p-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-900 flex items-center gap-2",children:[e.jsx("i",{className:"ri-table-line text-blue-600"}),"Lista de Piezas"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:y,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2 whitespace-nowrap",children:[e.jsx("i",{className:"ri-add-line"}),"Nueva Pieza"]}),e.jsxs("button",{onClick:()=>o(!0),className:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2 whitespace-nowrap",children:[e.jsx("i",{className:"ri-file-excel-2-line"}),"Importar Excel"]}),i.length>0&&e.jsxs("button",{onClick:g,className:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors flex items-center gap-2 whitespace-nowrap",children:[e.jsx("i",{className:"ri-delete-bin-line"}),"Limpiar Todo"]})]})]}),e.jsx(sa,{piezas:i,onEditar:_,onEliminar:p,onDuplicar:S,tiendaActual:d})]}),n&&e.jsx(Se,{onImportar:T,onCerrar:()=>o(!1)})]})};function ia({resultado:a}){const i=P.useRef(null),[t,v]=P.useState(0);P.useEffect(()=>{console.log("ðŸŽ¨ [VISUALIZADOR] Resultado completo recibido:",{tiene_resultado:!!a,estructura:a?{total_laminas:a.total_laminas,laminas_array_length:a.laminas?.length,resultados_por_material_length:a.resultados_por_material?.length,primera_lamina:a.laminas?.[0]?{id:a.laminas[0].id,piezas_length:a.laminas[0].piezas?.length,piezas_sample:a.laminas[0].piezas?.slice(0,2)}:null,primer_resultado_material:a.resultados_por_material?.[0]?{material_codigo:a.resultados_por_material[0].material_codigo,laminas_length:a.resultados_por_material[0].laminas?.length,primera_lamina_piezas:a.resultados_por_material[0].laminas?.[0]?.piezas?.length}:null}:null})},[a]),P.useEffect(()=>{if(!a||!i.current){console.log("âš ï¸ [VISUALIZADOR] No hay resultado o canvas");return}console.log("ðŸŽ¨ [VISUALIZADOR] useEffect disparado",{tiene_resultado:!!a,total_laminas:a.total_laminas,lamina_seleccionada:t});let g=null;if(a.resultados_por_material&&a.resultados_por_material.length>0){let n=0;for(const o of a.resultados_por_material){if(o.laminas)for(const d of o.laminas){if(n===t){g=d;break}n++}if(g)break}}if(!g&&a.laminas&&a.laminas[t]&&(g=a.laminas[t]),!g){console.error("âŒ [VISUALIZADOR] No se encontrÃ³ la lÃ¡mina seleccionada");return}console.log("ðŸŽ¨ [VISUALIZADOR] Dibujando lÃ¡mina",t,{lamina:{id:g.id,dimensiones:`${g.largo} Ã— ${g.ancho} mm`,total_piezas:g.piezas?.length||0,piezas:g.piezas?.map(n=>({id:n.id,desc:n.descripcion,pos:`(${n.posicion_x}, ${n.posicion_y})`,dim:`${n.largo}Ã—${n.ancho}`,rotada:n.rotada}))}}),N(i.current,g)},[a,t]);const N=(g,n)=>{console.log("ðŸ–Œï¸ [VISUALIZADOR] Iniciando dibujo de lÃ¡mina",{id:n.id,dimensiones:`${n.largo} Ã— ${n.ancho} mm`,total_piezas:n.piezas?.length||0,piezas:n.piezas});const o=g.getContext("2d");if(!o){console.error("âŒ [VISUALIZADOR] No se pudo obtener contexto 2D");return}o.clearRect(0,0,g.width,g.height);const d=g.width,S=g.height,y=40;console.log("ðŸ“ [VISUALIZADOR] Dimensiones canvas:",{canvas:`${d} Ã— ${S}`,area_dibujo:`${d-y*2} Ã— ${S-y*2}`,padding:y});const T=(d-y*2)/n.largo,C=(S-y*2)/n.ancho,j=Math.min(T,C),m=n.largo*j,s=n.ancho*j,c=(d-m)/2,r=(S-s)/2;if(console.log("ðŸ“ [VISUALIZADOR] Escala y posiciÃ³n:",{escala:j.toFixed(4),lamina_dibujada:`${m.toFixed(1)} Ã— ${s.toFixed(1)}`,offset:`(${c.toFixed(1)}, ${r.toFixed(1)})`}),o.fillStyle="#F9FAFB",o.fillRect(c,r,m,s),o.strokeStyle="#1F2937",o.lineWidth=2,o.strokeRect(c,r,m,s),console.log("âœ… [VISUALIZADOR] LÃ¡mina base dibujada"),!n.piezas||n.piezas.length===0){console.warn("âš ï¸ [VISUALIZADOR] La lÃ¡mina no tiene piezas para dibujar"),o.fillStyle="#6B7280",o.font="16px sans-serif",o.textAlign="center",o.fillText("No hay piezas en esta lÃ¡mina",d/2,S/2);return}const f=[];let x=0;n.piezas.forEach((l,D)=>{if(console.log(`ðŸ”· [VISUALIZADOR] Dibujando pieza ${D+1}:`,{id:l.id,descripcion:l.descripcion,posicion_mm:`(${l.posicion_x}, ${l.posicion_y})`,dimensiones_mm:`${l.largo} Ã— ${l.ancho}`,veta:l.veta,rotada:l.rotada,color:l.color}),l.posicion_x===void 0||l.posicion_y===void 0){console.error(`âŒ [VISUALIZADOR] Pieza ${D+1} sin posiciÃ³n asignada`);return}const M=l.rotada?l.ancho:l.largo,F=l.rotada?l.largo:l.ancho,B=c+l.posicion_x*j,L=r+l.posicion_y*j,z=M*j,h=F*j;if(f.push({x:l.posicion_x,y:l.posicion_y,w:M,h:F}),console.log("  ðŸ“ [VISUALIZADOR] PosiciÃ³n en canvas:",{posicion_canvas:`(${B.toFixed(1)}, ${L.toFixed(1)})`,tamaÃ±o_canvas:`${z.toFixed(1)} Ã— ${h.toFixed(1)}`}),o.fillStyle=l.color||"#3B82F6",o.fillRect(B,L,z,h),o.strokeStyle="#1F2937",o.lineWidth=1,o.strokeRect(B,L,z,h),o.strokeStyle="rgba(0, 0, 0, 0.25)",o.lineWidth=1,l.veta==="S"){const O=Math.floor(h/12);for(let E=1;E<O;E++){const k=L+E*h/O;o.beginPath(),o.moveTo(B,k),o.lineTo(B+z,k),o.stroke()}}else if(l.veta==="X"){const O=Math.floor(z/12);for(let E=1;E<O;E++){const k=B+E*z/O;o.beginPath(),o.moveTo(k,L),o.lineTo(k,L+h),o.stroke()}}if(z>40&&h>40){const O=Math.min(z,h)*.15,E=B+z-O-8,k=L+8;if(o.fillStyle="rgba(255, 255, 255, 0.9)",o.fillRect(E-4,k-4,O+8,O+8),o.strokeStyle="#1F2937",o.fillStyle="#1F2937",o.lineWidth=2,l.veta==="S"){const I=k+O/2;o.beginPath(),o.moveTo(E,I),o.lineTo(E+O,I),o.stroke(),o.beginPath(),o.moveTo(E+O,I),o.lineTo(E+O-6,I-4),o.lineTo(E+O-6,I+4),o.closePath(),o.fill()}else if(l.veta==="X"){const I=E+O/2;o.beginPath(),o.moveTo(I,k),o.lineTo(I,k+O),o.stroke(),o.beginPath(),o.moveTo(I,k+O),o.lineTo(I-4,k+O-6),o.lineTo(I+4,k+O-6),o.closePath(),o.fill()}else l.veta==="N"&&(o.font="bold 14px sans-serif",o.textAlign="center",o.textBaseline="middle",o.fillText("N",E+O/2,k+O/2))}o.fillStyle="white",o.font="bold 14px sans-serif",o.textAlign="center",o.textBaseline="middle",o.fillText(`${D+1}`,B+z/2,L+h/2),o.fillStyle="#1F2937",o.font="10px sans-serif",o.fillText(`${M}Ã—${F}`,B+z/2,L+h/2+15),x++}),console.log(`âœ… [VISUALIZADOR] ${x} piezas dibujadas`),console.log("ðŸ“¦ [SOBRANTES] Calculando sobrantes desde bordes de lÃ¡mina...");const A=[];if(f.length>0){const l=f.reduce((z,h)=>h.x+h.w>z.x+z.w?h:z),D=l.x+l.w,M=n.largo-D;M>50&&(A.push({x:D,y:0,w:M,h:n.ancho}),console.log("  âž¡ï¸ [SOBRANTE DERECHO]:",{posicion:`(${D}, 0)`,dimensiones:`${Math.round(M)} Ã— ${n.ancho} mm`,area_m2:(M*n.ancho/1e6).toFixed(2)}));const F=f.reduce((z,h)=>h.y+h.h>z.y+z.h?h:z),B=F.y+F.h,L=n.ancho-B;L>50&&(A.push({x:0,y:B,w:n.largo,h:L}),console.log("  â¬†ï¸ [SOBRANTE SUPERIOR]:",{posicion:`(0, ${B})`,dimensiones:`${n.largo} Ã— ${Math.round(L)} mm`,area_m2:(n.largo*L/1e6).toFixed(2)}))}console.log("ðŸ“¦ [SOBRANTES FINALES] LÃ¡mina completa:",{sobrantes:A.length,detalles:A.map(l=>({posicion:`(${Math.round(l.x)}, ${Math.round(l.y)})`,dimensiones:`${Math.round(l.w)}Ã—${Math.round(l.h)} mm`,area:(l.w*l.h/1e6).toFixed(2)+" mÂ²"}))}),o.fillStyle="#059669",o.font="bold 12px sans-serif",o.textAlign="center",o.textBaseline="middle",A.forEach((l,D)=>{const M=c+l.x*j,F=r+l.y*j,B=l.w*j,L=l.h*j;console.log(`  ðŸŽ¨ [DIBUJANDO SOBRANTE ${D+1}]:`,{canvas_pos:`(${M.toFixed(1)}, ${F.toFixed(1)})`,canvas_size:`${B.toFixed(1)} Ã— ${L.toFixed(1)} px`,real_size:`${Math.round(l.w)} Ã— ${Math.round(l.h)} mm`}),B>20&&L>20&&(o.fillStyle="rgba(5, 150, 105, 0.15)",o.fillRect(M,F,B,L),o.strokeStyle="#059669",o.lineWidth=2,o.setLineDash([5,5]),o.strokeRect(M,F,B,L),o.setLineDash([]),o.fillStyle="#047857",o.font="bold 13px sans-serif",B>80&&o.fillText(`${Math.round(l.w)} mm`,M+B/2,F+L/2-10),L>80&&o.fillText(`${Math.round(l.h)} mm`,M+B/2,F+L/2+10),B>100&&L>60&&(o.font="bold 11px sans-serif",o.fillStyle="#065f46",o.fillText("SOBRANTE",M+B/2,F+20)))}),console.log(`âœ… [VISUALIZADOR] ${A.length} sobrantes dibujados`),o.strokeStyle="#EF4444",o.lineWidth=1,o.setLineDash([5,5]),n.piezas.forEach(l=>{if(l.posicion_x===void 0||l.posicion_y===void 0)return;const D=l.rotada?l.ancho:l.largo,M=l.rotada?l.largo:l.ancho,F=c+l.posicion_x*j,B=r+l.posicion_y*j,L=D*j,z=M*j;o.beginPath(),o.moveTo(F+L,r),o.lineTo(F+L,r+s),o.stroke(),o.beginPath(),o.moveTo(c,B+z),o.lineTo(c+m,B+z),o.stroke()}),o.setLineDash([]),console.log("âœ… [VISUALIZADOR] LÃ­neas de corte dibujadas"),console.log("ðŸŽ‰ [VISUALIZADOR] Dibujo completado exitosamente")};if(!a)return e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border p-8 text-center",children:[e.jsx("i",{className:"ri-scissors-cut-line text-6xl text-gray-300 mb-4"}),e.jsx("p",{className:"text-gray-500",children:'Agrega piezas y haz clic en "Optimizar Cortes" para ver el resultado'})]});const _=a.resultados_por_material?.reduce((g,n)=>g+(n.laminas?.length||0),0)||a.total_laminas||0,b=(()=>{if(a.resultados_por_material&&a.resultados_por_material.length>0){let g=0;for(const n of a.resultados_por_material)if(n.laminas)for(const o of n.laminas){if(g===t)return o;g++}}return a.laminas&&a.laminas[t]?a.laminas[t]:null})();return e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("h3",{className:"text-lg font-bold text-gray-900 flex items-center gap-2",children:[e.jsx("i",{className:"ri-layout-grid-line text-blue-600"}),"Plano de Corte 2D"]}),_>1&&e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("span",{className:"text-sm text-gray-600",children:["LÃ¡mina ",t+1," de ",_]}),e.jsx("button",{onClick:()=>v(Math.max(0,t-1)),disabled:t===0,className:"p-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed",children:e.jsx("i",{className:"ri-arrow-left-line"})}),e.jsx("button",{onClick:()=>v(Math.min(_-1,t+1)),disabled:t>=_-1,className:"p-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed",children:e.jsx("i",{className:"ri-arrow-right-line"})})]})]}),e.jsx("div",{className:"bg-gray-50 rounded-lg border-2 border-gray-200 p-4",children:e.jsx("canvas",{ref:i,width:1200,height:800,className:"w-full h-auto"})}),e.jsxs("div",{className:"mt-4 grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-gray-900 bg-white"}),e.jsx("span",{className:"text-sm text-gray-700",children:"LÃ¡mina base"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 bg-blue-500"}),e.jsx("span",{className:"text-sm text-gray-700",children:"Piezas cortadas"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-0.5 border-t-2 border-dashed border-red-500"}),e.jsx("span",{className:"text-sm text-gray-700",children:"LÃ­neas de corte"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("i",{className:"ri-arrow-right-line text-gray-700"}),e.jsx("span",{className:"text-sm text-gray-700",children:"DirecciÃ³n veta"})]})]}),b&&b.piezas&&b.piezas.length>0&&e.jsxs("div",{className:"mt-6",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-900 mb-3",children:"Piezas en esta lÃ¡mina:"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:b.piezas.map((g,n)=>e.jsxs("div",{className:"flex items-center gap-3 p-2 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsx("div",{className:"w-8 h-8 rounded flex items-center justify-center text-white font-semibold text-sm flex-shrink-0",style:{backgroundColor:g.color},children:n+1}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 truncate",children:g.descripcion}),e.jsxs("div",{className:"text-xs text-gray-600",children:[g.largo," Ã— ",g.ancho," mm",g.rotada&&e.jsx("span",{className:"ml-2 text-orange-600",children:"(Rotada)"})]})]}),e.jsx("span",{className:`text-xs px-2 py-1 rounded-full font-semibold ${g.veta==="S"?"bg-green-100 text-green-800":g.veta==="X"?"bg-orange-100 text-orange-800":"bg-gray-100 text-gray-800"}`,children:g.veta})]},g.id))})]})]})}function na({resultado:a,onExportar:i}){return e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-900 flex items-center gap-2",children:[e.jsx("i",{className:"ri-bar-chart-box-line text-blue-600"}),"Resultados de OptimizaciÃ³n"]}),e.jsxs("button",{onClick:i,className:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2",children:[e.jsx("i",{className:"ri-file-excel-2-line"}),"Exportar Excel"]})]}),a.resultados_por_material&&a.resultados_por_material.length>0&&e.jsxs("div",{className:"mb-6",children:[e.jsxs("h4",{className:"text-sm font-semibold text-gray-900 mb-3 flex items-center gap-2",children:[e.jsx("i",{className:"ri-stack-line text-blue-600"}),"Resultados por Material"]}),e.jsx("div",{className:"space-y-4",children:a.resultados_por_material.map((t,v)=>e.jsxs("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4 border border-blue-200",children:[e.jsx("div",{className:"flex items-start justify-between mb-3",children:e.jsxs("div",{className:"flex-1",children:[e.jsx("h5",{className:"font-bold text-gray-900 text-base mb-1",children:t.material_codigo}),e.jsx("p",{className:"text-sm text-gray-700 mb-2",children:t.material_descripcion}),e.jsxs("div",{className:"flex flex-wrap gap-3 text-xs text-gray-600",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("i",{className:"ri-ruler-line text-blue-600"}),t.largo_lamina_mm," Ã— ",t.ancho_lamina_mm," mm"]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("i",{className:"ri-stack-line text-blue-600"}),"Espesor: ",t.espesor_mm," mm"]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("i",{className:"ri-price-tag-3-line text-green-600"}),le(t.precio_unitario_lamina)," / lÃ¡mina"]})]})]})}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3 mb-3",children:[e.jsxs("div",{className:"bg-white rounded-lg p-3 border border-blue-200",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"LÃ¡minas Usadas"}),e.jsx("div",{className:"text-xl font-bold text-blue-900",children:t.total_laminas})]}),e.jsxs("div",{className:"bg-white rounded-lg p-3 border border-green-200",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Aprovechamiento"}),e.jsxs("div",{className:"text-xl font-bold text-green-900",children:[t.porcentaje_aprovechamiento_promedio.toFixed(1),"%"]})]}),e.jsxs("div",{className:"bg-white rounded-lg p-3 border border-purple-200",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Piezas"}),e.jsx("div",{className:"text-xl font-bold text-purple-900",children:t.piezas_asignadas})]}),e.jsxs("div",{className:"bg-white rounded-lg p-3 border border-orange-200",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Costo Total"}),e.jsx("div",{className:"text-lg font-bold text-orange-900",children:le(t.costo_total_laminas)})]})]}),e.jsxs("div",{className:"bg-white rounded-lg p-3 border border-gray-200",children:[e.jsx("div",{className:"text-xs font-semibold text-gray-700 mb-2",children:"Detalle de LÃ¡minas:"}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-2",children:t.laminas.map(N=>e.jsxs("div",{className:"flex items-center justify-between p-2 bg-gray-50 rounded border border-gray-200 text-xs",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-6 h-6 bg-blue-100 rounded flex items-center justify-center",children:e.jsx("span",{className:"text-blue-900 font-bold text-xs",children:N.id})}),e.jsxs("span",{className:"text-gray-700",children:[N.piezas.length," pzs"]})]}),e.jsxs("span",{className:"font-semibold text-green-600",children:[N.porcentaje_aprovechamiento.toFixed(1),"%"]})]},N.id))})]})]},v))})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-blue-50 rounded-lg p-4 border border-blue-200",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("i",{className:"ri-stack-line text-blue-600"}),e.jsx("span",{className:"text-sm text-blue-900 font-medium",children:"Total LÃ¡minas"})]}),e.jsx("div",{className:"text-2xl font-bold text-blue-900",children:a.total_laminas})]}),e.jsxs("div",{className:"bg-green-50 rounded-lg p-4 border border-green-200",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("i",{className:"ri-percent-line text-green-600"}),e.jsx("span",{className:"text-sm text-green-900 font-medium",children:"Aprovechamiento"})]}),e.jsxs("div",{className:"text-2xl font-bold text-green-900",children:[a.porcentaje_aprovechamiento_global.toFixed(1),"%"]})]}),e.jsxs("div",{className:"bg-purple-50 rounded-lg p-4 border border-purple-200",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("i",{className:"ri-checkbox-circle-line text-purple-600"}),e.jsx("span",{className:"text-sm text-purple-900 font-medium",children:"Ãrea Utilizada"})]}),e.jsxs("div",{className:"text-2xl font-bold text-purple-900",children:[a.area_total_utilizada.toFixed(2)," mÂ²"]})]}),e.jsxs("div",{className:"bg-orange-50 rounded-lg p-4 border border-orange-200",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("i",{className:"ri-delete-bin-line text-orange-600"}),e.jsx("span",{className:"text-sm text-orange-900 font-medium",children:"Sobrante"})]}),e.jsxs("div",{className:"text-2xl font-bold text-orange-900",children:[a.area_total_sobrante.toFixed(2)," mÂ²"]})]})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 border border-gray-200",children:[e.jsxs("h4",{className:"text-sm font-semibold text-gray-900 mb-3 flex items-center gap-2",children:[e.jsx("i",{className:"ri-money-dollar-circle-line text-green-600"}),"Desglose de Costos"]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between py-2 border-b border-gray-200",children:[e.jsx("span",{className:"text-sm text-gray-700",children:"Materiales (LÃ¡minas)"}),e.jsx("span",{className:"text-sm font-semibold text-gray-900",children:le(a.costo_total_materiales)})]}),e.jsxs("div",{className:"flex items-center justify-between py-2 border-b border-gray-200",children:[e.jsx("span",{className:"text-sm text-gray-700",children:"Tapacantos"}),e.jsx("span",{className:"text-sm font-semibold text-gray-900",children:le(a.costo_total_tapacantos)})]}),e.jsxs("div",{className:"flex items-center justify-between py-2 border-b border-gray-200",children:[e.jsx("span",{className:"text-sm text-gray-700",children:"Horas MÃ¡quina (HH)"}),e.jsx("span",{className:"text-sm font-semibold text-gray-900",children:le(a.costo_total_hh)})]}),e.jsxs("div",{className:"flex items-center justify-between py-3 bg-blue-50 -mx-4 px-4 rounded-lg mt-2",children:[e.jsx("span",{className:"text-base font-bold text-blue-900",children:"TOTAL"}),e.jsx("span",{className:"text-xl font-bold text-blue-900",children:le(a.costo_total)})]})]})]}),e.jsxs("div",{className:"mt-6",children:[e.jsxs("h4",{className:"text-sm font-semibold text-gray-900 mb-3 flex items-center gap-2",children:[e.jsx("i",{className:"ri-list-check text-blue-600"}),"Todas las LÃ¡minas (",a.laminas.length,")"]}),e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:a.laminas.map(t=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center",children:e.jsx("span",{className:"text-blue-900 font-bold",children:t.id})}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-medium text-gray-900",children:["LÃ¡mina ",t.id," - ",t.material_codigo]}),e.jsxs("div",{className:"text-xs text-gray-600",children:[t.piezas.length," piezas â€¢ ",t.largo," Ã— ",t.ancho," mm â€¢ ",t.espesor," mm"]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-sm font-semibold text-green-600",children:[t.porcentaje_aprovechamiento.toFixed(1),"%"]}),e.jsxs("div",{className:"text-xs text-gray-600",children:[t.area_utilizada.toFixed(2)," mÂ² / ",t.area_total.toFixed(2)," mÂ²"]})]})]},t.id))})]}),a.piezas_sin_asignar.length>0&&e.jsx("div",{className:"mt-6 bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("i",{className:"ri-error-warning-line text-red-600 text-xl mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("h4",{className:"text-sm font-semibold text-red-900 mb-2",children:["Piezas sin asignar (",a.piezas_sin_asignar.length,")"]}),e.jsx("p",{className:"text-sm text-red-800 mb-3",children:"Las siguientes piezas no pudieron ser asignadas a ninguna lÃ¡mina. Considera ajustar las dimensiones o usar lÃ¡minas mÃ¡s grandes."}),e.jsx("div",{className:"space-y-1",children:a.piezas_sin_asignar.map(t=>e.jsxs("div",{className:"text-sm text-red-900",children:["â€¢ ",t.descripcion," (",t.largo," Ã— ",t.ancho," mm) - Material: ",t.material_codigo]},t.id))})]})]})}),e.jsxs("div",{className:"mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsxs("h4",{className:"text-sm font-semibold text-blue-900 mb-2 flex items-center gap-2",children:[e.jsx("i",{className:"ri-lightbulb-line"}),"Recomendaciones"]}),e.jsxs("ul",{className:"text-sm text-blue-800 space-y-1",children:[a.porcentaje_aprovechamiento_global<70&&e.jsx("li",{children:"â€¢ El aprovechamiento es bajo. Considera agrupar mÃ¡s piezas o ajustar dimensiones."}),a.porcentaje_aprovechamiento_global>=85&&e.jsx("li",{children:"â€¢ Â¡Excelente aprovechamiento! La optimizaciÃ³n es muy eficiente."}),a.area_total_sobrante>1&&e.jsxs("li",{children:["â€¢ Hay ",a.area_total_sobrante.toFixed(2)," mÂ² de sobrante que puede reutilizarse."]}),a.total_laminas>5&&e.jsxs("li",{children:["â€¢ Considera negociar descuento por volumen con tu proveedor (",a.total_laminas," lÃ¡minas)."]}),a.resultados_por_material&&a.resultados_por_material.length>1&&e.jsxs("li",{children:["â€¢ Se estÃ¡n usando ",a.resultados_por_material.length," tipos diferentes de lÃ¡minas en este proyecto."]})]})]})]})}function ca({resultado:a,piezas:i,laminaBase:t,onCerrar:v}){const[N,_]=P.useState(`Optimizacion_${new Date().toISOString().split("T")[0]}`),[p,b]=P.useState(!1),g=()=>{b(!0);try{const n=X.book_new(),o=[["OPTIMIZADOR DE CORTES 2D - RESUMEN GENERAL"],[""],["Fecha:",new Date().toLocaleDateString("es-CR")],["LÃ¡mina Base:",t?.descripcion_articulo||"N/A"],["Dimensiones LÃ¡mina:",`${t?.largo_lamina} Ã— ${t?.ancho_lamina} mm`],["Precio LÃ¡mina:",`â‚¡${t?.precio_unitario.toLocaleString("es-CR")}`],[""],["RESULTADOS DE OPTIMIZACIÃ“N"],["Total de LÃ¡minas:",a.total_laminas],["Aprovechamiento Global:",`${a.porcentaje_aprovechamiento_global.toFixed(2)}%`],["Ãrea Total Utilizada:",`${a.area_total_utilizada.toFixed(4)} mÂ²`],["Ãrea Total Sobrante:",`${a.area_total_sobrante.toFixed(4)} mÂ²`],[""],["COSTOS"],["Materiales (LÃ¡minas):",`â‚¡${a.costo_total_materiales.toLocaleString("es-CR")}`],["Tapacantos:",`â‚¡${a.costo_total_tapacantos.toLocaleString("es-CR")}`],["Horas MÃ¡quina (HH):",`â‚¡${a.costo_total_hh.toLocaleString("es-CR")}`],["TOTAL:",`â‚¡${a.costo_total.toLocaleString("es-CR")}`]],d=X.aoa_to_sheet(o);d["!cols"]=[{wch:25},{wch:30}],X.book_append_sheet(n,d,"Resumen");const S=[["DescripciÃ³n","Material (CÃ³digo)","Largo (mm)","Ancho (mm)","Cantidad","Veta","Largo Inf","Largo Sup","Ancho Inf","Ancho Sup","CNC1","CNC2","mÂ² Usados","Tapacantos (m)","HH (segundos)","Total Pieza"]];i.forEach(r=>{const x=r.largo*r.ancho/1e6*r.cantidad,A=r.tapacantos.find(F=>F.lado==="largo_inf"),l=r.tapacantos.find(F=>F.lado==="largo_sup"),D=r.tapacantos.find(F=>F.lado==="ancho_inf"),M=r.tapacantos.find(F=>F.lado==="ancho_sup");S.push([r.descripcion,r.material_codigo||"",r.largo,r.ancho,r.cantidad,r.veta,A?.codigo||"",l?.codigo||"",D?.codigo||"",M?.codigo||"",r.cnc1||"",r.cnc2||"",x.toFixed(4),r.metros_tapacanto_total?.toFixed(2)||"0",r.hh_segundos||0,r.costo_total?.toFixed(2)||"0"])});const y=i.reduce((r,f)=>r+f.largo*f.ancho*f.cantidad/1e6,0),T=i.reduce((r,f)=>r+(f.metros_tapacanto_total||0),0),C=i.reduce((r,f)=>r+(f.hh_segundos||0),0),j=i.reduce((r,f)=>r+(f.costo_total||0),0);S.push(["TOTALES","","","",i.reduce((r,f)=>r+f.cantidad,0),"","","","","","","",y.toFixed(4),T.toFixed(2),C,j.toFixed(2)]);const m=X.aoa_to_sheet(S);m["!cols"]=[{wch:30},{wch:15},{wch:12},{wch:12},{wch:10},{wch:8},{wch:12},{wch:12},{wch:12},{wch:12},{wch:20},{wch:20},{wch:12},{wch:15},{wch:12},{wch:15}],X.book_append_sheet(n,m,"Detalle Piezas");const s=[["DETALLE POR LÃMINA"],[""]];a.laminas.forEach(r=>{s.push([`LÃMINA ${r.id}`]),s.push(["Material:",r.material_descripcion,"Dimensiones:",`${r.largo} Ã— ${r.ancho} mm`,"Espesor:",`${r.espesor} mm`]),s.push(["Ãrea Total:",`${r.area_total.toFixed(4)} mÂ²`,"Ãrea Utilizada:",`${r.area_utilizada.toFixed(4)} mÂ²`,"Ãrea Sobrante:",`${r.area_sobrante.toFixed(4)} mÂ²`,"Aprovechamiento:",`${r.porcentaje_aprovechamiento.toFixed(2)}%`]),s.push([""]),s.push(["#","DescripciÃ³n","Largo","Ancho","Veta","Rotada","PosiciÃ³n X","PosiciÃ³n Y"]),r.piezas.forEach((f,x)=>{s.push([x+1,f.descripcion,f.largo,f.ancho,f.veta,f.rotada?"SÃ­":"No",f.posicion_x||0,f.posicion_y||0])}),s.push([""]),s.push([""])});const c=X.aoa_to_sheet(s);if(c["!cols"]=[{wch:8},{wch:30},{wch:12},{wch:12},{wch:8},{wch:10},{wch:12},{wch:12}],X.book_append_sheet(n,c,"Detalle LÃ¡minas"),a.piezas_sin_asignar.length>0){const r=[["PIEZAS SIN ASIGNAR"],[""],["Las siguientes piezas no pudieron ser asignadas a ninguna lÃ¡mina:"],[""],["DescripciÃ³n","Largo (mm)","Ancho (mm)","Cantidad","Veta"]];a.piezas_sin_asignar.forEach(x=>{r.push([x.descripcion,x.largo,x.ancho,x.cantidad,x.veta])});const f=X.aoa_to_sheet(r);f["!cols"]=[{wch:30},{wch:12},{wch:12},{wch:10},{wch:8}],X.book_append_sheet(n,f,"Sin Asignar")}je(n,`${N}.xlsx`),setTimeout(()=>{b(!1),v()},500)}catch(n){console.error("Error exportando Excel:",n),alert("Error al exportar el archivo Excel"),b(!1)}};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl max-w-2xl w-full",children:[e.jsxs("div",{className:"bg-gradient-to-r from-green-600 to-green-700 px-6 py-4 flex items-center justify-between rounded-t-lg",children:[e.jsxs("h2",{className:"text-xl font-bold text-white flex items-center gap-2",children:[e.jsx("i",{className:"ri-file-excel-2-line"}),"Exportar a Excel"]}),e.jsx("button",{onClick:v,className:"text-white hover:text-gray-200 p-1",children:e.jsx("i",{className:"ri-close-line text-2xl"})})]}),e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsxs("h3",{className:"text-sm font-semibold text-blue-900 mb-2 flex items-center gap-2",children:[e.jsx("i",{className:"ri-information-line"}),"Contenido del archivo"]}),e.jsxs("ul",{className:"text-sm text-blue-800 space-y-1",children:[e.jsxs("li",{children:["â€¢ ",e.jsx("strong",{children:"Resumen General:"})," MÃ©tricas y costos totales"]}),e.jsxs("li",{children:["â€¢ ",e.jsx("strong",{children:"Detalle de Piezas:"})," Todas las piezas con dimensiones, tapacantos y costos"]}),e.jsxs("li",{children:["â€¢ ",e.jsx("strong",{children:"Detalle por LÃ¡mina:"})," DistribuciÃ³n de piezas en cada lÃ¡mina"]}),a.piezas_sin_asignar.length>0&&e.jsxs("li",{children:["â€¢ ",e.jsx("strong",{children:"Piezas Sin Asignar:"})," Piezas que no cupieron en las lÃ¡minas"]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Nombre del archivo"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",value:N,onChange:n=>_(n.target.value),className:"flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent",placeholder:"Nombre del archivo..."}),e.jsx("span",{className:"px-4 py-2 bg-gray-100 text-gray-700 rounded-lg border border-gray-300",children:".xlsx"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 border border-gray-200",children:[e.jsx("div",{className:"text-sm text-gray-600 mb-1",children:"Total de Piezas"}),e.jsx("div",{className:"text-2xl font-bold text-gray-900",children:i.length})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 border border-gray-200",children:[e.jsx("div",{className:"text-sm text-gray-600 mb-1",children:"Total de LÃ¡minas"}),e.jsx("div",{className:"text-2xl font-bold text-gray-900",children:a.total_laminas})]})]}),e.jsxs("div",{className:"flex gap-3 pt-4 border-t border-gray-200",children:[e.jsx("button",{type:"button",onClick:v,disabled:p,className:"flex-1 px-6 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors disabled:opacity-50",children:"Cancelar"}),e.jsx("button",{type:"button",onClick:g,disabled:p,className:"flex-1 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center gap-2 disabled:opacity-50",children:p?e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"ri-loader-4-line animate-spin"}),"Exportando..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"ri-download-line"}),"Descargar Excel"]})})]})]})]})})}async function la(a){try{const{data:i}=await H.auth.getUser();if(!i.user)return{success:!1,error:"Usuario no autenticado"};const{data:t}=await H.from("usuario_tienda_actual").select("id_tienda").eq("id_usuario",i.user.id).single();if(!t)return{success:!1,error:"No se encontrÃ³ la tienda del usuario"};if(a.id_proyecto){const{error:v}=await H.from("optimizador_proyectos_temp").update({piezas:a.piezas,resultados_optimizacion:a.resultados_optimizacion,resumen:a.resumen,nombre_proyecto:a.nombre_proyecto}).eq("id_proyecto",a.id_proyecto);return v?(console.error("Error al actualizar proyecto:",v),{success:!1,error:v.message}):{success:!0,id_proyecto:a.id_proyecto}}else{const{data:v,error:N}=await H.from("optimizador_proyectos_temp").insert({id_usuario:i.user.id,id_tienda:t.id_tienda,piezas:a.piezas,resultados_optimizacion:a.resultados_optimizacion,resumen:a.resumen,nombre_proyecto:a.nombre_proyecto||"Proyecto sin nombre",estado:"activo"}).select("id_proyecto").single();return N?(console.error("Error al crear proyecto:",N),{success:!1,error:N.message}):{success:!0,id_proyecto:v.id_proyecto}}}catch(i){return console.error("Error en guardarProyectoOptimizador:",i),{success:!1,error:"Error al guardar el proyecto"}}}async function da(){try{const{data:a}=await H.auth.getUser();if(!a.user)return null;const{data:i,error:t}=await H.from("optimizador_proyectos_temp").select("*").eq("id_usuario",a.user.id).eq("estado","activo").order("fecha_creacion",{ascending:!1}).limit(1).single();return t||!i?null:i}catch(a){return console.error("Error al obtener proyecto activo:",a),null}}async function ma(a,i){try{const{error:t}=await H.from("optimizador_proyectos_temp").update({estado:"cotizado",id_cotizacion:i}).eq("id_proyecto",a);return t?(console.error("Error al marcar proyecto como cotizado:",t),{success:!1,error:t.message}):{success:!0}}catch(t){return console.error("Error en marcarProyectoCotizado:",t),{success:!1,error:"Error al actualizar el proyecto"}}}function ga({resultado:a,piezas:i,proyectoId:t,onCerrar:v}){const{currentStore:N}=me(),{showNotification:_}=fe(),p=Le(),[b,g]=P.useState(null),[n,o]=P.useState(!1),[d,S]=P.useState(!1),[y,T]=P.useState("CRC"),[C,j]=P.useState(520),[m,s]=P.useState(20),[c,r]=P.useState(15),[f,x]=P.useState(""),[A,l]=P.useState([]),D=u=>{if(!u||!u.id){_("error","Cliente seleccionado invÃ¡lido");return}console.log("âœ… Cliente seleccionado:",u),g(u),o(!1)},M=u=>{const R={id:Math.random().toString(36).substr(2,9),inventario_id:u.id,codigo:u.codigo_articulo,descripcion:u.descripcion_articulo,cantidad:1,precio_unitario:u.precio_unitario||0,subtotal:u.precio_unitario||0};l([...A,R]),_("success","Item agregado")},F=(u,R)=>{l(A.map(q=>q.id===u?{...q,cantidad:R,subtotal:R*q.precio_unitario}:q))},B=(u,R)=>{l(A.map(q=>q.id===u?{...q,precio_unitario:R,subtotal:q.cantidad*R}:q))},L=u=>{l(A.filter(R=>R.id!==u)),_("success","Item eliminado")},z=u=>typeof u!="number"||isNaN(u)||u<0?0:m>=100?(_("warning","El margen de utilidad no puede ser 100% o mayor"),u):u/(1-m/100),h=(u,R)=>`${R==="CRC"?"â‚¡":"$"}${u.toLocaleString("es-CR",{minimumFractionDigits:2,maximumFractionDigits:2})}`,O=async()=>{if(!(!b||!a))try{S(!0),console.log("ðŸ“‹ [OPT_QUOTE] Creando cotizaciÃ³n desde optimizador...",{cliente:b.nombre_razon_social,proyecto_id:t,total_piezas:i.length,items_adicionales:A.length,costo_total:a.costo_total,margen:m});const u=new Set;i.forEach($=>{$.cnc1_codigo&&u.add($.cnc1_codigo),$.cnc2_codigo&&u.add($.cnc2_codigo)});const R=new Map;if(u.size>0){console.log("ðŸ” [CNC] Buscando precios para cÃ³digos:",Array.from(u));const{data:$,error:ee}=await H.from("inventario").select("codigo_articulo, precio_articulo").in("codigo_articulo",Array.from(u)).eq("tienda_id",N?.id);ee?console.error("âŒ [CNC] Error obteniendo precios:",ee):$&&$.forEach(ce=>{R.set(ce.codigo_articulo,ce.precio_articulo||0),console.log(`ðŸ’° [CNC] ${ce.codigo_articulo}: â‚¡${ce.precio_articulo}`)})}console.log("ðŸ’° [CNC] Precios de CNC obtenidos:",Array.from(R.entries()));const q=a.costo_total_materiales||a.costo_total||0,re=a.costo_total_tapacantos||0,W=a.costo_total_hh||0,J=i.reduce(($,ee)=>$+ee.ancho*ee.largo,0);console.log("ðŸ’° [COSTOS] Costos del resultado:",{materiales:q,tapacantos:re,cnc:W,total:a.costo_total});const Y=i.map(($,ee)=>{const ce=$.ancho*$.largo,pe=$.costo_material||(J>0?ce/J*q:0),ue=$.costo_tapacantos||0,ye=U=>{if(!U)return{codigo:"",cantidad:0};const ne=String(U).trim();if(!ne||ne==="-"||ne==="Sin CNC"||ne==="0")return{codigo:"",cantidad:0};if(ne.includes(" x ")){const ve=ne.split(" x "),Re=ve[0].trim(),De=parseInt(ve[1])||0;return{codigo:Re,cantidad:De}}return{codigo:ne,cantidad:1}},Q=ye($.cnc1_codigo||$.cnc1),K=ye($.cnc2_codigo||$.cnc2);console.log(`ðŸ”§ [PARSE CNC] Pieza "${$.descripcion}":`,{cnc1_original:$.cnc1_codigo||$.cnc1,cnc1_parseado:Q,cnc2_original:$.cnc2_codigo||$.cnc2,cnc2_parseado:K});let de=0;if(Q.codigo&&Q.codigo!=="0"&&Q.codigo!=="Sin CNC"){const U=R.get(Q.codigo)||0;de+=U*Q.cantidad,console.log(`ðŸ’° [CNC1] ${Q.codigo}: ${U} x ${Q.cantidad} = ${U*Q.cantidad}`)}if(K.codigo&&K.codigo!=="0"&&K.codigo!=="Sin CNC"){const U=R.get(K.codigo)||0;de+=U*K.cantidad,console.log(`ðŸ’° [CNC2] ${K.codigo}: ${U} x ${K.cantidad} = ${U*K.cantidad}`)}const he=pe+ue+de,_e=he*(1+m/100);console.log(`ðŸ’° [PIEZA ${ee+1}] "${$.descripcion}":`,{costo_material:pe.toFixed(2),costo_tapacantos:ue.toFixed(2),costo_cnc:de.toFixed(2),costo_total:he.toFixed(2),precio_con_margen:_e.toFixed(2),cnc1_codigo:Q.codigo,cnc1_cantidad:Q.cantidad,cnc2_codigo:K.codigo,cnc2_cantidad:K.cantidad});const Oe=$.tapacantos.find(U=>U.lado==="superior"||U.lado==="largo_sup"),$e=$.tapacantos.find(U=>U.lado==="inferior"||U.lado==="largo_inf"),Ee=$.tapacantos.find(U=>U.lado==="izquierdo"||U.lado==="ancho_inf"),Pe=$.tapacantos.find(U=>U.lado==="derecho"||U.lado==="ancho_sup");return{descripcion:$.descripcion||`Pieza ${ee+1}`,largo:$.largo,ancho:$.ancho,cantidad:$.cantidad||1,material_codigo:$.material_codigo||"",material_nombre:$.material_nombre||"",veta:$.veta||"horizontal",tapacanto_superior:Oe?.codigo||"",tapacanto_inferior:$e?.codigo||"",tapacanto_izquierdo:Ee?.codigo||"",tapacanto_derecho:Pe?.codigo||"",cnc1_codigo:Q.codigo,cnc1_cantidad:Q.cantidad,cnc2_codigo:K.codigo,cnc2_cantidad:K.cantidad,costo_material:pe,costo_tapacantos:ue,costo_cnc:de,costo_total:he,precio_unitario:_e,subtotal:_e*($.cantidad||1)}});console.log("ðŸ’¾ [GUARDAR] Piezas con CNC:",Y.map($=>({descripcion:$.descripcion,cnc1_codigo:$.cnc1_codigo,cnc1_cantidad:$.cnc1_cantidad,cnc2_codigo:$.cnc2_codigo,cnc2_cantidad:$.cnc2_cantidad})));const se=A.map($=>({inventario_id:$.inventario_id,codigo:$.codigo,descripcion:$.descripcion,cantidad:$.cantidad,precio_unitario:$.precio_unitario,subtotal:$.subtotal})),ae=Y.reduce(($,ee)=>$+ee.subtotal,0),ge=se.reduce(($,ee)=>$+ee.subtotal,0),G=ae+ge,oe=G*.13,te=G+oe;console.log("ðŸ’° [OPT_QUOTE] Totales calculados:",{subtotal_optimizador:ae.toFixed(2),subtotal_inventario:ge.toFixed(2),subtotal_total:G.toFixed(2),impuestos:oe.toFixed(2),total:te.toFixed(2),items_optimizador:Y.length,items_inventario:se.length});const Te=`MÃ‰TRICAS DEL OPTIMIZADOR 2D:

ðŸ“¦ Total de Piezas: ${i.length}
ðŸ“‹ LÃ¡minas Utilizadas: ${a.total_laminas||0}
ðŸ“Š Aprovechamiento Global: ${a.porcentaje_aprovechamiento_global?.toFixed(2)||0}%
ðŸªµ Materiales Diferentes: ${a.resultados_por_material?.length||1}
ðŸ’° Costo Total Materiales: ${h(q,y)}
ðŸ’° Costo Total Tapacantos: ${h(re,y)}
ðŸ’° Costo Total CNC: ${h(W,y)}
ðŸ“ˆ Margen Aplicado: ${m}%
${A.length>0?`
ðŸ”§ Items Adicionales: ${A.length}`:""}
ðŸ’µ Precio Total: ${h(te,y)}

${f||""}`,Ne={cliente_id:b.id,fecha_emision:new Date().toISOString().split("T")[0],fecha_vencimiento:new Date(Date.now()+c*24*60*60*1e3).toISOString().split("T")[0],moneda:y,tipo_cambio:C,subtotal:G,descuento:0,impuestos:oe,total:te,estado:"borrador",notas:Te,items_optimizador:Y,items_inventario:se,metadata:{tipo:"optimizador",proyecto_id:t,margen_utilidad:m,costo_total_materiales:q,costo_total_tapacantos:re,costo_total_cnc:W,items_adicionales_count:A.length,metricas:{total_piezas:i.length,laminas_usadas:a.total_laminas,aprovechamiento:a.porcentaje_aprovechamiento_global,materiales_unicos:a.resultados_por_material?.length||1}}};console.log("ðŸ’¾ [OPT_QUOTE] Datos preparados para enviar (TABLAS SEPARADAS):",{tiene_metadata:!0,tipo_metadata:Ne.metadata.tipo,items_optimizador:Y.length,items_inventario:se.length,estructura:{tabla_1:"items_optimizador (piezas cortadas)",tabla_2:"items_inventario (artÃ­culos adicionales)"}});const xe=await Ze.crearCotizacion(Ne);console.log("âœ… [OPT_QUOTE] CotizaciÃ³n creada:",xe),t&&(await ma(t,xe.id.toString()),console.log("âœ… Proyecto marcado como cotizado")),_("success","CotizaciÃ³n creada exitosamente"),p(`/cotizaciones/optimizador/${xe.id}`),v()}catch(u){console.error("âŒ [OPT_QUOTE] Error al crear cotizaciÃ³n:",u),_("error",u.message||"Error al crear la cotizaciÃ³n")}finally{S(!1)}},E=a?.costo_total||0,k=z(E),I=A.reduce((u,R)=>u+R.subtotal,0),Z=k+I,w=Z*.13,V=Z+w;return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-5xl max-h-[90vh] flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Crear CotizaciÃ³n desde Optimizador"}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"Genera una cotizaciÃ³n con todas las piezas optimizadas + items adicionales"})]}),e.jsx("button",{onClick:v,className:"text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx("i",{className:"ri-close-line text-2xl"})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-6 space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Cliente *"}),b?e.jsxs("div",{className:"flex items-center justify-between p-4 bg-teal-50 border border-teal-200 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:b.nombre_razon_social||b.razon_social||b.nombre||"Sin nombre"}),e.jsx("p",{className:"text-sm text-gray-600",children:b.identificacion||b.cedula||"Sin identificaciÃ³n"}),b.telefono&&e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["ðŸ“ž ",b.telefono]})]}),e.jsx("button",{onClick:()=>g(null),className:"text-teal-600 hover:text-teal-700 text-sm font-medium whitespace-nowrap",children:"Cambiar"})]}):e.jsxs("button",{onClick:()=>o(!0),className:"w-full px-4 py-3 border-2 border-dashed border-gray-300 rounded-lg hover:border-teal-500 hover:bg-teal-50 transition-colors text-gray-600 hover:text-teal-600 flex items-center justify-center gap-2 whitespace-nowrap",children:[e.jsx("i",{className:"ri-search-line"}),"Buscar Cliente"]})]}),e.jsxs("div",{className:"bg-gradient-to-br from-purple-50 to-indigo-50 rounded-lg p-4 border border-purple-200",children:[e.jsxs("h3",{className:"text-sm font-semibold text-purple-900 mb-3 flex items-center gap-2",children:[e.jsx("i",{className:"ri-add-box-line"}),"Items Adicionales del Inventario"]}),e.jsx(ie,{onSeleccionar:M,placeholder:"Buscar artÃ­culo del inventario...",tiendaActual:N}),A.length>0&&e.jsx("div",{className:"mt-4 bg-white rounded-lg border border-purple-200 overflow-hidden",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-purple-100",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold text-purple-900",children:"CÃ³digo"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold text-purple-900",children:"DescripciÃ³n"}),e.jsx("th",{className:"px-3 py-2 text-center text-xs font-semibold text-purple-900 w-24",children:"Cantidad"}),e.jsx("th",{className:"px-3 py-2 text-right text-xs font-semibold text-purple-900 w-32",children:"Precio Unit."}),e.jsx("th",{className:"px-3 py-2 text-right text-xs font-semibold text-purple-900 w-32",children:"Subtotal"}),e.jsx("th",{className:"px-3 py-2 text-center text-xs font-semibold text-purple-900 w-16",children:"AcciÃ³n"})]})}),e.jsx("tbody",{className:"divide-y divide-purple-100",children:A.map(u=>e.jsxs("tr",{className:"hover:bg-purple-50",children:[e.jsx("td",{className:"px-3 py-2 text-gray-900 font-medium",children:u.codigo}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:u.descripcion}),e.jsx("td",{className:"px-3 py-2",children:e.jsx("input",{type:"number",min:"1",value:u.cantidad,onChange:R=>F(u.id,parseInt(R.target.value)||1),className:"w-full px-2 py-1 border border-gray-300 rounded text-center focus:ring-2 focus:ring-purple-500 focus:border-transparent"})}),e.jsx("td",{className:"px-3 py-2",children:e.jsx("input",{type:"number",step:"0.01",min:"0",value:u.precio_unitario,onChange:R=>B(u.id,parseFloat(R.target.value)||0),className:"w-full px-2 py-1 border border-gray-300 rounded text-right focus:ring-2 focus:ring-purple-500 focus:border-transparent"})}),e.jsx("td",{className:"px-3 py-2 text-right font-medium text-gray-900",children:h(u.subtotal,y)}),e.jsx("td",{className:"px-3 py-2 text-center",children:e.jsx("button",{onClick:()=>L(u.id),className:"text-red-600 hover:text-red-700 transition-colors",title:"Eliminar",children:e.jsx("i",{className:"ri-delete-bin-line"})})})]},u.id))})]})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Moneda"}),e.jsxs("select",{value:y,onChange:u=>T(u.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent",children:[e.jsx("option",{value:"CRC",children:"â‚¡ Colones (CRC)"}),e.jsx("option",{value:"USD",children:"$ DÃ³lares (USD)"})]})]}),y==="USD"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Tipo de Cambio"}),e.jsx("input",{type:"number",step:"0.01",value:C,onChange:u=>j(parseFloat(u.target.value)||0),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Margen de Utilidad (%) - Solo para piezas del optimizador"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("input",{type:"range",min:"0",max:"99",step:"1",value:m,onChange:u=>s(parseFloat(u.target.value)||0),className:"flex-1"}),e.jsx("input",{type:"number",step:"0.1",min:"0",max:"99",value:m,onChange:u=>s(parseFloat(u.target.value)||0),className:"w-24 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent text-center"}),e.jsx("span",{className:"text-gray-600 font-medium whitespace-nowrap",children:"%"})]}),e.jsx("p",{className:"text-xs text-gray-600 mt-2",children:"Este margen se aplicarÃ¡ sobre el costo total calculado por el optimizador. Los items adicionales usan el precio configurado."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"DÃ­as de Vencimiento"}),e.jsx("input",{type:"number",min:"1",value:c,onChange:u=>r(parseInt(u.target.value)||15),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 border border-gray-200",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-900 mb-3",children:"ðŸ“Š Resumen de Costos"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between text-blue-600",children:[e.jsxs("span",{children:["Piezas del Optimizador (",i.length,"):"]}),e.jsx("span",{className:"font-medium",children:h(k,y)})]}),A.length>0&&e.jsxs("div",{className:"flex justify-between text-purple-600",children:[e.jsxs("span",{children:["Items Adicionales (",A.length,"):"]}),e.jsx("span",{className:"font-medium",children:h(I,y)})]}),e.jsx("div",{className:"border-t border-gray-300 pt-2"}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Subtotal:"}),e.jsx("span",{className:"font-medium text-gray-900",children:h(Z,y)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"IVA (13%):"}),e.jsx("span",{className:"font-medium text-gray-900",children:h(w,y)})]}),e.jsx("div",{className:"border-t border-gray-300 pt-2"}),e.jsxs("div",{className:"flex justify-between text-lg",children:[e.jsx("span",{className:"font-semibold text-gray-900",children:"Total:"}),e.jsx("span",{className:"font-bold text-teal-600",children:h(V,y)})]})]})]}),e.jsxs("div",{className:"bg-blue-50 rounded-lg p-4 border border-blue-200",children:[e.jsx("h3",{className:"text-sm font-semibold text-blue-900 mb-2",children:"ðŸ“¦ InformaciÃ³n del Proyecto"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-blue-700",children:"Total de Piezas:"}),e.jsx("span",{className:"ml-2 font-medium text-blue-900",children:i?.length||0})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-blue-700",children:"LÃ¡minas Utilizadas:"}),e.jsx("span",{className:"ml-2 font-medium text-blue-900",children:a?.total_laminas||0})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-blue-700",children:"Aprovechamiento:"}),e.jsxs("span",{className:"ml-2 font-medium text-blue-900",children:[(a?.porcentaje_aprovechamiento_global||0).toFixed(1),"%"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-blue-700",children:"Items Adicionales:"}),e.jsx("span",{className:"ml-2 font-medium text-blue-900",children:A.length})]})]})]})]}),e.jsx("div",{className:"p-6 border-t border-gray-200 bg-gray-50",children:e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx("button",{onClick:v,disabled:d,className:"px-6 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed whitespace-nowrap",children:"Cancelar"}),e.jsx("button",{onClick:O,disabled:!b||d,className:"px-6 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center gap-2 whitespace-nowrap",children:d?e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"ri-loader-4-line animate-spin"}),"Creando..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"ri-file-text-line"}),"Crear CotizaciÃ³n"]})})]})})]})}),n&&e.jsx(Be,{onSelect:D,onCancel:()=>o(!1)})]})}function Na(){const{currentStore:a,user:i}=me(),{showNotification:t}=fe(),[v,N]=P.useState("manual"),[_,p]=P.useState([]),[b,g]=P.useState({espesor_sierra:3,margen_seguridad:5,permitir_rotacion:!0,optimizar_desperdicio:!0}),[n,o]=P.useState(null),[d,S]=P.useState(!1),[y,T]=P.useState(!1),[C,j]=P.useState(!1),[m,s]=P.useState(!1),[c,r]=P.useState(null),[f,x]=P.useState(null);P.useEffect(()=>{A()},[]);const A=async()=>{try{const I=await da();if(I&&(console.log("ðŸ“‚ Proyecto activo cargado:",I),x(I.id_proyecto||null),I.piezas&&I.piezas.length>0)){const Z=I.piezas.map(w=>({id:Math.random().toString(36).substr(2,9),descripcion:w.descripcion,largo:w.largo,ancho:w.ancho,cantidad:w.cantidad,veta:w.veta,material_codigo:w.codigo_material,material_nombre:w.nombre_material,tapacantos:[{lado:"largo_sup",codigo:w.tapacanto_superior},{lado:"largo_inf",codigo:w.tapacanto_inferior},{lado:"ancho_inf",codigo:w.tapacanto_izquierdo},{lado:"ancho_sup",codigo:w.tapacanto_derecho}],cnc1:w.cnc1,cnc1_codigo:w.cnc1_codigo||"",cnc1_cantidad:w.cnc1_cantidad||0,cnc2:w.cnc2,cnc2_codigo:w.cnc2_codigo||"",cnc2_cantidad:w.cnc2_cantidad||0}));p(Z),console.log("âœ… Piezas cargadas con CNC:",Z.map(w=>({descripcion:w.descripcion,cnc1:w.cnc1_codigo?`${w.cnc1_codigo} x ${w.cnc1_cantidad}`:"-",cnc2:w.cnc2_codigo?`${w.cnc2_codigo} x ${w.cnc2_cantidad}`:"-"})))}}catch(I){console.error("Error cargando proyecto activo:",I)}};P.useEffect(()=>{(_.length>0||n)&&l()},[_,n]);const l=async()=>{try{const I=_.map(u=>({descripcion:u.descripcion||"",largo:u.largo,ancho:u.ancho,cantidad:u.cantidad,veta:u.veta,tapacanto_superior:u.tapacantos.find(R=>R.lado==="largo_sup")?.codigo||"",tapacanto_inferior:u.tapacantos.find(R=>R.lado==="largo_inf")?.codigo||"",tapacanto_izquierdo:u.tapacantos.find(R=>R.lado==="ancho_inf")?.codigo||"",tapacanto_derecho:u.tapacantos.find(R=>R.lado==="ancho_sup")?.codigo||"",cnc1:u.cnc1||"",cnc1_codigo:u.cnc1_codigo||"",cnc1_cantidad:u.cnc1_cantidad||0,cnc2:u.cnc2||"",cnc2_codigo:u.cnc2_codigo||"",cnc2_cantidad:u.cnc2_cantidad||0,codigo_material:u.material_codigo||"",nombre_material:u.material_nombre||"",precio_unitario:0,subtotal:0}));console.log("ðŸ’¾ [GUARDAR] Piezas con CNC:",I.map(u=>({descripcion:u.descripcion,cnc1:u.cnc1_codigo?`${u.cnc1_codigo} x ${u.cnc1_cantidad}`:"-",cnc2:u.cnc2_codigo?`${u.cnc2_codigo} x ${u.cnc2_cantidad}`:"-"})));const Z={};n?.resultados_por_material&&n.resultados_por_material.forEach(u=>{Z[u.codigo_material]={codigo_material:u.codigo_material,nombre_material:u.nombre_material,dimensiones:u.dimensiones,precio_lamina:u.precio_lamina,laminas_usadas:u.laminas_usadas,aprovechamiento_promedio:u.aprovechamiento_promedio,total_piezas:u.total_piezas,costo_total:u.costo_total,area_utilizada:u.area_utilizada,area_sobrante:u.area_sobrante,detalle_laminas:u.detalle_laminas}});const w={total_laminas:n?.total_laminas||0,aprovechamiento_promedio:n?.porcentaje_aprovechamiento_global||0,total_piezas:_.length,costo_total:n?.costo_total||0,costo_materiales:n?.costo_materiales||0,costo_tapacantos:n?.costo_tapacantos||0,costo_horas_maquina:n?.costo_horas_maquina||0,area_utilizada:n?.area_utilizada||0,area_sobrante:n?.area_sobrante||0},V=await la({id_proyecto:f||void 0,piezas:I,resultados_optimizacion:Z,resumen:w,nombre_proyecto:`Proyecto ${new Date().toLocaleDateString()}`});V.success&&V.id_proyecto&&(x(V.id_proyecto),console.log("âœ… Proyecto guardado automÃ¡ticamente:",V.id_proyecto))}catch(I){console.error("Error guardando proyecto automÃ¡ticamente:",I)}},D=I=>{N(I),p([]),o(null),r(null)},M=async(I,Z)=>{S(!0);try{const{data:w,error:V}=await Xe(I,a);if(V)throw V;w&&w.length>0?(p(w),r({id:I,nombre:Z}),t("success",`Se cargaron ${w.length} piezas desde el BOM`)):t("warning","El producto no tiene piezas vÃ¡lidas en el BOM")}catch(w){console.error("Error cargando BOM:",w),t("error","Error al cargar las piezas del BOM")}finally{S(!1)}},F=()=>{j(!0)},B=I=>{p([..._,I]),o(null)},L=(I,Z)=>{const w=[..._];w[I]=Z,p(w),o(null)},z=I=>{const Z=_.filter((w,V)=>V!==I);p(Z),o(null)},h=async()=>{console.log("ðŸŽ¯ [OPTIMIZAR] BotÃ³n presionado",{total_piezas:_.length,piezas:_.map(w=>({descripcion:w.descripcion,material:w.material_codigo,dimensiones:`${w.largo}x${w.ancho}`,tiene_dimensiones_lamina:!!(w.material_largo_lamina_mm&&w.material_ancho_lamina_mm)}))});const I=_.filter(w=>!w.material_codigo);if(I.length>0){console.error("âŒ [OPTIMIZAR] Piezas sin material:",I),t("error",`Hay ${I.length} pieza(s) sin material asignado`);return}const Z=_.filter(w=>w.material_codigo&&(!w.material_largo_lamina_mm||!w.material_ancho_lamina_mm));if(Z.length>0){console.error("âŒ [OPTIMIZAR] Piezas sin dimensiones de lÃ¡mina:",Z),t("error",`Hay ${Z.length} pieza(s) cuyo material no tiene dimensiones de lÃ¡mina configuradas en inventario`);return}if(_.length===0){console.warn("âš ï¸ [OPTIMIZAR] No hay piezas para optimizar"),t("error","Debes agregar al menos una pieza");return}console.log("âœ… [OPTIMIZAR] Validaciones pasadas, iniciando optimizaciÃ³n..."),S(!0);try{console.log("ðŸš€ [OPTIMIZAR] Llamando a optimizarCortes...");const w=await Ye(_,b,a);console.log("ðŸ“Š [OPTIMIZAR] Resultado obtenido:",{total_laminas:w.total_laminas,laminas:w.laminas.length,aprovechamiento:w.porcentaje_aprovechamiento_global,materiales:w.resultados_por_material?.length||0,piezas_sin_asignar:w.piezas_sin_asignar.length}),o(w),w.piezas_sin_asignar.length>0?t("warning",`OptimizaciÃ³n completada. ${w.piezas_sin_asignar.length} piezas no pudieron ser asignadas`):t("success",`OptimizaciÃ³n completada. Se utilizaron ${w.total_laminas} lÃ¡minas con ${w.porcentaje_aprovechamiento_global.toFixed(1)}% de aprovechamiento`)}catch(w){console.error("âŒ [OPTIMIZAR] Error en optimizaciÃ³n:",w),t("error","Error al optimizar los cortes: "+w.message)}finally{S(!1),console.log("ðŸ [OPTIMIZAR] Proceso finalizado")}},O=()=>{p([]),o(null),r(null),x(null)},E=()=>{if(_.length===0){t("warning","No hay piezas para exportar");return}try{const I=_.map(R=>{const q=R.tapacantos.find(Y=>Y.lado==="largo_inf"),re=R.tapacantos.find(Y=>Y.lado==="largo_sup"),W=R.tapacantos.find(Y=>Y.lado==="ancho_inf"),J=R.tapacantos.find(Y=>Y.lado==="ancho_sup");return{DescripciÃ³n:R.descripcion||"",Material:R.material_codigo||"",Largo:R.largo,Ancho:R.ancho,Cantidad:R.cantidad,Veta:R.veta,"Largo inferior":q?.codigo||"","Largo superior":re?.codigo||"","Ancho inferior":W?.codigo||"","Ancho superior":J?.codigo||"",CNC1:R.cnc1||"",CNC2:R.cnc2||""}}),Z=X.json_to_sheet(I),w=X.book_new();Z["!cols"]=[{wch:30},{wch:15},{wch:10},{wch:10},{wch:10},{wch:8},{wch:15},{wch:15},{wch:15},{wch:15},{wch:20},{wch:20}],X.book_append_sheet(w,Z,"Piezas");const u=`Proyecto_Optimizador_${new Date().toISOString().split("T")[0]}.xlsx`;je(w,u),t("success",`Proyecto exportado: ${u}`)}catch(I){console.error("Error exportando proyecto:",I),t("error","Error al exportar el proyecto")}},k=I=>{p(I),o(null),t("success",`Se cargaron ${I.length} piezas desde el archivo`)};return e.jsx(qe,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Optimizador de Cortes"}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"Optimiza el corte de lÃ¡minas para minimizar desperdicios"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[n&&e.jsxs("button",{onClick:()=>s(!0),className:"px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition-colors flex items-center gap-2 whitespace-nowrap",children:[e.jsx("i",{className:"ri-file-text-line"}),"Crear CotizaciÃ³n"]}),e.jsxs("button",{onClick:E,disabled:_.length===0,className:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2 whitespace-nowrap disabled:bg-gray-300 disabled:cursor-not-allowed",children:[e.jsx("i",{className:"ri-file-excel-2-line"}),"Guardar Proyecto"]}),e.jsx(Se,{onImportar:k})]})]}),e.jsx(Ue,{modo:v,onCambiarModo:D,productoBOM:c}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border p-4",children:[e.jsxs("button",{onClick:()=>T(!y),className:"w-full flex items-center justify-between text-left",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-900 flex items-center gap-2",children:[e.jsx("i",{className:"ri-settings-3-line text-blue-600"}),"ConfiguraciÃ³n de Corte"]}),e.jsx("i",{className:`ri-arrow-${y?"up":"down"}-s-line text-gray-600`})]}),y&&e.jsxs("div",{className:"mt-4 grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Espesor de Sierra (Kerf) - mm"}),e.jsx("input",{type:"number",step:"0.1",min:"0",value:b.espesor_sierra,onChange:I=>g({...b,espesor_sierra:parseFloat(I.target.value)||0}),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),e.jsx("p",{className:"text-xs text-gray-600 mt-1",children:"Espacio que ocupa la sierra al cortar. TÃ­picamente 3-4 mm."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Margen de Seguridad - mm"}),e.jsx("input",{type:"number",step:"1",min:"0",value:b.margen_seguridad,onChange:I=>g({...b,margen_seguridad:parseFloat(I.target.value)||0}),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),e.jsx("p",{className:"text-xs text-gray-600 mt-1",children:"Espacio adicional entre piezas para evitar errores de corte."})]}),e.jsxs("div",{className:"flex items-start gap-3 p-4 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsx("input",{type:"checkbox",id:"permitir_rotacion",checked:b.permitir_rotacion,onChange:I=>g({...b,permitir_rotacion:I.target.checked}),className:"mt-1 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{htmlFor:"permitir_rotacion",className:"block text-sm font-medium text-gray-900 cursor-pointer",children:"Permitir RotaciÃ³n de Piezas"}),e.jsx("p",{className:"text-xs text-gray-600 mt-1",children:"Permite rotar piezas 90Â° para mejor aprovechamiento."})]})]}),e.jsxs("div",{className:"flex items-start gap-3 p-4 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsx("input",{type:"checkbox",id:"optimizar_desperdicio",checked:b.optimizar_desperdicio,onChange:I=>g({...b,optimizar_desperdicio:I.target.checked}),className:"mt-1 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{htmlFor:"optimizar_desperdicio",className:"block text-sm font-medium text-gray-900 cursor-pointer",children:"Optimizar Desperdicio"}),e.jsx("p",{className:"text-xs text-gray-600 mt-1",children:"Intenta minimizar el desperdicio agrupando piezas de forma mÃ¡s eficiente."})]})]})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"w-full",children:e.jsx(ra,{modo:v,piezas:_,laminaBase:null,onCargarBOM:M,onAgregarPieza:B,onEditarPieza:L,onEliminarPieza:z,onSeleccionarLamina:()=>{},onLimpiar:O})}),e.jsx("div",{className:"flex justify-center",children:e.jsx("button",{onClick:h,disabled:_.length===0||d,className:"px-8 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center gap-2 text-lg font-semibold whitespace-nowrap",children:d?e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"ri-loader-4-line animate-spin"}),"Optimizando..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"ri-scissors-cut-line"}),"Optimizar Cortes"]})})}),n&&e.jsx("div",{className:"w-full",children:e.jsx(ia,{resultado:n,configuracion:b})}),n&&e.jsx("div",{className:"w-full",children:e.jsx(na,{resultado:n,onExportar:F})})]}),C&&n&&e.jsx(ca,{resultado:n,piezas:_,laminaBase:null,onCerrar:()=>j(!1)}),m&&n&&e.jsx(ga,{resultado:n,piezas:_,proyectoId:f,onCerrar:()=>s(!1)})]})})}export{Na as default};
//# sourceMappingURL=page-B6HO1GGK.js.map
