import{r as w,j as e,s as E,u as F}from"./index-Xz42BvxI.js";import{S as H,T as O}from"./TopBar-BLe2nnBZ.js";import{f as C}from"./currency-BmxXlzML.js";import{u as k,w as P}from"./xlsx-BojT3SgY.js";function q({filtros:d,onFiltroChange:r}){const[a,n]=w.useState(d.busqueda||""),[x,c]=w.useState(d.fecha_inicio_desde||""),[s,t]=w.useState(d.fecha_cierre_hasta||""),[m,o]=w.useState(d.estado||""),[i,g]=w.useState(d.cliente||""),N=()=>{r({busqueda:a,fecha_inicio_desde:x,fecha_cierre_hasta:s,estado:m,cliente:i})},h=()=>{n(""),c(""),t(""),o(""),g(""),r({busqueda:"",fecha_inicio_desde:"",fecha_cierre_hasta:"",estado:"",cliente:""})};return e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4",children:[e.jsxs("div",{className:"lg:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Buscar en todas las tablas..."}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",value:a,onChange:f=>n(f.target.value),onKeyDown:f=>f.key==="Enter"&&N(),placeholder:"Caso, cliente, solicitante...",className:"w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white/80 backdrop-blur-sm"}),e.jsx("i",{className:"ri-search-line absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Inicio desde"}),e.jsx("input",{type:"date",value:x,onChange:f=>c(f.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white/80 backdrop-blur-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Cierre hasta"}),e.jsx("input",{type:"date",value:s,onChange:f=>t(f.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white/80 backdrop-blur-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Estado"}),e.jsxs("select",{value:m,onChange:f=>o(f.target.value),className:"w-full px-3 py-2 pr-8 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white/80 backdrop-blur-sm",children:[e.jsx("option",{value:"",children:"Todos los estados"}),e.jsx("option",{value:"En Cola",children:"En Cola"}),e.jsx("option",{value:"En Proceso",children:"En Proceso"}),e.jsx("option",{value:"Produciendo",children:"Produciendo"}),e.jsx("option",{value:"Esperando suministros",children:"Esperando suministros"}),e.jsx("option",{value:"Terminado",children:"Terminado"}),e.jsx("option",{value:"Finalizado",children:"Finalizado"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3 mt-4",children:[e.jsxs("button",{onClick:N,className:"px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors cursor-pointer whitespace-nowrap",children:[e.jsx("i",{className:"ri-filter-line mr-2"}),"Aplicar Filtros"]}),e.jsxs("button",{onClick:h,className:"px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors cursor-pointer whitespace-nowrap",children:[e.jsx("i",{className:"ri-close-line mr-2"}),"Limpiar"]})]})]})}function $({totalesPorCliente:d,totalGeneral:r}){const[a,n]=w.useState(!1),x=a?d:d.slice(0,5);return e.jsxs("div",{className:"bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg shadow-sm border border-blue-200 p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900",children:"Totales por cliente"}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"Resumen de producción por cliente"})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Total General"}),e.jsx("p",{className:"text-3xl font-bold text-blue-600",children:C(r)})]})]}),d.length===0?e.jsxs("div",{className:"text-center text-gray-500 py-8",children:[e.jsx("i",{className:"ri-inbox-line text-4xl text-gray-300 mb-2"}),e.jsx("p",{children:"No hay datos de clientes disponibles"})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"bg-white rounded-lg shadow-sm overflow-hidden",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider",children:"Cliente"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider",children:"Total ₡"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:x.map((c,s)=>e.jsxs("tr",{className:"hover:bg-gray-50 transition-colors",children:[e.jsx("td",{className:"px-6 py-4 text-sm font-medium text-gray-900",children:c.cliente}),e.jsx("td",{className:"px-6 py-4 text-sm font-semibold text-gray-900 text-right",children:C(c.total)})]},s))})]})}),d.length>5&&e.jsxs("div",{className:"flex items-center justify-between mt-4",children:[e.jsxs("p",{className:"text-sm text-gray-600",children:["Mostrando ",x.length," de ",d.length," clientes"]}),e.jsxs("button",{onClick:()=>n(!a),className:"flex items-center gap-2 px-4 py-2 text-sm font-medium text-blue-700 bg-blue-100 border border-blue-300 rounded-lg hover:bg-blue-200 transition-colors cursor-pointer whitespace-nowrap",children:[e.jsx("i",{className:`${a?"ri-eye-off-line":"ri-eye-line"}`}),a?"Ver menos":"Ver todos"]})]})]})]})}function I({estado:d,tareas:r}){const[a,n]=w.useState(new Set),x=t=>{const m=new Set(a);m.has(t)?m.delete(t):m.add(t),n(m)},c=t=>{switch(t){case"En Cola":return"bg-yellow-100 text-yellow-800 border-yellow-300";case"En Proceso":return"bg-blue-100 text-blue-800 border-blue-300";case"Produciendo":return"bg-purple-100 text-purple-800 border-purple-300";case"Esperando suministros":return"bg-orange-100 text-orange-800 border-orange-300";case"Terminado":return"bg-green-100 text-green-800 border-green-300";case"Finalizado":return"bg-gray-100 text-gray-800 border-gray-300";default:return"bg-gray-100 text-gray-800 border-gray-300"}},s=t=>{switch(t){case"HH":return"bg-blue-50 border-blue-200 text-blue-900";case"ETIQUETAS":return"bg-green-50 border-green-200 text-green-900";case"DEDICADOS":return"bg-purple-50 border-purple-200 text-purple-900";case"EMBALAJE":return"bg-orange-50 border-orange-200 text-orange-900";case"MAQUINA":return"bg-red-50 border-red-200 text-red-900";case"HABLADORES":return"bg-pink-50 border-pink-200 text-pink-900";case"REMPAQUE":return"bg-indigo-50 border-indigo-200 text-indigo-900";case"BOLSAS":return"bg-teal-50 border-teal-200 text-teal-900";default:return"bg-gray-50 border-gray-200 text-gray-900"}};return e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden",children:[e.jsx("div",{className:`px-6 py-4 border-b border-gray-200 ${c(d)} bg-opacity-30`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900",children:d}),e.jsxs("span",{className:`px-3 py-1 text-sm font-medium rounded-full border ${c(d)}`,children:[r.length," ",r.length===1?"tarea":"tareas"]})]})}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider whitespace-nowrap",children:"Caso"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider whitespace-nowrap",children:"Solicitante"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider whitespace-nowrap",children:"Cliente"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider whitespace-nowrap",children:"Descripción"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider whitespace-nowrap",children:"Inicio"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider whitespace-nowrap",children:"Cierre"}),e.jsx("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider whitespace-nowrap",children:"Personas"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider whitespace-nowrap",children:"Responsable"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider whitespace-nowrap",children:"Entregado a"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider whitespace-nowrap",children:"Observaciones VA"}),e.jsx("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider whitespace-nowrap",children:"Items"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:r.map(t=>{const m=a.has(t.id);return e.jsxs(e.Fragment,{children:[e.jsxs("tr",{className:"hover:bg-gray-50 transition-colors",children:[e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-gray-900 whitespace-nowrap",children:t.caso}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-900 whitespace-nowrap",children:t.solicitante}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-900 whitespace-nowrap",children:t.cliente}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-900 max-w-xs truncate",children:t.descripcion}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-900 whitespace-nowrap",children:t.inicio?new Date(t.inicio).toLocaleDateString():"-"}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-900 whitespace-nowrap",children:t.cierre?new Date(t.cierre).toLocaleDateString():"-"}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-900 text-center whitespace-nowrap",children:t.cantidad_personas||0}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-900 whitespace-nowrap",children:t.responsable}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-900 whitespace-nowrap",children:t.entregado_a||"-"}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-900 max-w-xs truncate",children:t.observaciones_va||"-"}),e.jsx("td",{className:"px-4 py-3 text-center whitespace-nowrap",children:e.jsxs("button",{onClick:()=>x(t.id),className:"px-3 py-1 text-xs font-medium text-blue-700 bg-blue-100 border border-blue-300 rounded hover:bg-blue-200 transition-colors cursor-pointer whitespace-nowrap",children:[e.jsx("i",{className:`${m?"ri-eye-off-line":"ri-eye-line"} mr-1`}),m?"Ocultar":"Ver"]})})]},t.id),m&&e.jsx("tr",{children:e.jsx("td",{colSpan:11,className:"px-4 py-4 bg-gray-50",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-900 mb-2",children:"Detalle de Items"}),t.items.length===0?e.jsx("p",{className:"text-sm text-gray-500 italic",children:"No hay items registrados para esta tarea"}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border border-gray-200 rounded-lg",children:[e.jsx("thead",{className:"bg-white",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-700 border-b border-gray-200",children:"Descripción"}),e.jsx("th",{className:"px-4 py-2 text-center text-xs font-medium text-gray-700 border-b border-gray-200",children:"Categoría"}),e.jsx("th",{className:"px-4 py-2 text-right text-xs font-medium text-gray-700 border-b border-gray-200",children:"Cantidad"}),e.jsx("th",{className:"px-4 py-2 text-center text-xs font-medium text-gray-700 border-b border-gray-200",children:"Unidad"}),e.jsx("th",{className:"px-4 py-2 text-right text-xs font-medium text-gray-700 border-b border-gray-200",children:"Costo Unitario"}),e.jsx("th",{className:"px-4 py-2 text-right text-xs font-medium text-gray-700 border-b border-gray-200",children:"Costo Total"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:t.items.map(o=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-2 text-sm text-gray-900",children:o.descripcion}),e.jsx("td",{className:"px-4 py-2 text-center",children:e.jsx("span",{className:`inline-block px-2 py-1 text-xs font-medium rounded border ${s(o.categoria)}`,children:o.categoria})}),e.jsx("td",{className:"px-4 py-2 text-sm text-gray-900 text-right",children:o.cantidad.toLocaleString()}),e.jsx("td",{className:"px-4 py-2 text-center",children:e.jsx("span",{className:"inline-block px-2 py-1 text-xs font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded",children:o.unidad_medida||"u"})}),e.jsx("td",{className:"px-4 py-2 text-sm text-gray-900 text-right",children:C(o.costo_unitario)}),e.jsx("td",{className:"px-4 py-2 text-sm font-medium text-gray-900 text-right",children:C(o.costo_total)})]},o.id))}),e.jsx("tfoot",{className:"bg-gray-50 border-t-2 border-gray-300",children:e.jsxs("tr",{children:[e.jsx("td",{colSpan:5,className:"px-4 py-2 text-sm font-bold text-gray-900 text-right",children:"Total General:"}),e.jsx("td",{className:"px-4 py-2 text-sm font-bold text-blue-600 text-right",children:C(t.total_general)})]})})]})}),e.jsxs("div",{className:"mt-4",children:[e.jsx("h5",{className:"text-sm font-semibold text-gray-900 mb-3",children:"Totales por Categoría"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3",children:[Object.entries(t.totales_por_categoria||{}).sort(([o],[i])=>o.localeCompare(i)).map(([o,i])=>e.jsxs("div",{className:`border rounded-lg p-3 ${s(o)}`,children:[e.jsx("p",{className:"text-xs font-medium mb-1",children:o}),e.jsx("p",{className:"text-lg font-bold",children:C(i)}),o==="HH"&&t.alerta_hh&&e.jsxs("div",{className:"mt-2 p-2 bg-yellow-50 border border-yellow-300 rounded text-xs text-yellow-800",children:[e.jsx("i",{className:"ri-alert-line mr-1"}),t.alerta_hh]})]},o)),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-3",children:[e.jsx("p",{className:"text-xs text-blue-700 font-medium mb-1",children:"TOTAL GENERAL"}),e.jsx("p",{className:"text-lg font-bold text-blue-600",children:C(t.total_general)})]})]})]})]})]})})})]})})})]})})]})}function L({tareas:d,totalesPorCliente:r,totalGeneral:a,loading:n,filtros:x,onFiltroChange:c,onExportarExcel:s,onRefresh:t}){const m=d.reduce((i,g)=>(i[g.estado]||(i[g.estado]=[]),i[g.estado].push(g),i),{}),o=Object.keys(m).sort();return e.jsx("div",{className:"flex-1 overflow-y-auto",children:e.jsxs("div",{className:"max-w-[1600px] mx-auto p-6 space-y-6",children:[e.jsx("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 bg-teal-500 rounded-lg flex items-center justify-center",children:e.jsx("span",{className:"text-white font-bold text-xl",style:{fontFamily:'"Pacifico", serif'},children:"O"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"CRM Valor Agregado - Tabla de datos Tareas"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Análisis EDA de producción y productividad"})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("button",{onClick:t,disabled:n,className:"px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 transition-colors cursor-pointer whitespace-nowrap",children:[e.jsx("i",{className:"ri-refresh-line mr-2"}),"Actualizar"]}),e.jsxs("button",{onClick:s,disabled:n,className:"px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700 disabled:opacity-50 transition-colors cursor-pointer whitespace-nowrap",children:[e.jsx("i",{className:"ri-file-excel-2-line mr-2"}),"Descargar Excel"]})]})]})}),e.jsx(q,{filtros:x,onFiltroChange:c}),e.jsx($,{totalesPorCliente:r,totalGeneral:a}),n?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx("i",{className:"ri-loader-4-line text-4xl text-blue-600 animate-spin mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Cargando datos..."})]})}):o.length===0?e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-12 text-center",children:[e.jsx("i",{className:"ri-inbox-line text-6xl text-gray-300 mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No hay datos disponibles"}),e.jsx("p",{className:"text-gray-500",children:"No se encontraron tareas con los filtros aplicados"})]}):e.jsx("div",{className:"space-y-6",children:o.map(i=>e.jsx(I,{estado:i,tareas:m[i]},i))})]})})}class M{async getTareasAnalisis(r){try{let a=E.from("tareas").select(`
          id,
          consecutivo,
          descripcion_breve,
          fecha_inicio,
          fecha_cierre,
          estado,
          entregado_a,
          solicitante_id,
          email_solicitante,
          datos_formulario
        `).order("consecutivo",{ascending:!1});r?.busqueda&&(a=a.or(`consecutivo.ilike.%${r.busqueda}%,descripcion_breve.ilike.%${r.busqueda}%`)),r?.fecha_inicio&&(a=a.gte("fecha_inicio",r.fecha_inicio)),r?.fecha_fin&&(a=a.lte("fecha_cierre",r.fecha_fin)),r?.estado&&(a=a.eq("estado",r.estado));const{data:n,error:x}=await a;if(x)throw x;const c=[];for(const s of n||[]){const t=s.datos_formulario?.cliente||"Sin cliente",m=s.datos_formulario?.solicitante||s.email_solicitante||"Sin solicitante",o=s.datos_formulario?.responsable||"Sin asignar",{data:i,error:g}=await E.from("tareas_items").select(`
            id,
            descripcion,
            cantidad,
            costo_unitario,
            costo_total
          `).eq("tarea_id",s.id);if(g)continue;const N=[],h={};for(const u of i||[]){let y="OTROS",v=null,l=null;const{data:p,error:j}=await E.from("inventario").select(`
              id_articulo,
              codigo_articulo,
              descripcion_articulo,
              categoria_id,
              unidad_base_id
            `).eq("descripcion_articulo",u.descripcion).single();if(j){const{data:b,error:S}=await E.from("inventario").select(`
                id_articulo,
                codigo_articulo,
                descripcion_articulo,
                categoria_id,
                unidad_base_id
              `).ilike("descripcion_articulo",`%${u.descripcion}%`).limit(1).single();if(!S&&b){if(v=b.codigo_articulo,b.categoria_id){const{data:T,error:D}=await E.from("categorias_inventario").select("nombre_categoria").eq("id_categoria",b.categoria_id).single();!D&&T&&(y=T.nombre_categoria)}if(b.unidad_base_id){const{data:T,error:D}=await E.from("unidades_medida").select("simbolo").eq("id",b.unidad_base_id).single();!D&&T&&(l=T.simbolo)}}}else if(p){if(v=p.codigo_articulo,p.categoria_id){const{data:b,error:S}=await E.from("categorias_inventario").select("nombre_categoria").eq("id_categoria",p.categoria_id).single();!S&&b&&(y=b.nombre_categoria)}if(p.unidad_base_id){const{data:b,error:S}=await E.from("unidades_medida").select("simbolo").eq("id",p.unidad_base_id).single();!S&&b&&(l=b.simbolo)}}N.push({id:u.id,descripcion:u.descripcion,codigo_articulo:v,categoria:y,unidad_medida:l,cantidad:u.cantidad,costo_unitario:u.costo_unitario,costo_total:u.costo_total}),h[y]||(h[y]=0),h[y]+=u.costo_total}const f=Object.values(h).reduce((u,y)=>u+y,0);let _;if(h.HH&&s.fecha_inicio&&s.fecha_cierre){const u=new Date(s.fecha_inicio),v=(new Date(s.fecha_cierre).getTime()-u.getTime())/(1e3*60*60),p=N.filter(j=>j.categoria==="HH").reduce((j,b)=>j+b.cantidad,0);if(p>0){const j=Math.abs(v-p)/p*100;j>30&&(_=`⚠️ Las horas cargadas en HH (${p.toFixed(1)}h) difieren ${j.toFixed(0)}% del tiempo real (${v.toFixed(1)}h). Revisar.`)}}c.push({id:s.id,caso:s.consecutivo,cliente:t,descripcion:s.descripcion_breve||"",solicitante:m,inicio:s.fecha_inicio,cierre:s.fecha_cierre,cantidad_personas:0,responsable:o,entregado_a:s.entregado_a||"",observaciones_va:s.descripcion_breve||"",estado:s.estado,items:N,totales_por_categoria:h,total_general:f,alerta_hh:_,dedicados:h.DEDICADOS||0,etiquetas:h.ETIQUETAS||0,hh:h.HH||0})}return c}catch(a){throw a}}async getTotalesPorCliente(r){try{const n=(await this.getTareasAnalisis(r)).reduce((c,s)=>{const t=s.cliente;return c[t]||(c[t]=0),c[t]+=s.total_general,c},{});return Object.entries(n).map(([c,s])=>({cliente:c,total:s})).sort((c,s)=>s.total-c.total)}catch(a){throw a}}async exportarExcel(r){try{const a=await this.getTareasAnalisis(r);if(a.length===0){alert("No hay datos para exportar con los filtros aplicados");return}const n=a.reduce((i,g)=>(i[g.estado]||(i[g.estado]=[]),i[g.estado].push(g),i),{}),x=Object.keys(n).sort(),c=new Set;a.forEach(i=>{Object.keys(i.totales_por_categoria||{}).forEach(g=>{c.add(g)})});const s=Array.from(c).sort(),t=k.book_new();x.forEach(i=>{const N=n[i].map(l=>{const p={Caso:l.consecutivo,Cliente:l.cliente,Descripción:l.descripcion,Solicitante:l.solicitante,Inicio:l.fecha_inicio?this.formatearFecha(l.fecha_inicio):"",Cierre:l.fecha_cierre?this.formatearFecha(l.fecha_cierre):"",Responsable:l.responsable,"Entregado a":l.entregado_a,"Observaciones VA":l.observaciones_va};return s.forEach(j=>{const b=l.totales_por_categoria?.[j]||0;p[j]=b}),p["Total General"]=l.total_general,p}),h=k.json_to_sheet(N),f=[{wch:15},{wch:25},{wch:40},{wch:30},{wch:12},{wch:12},{wch:25},{wch:25},{wch:40},...s.map(()=>({wch:15})),{wch:15}];h["!cols"]=f;const _=k.decode_range(h["!ref"]||"A1"),u=s.length+1,y=9;for(let l=_.s.r+1;l<=_.e.r;++l)for(let p=y;p<y+u;++p){const j=k.encode_cell({r:l,c:p});h[j]&&(h[j].z="₡#,##0.00")}const v=i.substring(0,31);k.book_append_sheet(t,h,v)});let o=`analisis_tareas_${new Date().toISOString().split("T")[0]}`;r?.estado&&(o+=`_${r.estado}`),r?.cliente_id&&(o+=`_cliente_${r.cliente_id}`),o+=".xlsx",P(t,o)}catch(a){throw a}}formatearFecha(r){try{const a=new Date(r),n=String(a.getDate()).padStart(2,"0"),x=String(a.getMonth()+1).padStart(2,"0"),c=a.getFullYear();return`${n}/${x}/${c}`}catch{return r}}async actualizarCategoriaItem(r,a){try{const{error:n}=await E.from("tareas_items").update({categoria:a}).eq("id",r);if(n)throw n}catch(n){throw n}}}const A=new M;function U(){F();const[d,r]=w.useState(!1),[a,n]=w.useState(!0),[x,c]=w.useState([]),[s,t]=w.useState([]),[m,o]=w.useState(0),[i,g]=w.useState({busqueda:"",fecha_inicio_desde:"",fecha_cierre_hasta:"",estado:"",cliente:""});w.useEffect(()=>{N()},[i]);const N=async()=>{try{n(!0);const[_,u]=await Promise.all([A.getTareasAnalisis(i),A.getTotalesPorCliente(i)]);c(_),t(u);const y=u.reduce((v,l)=>v+l.total,0);o(y)}catch{alert("Error al cargar los datos de análisis")}finally{n(!1)}},h=_=>{g(_)},f=async()=>{try{await A.exportarExcel(i)}catch{alert("Error al exportar el archivo Excel")}};return e.jsxs("div",{className:"flex h-screen bg-gray-50",children:[e.jsx(H,{isOpen:d,onClose:()=>r(!1)}),e.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden",children:[e.jsx(O,{onMenuClick:()=>r(!0)}),e.jsx(L,{tareas:x,totalesPorCliente:s,totalGeneral:m,loading:a,filtros:i,onFiltroChange:h,onExportarExcel:f,onRefresh:N})]})]})}export{U as default};
//# sourceMappingURL=page-PjmUQapK.js.map
